<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>ÓticaVision Pro - Sistema Profissional</title>
    <!-- ===== PWA META TAGS ===== -->
    <meta name="application-name" content="ÓticaVision Pro">
    <meta name="description" content="Sistema Profissional de Gestão para Óticas">
    <meta name="theme-color" content="#ff6b00">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ÓticaVision">
    <meta name="msapplication-TileColor" content="#ff6b00">
    <meta name="msapplication-tap-highlight" content="no">
    <!-- Manifest inline com URLs absolutas (resolve erro de blob URL com paths relativos) -->
    <script>
    (function() {
        var base = location.href.replace(/\/[^\/]*$/, '/');
        var manifest = {
            name: "ÓticaVision Pro",
            short_name: "ÓticaVision",
            description: "Sistema Profissional de Gestão para Óticas",
            start_url: base,
            scope: base,
            display: "standalone",
            background_color: "#ffffff",
            theme_color: "#ff6b00",
            orientation: "portrait-primary",
            icons: [
                { src: base + "icons/icon-192x192.png", sizes: "192x192", type: "image/png", purpose: "any maskable" },
                { src: base + "icons/icon-512x512.png", sizes: "512x512", type: "image/png", purpose: "any maskable" }
            ]
        };
        var blob = new Blob([JSON.stringify(manifest)], { type: 'application/manifest+json' });
        var url = URL.createObjectURL(blob);
        var link = document.createElement('link');
        link.rel = 'manifest';
        link.href = url;
        document.currentScript.parentNode.insertBefore(link, document.currentScript);
    })();
    </script>
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link rel="shortcut icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512x512.png">
    <!-- Gere os ícones abrindo generate_icons.html no navegador -->
    <!-- ===== /PWA META TAGS ===== -->

    <!-- ===== SUPABASE SDK ===== -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      const SUPABASE_URL  = 'https://qhscxyistzlmxxnjrqao.supabase.co';
      const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFoc2N4eWlzdHpsbXh4bmpycWFvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE4NTQzOTMsImV4cCI6MjA4NzQzMDM5M30.xrhD08N1PcOVAMdA0vovxbHOHrcSdqIYkJWw4K6G13w';
      const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
      supabaseClient.from('clients').select('id', { count: 'exact', head: true }).then(({error}) => {
        if (error) console.error('[Supabase] ❌ Erro:', error.message);
        else console.log('[Supabase] ✅ Conectado!');
      });
    </script>
    <!-- ===== /SUPABASE SDK ===== -->


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Bibliotecas para PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- SheetJS para exportar Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* ===== RESET E VARIÁVEIS ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        :root {
            --primary: #ff6b00;
            --primary-dark: #e55a00;
            --primary-light: #ffd4b3;
            --secondary: #ffcc00;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            --transition: all 0.2s ease;
        }

        .dark-mode {
            --primary: #3a3a3a;        /* cinza escuro */
            --primary-dark: #2a2a2a;
            --primary-light: #4a4a4a;
            --secondary: #555555;
            --light: #1a1a1a;           /* fundo preto */
            --dark: #f0f0f0;             /* texto claro */
            --gray: #b0b0b0;              /* cinza médio */
            --light-gray: #2d2d2d;        /* fundo de cards */
            --success: #2e7d32;
            --danger: #b71c1c;
            --warning: #b26a00;
            --info: #0d5466;
            --box-shadow: 0 4px 6px rgba(0,0,0,0.5);
            --border-radius: 8px;
        }

        .dark-mode body {
            background: #121212;
            color: #e0e0e0;
        }

        .dark-mode .card,
        .dark-mode .form-container,
        .dark-mode .venda-container,
        .dark-mode .table-container,
        .dark-mode .chart-container,
        .dark-mode .modal-content,
        .dark-mode .presc-container,
        .dark-mode .cliente-info-card,
        .dark-mode .presc-rapida,
        .dark-mode .cliente-card {
            background-color: #1a1d27;
            border-color: rgba(255,255,255,0.08);
            color: #e0e0e0;
        }
        .dark-mode .card::after { opacity: 0.8; }
        .dark-mode .card-icon { filter: brightness(0.7); }
        .dark-mode .card-title { color: rgba(255,255,255,0.45); }
        .dark-mode .card-value { color: #f0f0f0; }
        .dark-mode .bar-value { background: #2d2d2d; border-color: #444; color: #e0e0e0; }

        .dark-mode .form-control {
            background-color: #2d2d2d;
            border-color: #444;
            color: #e0e0e0;
        }

        .dark-mode .form-control:focus {
            border-color: #666;
            box-shadow: 0 0 0 3px rgba(255,255,255,0.1);
        }

        .dark-mode th {
            background-color: #2d2d2d;
            color: #e0e0e0;
            border-color: #444;
        }

        .dark-mode td {
            border-color: #444;
            color: #e0e0e0;
        }

        .dark-mode .btn-secondary {
            background-color: #2d2d2d;
            color: #e0e0e0;
            border: 1px solid #444;
        }

        .dark-mode .btn-secondary:hover {
            background-color: #3d3d3d;
        }

        .dark-mode .sidebar {
            background: linear-gradient(180deg, #1c1c1c 0%, #111111 100%);
        }

        .dark-mode .menu-item:hover,
        .dark-mode .menu-item.active {
            background: rgba(255,255,255,0.10);
        }

        .dark-mode .header {
            border-color: #222;
            background: #161616;
        }

        .dark-mode .main-content {
            background: #111111;
        }

        .dark-mode .badge {
            opacity: 0.9;
        }

        .dark-mode .presc-profissionais {
            background-color: #2d2d2d;
        }

        .dark-mode .presc-medidas {
            background: #2d2d2d;
        }

        .dark-mode .medida-card {
            background-color: #1e1e1e;
            border: 1px solid #333;
        }

        .dark-mode .parcelas-container {
            background-color: #2d2d2d;
        }

        .dark-mode .metodo-card {
            border-color: #444;
            color: #e0e0e0;
        }

        .dark-mode .metodo-card:hover {
            background-color: #2d2d2d;
        }

        .dark-mode .metodo-card.active {
            background-color: #2d2d2d;
            border-color: #888;
        }

        .dark-mode .cliente-info-card {
            background: linear-gradient(135deg, #1e1e1e, #2d2d2d);
        }

        .dark-mode .presc-rapida {
            background-color: #1e1e1e;
            border-left-color: #555;
        }

        .dark-mode .presc-field {
            background-color: #2d2d2d;
            border-color: #444;
            color: #e0e0e0;
        }

        .dark-mode .linha-pontilhada span {
            background-color: #1e1e1e;
            color: #aaa;
        }

        .dark-mode .auto-save-indicator {
            background-color: #2e7d32;
            color: white;
        }

        .dark-mode .datetime-widget {
            background: #2d2d2d;
            color: #e0e0e0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.5);
        }

        .dark-mode .datetime-widget .time {
            color: #e8e8e8;
        }

        .dark-mode .datetime-widget .date {
            color: #b0b0b0;
        }

        .dark-mode .header-left h1 {
            color: #e0e0e0;
        }

        .dark-mode .section-title {
            color: #cccccc;
        }

        .dark-mode .card-value {
            color: #e8e8e8;
        }

        .dark-mode .card {
            border-top-color: #444444;
        }

        .dark-mode #pixDetails > div,
        .dark-mode #cashDetails > div {
            background: #1a2a3a !important;
            color: #e0e0e0;
        }

        .dark-mode .tabela-parcelas th {
            background: #2d2d2d;
            color: #e0e0e0;
        }

        .dark-mode .tabela-parcelas td {
            border-color: #444;
            color: #e0e0e0;
        }

        .dark-mode .tabela-parcelas tr:nth-child(even) td {
            background: #252525;
        }

        .dark-mode .resumo-crediario {
            background: #2d2d2d;
        }

        .dark-mode .resumo-item {
            border-color: #444;
        }

        .dark-mode .sale-item {
            border-color: #444;
            color: #e0e0e0;
        }

        .dark-mode .sale-item-header {
            background: #2d2d2d !important;
            color: #b0b0b0;
        }

        .dark-mode .payment-card {
            border-color: #444;
            color: #e0e0e0;
            background: #1e1e1e;
        }

        .dark-mode .payment-card:hover {
            background: #2d2d2d;
        }

        .dark-mode .payment-card.active {
            border-color: #ff9944;
            background: #2d1a00;
            color: #ff9944;
        }

        body {
            background: #f4f5f7;
            color: var(--dark);
            transition: var(--transition);
            min-height: 100vh;
        }
        .dark-mode body {
            background: #111111;
        }

        /* ===== LAYOUT PRINCIPAL ===== */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 120px;
            background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            position: fixed;
            height: 100vh;
            overflow: hidden;
            transition: width 0.3s cubic-bezier(.4,0,.2,1);
            z-index: 100;
            box-shadow: 2px 0 32px rgba(0,0,0,0.25);
            display: flex;
            flex-direction: column;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .sidebar::-webkit-scrollbar { display: none; width: 0; }

        .sidebar-header {
            padding: 0.6rem 0.5rem 0.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.07);
            flex-shrink: 0;
        }

        .close-sidebar {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            color: rgba(255,255,255,0.6);
            font-size: 22px;
            cursor: pointer;
            display: none;
            width: 30px;
            height: 30px;
            border-radius: 6px;
            transition: background 0.2s;
        }
        .close-sidebar:hover { background: rgba(255,255,255,0.1); }

        .logo-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.3rem;
            width: 100%;
        }

        /* ── Sidebar: logo circular ── */
        .logo-wrapper {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            flex-shrink: 0;
            background-color: var(--primary);
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center center;
            display: block;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .logo-wrapper:hover { transform: scale(1.05); box-shadow: 0 4px 18px rgba(0,0,0,0.4); }
        .logo-img { display: none !important; }
        .logo-placeholder {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s;
            flex-shrink: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.3), rgba(255,255,255,0.1));
            border: 2px solid rgba(255,255,255,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .logo-placeholder:hover { transform: scale(1.05); }

        .company-name {
            font-size: 0.62rem;
            font-weight: 700;
            color: white;
            letter-spacing: 0.1px;
            line-height: 1.2;
            text-align: center;
            width: 100%;
            white-space: normal;
            word-break: break-word;
            overflow: visible;
        }

        .company-subtitle {
            display: none;
        }

        .sidebar-menu {
            flex: 1;
            padding: 0.2rem 0.4rem;
            overflow: hidden; /* nunca mostra scrollbar */
        }

        .sidebar-section-label {
            padding: 0.4rem 0.4rem 0.15rem;
            font-size: 0.5rem;
            font-weight: 700;
            color: rgba(255,255,255,0.25);
            letter-spacing: 1.5px;
            text-transform: uppercase;
            text-align: center;
        }

        .menu-item {
            padding: 0.38rem 0.4rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            cursor: pointer;
            transition: all 0.18s;
            border-radius: 8px;
            color: rgba(255,255,255,0.55);
            font-size: 0.82rem;
            font-weight: 500;
            margin-bottom: 1px;
            position: relative;
        }

        .menu-item span {
            display: block;
            font-size: 0.58rem;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 108px;
            line-height: 1.1;
        }

        .menu-item i {
            width: 16px;
            text-align: center;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .menu-item:hover {
            background: rgba(255,255,255,0.07);
            color: rgba(255,255,255,0.9);
        }

        .menu-item.active {
            background: rgba(255,255,255,0.15);
            color: white;
            font-weight: 600;
        }
        .menu-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 15%;
            height: 70%;
            width: 3px;
            border-radius: 0 3px 3px 0;
            background: white;
        }

        .sidebar-footer {
            padding: 0.4rem 0.4rem;
            border-top: 1px solid rgba(255,255,255,0.07);
            flex-shrink: 0;
        }

        .theme-toggle {
            width: 100%;
            padding: 0.4rem 0.4rem;
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.08);
            color: rgba(255,255,255,0.55);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            transition: all 0.18s;
            font-size: 0.56rem;
            font-weight: 500;
        }
        .theme-toggle span { display: block; }
        .theme-toggle i { font-size: 0.85rem; }
        .theme-toggle:hover { background: rgba(255,255,255,0.1); color: white; }

        .main-content {
            flex: 1;
            margin-left: 120px;
            padding: 1.5rem;
            transition: margin-left 0.3s cubic-bezier(.4,0,.2,1);
            min-width: 0;
        }

        .menu-toggle {
            display: none;
            background: var(--primary);
            color: white;
            border: none;
            font-size: 24px;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            margin-bottom: 15px;
        }

        /* ===== HEADER ===== */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 1.1rem;
            border-bottom: 1px solid rgba(0,0,0,0.07);
            margin-bottom: 1.75rem;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .header-left h1 {
            font-size: clamp(1.3rem, 3.5vw, 1.7rem);
            color: var(--dark);
            font-weight: 800;
            letter-spacing: -0.3px;
        }

        #pageSubtitle {
            font-size: 0.8rem;
            color: var(--gray);
            font-weight: 500;
            margin-top: 1px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .datetime-widget {
            background: white;
            padding: 0.4rem 1rem;
            border-radius: 10px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.07);
            border: 1px solid rgba(0,0,0,0.05);
            text-align: center;
        }

        .time {
            font-size: 1.05rem;
            font-weight: 800;
            color: var(--primary);
            letter-spacing: -0.3px;
        }

        .date {
            font-size: 0.72rem;
            color: var(--gray);
            font-weight: 500;
        }

        .backup-buttons {
            display: flex;
            gap: 0.4rem;
        }

        /* ===== SEÇÕES ===== */
        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-title {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--light-gray);
            font-weight: 600;
        }

        /* ===== CARDS ===== */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
            gap: 1.25rem;
            margin-bottom: 1.75rem;
        }

        .dashboard-cards .card[style*="grid-column: span 2"],
        .dashboard-cards .card[style*="grid-column:span 2"] {
            grid-column: span 2;
        }

        @media (max-width: 600px) {
            .dashboard-cards .card[style*="grid-column: span 2"],
            .dashboard-cards .card[style*="grid-column:span 2"] {
                grid-column: span 1;
            }
        }

        .card {
            background: white;
            border-radius: 14px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.07);
            padding: 1.35rem 1.35rem 1.1rem;
            border: 1px solid rgba(0,0,0,0.06);
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
            overflow: hidden;
        }

        .card::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: var(--card-accent, var(--primary));
            border-radius: 14px 14px 0 0;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(0,0,0,0.12);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.85rem;
        }

        .card-title {
            font-size: 0.75rem;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            font-weight: 600;
        }

        .card-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .card-value {
            font-size: 1.7rem;
            font-weight: 800;
            color: var(--dark);
            margin-bottom: 0.3rem;
            letter-spacing: -0.5px;
        }

        .dashboard-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.25rem;
            margin-bottom: 1.75rem;
        }

        /* ── Dashboard: painéis de alertas ── */
        .dash-alert-panel {
            background: white;
            border-radius: 14px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.07);
            border: 1px solid rgba(0,0,0,0.06);
            overflow: hidden;
            margin-bottom: 1.25rem;
        }
        .dash-alert-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.85rem 1.2rem;
            font-weight: 700;
            font-size: 0.82rem;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        .dash-alert-header.birthday { background: linear-gradient(90deg,#ff6b00 0%,#ffaa00 100%); color: white; }
        .dash-alert-header.glasses  { background: linear-gradient(90deg,#3b82f6 0%,#2563eb 100%); color: white; }
        .dash-alert-header .badge-count {
            background: rgba(255,255,255,0.25);
            border-radius: 999px;
            padding: 2px 10px;
            font-size: 0.78rem;
        }
        .dash-alert-list { max-height: 280px; overflow-y: auto; }
        .dash-alert-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.7rem 1.2rem;
            border-bottom: 1px solid var(--light-gray);
            gap: 0.5rem;
            font-size: 0.88rem;
        }
        .dash-alert-item:last-child { border-bottom: none; }
        .dash-alert-item:hover { background: var(--light); }
        .dash-alert-name { font-weight: 600; color: var(--dark); flex: 1; }
        .dash-alert-info { color: var(--gray); font-size: 0.8rem; }
        .dash-alert-empty {
            padding: 1.5rem;
            text-align: center;
            color: var(--gray);
            font-size: 0.88rem;
        }
        .btn-wpp-sm {
            background: #25d366;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 5px 10px;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
            transition: background 0.2s;
            flex-shrink: 0;
        }
        .btn-wpp-sm:hover { background: #128c4e; }
        .dark-mode .dash-alert-panel { background: #1e1e1e; }
        .dark-mode .dash-alert-item  { border-color: #333; }
        .dark-mode .dash-alert-item:hover { background: #2a2a2a; }

        /* ═══════════════════════════════════════
           EDITOR DE MENSAGENS WHATSAPP
        ═══════════════════════════════════════ */
        .wpp-editor-grid {
            display: grid;
            grid-template-columns: 260px 1fr;
            gap: 1.5rem;
            align-items: start;
        }
        @media (max-width: 768px) {
            .wpp-editor-grid { grid-template-columns: 1fr; }
        }
        /* Sidebar de seleção de mensagem */
        .wpp-sidebar {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            position: sticky;
            top: 1rem;
        }
        .wpp-sidebar-header {
            background: #25d366;
            color: white;
            padding: 0.9rem 1.1rem;
            font-weight: 700;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .wpp-nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.85rem 1.1rem;
            cursor: pointer;
            border-bottom: 1px solid var(--light-gray);
            transition: background 0.15s;
            font-size: 0.88rem;
            font-weight: 500;
            color: var(--dark);
            user-select: none;
        }
        .wpp-nav-item:last-child { border-bottom: none; }
        .wpp-nav-item:hover { background: #f0fdf4; }
        .wpp-nav-item.active { background: #dcfce7; color: #166534; border-left: 3px solid #25d366; }
        .wpp-nav-icon {
            width: 32px; height: 32px;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.95rem;
            flex-shrink: 0;
        }
        .wpp-nav-label { line-height: 1.2; }
        .wpp-nav-desc  { font-size: 0.7rem; color: var(--gray); font-weight: 400; }
        /* Painel de edição */
        .wpp-editor-panel {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
        }
        .wpp-editor-header {
            background: linear-gradient(135deg, #25d366, #128c4e);
            color: white;
            padding: 1.1rem 1.4rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .wpp-editor-header-title {
            font-weight: 700;
            font-size: 1rem;
        }
        .wpp-editor-header-sub {
            font-size: 0.78rem;
            opacity: 0.85;
            margin-top: 2px;
        }
        .wpp-editor-body { padding: 1.4rem; }
        /* Textarea estilo terminal */
        .wpp-textarea {
            width: 100%;
            min-height: 220px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.85rem;
            line-height: 1.65;
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            resize: vertical;
            color: #1a1a1a;
            background: #fafafa;
            transition: border-color 0.2s, box-shadow 0.2s;
            box-sizing: border-box;
        }
        .wpp-textarea:focus {
            outline: none;
            border-color: #25d366;
            box-shadow: 0 0 0 3px rgba(37,211,102,0.15);
            background: white;
        }
        /* Caixa de variáveis */
        .wpp-vars-section {
            margin-top: 1rem;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            overflow: hidden;
        }
        .wpp-vars-header {
            background: #f0fdf4;
            padding: 0.6rem 1rem;
            font-size: 0.78rem;
            font-weight: 700;
            color: #166534;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }
        .wpp-vars-chips {
            padding: 0.65rem 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            background: white;
        }
        .wpp-chip {
            background: #dcfce7;
            color: #15803d;
            border: 1px solid #86efac;
            border-radius: 20px;
            padding: 3px 10px;
            font-size: 0.73rem;
            font-family: 'Courier New', monospace;
            cursor: pointer;
            transition: all 0.15s;
            white-space: nowrap;
        }
        .wpp-chip:hover {
            background: #16a34a;
            color: white;
            border-color: #16a34a;
            transform: translateY(-1px);
        }
        /* Preview estilo WhatsApp */
        .wpp-preview-section { margin-top: 1.2rem; }
        .wpp-preview-toggle {
            background: none;
            border: 1.5px solid #25d366;
            color: #25d366;
            border-radius: 6px;
            padding: 6px 14px;
            font-size: 0.82rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .wpp-preview-toggle:hover { background: #25d366; color: white; }
        .wpp-preview-bubble-wrap {
            margin-top: 0.85rem;
            background: #e5ddd5;
            border-radius: 12px;
            padding: 1.2rem;
            display: none;
        }
        .wpp-preview-bubble-wrap.show { display: block; }
        .wpp-preview-label {
            font-size: 0.72rem;
            color: #888;
            margin-bottom: 0.6rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .wpp-bubble {
            background: white;
            border-radius: 2px 12px 12px 12px;
            padding: 0.8rem 1rem;
            font-size: 0.82rem;
            line-height: 1.6;
            white-space: pre-wrap;
            word-break: break-word;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            max-width: 90%;
            color: #111;
        }
        /* Barra de ações */
        .wpp-action-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 0.75rem;
            padding: 1rem 1.4rem;
            background: #f8f9fa;
            border-top: 1px solid var(--light-gray);
        }
        .wpp-char-count { font-size: 0.78rem; color: var(--gray); }
        /* Dark mode */
        .dark-mode .wpp-sidebar        { background: #1e1e1e; }
        .dark-mode .wpp-nav-item       { color: #ddd; border-color: #333; }
        .dark-mode .wpp-nav-item:hover { background: #1a2e1a; }
        .dark-mode .wpp-nav-item.active{ background: #2a2a2a; color: #e0e0e0; }
        .dark-mode .wpp-editor-panel   { background: #1e1e1e; }
        .dark-mode .wpp-textarea       { background: #2d2d2d; border-color: #444; color: #e0e0e0; }
        .dark-mode .wpp-vars-section   { border-color: #333333; }
        .dark-mode .wpp-vars-header    { background: #1e1e1e; }
        .dark-mode .wpp-vars-chips     { background: #1e1e1e; }
        .dark-mode .wpp-chip           { background: #2a2a2a; color: #cccccc; border-color: #444444; }
        .dark-mode .wpp-action-bar     { background: #252525; border-color: #333; }

        .chart-container {
            background: white;
            border-radius: 14px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.07);
            border: 1px solid rgba(0,0,0,0.06);
            padding: 1.5rem 1.5rem 1.8rem;
            overflow-x: auto;
        }

        .chart-title {
            font-size: 0.9rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: var(--dark);
            text-transform: uppercase;
            letter-spacing: 0.6px;
        }

        .bar-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 180px;
            padding: 1.2rem 0 0;
            border-bottom: 2px solid var(--light-gray);
            min-width: 300px;
            gap: 4px;
        }

        .bar {
            flex: 1;
            max-width: 48px;
            background: linear-gradient(180deg, var(--primary) 0%, color-mix(in srgb, var(--primary) 60%, transparent) 100%);
            border-radius: 6px 6px 0 0;
            position: relative;
            transition: height 0.4s cubic-bezier(.4,0,.2,1), opacity 0.2s;
            cursor: pointer;
            min-height: 4px;
        }

        .bar:hover { opacity: 0.8; }

        .bar-value {
            position: absolute;
            top: -26px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.65rem;
            font-weight: 700;
            white-space: nowrap;
            color: var(--dark);
            background: white;
            border: 1px solid var(--light-gray);
            padding: 2px 5px;
            border-radius: 5px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        }

        .bar-label {
            position: absolute;
            bottom: -22px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.64rem;
            white-space: nowrap;
            color: var(--gray);
            font-weight: 500;
        }

        /* ===== FORMULÁRIOS ===== */
        .form-container {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--dark);
        }

        .form-group label.required::after {
            content: " *";
            color: var(--danger);
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            font-size: 1rem;
            background: white;
            color: var(--dark);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255,107,0,0.15);
        }

        .form-control[readonly] {
            background-color: var(--light-gray);
            cursor: not-allowed;
        }

        .form-control.error {
            border-color: var(--danger);
        }

        .error-message {
            color: var(--danger);
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }

        /* ===== INPUT GROUPS ===== */
        .input-group {
            display: flex;
            align-items: stretch;
        }

        .input-group .form-control {
            border-radius: var(--border-radius) 0 0 var(--border-radius);
            flex: 1;
        }

        .input-group-text {
            background: var(--primary);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
            font-weight: 600;
            display: flex;
            align-items: center;
            white-space: nowrap;
        }

        .input-group-text.danger { background: var(--danger); }
        .input-group-text.warning { background: var(--warning); color: var(--dark); }

        /* ===== BOTÕES ===== */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s;
            white-space: nowrap;
            min-width: 80px;
        }

        .btn-sm { padding: 0.5rem 1rem; font-size: 0.85rem; }
        .btn-lg { padding: 1rem 2rem; font-size: 1.1rem; }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }

        .btn-secondary { background: var(--light-gray); color: var(--dark); }
        .btn-secondary:hover { background: #d3d9df; }

        .btn-success { background: var(--success); color: white; }
        .btn-success:hover { background: #218838; }

        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #c82333; }

        .btn-info { background: var(--info); color: white; }
        .btn-info:hover { background: #138496; }

        .btn-warning { background: var(--warning); color: var(--dark); }
        .btn-warning:hover { background: #e0a800; }

        .btn-pdf { background: #dc3545; color: white; }
        .btn-pdf:hover { background: #c82333; }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            transition: all 0.2s;
            font-size: 1rem;
        }

        .btn-edit { background: rgba(23,162,184,0.1); color: var(--info); }
        .btn-edit:hover { background: var(--info); color: white; }

        .btn-delete { background: rgba(220,53,69,0.1); color: var(--danger); }
        .btn-delete:hover { background: var(--danger); color: white; }

        .btn-view { background: rgba(40,167,69,0.1); color: var(--success); }
        .btn-view:hover { background: var(--success); color: white; }

        .btn-pdf-icon { background: rgba(220,53,69,0.1); color: #dc3545; }
        .btn-pdf-icon:hover { background: #dc3545; color: white; }

        .btn-profissional {
            border-radius: 30px;
            font-weight: 600;
            padding: 10px 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .btn-pdf-group {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 50px;
            justify-content: center;
        }

        /* ===== BOTÕES DE PAGAMENTO PROFISSIONAIS ===== */
        /* ===== PAYMENT METHODS — PROFISSIONAL ===== */
        .payment-methods {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.6rem;
            margin: 0.75rem 0;
        }
        @media (max-width: 600px) {
            .payment-methods { grid-template-columns: repeat(3, 1fr); }
        }
        .payment-card {
            padding: 0.8rem 0.4rem;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 12px;
            font-weight: 700;
            font-size: 0.78rem;
            color: var(--dark);
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.35rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
            cursor: pointer;
            position: relative;
        }
        .payment-card i { font-size: 1.5rem; }
        .payment-card small { font-size: 0.65rem; font-weight: 600; opacity: 0.75; }
        .payment-card:hover { border-color: var(--primary); background: rgba(255,107,0,0.05); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(255,107,0,0.15); }
        .payment-card.active { border-color: var(--primary); background: #fff3ee; box-shadow: 0 0 0 3px rgba(255,107,0,0.2); }
        .payment-card.active i { color: var(--primary); }
        .payment-card.active::after { content: '✓'; position:absolute; top:4px; right:6px; font-size:0.7rem; color:var(--primary); font-weight:900; }
        /* Cores por método */
        .payment-card[data-method="pix"] i { color: #00a884; }
        .payment-card[data-method="cash"] i { color: #2e7d32; }
        .payment-card[data-method="debit"] i { color: #1565c0; }
        .payment-card[data-method="credit"] i { color: #6a1b9a; }
        .payment-card[data-method="installment"] i { color: #e65100; }
        /* Painel de resumo de pagamento profissional */
        .pay-summary-box {
            background: linear-gradient(135deg, #fff8f3 0%, #fff3ea 100%);
            border: 2px solid #ffcc9a;
            border-radius: 12px;
            padding: 14px 16px;
            margin-top: 12px;
        }
        .pay-summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px dashed #ffd9b3;
            font-size: 0.88rem;
        }
        .pay-summary-row:last-child { border-bottom: none; }
        .pay-summary-row .label { color: #666; font-weight: 600; }
        .pay-summary-row .value { font-weight: 800; font-size: 1rem; color: #333; }
        .pay-summary-row.highlight .label { color: #e65100; font-weight: 700; }
        .pay-summary-row.highlight .value { color: #e65100; font-size: 1.15rem; }
        .pay-summary-row.troco .value { color: #2e7d32; }
        .pay-summary-row.restante .label { color: #c62828; font-weight: 800; }
        .pay-summary-row.restante .value { color: #c62828; font-size: 1.15rem; }
        /* Entrada box */
        .entrada-retirada-box {
            background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%);
            border: 2px solid #a5d6a7;
            border-radius: 12px;
            padding: 14px 16px;
            margin-top: 12px;
        }
        .entrada-retirada-box h5 { color: #2e7d32; font-size: 0.82rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
        .retirada-alert {
            background: #fff3e0;
            border: 2px dashed #ffb74d;
            border-radius: 10px;
            padding: 12px 16px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .retirada-alert i { color: #e65100; font-size: 1.4rem; }
        .retirada-alert .valor { font-size: 1.4rem; font-weight: 900; color: #c62828; }
        /* dark mode */
        .dark-mode .payment-card { background: #2d2d2d; border-color: #444; color: #e0e0e0; }
        .dark-mode .payment-card:hover { border-color: #888888; background: #2d2d2d; }
        .dark-mode .payment-card.active { border-color: #aaaaaa; background: #333333; }
        .dark-mode .pay-summary-box { background: #1e1e1e; border-color: #444444; }
        .dark-mode .pay-summary-row { border-color: #333333; }
        .dark-mode .pay-summary-row .label { color: #bbb; }
        .dark-mode .pay-summary-row .value { color: #eee; }

        /* ===== TABELAS ===== */
        .table-container {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 1.5rem;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        th {
            background: var(--light-gray);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            white-space: nowrap;
            color: var(--dark);
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid var(--light-gray);
        }

        tr:hover td {
            background: rgba(255,107,0,0.03);
        }

        /* ===== BADGES ===== */
        .badge {
            padding: 0.35rem 0.75rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .badge-success { background: rgba(40,167,69,0.15); color: var(--success); }
        .badge-warning { background: rgba(255,193,7,0.15); color: #856404; }
        .badge-danger { background: rgba(220,53,69,0.15); color: var(--danger); }
        .badge-info { background: rgba(23,162,184,0.15); color: var(--info); }
        .badge-secondary { background: rgba(108,117,125,0.15); color: #6c757d; }

        .badge-admin { background: rgba(220,53,69,0.15); color: #dc3545; }
        .badge-manager { background: rgba(255,193,7,0.15); color: #856404; }
        .badge-seller { background: rgba(23,162,184,0.15); color: #17a2b8; }
        .badge-viewer { background: rgba(108,117,125,0.15); color: #6c757d; }

        /* ===== RECEITUÁRIO ===== */
        .presc-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            padding: 1.5rem;
            margin: 1.5rem 0;
            border: 1px solid var(--light-gray);
        }

        .presc-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--primary);
            flex-wrap: wrap;
            gap: 1rem;
        }

        .presc-title {
            color: var(--primary);
            font-size: 1.3rem;
            font-weight: 600;
        }

        .presc-profissionais {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            background: var(--light);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .presc-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }

        .presc-table th {
            background: var(--primary);
            color: white;
            text-align: center;
            padding: 0.75rem;
        }

        .presc-table td {
            text-align: center;
            border: 1px solid var(--light-gray);
            padding: 0.5rem;
        }

        .presc-stepper {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
        }

        .presc-stepper button {
            width: 28px;
            height: 28px;
            border: none;
            background: var(--primary);
            color: white;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .presc-stepper button:hover {
            transform: scale(1.05);
            background: var(--primary-dark);
        }

        .presc-stepper button.danger { background: var(--danger); }
        .presc-stepper button.success { background: var(--success); }

        .presc-field {
            width: 70px;
            text-align: center;
            padding: 0.5rem;
            border: 1px solid var(--light-gray);
            border-radius: 5px;
            font-weight: 600;
            background: white;
        }

        .presc-field.negative { color: var(--danger); }
        .presc-field.positive { color: var(--success); }

        .presc-medidas {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
            padding: 1rem;
            background: linear-gradient(90deg, var(--light) 0%, #f0f0f0 100%);
            border-radius: 8px;
        }

        .medida-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .medida-icon {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white;
        }

        .medida-icon.primary { background: var(--primary); }
        .medida-icon.success { background: var(--success); }

        .medida-content {
            flex: 1;
        }

        .medida-label {
            font-weight: 600;
            color: var(--gray);
            margin-bottom: 0.25rem;
            font-size: 0.85rem;
        }

        .medida-value {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .medida-unit {
            color: var(--gray);
            font-size: 0.85rem;
        }

        /* ===== CLIENTES - NOVO DESIGN ===== */
        .cliente-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .cliente-card h3 {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 1px solid var(--light-gray);
            padding-bottom: 10px;
        }

        /* ===== PRODUTOS - UPLOAD DE IMAGEM ===== */
        .image-preview {
            width: 80px;
            height: 80px;
            border: 2px dashed var(--light-gray);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--light);
            overflow: hidden;
            cursor: pointer;
        }
        .image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }
        .image-preview i {
            font-size: 2rem;
            color: var(--gray);
        }

        /* ===== CREDIÁRIO ===== */
        .resumo-crediario {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            margin: 1.5rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .resumo-item {
            text-align: center;
            flex: 1;
            min-width: 120px;
        }

        .resumo-label {
            font-size: 0.8rem;
            opacity: 0.9;
            margin-bottom: 0.25rem;
        }

        .resumo-valor {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .tabela-parcelas {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .tabela-parcelas th {
            background: var(--primary);
            color: white;
            padding: 1rem;
            text-align: center;
            font-weight: 600;
        }

        .tabela-parcelas td {
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }

        .tabela-parcelas tfoot {
            background: var(--light);
            font-weight: bold;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.35rem 0.75rem;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-pendente { background: rgba(255,193,7,0.15); color: #856404; }
        .status-pago { background: rgba(40,167,69,0.15); color: var(--success); }
        .status-vencido { background: rgba(220,53,69,0.15); color: var(--danger); }

        /* ===== MODAIS ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 1rem;
            backdrop-filter: blur(3px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 1.5rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: modalIn 0.3s;
        }

        @keyframes modalIn {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--light-gray);
        }

        .modal-title {
            font-size: 1.3rem;
            color: var(--primary);
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: var(--gray);
            line-height: 1;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: var(--danger);
        }

        .modal-footer {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }

        /* ===== NOTIFICAÇÕES ===== */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 350px;
        }

        .toast {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: toastIn 0.3s;
            border-left: 4px solid var(--primary);
        }

        .toast-success { border-left-color: var(--success); }
        .toast-error { border-left-color: var(--danger); }
        .toast-warning { border-left-color: var(--warning); }
        .toast-info { border-left-color: var(--info); }

        .toast-icon {
            font-size: 1.2rem;
        }

        .toast-success .toast-icon { color: var(--success); }
        .toast-error .toast-icon { color: var(--danger); }
        .toast-warning .toast-icon { color: var(--warning); }
        .toast-info .toast-icon { color: var(--info); }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .toast-message {
            font-size: 0.9rem;
            color: var(--gray);
        }

        .toast-close {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--gray);
            font-size: 1rem;
            padding: 0.25rem;
        }

        @keyframes toastIn {
            from { opacity: 0; transform: translateX(50px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* ===== INDICADOR AUTO-SAVE ===== */
        .auto-save-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--success);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            font-size: 0.9rem;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            pointer-events: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .auto-save-indicator.show {
            opacity: 1;
        }

        .auto-save-indicator.error {
            background: var(--danger);
        }

        @keyframes pulse-warn {
            0%, 100% { box-shadow: 0 2px 10px rgba(255,193,7,0.3); }
            50%       { box-shadow: 0 2px 20px rgba(255,193,7,0.7); }
        }

        /* ===== BUSCA NO HISTÓRICO DE VENDAS ===== */
        .sales-search-bar {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }
        .sales-search-bar input {
            flex: 1;
            min-width: 200px;
            padding: 0.5rem 0.85rem;
            border: 1.5px solid var(--light-gray);
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }
        .sales-search-bar input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255,107,0,0.12);
        }
        .sales-search-bar select {
            padding: 0.5rem 0.75rem;
            border: 1.5px solid var(--light-gray);
            border-radius: var(--border-radius);
            font-size: 0.85rem;
            background: white;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .sales-search-bar select:focus {
            outline: none;
            border-color: var(--primary);
        }
        .sales-count-badge {
            font-size: 0.8rem;
            color: var(--gray);
            white-space: nowrap;
            padding: 4px 10px;
            background: var(--light);
            border-radius: 20px;
            border: 1px solid var(--light-gray);
        }
        .dark-mode .sales-search-bar input,
        .dark-mode .sales-search-bar select {
            background: #2d2d2d;
            border-color: #444;
            color: #e0e0e0;
        }

        /* ===== FILTRO PERÍODO DASHBOARD ===== */
        .dash-period-bar {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            background: white;
            padding: 0.6rem 1rem;
            border-radius: 12px;
            box-shadow: 0 1px 8px rgba(0,0,0,0.06);
            border: 1px solid rgba(0,0,0,0.05);
        }
        .dash-period-label {
            font-size: 0.72rem;
            color: var(--gray);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-right: 4px;
        }
        .dash-period-btn {
            padding: 5px 13px;
            border-radius: 8px;
            border: none;
            background: transparent;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--gray);
            cursor: pointer;
            transition: all 0.15s;
        }
        .dash-period-btn:hover {
            background: var(--light-gray);
            color: var(--dark);
        }
        .dash-period-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 8px rgba(255,107,0,0.3);
        }
        .dash-period-custom {
            display: none;
            gap: 0.4rem;
            align-items: center;
        }
        .dash-period-custom.show { display: flex; }
        .dash-period-custom input {
            padding: 4px 8px;
            border: 1.5px solid var(--light-gray);
            border-radius: 7px;
            font-size: 0.8rem;
        }
        .dark-mode .dash-period-bar { background: #1a1d27; border-color: rgba(255,255,255,0.07); }
        .dark-mode .dash-period-btn { color: #999; }
        .dark-mode .dash-period-btn:hover { background: rgba(255,255,255,0.08); color: #e0e0e0; }
        .dark-mode .dash-period-btn.active { background: var(--primary); color: white; }
        .dark-mode .dash-period-custom input { background: #2d2d2d; border-color: #444; color: #e0e0e0; }

        /* ===== MODAL WHATSAPP CONFIRMAÇÃO ===== */
        .wpp-confirm-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.55);
            z-index: 10002;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            backdrop-filter: blur(3px);
        }
        .wpp-confirm-modal.show { display: flex; }
        .wpp-confirm-box {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 480px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.25);
            overflow: hidden;
            animation: modalIn 0.25s ease;
        }
        .wpp-confirm-header {
            background: linear-gradient(135deg, #25d366, #128c4e);
            color: white;
            padding: 1.1rem 1.4rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .wpp-confirm-header i { font-size: 1.4rem; }
        .wpp-confirm-header h3 { font-size: 1rem; font-weight: 700; margin: 0; }
        .wpp-confirm-header small { font-size: 0.78rem; opacity: 0.85; display: block; }
        .wpp-confirm-body { padding: 1.2rem 1.4rem; }
        .wpp-confirm-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        .wpp-confirm-info-item {
            background: var(--light);
            border-radius: 8px;
            padding: 0.6rem 0.9rem;
        }
        .wpp-confirm-info-item small {
            display: block;
            font-size: 0.7rem;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.4px;
            margin-bottom: 2px;
        }
        .wpp-confirm-info-item strong { font-size: 0.9rem; color: var(--dark); }
        .wpp-confirm-preview {
            background: #e5ddd5;
            border-radius: 10px;
            padding: 0.9rem;
            max-height: 160px;
            overflow-y: auto;
            margin-bottom: 1rem;
        }
        .wpp-confirm-preview-label {
            font-size: 0.72rem;
            color: #888;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .wpp-confirm-bubble {
            background: white;
            border-radius: 2px 10px 10px 10px;
            padding: 0.65rem 0.85rem;
            font-size: 0.78rem;
            line-height: 1.55;
            white-space: pre-wrap;
            word-break: break-word;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            color: #111;
        }
        .wpp-confirm-footer {
            display: flex;
            gap: 0.75rem;
            padding: 1rem 1.4rem;
            background: var(--light);
            border-top: 1px solid var(--light-gray);
        }
        .dark-mode .wpp-confirm-box { background: #1e1e1e; }
        .dark-mode .wpp-confirm-info-item { background: #2d2d2d; }
        .dark-mode .wpp-confirm-info-item strong { color: #e0e0e0; }
        .dark-mode .wpp-confirm-footer { background: #252525; border-color: #333; }

        /* ===== UTILITÁRIOS ===== */
        .d-none { display: none !important; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-primary { color: var(--primary); }
        .mt-2 { margin-top: 0.5rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mt-3 { margin-top: 1rem; }
        .mb-3 { margin-bottom: 1rem; }
        .mt-4 { margin-top: 2rem; }
        .mb-4 { margin-bottom: 2rem; }
        .w-100 { width: 100%; }
        .justify-between { display: flex; justify-content: space-between; align-items: center; }
        .flex-wrap { flex-wrap: wrap; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 1rem; }

        [data-tooltip] {
            position: relative;
            cursor: help;
        }

        [data-tooltip]:before {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.5rem 1rem;
            background: #333;
            color: white;
            font-size: 0.8rem;
            border-radius: 4px;
            white-space: nowrap;
            display: none;
            z-index: 1000;
            margin-bottom: 0.5rem;
        }

        [data-tooltip]:hover:before {
            display: block;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== SYNC BUTTON ANIMATION ===== */
        #headerSyncBtn.syncing #headerSyncIcon {
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ===== RESPONSIVIDADE ===== */
        @media (max-width: 992px) {
            .sidebar { width: 66px; }
            .sidebar .company-name,
            .sidebar .company-subtitle,
            .sidebar .sidebar-section-label,
            .sidebar .menu-item span,
            .sidebar-footer .theme-toggle span { display: none; }
            .main-content { margin-left: 120px; }
            .menu-item { justify-content: center; padding: 0.7rem; border-radius: 9px; }
            .menu-item i { font-size: 1.05rem; }
            .menu-item.active::before { display: none; }
            .menu-item.active { background: rgba(255,255,255,0.12); }
            .logo-container { justify-content: center; }
            .sidebar-header { padding: 1.1rem 0.6rem; }
            .sidebar-footer { padding: 0.6rem; }
            .theme-toggle { justify-content: center; padding: 0.6rem; }
        }

        @media (max-width: 768px) {
            .menu-toggle {
                display: inline-block;
            }
            
            .sidebar {
                transform: translateX(-100%);
                width: 130px;
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .sidebar .company-name,
            .sidebar .company-subtitle,
            .sidebar .sidebar-section-label,
            .sidebar .menu-item span {
                display: block;
            }
            .sidebar .menu-item span { display: inline; }
            
            .sidebar-footer .theme-toggle span {
                display: inline;
            }
            
            .close-sidebar {
                display: block;
            }
            
            .main-content {
                margin-left: 0;
            }

            .header { flex-direction: column; align-items: flex-start; }
            .header-right { width: 100%; flex-wrap: wrap; }
            .backup-buttons { flex-direction: column; width: 100%; }
            .backup-buttons .btn { width: 100%; }
            .btn-group { flex-direction: column; width: 100%; }
            .btn-group .btn { width: 100%; }
            .payment-methods { grid-template-columns: repeat(2, 1fr); }
            .resumo-crediario { flex-direction: column; }
            .resumo-item { width: 100%; }
        }

        @media (max-width: 576px) {
            .main-content { padding: 0.75rem; }
            .dashboard-cards { grid-template-columns: 1fr; }
            .presc-table { font-size: 0.7rem; }
            .presc-table th,
            .presc-table td { padding: 0.35rem; }
            .presc-field { width: 50px; padding: 0.35rem; }
        }

        /* ===== RECEITUÁRIO — RESPONSIVIDADE MOBILE ===== */

        /* Wrapper de cada tabela de prescrição: scroll horizontal sem quebrar o layout */
        .presc-table-wrapper {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 8px;
            border: 1px solid var(--light-gray);
            margin-bottom: 1rem;
        }

        /* Garantir que a tabela nunca encolha abaixo do mínimo funcional */
        .presc-table-wrapper .presc-table {
            min-width: 480px;
            margin-bottom: 0;
            border: none;
        }

        /* Indicador visual de scroll horizontal em mobile */
        .presc-scroll-hint {
            display: none;
            text-align: right;
            font-size: 0.72rem;
            color: var(--gray);
            margin-bottom: 0.35rem;
            padding-right: 0.25rem;
        }

        @media (max-width: 768px) {
            /* Receituário container: padding reduzido */
            .presc-container {
                padding: 1rem 0.75rem;
            }

            /* Mostrar dica de scroll */
            .presc-scroll-hint {
                display: block;
            }

            /* Profissionais: 1 coluna */
            .presc-profissionais {
                grid-template-columns: 1fr;
            }

            /* Cabeçalho do receituário: empilhado */
            .presc-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }

            .presc-header .btn-pdf {
                width: 100%;
                justify-content: center;
            }

            /* Medidas: 1 coluna em mobile */
            .presc-medidas {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 576px) {
            /* Campos e botões menores dentro das tabelas */
            .presc-field {
                width: 44px !important;
                padding: 0.25rem !important;
                font-size: 0.68rem !important;
            }

            .presc-stepper button {
                width: 22px !important;
                height: 22px !important;
                font-size: 0.8rem !important;
                flex-shrink: 0;
            }

            .presc-stepper {
                gap: 0.15rem !important;
            }

            .presc-table th,
            .presc-table td {
                padding: 0.3rem 0.2rem !important;
                font-size: 0.65rem !important;
            }

            .presc-table-wrapper .presc-table {
                min-width: 420px;
            }

            /* Medida: inputs de DP e Altura */
            .presc-container .medida-value input,
            .presc-container input[style*="width: 80px"] {
                width: 64px !important;
            }
        }

        @media (max-width: 400px) {
            .presc-container {
                padding: 0.75rem 0.5rem;
            }

            .presc-field {
                width: 38px !important;
                font-size: 0.62rem !important;
            }

            .presc-stepper button {
                width: 20px !important;
                height: 20px !important;
                font-size: 0.75rem !important;
            }

            .presc-table-wrapper .presc-table {
                min-width: 380px;
            }
        }

        /* ===== IMPRESSÃO ===== */
        /* ===== @media print — qualidade profissional ===== */
        @media print {
            /* ── Ocultar elementos de UI ── */
            .no-print,
            .sidebar, .header, .header-right,
            .menu-toggle, .btn-group, .modal,
            #pwa-install-banner, #pwa-update-toast, #pwa-offline-bar,
                    .auto-save-indicator, #cloudSyncIndicator,
            .datetime-widget, .theme-toggle { display: none !important; }

            /* ── Layout de impressão ── */
            html, body {
                width: 210mm !important;
                margin: 0 !important;
                padding: 0 !important;
                background: #ffffff !important;
                color: #000000 !important;
                font-size: 10pt !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }

            .main-content {
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
            }

            .section { display: block !important; }

            /* ── Evitar quebras ruins ── */
            table, tr, td, th { page-break-inside: avoid !important; }
            h1, h2, h3, h4 { page-break-after: avoid !important; }
            .os-via, .promissoria, .comprovante-body { page-break-inside: avoid !important; }

            /* ── Garantir cores e bordas impressas ── */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
                text-shadow: none !important;
                box-shadow: none !important;
            }

            /* ── Tabelas e cards ── */
            .card, .form-container, .table-container {
                box-shadow: none !important;
                border: 1px solid #999 !important;
            }

            table {
                border-collapse: collapse !important;
                width: 100% !important;
            }
            th, td {
                border: 1px solid #999 !important;
                padding: 2mm !important;
                font-size: 9pt !important;
            }
            th {
                background-color: #f0f0f0 !important;
                font-weight: bold !important;
                color: #000 !important;
            }

            /* ── Links: mostrar URL ── */
            a[href]:after { content: none !important; }

            /* ── Relatórios ── */
            #reportContainer {
                padding: 0 !important;
                font-size: 9pt !important;
            }
            #reportContainer h3 {
                font-size: 12pt !important;
                margin-bottom: 3mm !important;
                color: #000 !important;
            }
        }

        /* ===== ESTILOS PARA OS NOVOS PDFs — ALTA QUALIDADE ===== */

        /* Diretivas globais de qualidade para todos os documentos PDF/impressão */
        .os-pdf-wrapper,
        .promissoria-pdf,
        .carne-pdf,
        .comprovante-pdf,
        .receituario-pdf,
        .relatorio-pdf {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
            color-adjust: exact !important;
            font-family: Arial, Helvetica, sans-serif !important;
            -webkit-font-smoothing: antialiased !important;
            -moz-osx-font-smoothing: grayscale !important;
            text-rendering: optimizeLegibility !important;
        }

        /* Força opacidade total em todos os textos dos documentos */
        .os-pdf-wrapper *,
        .promissoria-pdf *,
        .carne-pdf *,
        .comprovante-pdf * {
            opacity: 1 !important;
            color: inherit;
        }

        /* Textos escuros e nítidos */
        .os-pdf-wrapper p,
        .os-pdf-wrapper span,
        .os-pdf-wrapper td,
        .os-pdf-wrapper th,
        .os-pdf-wrapper div {
            color: #000000 !important;
        }

        /* Evita anti-aliasing ruim em textos pequenos */
        .os-pdf-wrapper,
        .promissoria-pdf {
            -webkit-text-stroke: 0 !important;
            text-stroke: 0 !important;
        }

        /* ===== OS PDF - DESIGN PROFISSIONAL PREMIUM ===== */
        .os-pdf-wrapper {
            width: 210mm;
            background: white;
            font-family: 'Arial', sans-serif;
            font-size: 8px;
        }
        /* Modo página única (ambas) */
        .os-pdf-wrapper.uma-folha .os-via {
            width: 210mm;
            background: white;
            box-sizing: border-box;
        }
        /* Modo página separada */
        .os-via {
            width: 210mm;
            background: white;
            box-sizing: border-box;
            border: 1px solid #e0e0e0;
        }
        /* Compactar elementos quando ambas as vias estão numa folha */
        .os-pdf-wrapper.uma-folha .os-via-header-bar { min-height: 16mm; }
        .os-pdf-wrapper.uma-folha .os-empresa-nome   { font-size: 14px; }
        .os-pdf-wrapper.uma-folha .os-empresa-sub    { font-size: 8px; font-weight: 600; }
        .os-pdf-wrapper.uma-folha .os-numero-valor   { font-size: 17px; }
        .os-pdf-wrapper.uma-folha .os-logo-area      { width: 15mm; font-size: 17px; }
        .os-pdf-wrapper.uma-folha .os-info-cell      { padding: 1.2mm 2mm; font-size: 9px; }
        .os-pdf-wrapper.uma-folha .os-info-cell-val  { font-size: 9.5px; font-weight: 800; }
        .os-pdf-wrapper.uma-folha .os-info-cell-label{ font-size: 7px; font-weight: 700; }
        .os-pdf-wrapper.uma-folha .os-cliente-body   { padding: 2mm 3mm; }
        .os-pdf-wrapper.uma-folha .os-cliente-nome   { font-size: 13px; margin-bottom: 0.5mm; }
        .os-pdf-wrapper.uma-folha .os-cliente-field  { font-size: 8.5px; font-weight: 600; }
        .os-pdf-wrapper.uma-folha .os-section-title  { padding: 1.2mm 3mm; font-size: 9px; }
        .os-pdf-wrapper.uma-folha .os-receita-table th { padding: 1.2mm 2mm; font-size: 9px; }
        .os-pdf-wrapper.uma-folha .os-receita-table td { padding: 1.2mm 2mm; font-size: 9px; font-weight: 700; }
        .os-pdf-wrapper.uma-folha .os-receita-extra  { padding: 1.8mm 3mm; font-size: 9px; gap: 4mm; }
        .os-pdf-wrapper.uma-folha .os-itens-table th { padding: 1.2mm 2mm; font-size: 9px; }
        .os-pdf-wrapper.uma-folha .os-itens-table td { padding: 1.2mm 2mm; font-size: 9px; font-weight: 600; }
        .os-pdf-wrapper.uma-folha .os-totais-row     { padding: 1.8mm 3mm; font-size: 9px; }
        .os-pdf-wrapper.uma-folha .os-total-final    { font-size: 14px; }
        .os-pdf-wrapper.uma-folha .os-pagamento-cell { padding: 1.8mm 2.5mm; font-size: 9px; }
        .os-pdf-wrapper.uma-folha .os-pagamento-pix  { padding: 1.2mm 3mm; font-size: 8.5px; }
        .os-pdf-wrapper.uma-folha .os-obs-section    { min-height: 8mm; }
        .os-pdf-wrapper.uma-folha .os-obs-body       { padding: 1.8mm 3mm; font-size: 9px; }
        .os-pdf-wrapper.uma-folha .os-assinaturas    { padding: 2.5mm 3mm 2mm; }
        .os-pdf-wrapper.uma-folha .os-assinatura-linha { height: 7mm; }
        .os-pdf-wrapper.uma-folha .os-assinatura-label { font-size: 8.5px; font-weight: 700; }
        .os-pdf-wrapper.uma-folha .os-rodape         { padding: 1.5mm 3mm; font-size: 8px; font-weight: 600; }

        /* ── Cabeçalho da via — barra colorida premium ── */
        .os-via-header-bar {
            display: flex;
            align-items: stretch;
            background: #ff6b00;
            color: white;
            min-height: 20mm;
            position: relative;
        }
        /* Linha decorativa dourada na base do header */
        .os-via-header-bar::after {
            content: '';
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 2px;
            background: linear-gradient(90deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.6) 50%, rgba(255,255,255,0.15) 100%);
        }
        .os-via-header-bar.verde { background: linear-gradient(135deg, #1a7a3e 0%, #0d5a2c 100%); }
        .os-via-header-bar:not(.verde) { background: linear-gradient(135deg, #ff6b00 0%, #cc4a00 100%); }
        .os-logo-area {
            width: 20mm;
            background: rgba(0,0,0,0.18);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2.5mm;
            flex-shrink: 0;
            border-right: 1px solid rgba(255,255,255,0.2);
        }
        .os-logo-circulo {
            width: 15mm;
            height: 15mm;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: 0 0 0 2px rgba(255,255,255,0.5);
            flex-shrink: 0;
        }
        .os-logo-circulo span {
            font-size: 19px;
            line-height: 1;
        }
        /* ===== REGRA GLOBAL: logos circulares preenchendo todo o círculo sem distorção ===== */
        .os-logo-circulo,
        .carne-logo-circulo,
        .comp-logo-circulo,
        .prom-logo-circulo,
        .rec-logo-circulo {
            overflow: hidden !important;
            border-radius: 50% !important;
            background-size: cover !important;
            background-repeat: no-repeat !important;
            background-position: center center !important;
        }
        /* Imagens ocultas — logo renderizada via background-image no container */
        .os-logo-circulo img,
        .carne-logo-circulo img,
        .comp-logo-circulo img,
        .prom-logo-circulo img,
        .rec-logo-circulo img,
        .logo-img {
            display: none !important;
        }
        /* Compacto (uma-folha) */
        .os-pdf-wrapper.uma-folha .os-logo-area { width: 14mm; }
        .os-pdf-wrapper.uma-folha .os-logo-circulo { width: 11mm; height: 11mm; }
        .os-pdf-wrapper.uma-folha .os-logo-circulo span { font-size: 15px; }
        .os-empresa-area {
            flex: 1;
            padding: 3mm 4mm;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 0.5mm;
        }
        /* Linha tênue separando nome da empresa do subtítulo */
        .os-empresa-nome-wrap {
            display: flex;
            align-items: center;
            gap: 3mm;
            padding-bottom: 1mm;
            border-bottom: 1px solid rgba(255,255,255,0.25);
            margin-bottom: 1mm;
        }
        .os-empresa-nome {
            font-size: 15px;
            font-weight: 900;
            letter-spacing: 0.8px;
            text-transform: uppercase;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .os-empresa-badge {
            font-size: 6px;
            font-weight: 700;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.4);
            border-radius: 10px;
            padding: 0.5mm 2mm;
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        .os-empresa-sub {
            font-size: 7.5px;
            opacity: 0.92;
            line-height: 1.4;
        }
        .os-numero-area {
            min-width: 32mm;
            background: rgba(0,0,0,0.22);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2.5mm 3.5mm;
            text-align: center;
            border-left: 1px solid rgba(255,255,255,0.2);
            gap: 0.5mm;
        }
        .os-numero-label { font-size: 6px; letter-spacing: 1.5px; opacity: 0.85; text-transform: uppercase; font-weight: 700; }
        .os-numero-valor { font-size: 20px; font-weight: 900; letter-spacing: 1px; text-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .os-via-label { font-size: 6.5px; opacity: 0.85; margin-top: 0.5mm; font-weight: 700; letter-spacing: 0.5px; background: rgba(255,255,255,0.15); padding: 0.5mm 2mm; border-radius: 8px; }

        /* ── Linha tênue divisória entre seções (impressão nítida) ── */
        .os-divider {
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, #e0e0e0 5%, #e0e0e0 95%, transparent 100%);
        }

        /* Barra de info rápida */
        .os-info-bar {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            font-size: 0;
        }
        .os-info-cell {
            flex: 1;
            padding: 2.2mm 3mm;
            border-right: 1px solid #e4e4e4;
            font-size: 0;
            position: relative;
        }
        /* Linha vertical decorativa entre células */
        .os-info-cell:not(:last-child)::after {
            content: '';
            position: absolute;
            right: 0; top: 20%; bottom: 20%;
            width: 1px;
            background: #d0d0d0;
        }
        .os-info-cell:last-child { border-right: none; }
        .os-info-cell-label {
            font-size: 7.5px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            display: block;
            margin-bottom: 0.5mm;
            font-weight: 800;
        }
        .os-info-cell-val { font-weight: 900; color: #111; font-size: 11px; }

        /* ── Cliente ── */
        .os-cliente-section {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
        }
        .os-cliente-accent {
            width: 2mm;
            background: #ff6b00;
            flex-shrink: 0;
        }
        .os-cliente-accent.verde { background: #1a7a3e; }
        .os-cliente-body { flex: 1; padding: 3mm 4mm; }
        .os-cliente-nome { font-size: 15px; font-weight: 900; color: #111; margin-bottom: 1.5mm; letter-spacing: 0.3px; }
        /* Linha separadora abaixo do nome */
        .os-cliente-nome-sep {
            height: 1px;
            background: linear-gradient(90deg, #e0e0e0 0%, transparent 100%);
            margin-bottom: 1.5mm;
        }
        .os-cliente-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5mm 2mm;
        }
        .os-cliente-field {
            font-size: 8px;
            color: #666;
            padding-bottom: 1mm;
            border-bottom: 1px dotted #e8e8e8;
            font-weight: 700;
        }
        .os-cliente-field span { font-weight: 900; color: #111; display: block; font-size: 9.5px; margin-top: 0.3mm; }

        /* ── Receituário ── */
        .os-receita-section { border-bottom: 2px solid #e0e0e0; }
        .os-section-title {
            font-size: 10px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            padding: 2mm 4mm;
            background: linear-gradient(90deg, #f5f5f5, #fafafa);
            border-bottom: 1.5px solid #d8d8d8;
            color: #333;
            display: flex;
            align-items: center;
            gap: 1.5mm;
        }
        /* Linha colorida à esquerda do título de seção */
        .os-section-title::before {
            content: '';
            display: inline-block;
            width: 2px;
            height: 8px;
            background: var(--cor, #ff6b00);
            border-radius: 1px;
            flex-shrink: 0;
        }
        .os-receita-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 8px;
        }
        .os-receita-table th {
            background: #ff6b00;
            color: white;
            padding: 2mm 3mm;
            text-align: center;
            font-size: 8.5px;
            font-weight: 800;
            letter-spacing: 0.5px;
            border: 1px solid rgba(0,0,0,0.1);
        }
        .os-receita-table.verde th { background: #1a7a3e; }
        .os-receita-table td {
            padding: 2mm 3mm;
            text-align: center;
            border: 1px solid #ececec;
            font-size: 9.5px;
            font-weight: 800;
        }
        .os-receita-table tr:nth-child(odd) td { background: #fafafa; }
        .os-olho-label { font-weight: 800; background: #f0f0f0 !important; color: #333; }
        .os-receita-extra {
            display: flex;
            gap: 5mm;
            padding: 2mm 3.5mm;
            font-size: 8px;
            background: #fffdf5;
            border-top: 1px solid #ede8d5;
        }
        .os-receita-extra-item { color: #666; border-right: 1px dotted #ddd; padding-right: 5mm; }
        .os-receita-extra-item:last-child { border-right: none; }
        .os-receita-extra-item strong { color: #111; display: block; font-size: 8.5px; }

        /* ── Itens ── */
        .os-itens-section { border-bottom: 2px solid #e0e0e0; }
        .os-itens-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 8px;
        }
        .os-itens-table th {
            background: linear-gradient(180deg, #2d6a4f 0%, #1e4d38 100%);
            color: white;
            padding: 2mm 3mm;
            text-align: left;
            font-size: 8.5px;
            font-weight: 800;
            letter-spacing: 0.5px;
            border: 1px solid rgba(0,0,0,0.15);
        }
        .os-itens-table th:nth-child(3),
        .os-itens-table th:nth-child(4),
        .os-itens-table th:nth-child(5) { text-align: right; }
        .os-itens-table td {
            padding: 2mm 3mm;
            border-bottom: 1px solid #eeeeee;
            border-left: 1px solid #f5f5f5;
            font-size: 9px;
            font-weight: 700;
        }
        .os-itens-table td:nth-child(3),
        .os-itens-table td:nth-child(4),
        .os-itens-table td:nth-child(5) { text-align: right; }
        .os-itens-table tr:nth-child(even) td { background: #f9f9f9; }
        .os-itens-table tr:last-child td { border-bottom: none; }

        /* ── Totais ── */
        .os-totais-row {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 5mm;
            padding: 2.5mm 4mm;
            background: linear-gradient(90deg, #f0f0f0, #f8f8f8);
            border-bottom: 2px solid #d8d8d8;
            font-size: 9px;
        }
        .os-totais-item { color: #777; }
        .os-totais-item strong { color: #333; }
        .os-total-final {
            font-size: 17px;
            font-weight: 900;
            color: #1a7a3e;
            border-left: 3px solid #1a7a3e;
            padding-left: 3.5mm;
            margin-left: 2mm;
        }

        /* ── Pagamento ── */
        .os-pagamento-section { border-bottom: 2px solid #e0e0e0; }
        .os-pagamento-grid {
            display: flex;
            font-size: 0;
            background: #fff;
        }
        .os-pagamento-cell {
            flex: 1;
            padding: 3mm 4mm;
            border-right: 1px solid #eeeeee;
            font-size: 9px;
        }
        .os-pagamento-cell:last-child { border-right: none; }
        .os-pagamento-cell-label {
            font-size: 7.5px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 0.8mm;
            font-weight: 800;
        }
        .os-pagamento-cell-val { font-weight: 900; color: #111; font-size: 11px; }
        .os-pagamento-pix {
            background: linear-gradient(90deg, #e8f5fe, #f0f8ff);
            padding: 2mm 3.5mm;
            font-size: 7.5px;
            color: #1565c0;
            border-top: 1.5px dashed #90caf9;
            font-weight: 600;
        }

        /* ── Observações + Assinaturas ── */
        .os-obs-section {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            min-height: 11mm;
        }
        .os-obs-body {
            flex: 1;
            padding: 2.5mm 3.5mm;
            font-size: 8px;
            color: #555;
        }
        .os-obs-label { font-size: 6.5px; color: #aaa; text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 1mm; font-weight: 700; }

        .os-assinaturas {
            display: flex;
            padding: 4mm 5mm 2.5mm;
            gap: 8mm;
            background: #fafafa;
            border-bottom: 1px solid #eeeeee;
        }
        .os-assinatura-box {
            flex: 1;
            text-align: center;
        }
        /* Linha de assinatura com pontos __ estilo formulário */
        .os-assinatura-linha {
            border-bottom: 1.5px solid #333;
            margin-bottom: 1.5mm;
            height: 8mm;
            position: relative;
        }
        /* X pontilhado para sinalizar onde assinar */
        .os-assinatura-linha::before {
            content: '✕';
            position: absolute;
            bottom: 2px;
            left: 2mm;
            font-size: 7px;
            color: #bbb;
        }
        .os-assinatura-label { font-size: 8.5px; color: #555; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }

        /* ── Rodapé ── */
        .os-rodape {
            background: linear-gradient(90deg, #f0f0f0, #f8f8f8);
            padding: 2mm 4mm;
            font-size: 7.5px;
            color: #666;
            text-align: center;
            border-top: 2px solid #d0d0d0;
            line-height: 1.6;
            font-weight: 600;
        }

        /* ── Separador entre vias ── */
        .os-corte {
            display: flex;
            align-items: center;
            gap: 2mm;
            padding: 2mm 3.5mm;
            background: #fff9f5;
            border-top: 2px dashed #ff8c40;
            border-bottom: 2px dashed #ff8c40;
            font-size: 8px;
            color: #cc5200;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        .os-corte-linha { flex: 1; border-top: 1px dashed #ffb380; }

        /* ===== PROMISSÓRIA PDF — DESIGN PROFISSIONAL ===== */
        .promissoria-pdf {
            width: 210mm;
            background: white;
            font-family: Arial, sans-serif;
            color: #1a1a1a;
        }
        .promissoria-pdf .promissoria {
            border: 1px solid #ccc;
            background: white;
            position: relative;
            overflow: hidden;
        }
        .promissoria-pdf .prom-faixa-topo {
            height: 5mm;
            background: linear-gradient(90deg, #ff6b00 0%, #e05500 60%, #c04000 100%);
        }
        .promissoria-pdf .prom-faixa-serie {
            background: #1a1a1a;
            color: #ccc;
            padding: 1.2mm 5mm;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 7px;
            letter-spacing: 0.8px;
        }
        .promissoria-pdf .prom-faixa-serie strong { color: white; font-size: 8px; letter-spacing: 1.5px; }
        .promissoria-pdf .marca-dagua {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%,-50%) rotate(-35deg);
            font-size: 55px; font-weight: 900;
            color: rgba(255,107,0,0.04);
            white-space: nowrap;
            z-index: 0; pointer-events: none;
            letter-spacing: 6px;
        }
        .promissoria-pdf .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 3mm 5mm 2.5mm;
            border-bottom: 1px solid #eee;
            background: #fffdf9;
            position: relative; z-index: 1;
        }
        .prom-logo-circulo {
            width: 14mm; height: 14mm;
            border-radius: 50%;
            overflow: hidden;
            background: white;
            border: 2px solid #ff6b00;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; margin-right: 3mm;
        }
        .prom-logo-circulo span { font-size: 20px; line-height: 1; }
        .promissoria-pdf .empresa-cabecalho { display: flex; align-items: center; flex: 1; }
        .promissoria-pdf .empresa-info { flex: 1; }
        .promissoria-pdf .empresa-nome { font-size: 14px; font-weight: 700; color: #ff6b00; }
        .promissoria-pdf .empresa-subtitulo { font-size: 7px; color: #aaa; margin-bottom: 1mm; }
        .promissoria-pdf .empresa-dados { font-size: 7.5px; color: #555; line-height: 1.55; }
        .promissoria-pdf .numero-promissoria { text-align: right; }
        .promissoria-pdf .numero-label { font-size: 7px; color: #aaa; text-transform: uppercase; letter-spacing: 0.8px; }
        .promissoria-pdf .numero-valor {
            font-size: 15px; font-weight: 900; color: white;
            background: #ff6b00;
            padding: 1.5mm 3.5mm; border-radius: 6px;
            display: inline-block; margin-top: 0.5mm; letter-spacing: 1px;
        }
        .promissoria-pdf .titulo-block {
            background: linear-gradient(90deg, #ff6b00, #e05500);
            color: white; text-align: center;
            padding: 2.5mm 5mm;
            position: relative; z-index: 1;
        }
        .promissoria-pdf .titulo { font-size: 16px; font-weight: 900; text-transform: uppercase; letter-spacing: 4px; }
        .promissoria-pdf .titulo-sub { font-size: 7px; opacity: 0.85; letter-spacing: 1.5px; margin-top: 0.5mm; }
        .promissoria-pdf .corpo { padding: 3.5mm 5mm; position: relative; z-index: 1; }
        .promissoria-pdf .texto {
            font-size: 8.5px; line-height: 1.7;
            text-align: justify; margin-bottom: 3mm; color: #222;
        }
        .promissoria-pdf .destaque { font-weight: 700; color: #c04000; }
        .promissoria-pdf .valor-box {
            background: #fff8f0;
            border: 2px solid #ff6b00;
            border-radius: 6px;
            padding: 2.5mm 4mm;
            margin: 2.5mm 0;
            display: flex; align-items: center; justify-content: space-between; gap: 3mm;
        }
        .promissoria-pdf .valor-box-label { font-size: 7px; color: #aaa; text-transform: uppercase; letter-spacing: 0.8px; }
        .promissoria-pdf .valor-box-num { font-size: 20px; font-weight: 900; color: #ff6b00; }
        .promissoria-pdf .valor-box-extenso { font-size: 8px; color: #555; font-style: italic; margin-top: 1mm; }
        .promissoria-pdf .tabela {
            width: 100%; border-collapse: collapse;
            margin: 2.5mm 0; font-size: 8.5px;
        }
        .promissoria-pdf .tabela thead th {
            background: #1a1a1a; color: white;
            padding: 1.8mm 2.5mm; text-align: center; font-weight: 700; letter-spacing: 0.5px;
        }
        .promissoria-pdf .tabela thead th:first-child { background: #ff6b00; }
        .promissoria-pdf .tabela td { padding: 1.5mm 2.5mm; border: 1px solid #e8e8e8; text-align: center; }
        .promissoria-pdf .tabela tbody tr:nth-child(even) td { background: #fafafa; }
        .promissoria-pdf .tabela tfoot td { background: #ff6b00; color: white; font-weight: 700; border-color: #e05500; }
        .promissoria-pdf .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2.5mm; margin: 2.5mm 0; }
        .promissoria-pdf .info-box {
            border: 1px solid #e8e8e8; padding: 2.5mm; background: #fafafa; border-radius: 4px;
        }
        .promissoria-pdf .info-box h4 {
            color: #ff6b00; font-size: 8px;
            border-bottom: 1px solid #ffd4b3; padding-bottom: 1mm; margin-bottom: 1.5mm;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .promissoria-pdf .info-box p { font-size: 7.5px; margin: 0.8mm 0; color: #444; }
        .promissoria-pdf .juros-box {
            background: #fffbee;
            border: 1px solid #ffd700; border-left: 4px solid #f0a000;
            padding: 2mm 3mm; margin: 2.5mm 0;
            font-size: 7.5px; line-height: 1.6; border-radius: 0 4px 4px 0;
        }
        .promissoria-pdf .pix-box {
            background: #f0fdf8;
            border: 1px solid #1abc9c;
            padding: 1.8mm 3mm; text-align: center;
            font-size: 8.5px; border-radius: 4px; margin: 2mm 0;
        }
        .promissoria-pdf .clausula {
            font-size: 7.5px; font-style: italic;
            background: #fef5f5;
            border: 1px solid #f5c6cb; border-left: 4px solid #dc3545;
            padding: 2mm 3mm; margin: 2.5mm 0; line-height: 1.6; border-radius: 0 4px 4px 0;
        }
        .promissoria-pdf .separador {
            border: none; border-top: 1px dashed #ccc; margin: 3mm 0;
        }
        .promissoria-pdf .local-data { text-align: right; margin: 2mm 0; font-size: 8.5px; color: #444; }
        .promissoria-pdf .assinaturas { display: flex; justify-content: space-between; margin: 5mm 0 2mm; gap: 5mm; }
        .promissoria-pdf .assinatura-box { flex: 1; text-align: center; }
        .promissoria-pdf .linha-assinatura { border-top: 1px solid #333; height: 11mm; margin-bottom: 1.5mm; }
        .promissoria-pdf .assinatura-nome { font-size: 8.5px; font-weight: 700; color: #222; }
        .promissoria-pdf .assinatura-info { font-size: 7.5px; color: #666; margin: 0.3mm 0; }
        .promissoria-pdf .assinatura-role { font-size: 7px; color: #aaa; font-style: italic; margin-top: 0.5mm; }
        .promissoria-pdf .testemunhas-block {
            background: #f9f9f9; border: 1px solid #e8e8e8;
            padding: 2.5mm 3mm; margin: 2mm 0; border-radius: 4px;
        }
        .promissoria-pdf .testemunhas-titulo { font-size: 7.5px; font-weight: 700; color: #555; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2mm; }
        .promissoria-pdf .testemunhas { display: flex; justify-content: space-between; gap: 4mm; }
        .promissoria-pdf .testemunha { flex: 1; }
        .promissoria-pdf .linha-testemunha { border-bottom: 1px solid #333; height: 6mm; margin: 1mm 0; }
        .promissoria-pdf .testemunha p { font-size: 7.5px; color: #555; margin: 0.3mm 0; }
        .promissoria-pdf .rodape {
            background: #1a1a1a; color: #bbb;
            text-align: center; font-size: 7px;
            padding: 2mm 5mm; line-height: 1.7;
        }
        .promissoria-pdf .prom-faixa-base {
            height: 2.5mm;
            background: linear-gradient(90deg, #ff6b00, #e05500);
        }

        /* ===== CARNÊ PDF - DESIGN PROFISSIONAL PREMIUM ===== */
        .carne-pdf-wrapper {
            width: 210mm;
            background: white;
            font-family: Arial, sans-serif;
        }
        /* Faixa decorativa topo do carnê */
        .carne-faixa-topo {
            height: 2.5mm;
            background: linear-gradient(90deg, #ff6b00 0%, #ff9040 50%, #ff6b00 100%);
        }
        .carne-header-geral {
            background: linear-gradient(135deg, #ff6b00 0%, #cc4a00 100%);
            color: white;
            padding: 3.5mm 5mm;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid rgba(0,0,0,0.15);
        }
        /* Área logo + nome empresa */
        .carne-header-logo-wrap {
            display: flex;
            align-items: center;
            gap: 3mm;
        }
        .carne-header-logo-circulo {
            width: 13mm;
            height: 13mm;
            border-radius: 50%;
            background: rgba(255,255,255,0.15);
            border: 2px solid rgba(255,255,255,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            flex-shrink: 0;
            background-size: cover;
            background-position: center;
        }
        .carne-header-logo-circulo span { font-size: 17px; line-height: 1; }
        .carne-empresa-nome { font-size: 17px; font-weight: 900; text-transform: uppercase; text-shadow: 0 1px 2px rgba(0,0,0,0.2); letter-spacing: 0.5px; }
        .carne-empresa-info { font-size: 8.5px; opacity: 0.92; margin-top: 1mm; font-weight: 700; line-height: 1.5; }
        .carne-header-os {
            text-align: right;
            background: rgba(0,0,0,0.2);
            padding: 2mm 3.5mm;
            border-radius: 4px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .carne-header-os-label { font-size: 8px; opacity: 0.88; text-transform: uppercase; letter-spacing: 1.2px; font-weight: 800; }
        .carne-header-os-num { font-size: 24px; font-weight: 900; text-shadow: 0 1px 3px rgba(0,0,0,0.3); }

        /* Barra de info do cliente no cabeçalho */
        .carne-cliente-bar {
            background: #fff8f2;
            border-bottom: 2px solid #ff6b00;
            border-top: 1px solid #ffe0cc;
            padding: 2.5mm 5mm;
            display: flex;
            gap: 8mm;
            flex-wrap: wrap;
            font-size: 9px;
            font-weight: 600;
        }
        .carne-cliente-item { color: #666; border-right: 1px dotted #ddd; padding-right: 8mm; font-size: 8.5px; font-weight: 600; }
        .carne-cliente-item:last-child { border-right: none; }
        .carne-cliente-item strong { color: #111; display: block; font-size: 11px; font-weight: 900; margin-top: 0.3mm; }

        /* ===== CARNÊ TALÃO — 5 parcelas por página A4 ===== */
        .carne-talao-page {
            width: 210mm;
            background: white;
            box-sizing: border-box;
            page-break-after: always;
        }
        .carne-talao-page:last-child { page-break-after: avoid; }

        /* Cada parcela ocupa ~50mm de altura */
        .carne-parcela {
            width: 210mm;
            box-sizing: border-box;
            border-top: 1px solid #e0e0e0;
            display: flex;
            height: 50mm;
            overflow: hidden;
            page-break-inside: avoid;
        }
        .carne-parcela:last-child { border-bottom: 1px solid #e0e0e0; }

        /* Faixa lateral colorida com número */
        .carne-lateral {
            width: 13mm;
            background: linear-gradient(180deg, #ff6b00 0%, #cc4a00 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            color: white;
            gap: 1mm;
            border-right: 1px solid rgba(0,0,0,0.1);
        }
        .carne-lateral-num {
            font-size: 22px;
            font-weight: 900;
            line-height: 1;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        .carne-lateral-label {
            font-size: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.85;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            transform: rotate(180deg);
            font-weight: 700;
        }

        /* CANHOTO (recibo da empresa) */
        .carne-canhoto {
            width: 50mm;
            background: #fafafa;
            border-right: 2px dashed #bbb;
            padding: 2.5mm 3mm;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            box-sizing: border-box;
        }
        .carne-canhoto-title {
            font-size: 7.5px;
            font-weight: 800;
            text-transform: uppercase;
            color: #ff6b00;
            letter-spacing: 0.8px;
            padding-bottom: 1mm;
            border-bottom: 1.5px solid #e8e8e8;
            margin-bottom: 1.5mm;
        }
        .carne-canhoto-row {
            display: flex;
            justify-content: space-between;
            font-size: 7.5px;
            color: #666;
            padding: 0.7mm 0;
            border-bottom: 1px dotted #e4e4e4;
        }
        .carne-canhoto-row span:last-child { font-weight: 800; color: #111; }
        .carne-canhoto-assin {
            margin-top: auto;
            border-top: 1.5px solid #555;
            padding-top: 1mm;
            font-size: 7px;
            text-align: center;
            color: #555;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Logo circular no carnê */
        .carne-logo-circulo {
            width: 10mm;
            height: 10mm;
            border-radius: 50%;
            background: white;
            border: 1.5px solid #ff6b00;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            flex-shrink: 0;
            background-size: cover;
            background-position: center;
        }
        .carne-logo-circulo span { font-size: 14px; line-height: 1; }

        /* Contatos extras (whatsapp/site) no dados da parcela */
        .carne-contatos {
            display: flex;
            gap: 2.5mm;
            align-items: center;
            font-size: 7.5px;
            color: #1565c0;
            padding: 1mm 0;
            border-top: 1px dotted #dde;
            margin-top: 0.5mm;
        }
        .carne-contatos-item { display: flex; align-items: center; gap: 0.5mm; }
        .carne-contatos-item span { color: #222; font-weight: 700; }

        /* DADOS PRINCIPAIS */
        .carne-dados {
            flex: 1;
            padding: 2.5mm 3.5mm;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }
        .carne-dados-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5mm;
            padding-bottom: 1.5mm;
            border-bottom: 1.5px solid #eeeeee;
        }
        .carne-logo-circulo.compacto { width: 9mm; height: 9mm; }
        .carne-dados-contato { font-size: 8px; color: #1565c0; margin-top: 0.3mm; font-weight: 700; }
        .carne-dados-empresa { font-size: 11.5px; font-weight: 900; color: #111; }
        .carne-dados-os { font-size: 8.5px; color: #777; font-weight: 700; }
        .carne-dados-venc {
            text-align: right;
        }
        .carne-dados-venc-label { font-size: 7.5px; color: #888; text-transform: uppercase; font-weight: 800; letter-spacing: 0.5px; }
        .carne-dados-venc-date { font-size: 14px; font-weight: 900; color: #c0392b; }

        .carne-dados-meio {
            display: flex;
            gap: 3mm;
            flex: 1;
            align-items: stretch;
        }
        .carne-dados-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.8mm;
        }
        .carne-dados-row {
            display: flex;
            justify-content: space-between;
            font-size: 8.5px;
            color: #555;
            font-weight: 700;
            padding-bottom: 0.6mm;
            border-bottom: 1px dotted #e8e8e8;
        }
        .carne-dados-row span:last-child { font-weight: 900; color: #111; }

        /* Caixa de valor destaque */
        .carne-valor-box {
            background: linear-gradient(135deg, #fff5ee, #ffeedd);
            border: 2px solid #ff6b00;
            border-radius: 4px;
            text-align: center;
            padding: 2mm 3mm;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 38mm;
            flex-shrink: 0;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.8);
        }
        .carne-valor-label { font-size: 8px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5mm; font-weight: 800; }
        .carne-valor-num   { font-size: 20px; font-weight: 900; color: #ff6b00; line-height: 1; text-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .carne-valor-extenso { font-size: 7.5px; color: #aaa; margin-top: 0.5mm; font-style: italic; }
        .carne-valor-venc  { font-size: 9px; font-weight: 900; color: #c0392b; margin-top: 1mm; }

        /* Rodapé da parcela */
        .carne-dados-rodape {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
            padding-top: 1mm;
            border-top: 1px solid #eeeeee;
            font-size: 7px;
            font-weight: 700;
        }
        .carne-pix-inline { color: #1565c0; }
        .carne-multa-info  { color: #c0392b; }

        /* Linha de corte entre parcelas */
        .carne-parcela-sep {
            display: flex;
            align-items: center;
            gap: 1mm;
            padding: 0 13mm;
            height: 3mm;
            background: white;
        }
        .carne-parcela-sep-linha { flex: 1; border-top: 1px dashed #ccc; }
        .carne-parcela-sep-txt { font-size: 5px; color: #ccc; white-space: nowrap; }

        /* Totalizador */
        .carne-totalizador {
            background: linear-gradient(135deg, #ff6b00 0%, #cc4a00 100%);
            color: white;
            padding: 3mm 5mm;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 2px solid rgba(0,0,0,0.1);
        }
        .carne-totalizador-item { text-align: center; }
        .carne-totalizador-label { font-size: 7px; opacity: 0.88; text-transform: uppercase; letter-spacing: 0.8px; display: block; margin-bottom: 0.5mm; font-weight: 700; }
        .carne-totalizador-val   { font-size: 14px; font-weight: 900; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }

        /* ===== COMPROVANTE — cupom 80mm, 1 via, tamanho real ===== */
        .comprovante-wrapper {
            width: 80mm;
            background: white;
            font-family: Arial, sans-serif;
            box-sizing: border-box;
        }
        /* Faixa de topo colorida */
        .comp-topo {
            background: #ff6b00;
            color: white;
            padding: 3mm 3mm 2mm;
            text-align: center;
        }
        .comp-logo-circulo {
            width: 14mm;
            height: 14mm;
            border-radius: 50%;
            background: white;
            border: 2px solid rgba(255,255,255,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin: 0 auto 1.5mm;
        }
        .comp-logo-circulo span { font-size: 18px; line-height: 1; }
        .comp-empresa-nome {
            font-size: 11px;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .comp-empresa-sub {
            font-size: 6px;
            opacity: 0.9;
            margin-top: 0.5mm;
        }
        /* Faixa título */
        .comp-titulo {
            background: #222;
            color: white;
            text-align: center;
            font-size: 9px;
            font-weight: 800;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            padding: 1.5mm;
        }
        /* Corpo */
        .comp-body { padding: 2.5mm 3mm; }
        /* Grid info 2 colunas */
        .comp-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            border: 1px solid #eee;
            border-radius: 3px;
            overflow: hidden;
            margin: 2mm 0;
        }
        .comp-cell {
            padding: 1.5mm 2mm;
            border-right: 1px solid #eee;
            border-bottom: 1px solid #eee;
        }
        .comp-cell:nth-child(even) { border-right: none; }
        .comp-cell:nth-last-child(-n+2) { border-bottom: none; }
        .comp-cell-label {
            font-size: 6px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.3mm;
        }
        .comp-cell-val { font-size: 9px; font-weight: 700; color: #222; }
        /* Cliente */
        .comp-cliente {
            background: #f8f8f8;
            border-left: 3px solid #ff6b00;
            padding: 1.5mm 2mm;
            margin: 2mm 0;
            border-radius: 0 3px 3px 0;
        }
        .comp-cliente-label { font-size: 6px; color: #999; text-transform: uppercase; margin-bottom: 0.3mm; }
        .comp-cliente-nome  { font-size: 10px; font-weight: 800; color: #222; }
        .comp-cliente-cpf   { font-size: 7px; color: #666; margin-top: 0.3mm; }
        /* Valor pago */
        .comp-valor-box {
            background: linear-gradient(135deg, #fff5ee, #ffeedd);
            border: 2px solid #ff6b00;
            border-radius: 5px;
            text-align: center;
            padding: 2.5mm 3mm;
            margin: 2mm 0;
        }
        .comp-valor-label   { font-size: 7px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5mm; }
        .comp-valor-num     { font-size: 22px; font-weight: 900; color: #ff6b00; line-height: 1; }
        .comp-valor-extenso { font-size: 6.5px; color: #aaa; margin-top: 0.8mm; font-style: italic; }
        /* Tabela multa */
        .comp-multa {
            width: 100%;
            border-collapse: collapse;
            font-size: 8px;
            margin: 1.5mm 0;
        }
        .comp-multa td { padding: 1.2mm; border: 1px solid #eee; }
        .comp-multa td:first-child { background: #f5f5f5; font-weight: 700; color: #555; }
        .comp-multa td:last-child  { text-align: right; font-weight: 700; }
        .comp-multa tr:last-child td { background: #fff3e0; color: #e65100; font-weight: 800; }
        /* Status */
        .comp-status {
            background: #1a7a3e;
            color: white;
            text-align: center;
            padding: 2mm;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 900;
            letter-spacing: 0.5px;
            margin: 2mm 0;
        }
        /* Info pagamento */
        .comp-info-pag {
            font-size: 7.5px;
            color: #555;
            display: flex;
            flex-direction: column;
            gap: 0.8mm;
            margin: 1.5mm 0;
        }
        .comp-info-pag div { display: flex; justify-content: space-between; border-bottom: 1px dotted #eee; padding-bottom: 0.5mm; }
        .comp-info-pag span:last-child { font-weight: 700; color: #222; }
        /* Assinatura */
        .comp-assinatura {
            border-top: 1px solid #333;
            margin-top: 4mm;
            padding-top: 1mm;
            text-align: center;
            font-size: 7px;
            color: #555;
        }
        /* Rodapé */
        .comp-rodape {
            background: #f5f5f5;
            border-top: 1px dashed #ddd;
            padding: 2mm 3mm;
            text-align: center;
            font-size: 6px;
            color: #888;
            line-height: 1.5;
        }
        .comp-rodape strong { color: #ff6b00; }

        /* RECEITUÁRIO PDF */
        /* ===== RECEITUÁRIO PDF — DESIGN PROFISSIONAL ===== */
        .receituario-pdf {
            width: 210mm;
            background: white;
            font-family: Arial, sans-serif;
            color: #1a1a1a;
        }
        /* Faixa topo */
        .receituario-pdf .rec-faixa-topo { height: 4mm; background: linear-gradient(90deg,#ff6b00,#e05500); }
        /* Cabeçalho */
        .receituario-pdf .header {
            background: white;
            padding: 4mm 6mm 3mm;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid #ff6b00;
        }
        .receituario-pdf .header-logo { display: flex; align-items: center; gap: 3mm; }
        .receituario-pdf .rec-logo-circulo {
            width: 16mm; height: 16mm; border-radius: 50%;
            overflow: hidden; border: 2px solid #ff6b00;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0; background: white;
        }
        .receituario-pdf .rec-logo-circulo span { font-size: 22px; }
        .receituario-pdf .header-empresa-nome { font-size: 16px; font-weight: 700; color: #ff6b00; }
        .receituario-pdf .header-empresa-sub { font-size: 7.5px; color: #aaa; letter-spacing: 0.5px; margin-bottom: 1mm; }
        .receituario-pdf .header-empresa-info { font-size: 8px; color: #555; line-height: 1.55; }
        .receituario-pdf .header-right { text-align: right; }
        .receituario-pdf .header-doc-label { font-size: 7px; color: #aaa; text-transform: uppercase; letter-spacing: 1px; }
        .receituario-pdf .header-doc-title { font-size: 20px; font-weight: 900; color: #ff6b00; letter-spacing: 2px; line-height: 1.1; }
        .receituario-pdf .header-doc-sub { font-size: 7.5px; color: #888; }
        /* Faixa paciente */
        .receituario-pdf .faixa-paciente {
            background: linear-gradient(90deg,#ff6b00,#e05500);
            color: white; padding: 1.8mm 6mm;
            display: flex; justify-content: space-between; align-items: center;
            font-size: 7px; letter-spacing: 0.5px;
        }
        .receituario-pdf .faixa-paciente strong { font-size: 9px; letter-spacing: 0; }
        /* Dados paciente e profissional */
        .receituario-pdf .dados-bloco {
            padding: 3mm 6mm;
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 2mm; background: #fafafa;
            border-bottom: 1px solid #eee;
        }
        .receituario-pdf .dado-item { }
        .receituario-pdf .dado-label { font-size: 7px; color: #aaa; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5mm; }
        .receituario-pdf .dado-valor { font-size: 9.5px; font-weight: 700; color: #1a1a1a; }
        /* Corpo */
        .receituario-pdf .corpo { padding: 3mm 6mm; }
        /* Título de seção */
        .receituario-pdf .secao-titulo {
            background: linear-gradient(90deg,#ff6b00,#e05500);
            color: white; padding: 1.5mm 3mm;
            font-size: 10px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 1px;
            border-radius: 3px; margin-bottom: 0;
        }
        .receituario-pdf .secao-titulo.verde { background: linear-gradient(90deg,#28a745,#1e7e34); }
        .receituario-pdf .secao-titulo.azul { background: linear-gradient(90deg,#007bff,#0056b3); }
        .receituario-pdf .secao-titulo.roxo { background: linear-gradient(90deg,#6f42c1,#5a2d91); }
        /* Tabela de prescrição */
        .receituario-pdf table { width: 100%; border-collapse: collapse; font-size: 9px; margin-bottom: 3mm; }
        .receituario-pdf th {
            background: #1a1a1a; color: white;
            padding: 2mm 2.5mm; text-align: center;
            font-weight: 700; letter-spacing: 0.3px;
        }
        .receituario-pdf th:first-child { background: #ff6b00; }
        .receituario-pdf .tabela-verde th { background: #28a745; }
        .receituario-pdf .tabela-verde th:first-child { background: #1e7e34; }
        .receituario-pdf td { padding: 2mm 2.5mm; text-align: center; border: 1px solid #e8e8e8; font-weight: 700; font-size: 10px; }
        .receituario-pdf .olho-label { background: #f5f5f5; font-size: 9px; font-weight: 700; color: #555; }
        .receituario-pdf tbody tr:nth-child(even) td { background: #fafafa; }
        /* Medidas */
        .receituario-pdf .medidas-grid {
            display: grid; grid-template-columns: repeat(4,1fr);
            gap: 2mm; margin: 2mm 0 3mm;
        }
        .receituario-pdf .medida-card {
            background: #fff8f0; border: 1.5px solid #ffd4b3;
            border-radius: 5px; padding: 2mm;
            text-align: center;
        }
        .receituario-pdf .medida-label { font-size: 7px; color: #888; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 1mm; }
        .receituario-pdf .medida-valor { font-size: 15px; font-weight: 900; color: #ff6b00; }
        .receituario-pdf .medida-unidade { font-size: 8px; color: #aaa; font-weight: 400; }
        /* Seção adaptação lentes */
        .receituario-pdf .adaptacao-grid {
            display: grid; grid-template-columns: 1fr 1fr 1fr;
            gap: 2mm; margin: 2mm 0 3mm;
        }
        .receituario-pdf .adaptacao-item {
            border: 1px solid #e8e8e8; border-radius: 4px;
            padding: 2mm 2.5mm; background: #fafafa;
        }
        .receituario-pdf .adaptacao-label { font-size: 7px; color: #aaa; text-transform: uppercase; letter-spacing: 0.4px; margin-bottom: 1mm; }
        .receituario-pdf .adaptacao-valor { font-size: 9px; font-weight: 700; color: #1a1a1a; min-height: 4mm; }
        .receituario-pdf .adaptacao-linha { border-bottom: 1px solid #ccc; height: 4mm; }
        /* Observações */
        .receituario-pdf .observacoes {
            background: #fffbee; border: 1px solid #ffd700;
            border-left: 4px solid #f0a000;
            padding: 2mm 3mm; margin: 2mm 0 3mm;
            font-size: 8.5px; border-radius: 0 4px 4px 0; line-height: 1.6;
        }
        .receituario-pdf .obs-titulo { font-size: 7.5px; font-weight: 700; color: #b07000; text-transform: uppercase; margin-bottom: 1mm; }
        /* Validade */
        .receituario-pdf .validade-box {
            background: #f0fdf4; border: 1px solid #86efac;
            border-radius: 4px; padding: 2mm 3mm;
            font-size: 8px; color: #166534; margin-bottom: 3mm;
            display: flex; align-items: center; gap: 2mm;
        }
        /* Assinatura */
        .receituario-pdf .assinatura-bloco { text-align: center; margin: 4mm 0 2mm; }
        .receituario-pdf .linha-assinatura { display: inline-block; width: 75mm; border-top: 1px solid #333; margin: 3mm auto 1.5mm; }
        .receituario-pdf .assinatura-nome { font-size: 9.5px; font-weight: 700; color: #1a1a1a; }
        .receituario-pdf .assinatura-info { font-size: 8px; color: #666; margin: 0.5mm 0; }
        .receituario-pdf .assinatura-role { font-size: 7.5px; color: #aaa; font-style: italic; }
        /* Rodapé */
        .receituario-pdf .rodape {
            background: #1a1a1a; color: #bbb;
            text-align: center; font-size: 7px;
            padding: 2mm 6mm; line-height: 1.7;
        }
        .receituario-pdf .rec-faixa-base { height: 2.5mm; background: linear-gradient(90deg,#ff6b00,#e05500); }
    
        
        /* ============================================
           🎨 ESTILOS MELHORADOS - VERSÃO 2.0
           ============================================ */
        
        /* Loading Global */
        #global-loader {
            backdrop-filter: blur(5px);
        }
        
        /* Melhor contraste em modo escuro */
        .dark-mode input:focus,
        .dark-mode select:focus,
        .dark-mode textarea:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }
        
        /* Animações suaves */
        * {
            scroll-behavior: smooth;
        }
        
        /* Foco visível para acessibilidade */
        *:focus-visible {
            outline: 3px solid var(--primary);
            outline-offset: 2px;
        }
        
        /* Botões com estados melhorados */
        .btn {
            position: relative;
            overflow: hidden;
        }
        

    

        /* ===== SYNC STATUS PANEL ===== */
        .sync-status-panel {
            background: #1e1e2e;
            color: #cdd6f4;
            border-radius: 14px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .sync-status-panel h4 { color: #89b4fa; font-size: 1rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        .sync-row { display: flex; justify-content: space-between; padding: 0.35rem 0; font-size: 0.85rem; border-bottom: 1px solid rgba(255,255,255,0.06); }
        .sync-label { color: #a6adc8; }
        .sync-ok { color: #a6e3a1; font-weight: 600; }
        .sync-off { color: #f38ba8; font-weight: 600; }
        .sync-actions { display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap; }
        .conta-item { background: white; border-radius: 10px; padding: 0.85rem 1rem; margin-bottom: 0.5rem; border-left: 4px solid var(--success); display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; box-shadow: 0 1px 4px rgba(0,0,0,0.06); flex-wrap: wrap; }
        .conta-item.pagar { border-left-color: var(--danger); }
        .conta-item.vencida { border-left-color: var(--warning); background: #fffbf0; }
        .conta-item.paga { opacity: 0.65; background: #f0fff4; border-left-color: #aaa; }
        .conta-item-info { flex: 1; min-width: 0; }
        .conta-item-nome { font-weight: 600; font-size: 0.88rem; color: var(--dark); }
        .conta-item-det { font-size: 0.76rem; color: var(--gray); margin-top: 2px; }
        .conta-item-valor { font-weight: 700; font-size: 0.95rem; color: var(--success); white-space: nowrap; }
        .conta-item.pagar .conta-item-valor { color: var(--danger); }
        .conta-item-actions { display: flex; gap: 0.4rem; flex-shrink: 0; }
        .dark-mode .conta-item { background: #1a1d27; }
        .dark-mode .conta-item.vencida { background: #2a2510; }
        .dark-mode .conta-item.paga { background: #1a2a1a; }
</style>

<!-- Estilos de qualidade extra para documentos PDF e impressão -->
<style id="pdf-quality-styles">
  /* Garante que documentos renderizados via html2canvas sejam nítidos */
  .os-pdf-wrapper,
  .promissoria-pdf,
  .carne-pdf {
    font-size: 8pt;
    line-height: 1.3;
  }

  /* Textos escuros garantidos — evita "apagado" no PDF */
  .os-info-cell-label { color: #444 !important; font-weight: 600 !important; }
  .os-info-cell-val   { color: #000 !important; font-weight: 700 !important; }
  .os-cliente-nome    { color: #000 !important; font-weight: 800 !important; }
  .os-cliente-field   { color: #222 !important; }
  .os-section-title   { color: #fff !important; font-weight: 700 !important; }
  .os-receita-table th{ color: #fff !important; font-weight: 700 !important; }
  .os-receita-table td{ color: #000 !important; font-weight: 600 !important; }
  .os-itens-table th  { color: #fff !important; }
  .os-itens-table td  { color: #000 !important; }
  .os-total-final     { color: #000 !important; font-weight: 900 !important; }
  .os-empresa-nome    { color: #fff !important; font-weight: 900 !important; letter-spacing: 0.3px; }
  .os-numero-valor    { color: #fff !important; font-weight: 900 !important; }
  .os-rodape          { color: #555 !important; }

  /* Promissória */
  .promissoria-pdf .titulo        { color: #fff !important; font-weight: 900 !important; }
  .promissoria-pdf .numero-valor  { color: #000 !important; font-weight: 900 !important; }
  .promissoria-pdf .campo-valor   { color: #000 !important; font-weight: 700 !important; }
  .promissoria-pdf .campo-label   { color: #555 !important; font-weight: 600 !important; }

  /* Comprovante */
  .comprovante-body               { color: #000 !important; }
  .comprovante-body strong        { font-weight: 800 !important; }

  /* Receituário */
  .presc-container label          { color: #333 !important; font-weight: 600 !important; }
  .presc-container .presc-field   { color: #000 !important; font-weight: 700 !important; background: #fff !important; }
</style>

<!-- ═══════════════════════════════════════════════════════
     🎨 ÓTICA VISION PRO — UPGRADE VISUAL PROFISSIONAL v4.0
     Laranja #ff6b00 · Âmbar #ffaa00 · Ouro #ffcc00
     Zero alterações em JavaScript
═══════════════════════════════════════════════════════ -->
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
/* ── VARIÁVEIS ── */
:root {
    --orange-1: #ff6b00;
    --orange-2: #e85500;
    --amber-1: #ffaa00;
    --gold: #ffcc00;
    --grad-primary: linear-gradient(135deg, #ff6b00 0%, #ffaa00 100%);
    --grad-primary-h: linear-gradient(135deg, #e85500 0%, #ff8c00 100%);
    --grad-gold: linear-gradient(135deg, #ffaa00 0%, #ffcc00 100%);
    --shadow-card: 0 2px 16px rgba(0,0,0,0.08);
    --shadow-card-hover: 0 8px 32px rgba(255,107,0,0.18);
    --shadow-orange: 0 4px 20px rgba(255,107,0,0.25);
    --radius-lg: 16px;
    --radius-xl: 20px;
}

/* ── TIPOGRAFIA — protege Font Awesome ── */
body, input, select, textarea, button,
h1,h2,h3,h4,h5,h6,p,a,label,
td,th,.btn,.form-control,.badge,.toast,
.menu-item span, .card-title, .card-value,
.section-title, .modal-title, .chart-title {
    font-family: 'Outfit', 'Inter', -apple-system, sans-serif !important;
}

body {
    background: #f5f3ef !important;
    background-image:
        radial-gradient(ellipse at 10% 20%, rgba(255,107,0,0.04) 0%, transparent 50%),
        radial-gradient(ellipse at 90% 80%, rgba(255,204,0,0.04) 0%, transparent 50%) !important;
}

/* ══════════════════════════════════════
   SIDEBAR — LARANJA
══════════════════════════════════════ */
.sidebar {
    background: linear-gradient(180deg, #ff6b00 0%, #cc4400 100%) !important;
    border-right: none !important;
    box-shadow: 4px 0 32px rgba(0,0,0,0.2) !important;
}
.sidebar-header {
    background: linear-gradient(180deg, rgba(255,255,255,0.12) 0%, transparent 100%) !important;
    border-bottom: 1px solid rgba(255,255,255,0.15) !important;
}
.logo-placeholder {
    background: rgba(255,255,255,0.25) !important;
    border: 2px solid rgba(255,255,255,0.5) !important;
    box-shadow: 0 0 20px rgba(0,0,0,0.15) !important;
}
.logo-placeholder:hover {
    transform: scale(1.08) !important;
    background: rgba(255,255,255,0.35) !important;
}
.company-name {
    font-weight: 800 !important;
    color: white !important;
    text-shadow: 0 1px 4px rgba(0,0,0,0.2) !important;
}
.sidebar-section-label {
    color: rgba(255,255,200,0.6) !important;
    font-weight: 700 !important;
    letter-spacing: 2px !important;
}
.menu-item {
    color: rgba(255,255,255,0.75) !important;
    border-radius: 10px !important;
    transition: all 0.2s ease !important;
}
.menu-item:hover {
    background: rgba(255,255,255,0.18) !important;
    color: white !important;
    transform: translateX(2px) !important;
}
.menu-item.active {
    background: rgba(255,255,255,0.25) !important;
    color: white !important;
    border-left: 3px solid rgba(255,255,255,0.9) !important;
}
.menu-item.active i { color: #fff8e0 !important; }
.menu-item:hover i  { color: white !important; }
.menu-item.active::before { display: none !important; }
.sidebar-footer {
    border-top: 1px solid rgba(255,255,255,0.15) !important;
}
.theme-toggle {
    background: rgba(255,255,255,0.1) !important;
    border: 1px solid rgba(255,255,255,0.2) !important;
    color: rgba(255,255,255,0.85) !important;
    border-radius: 10px !important;
}
.theme-toggle:hover {
    background: rgba(255,255,255,0.22) !important;
    color: white !important;
}

/* ── DARK MODE SIDEBAR ── */
.dark-mode .sidebar {
    background: linear-gradient(180deg, #cc4400 0%, #7a2800 100%) !important;
}

/* ══════════════════════════════════════
   HEADER
══════════════════════════════════════ */
.header {
    border-bottom: 1px solid rgba(255,107,0,0.12) !important;
    margin-bottom: 2rem !important;
}
.header-left h1 {
    font-weight: 900 !important;
    background: linear-gradient(135deg, #ff6b00, #ffaa00) !important;
    -webkit-background-clip: text !important;
    -webkit-text-fill-color: transparent !important;
    background-clip: text !important;
}
.datetime-widget {
    background: white !important;
    border: 1px solid rgba(255,107,0,0.15) !important;
    border-radius: 12px !important;
    box-shadow: 0 2px 12px rgba(255,107,0,0.08) !important;
}
.time {
    font-weight: 800 !important;
    background: linear-gradient(135deg, #ff6b00, #ffaa00) !important;
    -webkit-background-clip: text !important;
    -webkit-text-fill-color: transparent !important;
    background-clip: text !important;
}

/* ══════════════════════════════════════
   CARDS
══════════════════════════════════════ */
.card {
    background: white !important;
    border-radius: var(--radius-lg) !important;
    border: 1px solid rgba(255,107,0,0.08) !important;
    box-shadow: var(--shadow-card) !important;
    transition: transform 0.25s ease, box-shadow 0.25s ease !important;
}
.card:hover {
    transform: translateY(-4px) !important;
    box-shadow: var(--shadow-card-hover) !important;
}
.card::after {
    height: 4px !important;
    background: var(--card-accent, linear-gradient(90deg,#ff6b00,#ffaa00)) !important;
    border-radius: var(--radius-lg) var(--radius-lg) 0 0 !important;
}
.card-title {
    font-size: 0.7rem !important;
    font-weight: 700 !important;
    letter-spacing: 1.2px !important;
    color: #aaa !important;
}
.card-value {
    font-size: 1.85rem !important;
    font-weight: 900 !important;
    letter-spacing: -1px !important;
}
.dark-mode .card { background: #1a1208 !important; border-color: rgba(255,107,0,0.12) !important; }

/* ══════════════════════════════════════
   SECTION TITLE
══════════════════════════════════════ */
.section-title {
    font-size: 1.4rem !important;
    font-weight: 900 !important;
    background: linear-gradient(135deg, #ff6b00, #ffaa00) !important;
    -webkit-background-clip: text !important;
    -webkit-text-fill-color: transparent !important;
    background-clip: text !important;
    border-bottom: 3px solid #ff6b00 !important;
    padding-bottom: 0.65rem !important;
    margin-bottom: 1.75rem !important;
}

/* ══════════════════════════════════════
   FORMS
══════════════════════════════════════ */
.form-container {
    background: white !important;
    border-radius: var(--radius-xl) !important;
    box-shadow: var(--shadow-card) !important;
    border: 1px solid rgba(255,107,0,0.06) !important;
}
.cliente-card {
    background: #fff9f5 !important;
    border-radius: 14px !important;
    border: 1px solid rgba(255,107,0,0.12) !important;
    margin-bottom: 1.5rem !important;
    position: relative !important;
    overflow: hidden !important;
}
.cliente-card::before {
    content: '' !important;
    position: absolute !important;
    top: 0 !important; left: 0 !important; right: 0 !important;
    height: 3px !important;
    background: linear-gradient(90deg, #ff6b00, #ffaa00) !important;
}
.cliente-card h3 {
    font-size: 0.85rem !important;
    font-weight: 800 !important;
    color: #ff6b00 !important;
    letter-spacing: 0.5px !important;
    text-transform: uppercase !important;
}
.form-group label {
    font-size: 0.78rem !important;
    font-weight: 700 !important;
    color: #555 !important;
}
.form-control {
    border: 1.5px solid #e8e8e8 !important;
    border-radius: 10px !important;
    transition: border-color 0.2s, box-shadow 0.2s !important;
    -webkit-text-fill-color: initial !important;
}
.form-control:focus {
    border-color: #ff6b00 !important;
    box-shadow: 0 0 0 3px rgba(255,107,0,0.12) !important;
    outline: none !important;
}
.form-control:hover { border-color: rgba(255,107,0,0.3) !important; }
.dark-mode .form-control {
    background: #241500 !important;
    border-color: rgba(255,107,0,0.2) !important;
    color: #f0e8d8 !important;
    -webkit-text-fill-color: #f0e8d8 !important;
}

/* ══════════════════════════════════════
   BOTÕES
══════════════════════════════════════ */
.btn-primary {
    background: linear-gradient(135deg, #ff6b00, #ffaa00) !important;
    border: none !important;
    color: white !important;
    font-weight: 700 !important;
    border-radius: 10px !important;
    box-shadow: 0 4px 15px rgba(255,107,0,0.3) !important;
}
.btn-primary:hover {
    background: linear-gradient(135deg, #e85500, #ff8c00) !important;
    box-shadow: 0 6px 25px rgba(255,107,0,0.45) !important;
    transform: translateY(-2px) !important;
}
.btn-success {
    background: linear-gradient(135deg, #28a745, #20c997) !important;
    border: none !important; font-weight: 700 !important; border-radius: 10px !important;
    box-shadow: 0 4px 15px rgba(40,167,69,0.25) !important;
}
.btn-success:hover { transform: translateY(-2px) !important; }
.btn-danger {
    background: linear-gradient(135deg, #dc3545, #c0392b) !important;
    border: none !important; font-weight: 700 !important; border-radius: 10px !important;
    box-shadow: 0 4px 15px rgba(220,53,69,0.25) !important;
}
.btn-danger:hover { transform: translateY(-2px) !important; }
.btn-secondary {
    background: #f0ede8 !important; color: #555 !important;
    border: 1px solid #e0ddd8 !important; font-weight: 600 !important; border-radius: 10px !important;
}
.btn-secondary:hover { background: #e8e4de !important; color: #ff6b00 !important; }
.btn-info {
    background: linear-gradient(135deg, #17a2b8, #138496) !important;
    border: none !important; font-weight: 700 !important; border-radius: 10px !important;
}
.btn-warning {
    background: linear-gradient(135deg, #ffaa00, #ffcc00) !important;
    color: #3d2800 !important; border: none !important; font-weight: 700 !important; border-radius: 10px !important;
}
.dark-mode .btn-secondary { background: #241500 !important; color: #f0e8d8 !important; border-color: rgba(255,107,0,0.2) !important; }

/* ══════════════════════════════════════
   TABELAS — GRADIENTE OPÇÃO 2
   Gradiente aplicado no thead (elemento pai),
   th com background transparent para não criar divisórias
══════════════════════════════════════ */
.table-container {
    background: white !important;
    border-radius: var(--radius-lg) !important;
    border: 1px solid rgba(255,107,0,0.06) !important;
    box-shadow: var(--shadow-card) !important;
    overflow-x: auto !important;   /* scroll horizontal, SEM cortar vertical */
    overflow-y: visible !important;
    padding: 0 0 0.5rem 0 !important;
}
.table-container h3,
.table-container .mb-3 {
    padding: 1.2rem 1.5rem 0.75rem !important;
    font-weight: 800 !important;
}

/* ── Wrapper interno para manter borda-radius no thead ── */
.table-container table {
    border-collapse: separate !important;
    border-spacing: 0 !important;
    width: 100% !important;
    min-width: 600px !important;
}

/* thead com gradiente correto — sem divisórias entre th */
thead {
    background: linear-gradient(90deg, #ff6b00 0%, #ffaa00 100%) !important;
}

/* th transparente para o gradiente do thead aparecer sem cortes */
th {
    background: transparent !important;
    color: white !important;
    font-weight: 700 !important;
    font-size: 0.76rem !important;
    letter-spacing: 0.8px !important;
    text-transform: uppercase !important;
    padding: 1rem 1.1rem !important;
    border: none !important;
    white-space: nowrap !important;
}

td {
    padding: 0.9rem 1.1rem !important;
    border-bottom: 1px solid rgba(255,107,0,0.06) !important;
    font-size: 0.88rem !important;
    color: #333 !important;
    font-weight: 500 !important;
    vertical-align: middle !important;
}
tr:last-child td { border-bottom: none !important; }
tr:hover td { background: rgba(255,107,0,0.03) !important; }

/* Receituário e parcelas */
.presc-table,
.tabela-parcelas {
    border-collapse: separate !important;
    border-spacing: 0 !important;
}
.presc-table thead,
.tabela-parcelas thead {
    background: linear-gradient(90deg, #ff6b00 0%, #ffaa00 100%) !important;
}
.presc-table th,
.tabela-parcelas th {
    background: transparent !important;
    color: white !important;
    border: none !important;
    font-weight: 700 !important;
}

/* Dark mode tabela */
.dark-mode thead { background: linear-gradient(90deg, #cc5500 0%, #cc8800 100%) !important; }
.dark-mode th { background: transparent !important; color: white !important; }
.dark-mode td { color: #e0d4c0 !important; border-bottom-color: rgba(255,107,0,0.08) !important; }
.dark-mode .table-container { background: #1a1208 !important; border-color: rgba(255,107,0,0.12) !important; }

/* ══════════════════════════════════════
   MODAIS
══════════════════════════════════════ */
.modal-content {
    border-radius: var(--radius-xl) !important;
    box-shadow: 0 20px 80px rgba(0,0,0,0.25) !important;
    overflow: hidden !important;
}
.modal-header {
    background: linear-gradient(90deg, rgba(255,107,0,0.06), rgba(255,170,0,0.03)) !important;
    border-bottom: 1px solid rgba(255,107,0,0.1) !important;
    padding: 1.25rem 1.5rem !important;
}
.modal-title {
    font-weight: 800 !important;
    background: linear-gradient(135deg, #ff6b00, #ffaa00) !important;
    -webkit-background-clip: text !important;
    -webkit-text-fill-color: transparent !important;
    background-clip: text !important;
}
.modal-footer {
    background: #fdf8f4 !important;
    border-top: 1px solid rgba(255,107,0,0.08) !important;
}
.modal-close { transition: all 0.2s !important; }
.modal-close:hover { color: #ff6b00 !important; transform: rotate(90deg) !important; }
.dark-mode .modal-content { background: #1a1208 !important; }
.dark-mode .modal-header  { background: rgba(255,107,0,0.08) !important; }
.dark-mode .modal-footer  { background: #120d05 !important; }
.dark-mode .modal-title   {
    background: linear-gradient(135deg,#ff8c40,#ffcc00) !important;
    -webkit-background-clip: text !important; -webkit-text-fill-color: transparent !important; background-clip: text !important;
}

/* ══════════════════════════════════════
   CHARTS & ALERTAS
══════════════════════════════════════ */
.chart-container {
    background: white !important;
    border-radius: var(--radius-lg) !important;
    border: 1px solid rgba(255,107,0,0.06) !important;
    box-shadow: var(--shadow-card) !important;
}
.chart-title { font-weight: 800 !important; }
.dash-alert-panel {
    border-radius: var(--radius-lg) !important;
    border: 1px solid rgba(255,107,0,0.08) !important;
    box-shadow: var(--shadow-card) !important;
    overflow: hidden !important;
}
.dash-alert-header.birthday {
    background: linear-gradient(90deg, #ff6b00, #ffaa00) !important;
}
.dash-alert-item:hover { background: rgba(255,107,0,0.04) !important; }
.dark-mode .chart-container  { background: #1a1208 !important; border-color: rgba(255,107,0,0.12) !important; }
.dark-mode .dash-alert-panel { background: #1a1208 !important; }

/* ══════════════════════════════════════
   RECEITUÁRIO
══════════════════════════════════════ */
.presc-container {
    border-radius: var(--radius-lg) !important;
    border: 1px solid rgba(255,107,0,0.1) !important;
}
.presc-title {
    font-weight: 900 !important;
    background: linear-gradient(135deg, #ff6b00, #ffaa00) !important;
    -webkit-background-clip: text !important;
    -webkit-text-fill-color: transparent !important;
    background-clip: text !important;
}
.presc-stepper button {
    background: linear-gradient(135deg, #ff6b00, #ffaa00) !important;
    border-radius: 7px !important;
    font-weight: 800 !important;
}
.presc-stepper button.danger  { background: linear-gradient(135deg,#dc3545,#c0392b) !important; }
.presc-stepper button.success { background: linear-gradient(135deg,#28a745,#20c997) !important; }
.presc-profissionais {
    background: linear-gradient(135deg, #fff9f5, #fff5ec) !important;
    border: 1px solid rgba(255,107,0,0.1) !important;
    border-radius: 10px !important;
}

/* ══════════════════════════════════════
   FORMAS DE PAGAMENTO
══════════════════════════════════════ */
.payment-card {
    border-radius: 14px !important;
    border: 2px solid #eeebe6 !important;
    background: #fdfcfa !important;
    transition: all 0.2s ease !important;
}
.payment-card:hover {
    border-color: #ff6b00 !important;
    background: rgba(255,107,0,0.04) !important;
    transform: translateY(-3px) !important;
    box-shadow: 0 6px 20px rgba(255,107,0,0.18) !important;
}
.payment-card.active {
    border-color: #ff6b00 !important;
    background: linear-gradient(135deg, #fff5ee, #fff8f0) !important;
    box-shadow: 0 0 0 3px rgba(255,107,0,0.15) !important;
}
.pay-summary-box {
    background: linear-gradient(135deg, #fff9f5, #fff5ec) !important;
    border: 2px solid rgba(255,107,0,0.2) !important;
    border-radius: 14px !important;
}
.dark-mode .payment-card { background: #241500 !important; border-color: rgba(255,107,0,0.2) !important; color: #f0e8d8 !important; }
.dark-mode .payment-card.active { background: linear-gradient(135deg,#2d1500,#3d1f00) !important; }

/* ══════════════════════════════════════
   CONTAS / CREDIÁRIO / OUTROS
══════════════════════════════════════ */
.resumo-crediario {
    background: linear-gradient(135deg, #ff6b00, #ffaa00) !important;
    border-radius: 14px !important;
    box-shadow: var(--shadow-orange) !important;
}
.conta-item {
    border-radius: 10px !important;
    box-shadow: 0 1px 6px rgba(0,0,0,0.05) !important;
    transition: box-shadow 0.2s !important;
}
.conta-item:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.1) !important; }
.medida-icon.primary { background: linear-gradient(135deg,#ff6b00,#ffaa00) !important; }
.dark-mode .conta-item { background: #1a1208 !important; }

/* ══════════════════════════════════════
   BADGES & TOASTS
══════════════════════════════════════ */
.badge-success { background: rgba(40,167,69,0.12) !important; color: #1a7a3a !important; font-weight: 700 !important; }
.badge-warning { background: rgba(255,170,0,0.15) !important; color: #8a5800 !important; font-weight: 700 !important; }
.badge-danger  { background: rgba(220,53,69,0.12) !important; color: #b02030 !important; font-weight: 700 !important; }
.badge-info    { background: rgba(23,162,184,0.12) !important; color: #0d7a8a !important; font-weight: 700 !important; }
.toast { border-radius: 12px !important; border-left-width: 5px !important; }
.menu-toggle { background: linear-gradient(135deg,#ff6b00,#ffaa00) !important; border-radius: 12px !important; box-shadow: var(--shadow-orange) !important; }

/* ══════════════════════════════════════════════════════
   DARK MODE — PRETO & CINZA PROFISSIONAL v2.0
   Paleta: #0d0d0d · #141414 · #1c1c1e · #252528 · #2e2e32
   Acento: laranja #ff6b00 / âmbar #ffaa00
══════════════════════════════════════════════════════ */

/* ── Fundo geral ── */
.dark-mode body {
    background: #0d0d0d !important;
    color: #e8e8e8 !important;
}
.dark-mode .main-content {
    background: #0d0d0d !important;
}

/* ── Sidebar dark: mantém laranja ── */
.dark-mode .sidebar {
    background: linear-gradient(180deg, #cc4400 0%, #8a2d00 100%) !important;
    box-shadow: 4px 0 24px rgba(0,0,0,0.6) !important;
}

/* ── Header ── */
.dark-mode .header {
    border-bottom-color: #2e2e32 !important;
}
.dark-mode .header-left h1 {
    background: linear-gradient(135deg, #ff8040 0%, #ffcc00 100%) !important;
    -webkit-background-clip: text !important;
    -webkit-text-fill-color: transparent !important;
    background-clip: text !important;
}
.dark-mode #pageSubtitle { color: #666 !important; }

/* ── Widget data/hora ── */
.dark-mode .datetime-widget {
    background: #1c1c1e !important;
    border-color: #2e2e32 !important;
    box-shadow: none !important;
}
.dark-mode .time {
    background: linear-gradient(135deg, #ff8040, #ffcc00) !important;
    -webkit-background-clip: text !important;
    -webkit-text-fill-color: transparent !important;
    background-clip: text !important;
}
.dark-mode .date { color: #666 !important; }

/* ── Cards do dashboard ── */
.dark-mode .card {
    background: #1c1c1e !important;
    border-color: #2e2e32 !important;
    box-shadow: 0 2px 12px rgba(0,0,0,0.4) !important;
}
.dark-mode .card:hover {
    box-shadow: 0 6px 24px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,107,0,0.15) !important;
}
.dark-mode .card-title  { color: #555 !important; }
.dark-mode .card-value  { color: #f0f0f0 !important; }
.dark-mode .card-icon   { opacity: 0.85 !important; }

/* ── Section title ── */
.dark-mode .section-title {
    background: linear-gradient(135deg, #ff8040, #ffcc00) !important;
    -webkit-background-clip: text !important;
    -webkit-text-fill-color: transparent !important;
    background-clip: text !important;
    border-bottom-color: #2e2e32 !important;
}

/* ── Form container ── */
.dark-mode .form-container {
    background: #141414 !important;
    border-color: #2e2e32 !important;
    box-shadow: 0 2px 16px rgba(0,0,0,0.5) !important;
}

/* ── Cliente cards (subseções de formulário) ── */
.dark-mode .cliente-card {
    background: #1c1c1e !important;
    border-color: #2e2e32 !important;
    box-shadow: 0 1px 8px rgba(0,0,0,0.3) !important;
}
.dark-mode .cliente-card::before {
    background: linear-gradient(90deg, #ff6b00, #ffaa00) !important;
}
.dark-mode .cliente-card h3 {
    color: #ff8040 !important;
    -webkit-text-fill-color: #ff8040 !important;
    border-bottom-color: #2e2e32 !important;
}

/* ── Inputs e selects ── */
.dark-mode .form-control {
    background: #252528 !important;
    border-color: #3a3a3e !important;
    color: #e0e0e0 !important;
    -webkit-text-fill-color: #e0e0e0 !important;
}
.dark-mode .form-control:focus {
    border-color: #ff6b00 !important;
    box-shadow: 0 0 0 3px rgba(255,107,0,0.18) !important;
    background: #2e2e32 !important;
}
.dark-mode .form-control:hover { border-color: #555 !important; }
.dark-mode .form-group label { color: #888 !important; }

/* ── Botões dark ── */
.dark-mode .btn-secondary {
    background: #252528 !important;
    color: #ccc !important;
    border-color: #3a3a3e !important;
}
.dark-mode .btn-secondary:hover {
    background: #2e2e32 !important;
    border-color: #ff6b00 !important;
    color: #ff8040 !important;
}

/* ── Tabelas ── */
.dark-mode .table-container {
    background: #1c1c1e !important;
    border-color: #2e2e32 !important;
    box-shadow: 0 2px 16px rgba(0,0,0,0.4) !important;
}
.dark-mode .table-container h3 { color: #e0e0e0 !important; }
.dark-mode thead {
    background: linear-gradient(90deg, #cc5500 0%, #cc8800 100%) !important;
}
.dark-mode th { background: transparent !important; color: #fff !important; }
.dark-mode td {
    color: #c8c8c8 !important;
    border-bottom-color: #252528 !important;
}
.dark-mode tr:hover td { background: rgba(255,255,255,0.03) !important; }
.dark-mode tbody tr:nth-child(even) td { background: rgba(255,255,255,0.02) !important; }

/* ── Modais ── */
.dark-mode .modal-content {
    background: #1c1c1e !important;
    border: 1px solid #2e2e32 !important;
    box-shadow: 0 24px 80px rgba(0,0,0,0.7) !important;
}
.dark-mode .modal-header {
    background: rgba(255,107,0,0.07) !important;
    border-bottom-color: #2e2e32 !important;
}
.dark-mode .modal-title {
    background: linear-gradient(135deg, #ff8040, #ffcc00) !important;
    -webkit-background-clip: text !important;
    -webkit-text-fill-color: transparent !important;
    background-clip: text !important;
}
.dark-mode .modal-footer {
    background: #141414 !important;
    border-top-color: #2e2e32 !important;
}

/* ── Charts ── */
.dark-mode .chart-container {
    background: #1c1c1e !important;
    border-color: #2e2e32 !important;
    box-shadow: 0 2px 12px rgba(0,0,0,0.4) !important;
}
.dark-mode .chart-title { color: #aaa !important; }
.dark-mode .bar-value   { background: #252528 !important; border-color: #3a3a3e !important; color: #ccc !important; }

/* ── Alert panels ── */
.dark-mode .dash-alert-panel {
    background: #1c1c1e !important;
    border-color: #2e2e32 !important;
}
.dark-mode .dash-alert-item {
    border-bottom-color: #252528 !important;
}
.dark-mode .dash-alert-item:hover { background: rgba(255,255,255,0.03) !important; }
.dark-mode .dash-alert-name  { color: #e0e0e0 !important; }
.dark-mode .dash-alert-info  { color: #666 !important; }

/* ── Receituário ── */
.dark-mode .presc-container {
    background: #1c1c1e !important;
    border-color: #2e2e32 !important;
}
.dark-mode .presc-profissionais {
    background: #252528 !important;
    border-color: #3a3a3e !important;
}
.dark-mode .presc-title {
    background: linear-gradient(135deg, #ff8040, #ffcc00) !important;
    -webkit-background-clip: text !important;
    -webkit-text-fill-color: transparent !important;
    background-clip: text !important;
}
.dark-mode .presc-field {
    background: #252528 !important;
    border-color: #3a3a3e !important;
    color: #e0e0e0 !important;
}
.dark-mode .medida-card {
    background: #252528 !important;
    border-color: #3a3a3e !important;
}

/* ── Pagamentos ── */
.dark-mode .payment-card {
    background: #1c1c1e !important;
    border-color: #3a3a3e !important;
    color: #c8c8c8 !important;
}
.dark-mode .payment-card:hover {
    border-color: #ff6b00 !important;
    background: #252528 !important;
    box-shadow: 0 4px 16px rgba(255,107,0,0.2) !important;
}
.dark-mode .payment-card.active {
    border-color: #ff6b00 !important;
    background: #2a1800 !important;
    box-shadow: 0 0 0 3px rgba(255,107,0,0.2) !important;
}
.dark-mode .payment-card.active i { color: #ff8040 !important; }
.dark-mode .pay-summary-box {
    background: #252528 !important;
    border-color: #3a3a3e !important;
}
.dark-mode .pay-summary-row { border-bottom-color: #3a3a3e !important; }
.dark-mode .pay-summary-row .label { color: #888 !important; }
.dark-mode .pay-summary-row .value { color: #e0e0e0 !important; }

/* ── Contas / Crediário ── */
.dark-mode .conta-item {
    background: #1c1c1e !important;
    border-color: #2e2e32 !important;
    box-shadow: 0 1px 6px rgba(0,0,0,0.3) !important;
}
.dark-mode .conta-item.vencida { background: #1e1a0e !important; }
.dark-mode .conta-item.paga    { background: #141814 !important; opacity: 0.7 !important; }
.dark-mode .conta-item-nome    { color: #e0e0e0 !important; }
.dark-mode .conta-item-det     { color: #666 !important; }
.dark-mode .parcelas-container { background: #252528 !important; }
.dark-mode .tabela-parcelas td { border-color: #2e2e32 !important; color: #c8c8c8 !important; }
.dark-mode .resumo-crediario   { box-shadow: 0 4px 20px rgba(0,0,0,0.5) !important; }

/* ── Sync panel ── */
.dark-mode .sync-status-panel {
    background: #141414 !important;
    border-color: #2e2e32 !important;
}
.dark-mode .sync-row { border-bottom-color: #252528 !important; }
.dark-mode .sync-label { color: #666 !important; }

/* ── Toasts ── */
.dark-mode .toast {
    background: #1c1c1e !important;
    border-color: #2e2e32 !important;
    color: #e0e0e0 !important;
    box-shadow: 0 8px 32px rgba(0,0,0,0.6) !important;
}

/* ── Badges dark ── */
.dark-mode .badge-success { background: rgba(40,167,69,0.18) !important; color: #4caf70 !important; }
.dark-mode .badge-warning { background: rgba(255,170,0,0.18) !important; color: #ffaa40 !important; }
.dark-mode .badge-danger  { background: rgba(220,53,69,0.18) !important; color: #e06070 !important; }
.dark-mode .badge-info    { background: rgba(23,162,184,0.18) !important; color: #40bcd0 !important; }

/* ── Texto geral dark ── */
.dark-mode h3, .dark-mode h4 { color: #e0e0e0 !important; }
.dark-mode p, .dark-mode span:not(.badge):not(.menu-item span) { color: inherit !important; }
.dark-mode .gray, .dark-mode small { color: #666 !important; }

/* ── SCROLLBAR ── */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: linear-gradient(180deg,#ff6b00,#ffaa00); border-radius: 99px; }
::selection { background: rgba(255,107,0,0.2) !important; }

/* ── ANIMAÇÃO SEÇÃO ── */
@keyframes sectionReveal {
    from { opacity:0; transform:translateY(14px); }
    to   { opacity:1; transform:translateY(0); }
}
.section.active { animation: sectionReveal 0.35s ease !important; }

/* ══ FIM UPGRADE VISUAL v4.0 ══ */
</style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar no-print" id="sidebar">
            <div class="sidebar-header">
                <button class="close-sidebar" id="closeSidebar">&times;</button>
                <div class="logo-container">
                    <!-- Placeholder visível quando não há logo -->
                    <div class="logo-placeholder" id="logoPlaceholder"
                         onclick="document.getElementById('logoUpload').click()"
                         role="button" tabindex="0" aria-label="Upload logo" title="Clique para adicionar logo">
                        <i class="fas fa-eye"></i>
                    </div>
                    <!-- Wrapper circular com overflow:hidden — único elemento que garante recorte real -->
                    <div class="logo-wrapper d-none" id="logoWrapper"
                         onclick="document.getElementById('logoUpload').click()" title="Clique para trocar logo">
                        <img id="logoImg" class="logo-img" alt="Logo da empresa">
                    </div>
                    <input type="file" id="logoUpload" accept="image/*" class="d-none" onchange="App.updateLogo(event)" aria-hidden="true">
                    <div class="company-name" id="companyName">ÓticaVision Pro</div>
                    <div class="company-subtitle">Sistema Ótico</div>
                </div>
            </div>
            <nav class="sidebar-menu" aria-label="Navegação principal">
                <div class="sidebar-section-label">Principal</div>
                <div class="menu-item active" data-section="dashboard" role="button" tabindex="0"><i class="fas fa-home"></i><span>Dashboard</span></div>
                <div class="menu-item" data-section="sales" role="button" tabindex="0"><i class="fas fa-shopping-cart"></i><span>Vendas</span></div>
                <div class="menu-item" data-section="clients" role="button" tabindex="0"><i class="fas fa-users"></i><span>Clientes</span></div>
                <div class="menu-item" data-section="products" role="button" tabindex="0"><i class="fas fa-box"></i><span>Produtos</span></div>
                <div class="sidebar-section-label">Gestão</div>
                <div class="menu-item" data-section="services" role="button" tabindex="0"><i class="fas fa-concierge-bell"></i><span>Serviços</span></div>
                <div class="menu-item" data-section="suppliers" role="button" tabindex="0"><i class="fas fa-truck"></i><span>Fornecedores</span></div>
                <div class="menu-item" data-section="expenses" role="button" tabindex="0"><i class="fas fa-money-bill-wave"></i><span>Despesas</span></div>
                <div class="menu-item" data-section="reports" role="button" tabindex="0"><i class="fas fa-chart-bar"></i><span>Relatórios</span></div>
                <div class="menu-item" data-section="config" role="button" tabindex="0"><i class="fas fa-cog"></i><span>Configurações</span></div>
                <div class="sidebar-section-label">Fiscal</div>
                <div class="menu-item" data-section="nfe" role="button" tabindex="0"><i class="fas fa-file-invoice"></i><span>NF-e</span></div>
            </nav>
            <div class="sidebar-footer">
                <button class="theme-toggle" id="themeToggle" aria-label="Alternar modo escuro"><i class="fas fa-moon"></i><span>Modo Escuro</span></button>
            </div>
        </aside>

        <!-- Main content -->
        <main class="main-content">
            <button class="menu-toggle no-print" id="menuToggle">☰</button>
            
            <header class="header no-print">
                <div class="header-left">
                    <h1 id="pageTitle">Dashboard</h1>
                    <div id="pageSubtitle"></div>
                </div>
                <div class="header-right">
                    <div class="datetime-widget" aria-live="polite">
                        <div class="time" id="currentTime"></div>
                        <div class="date" id="currentDate"></div>
                    </div>
                    <div class="backup-buttons">
                        <input type="file" id="importBackup" class="d-none" accept=".json" onchange="App.importBackup(event)" aria-hidden="true">
                        <button class="btn btn-sm" style="background:#3ecf8e;color:#000;font-weight:700;" onclick="SupaSync.syncDown()" title="Sincronizar com a nuvem" id="headerSyncBtn">
                            <i class="fas fa-cloud-arrow-down" id="headerSyncIcon"></i> Sync
                        </button>
                        <button class="btn btn-sm" style="background:#3b82f6;color:#fff;font-weight:700;" onclick="if(confirm('Enviar todos os dados locais para o Supabase?'))SupaSync.migrarParaSupabase()" title="Enviar dados locais para o Supabase (use 1x)">
                            &#8679; Migrar
                        </button>
                    </div>

                </div>
            </header>

            <!-- Seção Dashboard -->
            <section id="dashboard" class="section active" aria-labelledby="pageTitle">

                <!-- Filtro de período -->
                <div class="dash-period-bar">
                    <span class="dash-period-label"><i class="fas fa-calendar-alt"></i> Período:</span>
                    <button class="dash-period-btn" data-period="today" onclick="Dashboard.setPeriod('today',this)">Hoje</button>
                    <button class="dash-period-btn active" data-period="month" onclick="Dashboard.setPeriod('month',this)">Este Mês</button>
                    <button class="dash-period-btn" data-period="year" onclick="Dashboard.setPeriod('year',this)">Este Ano</button>
                    <button class="dash-period-btn" data-period="all" onclick="Dashboard.setPeriod('all',this)">Tudo</button>
                    <button class="dash-period-btn" data-period="custom" onclick="Dashboard.setPeriod('custom',this)">Personalizado</button>
                    <div class="dash-period-custom" id="dashCustomRange">
                        <input type="date" id="dashDateFrom" onchange="Dashboard.applyCustomPeriod()">
                        <span style="color:var(--gray);font-size:0.85rem;">até</span>
                        <input type="date" id="dashDateTo" onchange="Dashboard.applyCustomPeriod()">
                    </div>
                </div>

                <div class="dashboard-cards" id="dashboardCards"></div>

                <!-- CONTAS A RECEBER E A PAGAR -->
                <div class="dashboard-charts" id="contasPaineis" style="margin-bottom: 1rem;">
                    <!-- Contas a Receber -->
                    <div class="chart-container" style="padding: 1.25rem;">
                        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:0.85rem; flex-wrap:wrap; gap:0.5rem;">
                            <div class="chart-title" style="margin-bottom:0; color:#28a745;">
                                <i class="fas fa-arrow-circle-down" style="margin-right:0.4rem;"></i>Contas a Receber
                            </div>
                            <button class="btn btn-sm" style="background:#28a745;color:white;font-size:0.78rem;" onclick="ContasManager.showModal('receber')">
                                <i class="fas fa-plus"></i> Nova
                            </button>
                        </div>
                        <div id="contasReceberTotal" style="font-size:1.3rem;font-weight:700;color:#28a745;margin-bottom:0.75rem;">R$ 0,00</div>
                        <div id="contasReceberList" style="max-height:220px;overflow-y:auto;">
                            <p style="color:var(--gray);font-size:0.85rem;text-align:center;padding:1rem 0;">Nenhuma conta a receber</p>
                        </div>
                    </div>
                    <!-- Contas a Pagar -->
                    <div class="chart-container" style="padding: 1.25rem;">
                        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:0.85rem; flex-wrap:wrap; gap:0.5rem;">
                            <div class="chart-title" style="margin-bottom:0; color:#dc3545;">
                                <i class="fas fa-arrow-circle-up" style="margin-right:0.4rem;"></i>Contas a Pagar
                            </div>
                            <button class="btn btn-sm" style="background:#dc3545;color:white;font-size:0.78rem;" onclick="ContasManager.showModal('pagar')">
                                <i class="fas fa-plus"></i> Nova
                            </button>
                        </div>
                        <div id="contasPagarTotal" style="font-size:1.3rem;font-weight:700;color:#dc3545;margin-bottom:0.75rem;">R$ 0,00</div>
                        <div id="contasPagarList" style="max-height:220px;overflow-y:auto;">
                            <p style="color:var(--gray);font-size:0.85rem;text-align:center;padding:1rem 0;">Nenhuma conta a pagar</p>
                        </div>
                    </div>
                </div>

                <!-- Modal Contas -->
                <div id="modalContas" class="modal" style="display:none;" role="dialog">
                    <div class="modal-content" style="max-width:480px;">
                        <div class="modal-header">
                            <h3 id="modalContasTitulo">Nova Conta</h3>
                            <button class="modal-close" onclick="ContasManager.closeModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="contaEditId">
                            <input type="hidden" id="contaTipo">
                            <div class="form-row">
                                <div class="form-group" style="flex:2;">
                                    <label>Descrição *</label>
                                    <input type="text" id="contaDescricao" class="form-control" placeholder="Ex: Fornecedor XYZ, Parcela OS-001...">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Valor (R$) *</label>
                                    <input type="number" id="contaValor" class="form-control" placeholder="0,00" step="0.01" min="0">
                                </div>
                                <div class="form-group">
                                    <label>Vencimento *</label>
                                    <input type="date" id="contaVencimento" class="form-control">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Cliente/Fornecedor</label>
                                    <input type="text" id="contaParte" class="form-control" placeholder="Nome (opcional)">
                                </div>
                                <div class="form-group">
                                    <label>Categoria</label>
                                    <input type="text" id="contaCategoria" class="form-control" placeholder="Ex: Aluguel, OS, Lens...">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Observações</label>
                                <textarea id="contaObs" class="form-control" rows="2" style="resize:vertical;"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="ContasManager.closeModal()">Cancelar</button>
                            <button class="btn btn-primary" onclick="ContasManager.saveConta()"><i class="fas fa-save"></i> Salvar</button>
                        </div>
                    </div>
                </div>

                <!-- Modal Comprovante -->
                <div id="modalComprovante" class="modal" style="display:none;" role="dialog">
                    <div class="modal-content" style="max-width:420px;">
                        <div class="modal-header">
                            <h3>🧾 Comprovante de Pagamento</h3>
                            <button class="modal-close" onclick="document.getElementById('modalComprovante').style.display='none'">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div id="comprovanteContent" style="font-family:monospace; font-size:0.85rem; line-height:1.7; white-space:pre-wrap; background:var(--light); padding:1rem; border-radius:8px; border:1px dashed var(--gray);"></div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="document.getElementById('modalComprovante').style.display='none'">Fechar</button>
                            <button class="btn btn-primary" onclick="ContasManager.imprimirComprovante()"><i class="fas fa-print"></i> Imprimir</button>
                        </div>
                    </div>
                </div>
                <div class="dashboard-charts" id="dashAlertPanels">
                    <!-- Aniversariantes do dia -->
                    <div class="dash-alert-panel">
                        <div class="dash-alert-header birthday">
                            <span>🎂 Aniversariantes de Hoje</span>
                            <span class="badge-count" id="bdayCount">0</span>
                        </div>
                        <div class="dash-alert-list" id="bdayList">
                            <div class="dash-alert-empty">Carregando...</div>
                        </div>
                    </div>
                    <!-- Óculos vencido há mais de 1 ano -->
                    <div class="dash-alert-panel">
                        <div class="dash-alert-header glasses">
                            <span>👓 Óculos Entregues há +1 Ano</span>
                            <span class="badge-count" id="glassesCount">0</span>
                        </div>
                        <div class="dash-alert-list" id="glassesList">
                            <div class="dash-alert-empty">Carregando...</div>
                        </div>
                    </div>
                </div>

                <div class="dashboard-charts">
                    <div class="chart-container">
                        <div class="chart-title">Vendas por Dia (últimos 7 dias)</div>
                        <div class="bar-chart" id="salesChart"></div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">Produtos Mais Vendidos</div>
                        <div class="bar-chart" id="productsChart"></div>
                    </div>
                </div>
                <div class="table-container">
                    <h3 class="mb-3">Últimas Vendas</h3>
                    <table id="recentSalesTable">
                        <thead><tr><th>Nº O.S</th><th>Cliente</th><th>Valor</th><th>Status</th><th>Data</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- Seção Vendas -->
            <section id="sales" class="section" aria-labelledby="pageTitle">
                <div class="form-container no-print">
                    <h2 class="section-title">NOVA ORDEM DE SERVIÇO</h2>
                    
                    <!-- DADOS DA OS -->
                    <div class="cliente-card">
                        <h3>📋 DADOS DA OS</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="saleNumber">Nº OS</label>
                                <input type="text" id="saleNumber" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label for="saleDate">Data</label>
                                <input type="date" id="saleDate" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="saleUnit">Unidade</label>
                                <select id="saleUnit" class="form-control">
                                    <option value="barueri">Barueri</option>
                                    <option value="caucaia">Caucaia do Alto</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="saleSeller">Vendedor</label>
                                <input type="text" id="saleSeller" class="form-control" placeholder="Nome do vendedor">
                            </div>
                            <div class="form-group">
                                <label for="deliveryForecast">Entrega Prevista</label>
                                <input type="date" id="deliveryForecast" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="saleStatus">Status</label>
                                <select id="saleStatus" class="form-control">
                                    <option value="orcamento">📋 Orçamento</option>
                                    <option value="pendente">⏳ Pendente</option>
                                    <option value="producao">🔧 Em Produção</option>
                                    <option value="laboratorio">🔬 Laboratório</option>
                                    <option value="tratamento">🧪 Tratamento</option>
                                    <option value="atrasado">⚠️ Atrasado</option>
                                    <option value="pronto">📦 Pronto p/ Retirada</option>
                                    <option value="entregue">✅ Entregue</option>
                                    <option value="cancelado">❌ Cancelado</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- SELEÇÃO DE CLIENTE -->
                    <div class="cliente-card">
                        <h3>👤 SELECIONAR CLIENTE</h3>
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label for="searchClientSale">Buscar Cliente</label>
                                <div style="display: flex; gap: 10px;">
                                    <input type="text" id="searchClientSale" class="form-control" placeholder="Digite nome, CPF ou telefone" onkeyup="Sales.searchClient()">
                                    <button type="button" class="btn btn-primary" onclick="Sales.searchClient()"><i class="fas fa-search"></i> Buscar</button>
                                </div>
                            </div>
                        </div>
                        <div id="clientSearchResults" class="form-group" style="display: none;">
                            <label>Resultados da busca:</label>
                            <select id="clientSelect" class="form-control" onchange="Sales.loadClientData()">
                                <option value="">Selecione um cliente</option>
                            </select>
                        </div>
                        <div id="selectedClientData" class="form-group" style="background: #e8f4fd; padding: 15px; border-radius: 8px; margin-top: 10px; display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong id="clientNameDisplay" style="font-size: 16px;"></strong><br>
                                    <span id="clientDocDisplay"></span><br>
                                    <span id="clientContactDisplay"></span><br>
                                    <span id="clientAddressDisplay"></span>
                                </div>
                                <div>
                                    <button type="button" class="btn btn-info" onclick="Sales.loadClientPrescription()">
                                        <i class="fas fa-file-prescription"></i> Carregar Receita
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- RECEITUÁRIO (COMPLETO) -->
                    <div class="presc-container" id="prescSection" style="display: none; margin-top: 0;">
                        <div class="presc-header">
                            <div>
                                <div class="presc-title">RECEITUÁRIO DO CLIENTE</div>
                                <div class="presc-subtitle" id="prescClientName"></div>
                            </div>
                            <div>
                                <span class="badge badge-info" id="prescDate"></span>
                            </div>
                        </div>
                        
                        <div class="presc-profissionais">
                            <div>
                                <label style="font-weight: 600; color: var(--primary);"><i class="fas fa-user-md"></i> Optometrista</label>
                                <input type="text" id="prescOptometrist" class="form-control" placeholder="Nome do optometrista">
                            </div>
                        </div>

                        <!-- Tabela LONGE -->
                        <div style="margin-bottom: 30px;">
                            <h4 style="color: var(--primary);">LONGE</h4>
                            <div class="presc-scroll-hint"><i class="fas fa-arrows-left-right"></i> Deslize para ver mais</div>
                            <div class="presc-table-wrapper">
                            <table class="presc-table">
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th>ESF</th>
                                        <th>CIL</th>
                                        <th>EIXO</th>
                                        <th>ADIÇÃO</th>
                                        <th>DNP</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="font-weight: bold;">OD</td>
                                        <td>
                                            <div class="presc-stepper">
                                                <button type="button" onclick="Presc.stepValue('odSph', -20, 20, 0.25, -1)" data-tooltip="Diminuir">−</button>
                                                <input type="text" id="odSph" value="0.00" readonly class="presc-field" ondblclick="Presc.resetField('odSph')" onchange="Presc.updateAllPertoOD()">
                                                <button type="button" onclick="Presc.stepValue('odSph', -20, 20, 0.25, 1)" data-tooltip="Aumentar">+</button>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="presc-stepper">
                                                <button type="button" onclick="Presc.stepValue('odCyl', -6, 0, 0.25, -1)" style="background: var(--danger);" data-tooltip="Diminuir">−</button>
                                                <input type="text" id="odCyl" value="0.00" readonly class="presc-field negative" ondblclick="Presc.resetField('odCyl')" onchange="Presc.updateAllPertoOD()">
                                            </div>
                                        </td>
                                        <td>
                                            <input type="text" id="odAxis" class="presc-field" onblur="Presc.formatAxis(this)" onchange="Presc.updatePertoEixoOD()" placeholder="0°" ondblclick="this.value='0°'" data-tooltip="Duplo clique para zerar">
                                        </td>
                                        <td>
                                            <div class="presc-stepper">
                                                <input type="text" id="odAdd" value="0.00" readonly class="presc-field positive" ondblclick="Presc.resetField('odAdd')" onchange="Presc.updateAllPertoOD()">
                                                <button type="button" onclick="Presc.stepValue('odAdd', 0, 4, 0.25, 1)" style="background: var(--success);" data-tooltip="Aumentar">+</button>
                                            </div>
                                        </td>
                                        <td>
                                            <input type="text" id="odDnp" class="presc-field" onblur="Presc.validateDnp(this); Presc.updateAllPertoOD(); Presc.updateDP()" placeholder="20-40mm" ondblclick="this.value=''" data-tooltip="Duplo clique para limpar">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="font-weight: bold;">OE</td>
                                        <td>
                                            <div class="presc-stepper">
                                                <button type="button" onclick="Presc.stepValue('oeSph', -20, 20, 0.25, -1)" data-tooltip="Diminuir">−</button>
                                                <input type="text" id="oeSph" value="0.00" readonly class="presc-field" ondblclick="Presc.resetField('oeSph')" onchange="Presc.updateAllPertoOE()">
                                                <button type="button" onclick="Presc.stepValue('oeSph', -20, 20, 0.25, 1)" data-tooltip="Aumentar">+</button>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="presc-stepper">
                                                <button type="button" onclick="Presc.stepValue('oeCyl', -6, 0, 0.25, -1)" style="background: var(--danger);" data-tooltip="Diminuir">−</button>
                                                <input type="text" id="oeCyl" value="0.00" readonly class="presc-field negative" ondblclick="Presc.resetField('oeCyl')" onchange="Presc.updateAllPertoOE()">
                                            </div>
                                        </td>
                                        <td>
                                            <input type="text" id="oeAxis" class="presc-field" onblur="Presc.formatAxis(this)" onchange="Presc.updatePertoEixoOE()" placeholder="0°" ondblclick="this.value='0°'" data-tooltip="Duplo clique para zerar">
                                        </td>
                                        <td>
                                            <div class="presc-stepper">
                                                <input type="text" id="oeAdd" value="0.00" readonly class="presc-field positive" ondblclick="Presc.resetField('oeAdd')" onchange="Presc.updateAllPertoOE()">
                                                <button type="button" onclick="Presc.stepValue('oeAdd', 0, 4, 0.25, 1)" style="background: var(--success);" data-tooltip="Aumentar">+</button>
                                            </div>
                                        </td>
                                        <td>
                                            <input type="text" id="oeDnp" class="presc-field" onblur="Presc.validateDnp(this); Presc.updateAllPertoOE(); Presc.updateDP()" placeholder="20-40mm" ondblclick="this.value=''" data-tooltip="Duplo clique para limpar">
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            </div>
                        </div>

                        <!-- Tabela PERTO -->
                        <div style="margin-bottom: 30px;">
                            <h4 style="color: var(--success);">PERTO</h4>
                            <div class="presc-scroll-hint"><i class="fas fa-arrows-left-right"></i> Deslize para ver mais</div>
                            <div class="presc-table-wrapper">
                            <table class="presc-table">
                                <thead>
                                    <tr>
                                        <th style="background: var(--success);"></th>
                                        <th style="background: var(--success);">ESF</th>
                                        <th style="background: var(--success);">CIL</th>
                                        <th style="background: var(--success);">EIXO</th>
                                        <th style="background: var(--success);">DNP</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td style="font-weight: bold;">OD</td>
                                        <td><input type="text" id="odNearSph" readonly value="0.00" class="presc-field" style="background: #f0f9f0;"></td>
                                        <td><input type="text" id="odNearCyl" readonly value="0.00" class="presc-field negative" style="background: #f0f9f0;"></td>
                                        <td><input type="text" id="odNearAxis" readonly value="0°" class="presc-field" style="background: #f0f9f0;"></td>
                                        <td><input type="text" id="odNearDnp" readonly value="0.0" class="presc-field" style="background: #e7f3ff;"></td>
                                    </tr>
                                    <tr>
                                        <td style="font-weight: bold;">OE</td>
                                        <td><input type="text" id="oeNearSph" readonly value="0.00" class="presc-field" style="background: #f0f9f0;"></td>
                                        <td><input type="text" id="oeNearCyl" readonly value="0.00" class="presc-field negative" style="background: #f0f9f0;"></td>
                                        <td><input type="text" id="oeNearAxis" readonly value="0°" class="presc-field" style="background: #f0f9f0;"></td>
                                        <td><input type="text" id="oeNearDnp" readonly value="0.0" class="presc-field" style="background: #e7f3ff;"></td>
                                    </tr>
                                </tbody>
                            </table>
                            </div>
                        </div>

                        <!-- Medidas -->
                        <div class="presc-medidas">
                            <div class="medida-card">
                                <div class="medida-icon primary"><i class="fas fa-ruler"></i></div>
                                <div class="medida-content">
                                    <div class="medida-label">DP Longe</div>
                                    <div class="medida-value">
                                        <input type="text" id="prescDp" readonly value="0.0" style="width: 80px; text-align: center;" class="form-control"> <span class="medida-unit">mm</span>
                                    </div>
                                </div>
                            </div>
                            <div class="medida-card">
                                <div class="medida-icon success"><i class="fas fa-arrows-alt-v"></i></div>
                                <div class="medida-content">
                                    <div class="medida-label">Altura</div>
                                    <div class="medida-value">
                                        <input type="text" id="prescHeight" class="presc-field" onblur="Presc.validateNumber(this, 10, 35)" placeholder="0.0" style="width: 80px;" ondblclick="this.value=''" data-tooltip="Duplo clique para limpar">
                                        <span class="medida-unit">mm</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ITENS DA VENDA — REDESIGN PROFISSIONAL -->
                    <div class="cliente-card" style="padding:0;overflow:hidden;">

                        <!-- Header da seção -->
                        <div style="background:linear-gradient(135deg,#ff6b00 0%,#e55a00 100%);padding:14px 18px;display:flex;align-items:center;justify-content:space-between;">
                            <div style="display:flex;align-items:center;gap:10px;">
                                <div style="width:34px;height:34px;background:rgba(255,255,255,0.2);border-radius:10px;display:flex;align-items:center;justify-content:center;">
                                    <i class="fas fa-shopping-cart" style="color:#fff;font-size:15px;"></i>
                                </div>
                                <div>
                                    <div style="font-weight:800;color:#fff;font-size:0.95rem;letter-spacing:0.3px;">ITENS DA VENDA</div>
                                    <div style="font-size:0.7rem;color:rgba(255,255,255,0.75);">Lentes, armações e serviços</div>
                                </div>
                            </div>
                            <div id="itemCountBadge" style="background:rgba(255,255,255,0.2);color:#fff;font-size:0.75rem;font-weight:700;padding:3px 10px;border-radius:20px;">0 itens</div>
                        </div>

                        <!-- Lista de itens adicionados -->
                        <div id="saleItemsContainer" style="min-height:52px;padding:0 16px;">
                            <!-- Itens inseridos via JS -->
                        </div>

                        <!-- Empty state -->
                        <div id="emptyItemsHint" style="text-align:center;padding:16px 0 4px;color:#aaa;font-size:0.82rem;display:flex;align-items:center;justify-content:center;gap:6px;">
                            <i class="fas fa-arrow-down" style="color:#ffb347;"></i> Adicione produtos abaixo
                        </div>

                        <!-- Separador -->
                        <div style="height:1px;background:linear-gradient(90deg,transparent,#f0f0f0,transparent);margin:0 16px 14px;"></div>

                        <!-- Painel de adição — 3 tabs -->
                        <div style="padding:0 16px 16px;">
                            <!-- Tab buttons -->
                            <div style="display:flex;gap:6px;margin-bottom:12px;">
                                <button type="button" onclick="Sales.showItemTab('lente')" id="tabBtnLente"
                                    style="flex:1;padding:8px 4px;border-radius:10px;border:2px solid #ff6b00;background:#ff6b00;color:#fff;font-size:0.75rem;font-weight:700;cursor:pointer;transition:all 0.18s;display:flex;flex-direction:column;align-items:center;gap:3px;">
                                    <i class="fas fa-eye" style="font-size:14px;"></i>Lente
                                </button>
                                <button type="button" onclick="Sales.showItemTab('armacao')" id="tabBtnArmacao"
                                    style="flex:1;padding:8px 4px;border-radius:10px;border:2px solid #ddd;background:#fff;color:#888;font-size:0.75rem;font-weight:700;cursor:pointer;transition:all 0.18s;display:flex;flex-direction:column;align-items:center;gap:3px;">
                                    <i class="fas fa-glasses" style="font-size:14px;"></i>Armação
                                </button>
                                <button type="button" onclick="Sales.showItemTab('servico')" id="tabBtnServico"
                                    style="flex:1;padding:8px 4px;border-radius:10px;border:2px solid #ddd;background:#fff;color:#888;font-size:0.75rem;font-weight:700;cursor:pointer;transition:all 0.18s;display:flex;flex-direction:column;align-items:center;gap:3px;">
                                    <i class="fas fa-tools" style="font-size:14px;"></i>Serviço
                                </button>
                            </div>

                            <!-- Painel Lente -->
                            <div id="itemTabLente" style="animation:fadeIn 0.2s ease;">
                                <div style="background:#f9f9f9;border:1.5px solid #ffe0b2;border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:10px;">
                                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:2px;">
                                        <div style="width:28px;height:28px;background:#fff3e0;border-radius:8px;display:flex;align-items:center;justify-content:center;">
                                            <i class="fas fa-eye" style="color:#ff6b00;font-size:12px;"></i>
                                        </div>
                                        <span style="font-weight:700;font-size:0.82rem;color:#e65100;">Selecionar Lente</span>
                                    </div>
                                    <select id="lenteSelect" class="form-control" style="border-radius:8px;border-color:#ffcc80;background:#fff;font-size:0.85rem;">
                                        <option value="">🔍 Escolha uma lente...</option>
                                    </select>
                                    <div style="display:flex;gap:10px;align-items:center;">
                                        <div style="flex:1;">
                                            <label style="font-size:11px;color:#888;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">Quantidade</label>
                                            <div style="display:flex;align-items:center;gap:0;border:1.5px solid #ffcc80;border-radius:8px;overflow:hidden;background:#fff;width:fit-content;">
                                                <button type="button" onclick="Sales.changeQty('lenteQty',-1)" style="width:34px;height:34px;border:none;background:#fff3e0;color:#e65100;font-size:16px;font-weight:700;cursor:pointer;">−</button>
                                                <input type="number" id="lenteQty" value="1" min="1" style="width:44px;height:34px;border:none;text-align:center;font-size:0.9rem;font-weight:700;color:#333;outline:none;">
                                                <button type="button" onclick="Sales.changeQty('lenteQty',1)" style="width:34px;height:34px;border:none;background:#fff3e0;color:#e65100;font-size:16px;font-weight:700;cursor:pointer;">+</button>
                                            </div>
                                        </div>
                                        <button type="button" onclick="Sales.addLente()"
                                            style="flex:1;padding:10px;border-radius:10px;border:none;background:linear-gradient(135deg,#ff6b00,#e55a00);color:#fff;font-weight:700;font-size:0.83rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;box-shadow:0 3px 10px rgba(255,107,0,0.3);">
                                            <i class="fas fa-plus-circle"></i> Adicionar Lente
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Painel Armação -->
                            <div id="itemTabArmacao" style="display:none;animation:fadeIn 0.2s ease;">
                                <div style="background:#f9f9f9;border:1.5px solid #c8e6c9;border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:10px;">
                                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:2px;">
                                        <div style="width:28px;height:28px;background:#e8f5e9;border-radius:8px;display:flex;align-items:center;justify-content:center;">
                                            <i class="fas fa-glasses" style="color:#2e7d32;font-size:12px;"></i>
                                        </div>
                                        <span style="font-weight:700;font-size:0.82rem;color:#2e7d32;">Selecionar Armação</span>
                                    </div>
                                    <select id="armacaoSelect" class="form-control" style="border-radius:8px;border-color:#a5d6a7;background:#fff;font-size:0.85rem;">
                                        <option value="">🔍 Escolha uma armação...</option>
                                    </select>
                                    <div style="display:flex;gap:10px;align-items:center;">
                                        <div style="flex:1;">
                                            <label style="font-size:11px;color:#888;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">Quantidade</label>
                                            <div style="display:flex;align-items:center;gap:0;border:1.5px solid #a5d6a7;border-radius:8px;overflow:hidden;background:#fff;width:fit-content;">
                                                <button type="button" onclick="Sales.changeQty('armacaoQty',-1)" style="width:34px;height:34px;border:none;background:#e8f5e9;color:#2e7d32;font-size:16px;font-weight:700;cursor:pointer;">−</button>
                                                <input type="number" id="armacaoQty" value="1" min="1" style="width:44px;height:34px;border:none;text-align:center;font-size:0.9rem;font-weight:700;color:#333;outline:none;">
                                                <button type="button" onclick="Sales.changeQty('armacaoQty',1)" style="width:34px;height:34px;border:none;background:#e8f5e9;color:#2e7d32;font-size:16px;font-weight:700;cursor:pointer;">+</button>
                                            </div>
                                        </div>
                                        <button type="button" onclick="Sales.addArmacao()"
                                            style="flex:1;padding:10px;border-radius:10px;border:none;background:linear-gradient(135deg,#43a047,#2e7d32);color:#fff;font-weight:700;font-size:0.83rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;box-shadow:0 3px 10px rgba(46,125,50,0.25);">
                                            <i class="fas fa-plus-circle"></i> Adicionar Armação
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Painel Serviço -->
                            <div id="itemTabServico" style="display:none;animation:fadeIn 0.2s ease;">
                                <div style="background:#f9f9f9;border:1.5px solid #b3e5fc;border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:10px;">
                                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:2px;">
                                        <div style="width:28px;height:28px;background:#e1f5fe;border-radius:8px;display:flex;align-items:center;justify-content:center;">
                                            <i class="fas fa-tools" style="color:#0277bd;font-size:12px;"></i>
                                        </div>
                                        <span style="font-weight:700;font-size:0.82rem;color:#0277bd;">Selecionar Serviço</span>
                                    </div>
                                    <select id="servicoSelect" class="form-control" style="border-radius:8px;border-color:#81d4fa;background:#fff;font-size:0.85rem;">
                                        <option value="">🔍 Escolha um serviço...</option>
                                    </select>
                                    <div style="display:flex;gap:10px;align-items:center;">
                                        <div style="flex:1;">
                                            <label style="font-size:11px;color:#888;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">Quantidade</label>
                                            <div style="display:flex;align-items:center;gap:0;border:1.5px solid #81d4fa;border-radius:8px;overflow:hidden;background:#fff;width:fit-content;">
                                                <button type="button" onclick="Sales.changeQty('servicoQty',-1)" style="width:34px;height:34px;border:none;background:#e1f5fe;color:#0277bd;font-size:16px;font-weight:700;cursor:pointer;">−</button>
                                                <input type="number" id="servicoQty" value="1" min="1" style="width:44px;height:34px;border:none;text-align:center;font-size:0.9rem;font-weight:700;color:#333;outline:none;">
                                                <button type="button" onclick="Sales.changeQty('servicoQty',1)" style="width:34px;height:34px;border:none;background:#e1f5fe;color:#0277bd;font-size:16px;font-weight:700;cursor:pointer;">+</button>
                                            </div>
                                        </div>
                                        <button type="button" onclick="Sales.addServico()"
                                            style="flex:1;padding:10px;border-radius:10px;border:none;background:linear-gradient(135deg,#039be5,#0277bd);color:#fff;font-weight:700;font-size:0.83rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;box-shadow:0 3px 10px rgba(2,119,189,0.25);">
                                            <i class="fas fa-plus-circle"></i> Adicionar Serviço
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- TOTAIS -->
                    <div class="cliente-card">
                        <h3>💰 TOTAIS</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Subtotal</label>
                                <div class="form-control" id="subtotalDisplay" aria-live="polite">R$ 0,00</div>
                            </div>
                            <div class="form-group">
                                <label for="discountValue">Desconto (R$)</label>
                                <input type="text" inputmode="numeric" id="discountValue" class="form-control" value="0" placeholder="0,00" oninput="Utils.maskMoney(this); Sales.calculateTotal()">
                            </div>
                            <div class="form-group">
                                <label for="additionValue">Acréscimo (R$)</label>
                                <input type="text" inputmode="numeric" id="additionValue" class="form-control" value="0" placeholder="0,00" oninput="Utils.maskMoney(this); Sales.calculateTotal()">
                            </div>
                            <div class="form-group">
                                <label>TOTAL</label>
                                <div class="form-control" id="totalDisplay" style="font-weight: bold; color: var(--primary);" aria-live="polite">R$ 0,00</div>
                            </div>
                        </div>
                    </div>

                    <!-- FORMA DE PAGAMENTO -->
                    <div class="cliente-card">
                        <h3>💳 FORMA DE PAGAMENTO</h3>

                        <!-- SELEÇÃO DE MÉTODO -->
                        <div id="paymentSingleMode">
                            <div class="payment-methods">
                                <button type="button" class="payment-card" data-method="pix" onclick="Sales.selectPayment('pix')">
                                    <i class="fas fa-qrcode"></i>
                                    <span>PIX</span>
                                    <small>5% desc</small>
                                </button>
                                <button type="button" class="payment-card" data-method="cash" onclick="Sales.selectPayment('cash')">
                                    <i class="fas fa-money-bill-wave"></i>
                                    <span>Dinheiro</span>
                                    <small>3% desc</small>
                                </button>
                                <button type="button" class="payment-card" data-method="debit" onclick="Sales.selectPayment('debit')">
                                    <i class="fas fa-credit-card"></i>
                                    <span>Débito</span>
                                    <small>à vista</small>
                                </button>
                                <button type="button" class="payment-card" data-method="credit" onclick="Sales.selectPayment('credit')">
                                    <i class="far fa-credit-card"></i>
                                    <span>Crédito</span>
                                    <small>parcelado</small>
                                </button>
                                <button type="button" class="payment-card active" data-method="installment" onclick="Sales.selectPayment('installment')">
                                    <i class="fas fa-calendar-alt"></i>
                                    <span>Crediário</span>
                                    <small>próprio</small>
                                </button>
                            </div>
                        </div>

                        <!-- ── TOGGLE: pagamento único / duplo ── -->
                        <div style="display:flex;align-items:center;gap:10px;margin:10px 0 4px;">
                            <label style="font-size:0.8rem;font-weight:600;color:var(--gray);">Modo:</label>
                            <button type="button" id="btnModoSimples" onclick="Sales.setDualMode(false)"
                                style="padding:5px 14px;border-radius:20px;border:2px solid var(--primary);background:var(--primary);color:#fff;font-size:0.78rem;font-weight:700;cursor:pointer;">
                                💳 Simples
                            </button>
                            <button type="button" id="btnModoDuplo" onclick="Sales.setDualMode(true)"
                                style="padding:5px 14px;border-radius:20px;border:2px solid var(--primary);background:#fff;color:var(--primary);font-size:0.78rem;font-weight:700;cursor:pointer;">
                                💳+💳 2 Formas
                            </button>
                        </div>

                        <!-- ── PAINEL PAGAMENTO DUPLO ── -->
                        <div id="dualPaymentPanel" style="display:none;background:#fff8f0;border:2px solid #ffcc80;border-radius:12px;padding:14px;margin-top:8px;">
                            <div style="font-weight:700;color:#e65100;font-size:0.88rem;margin-bottom:10px;">⚡ Dividir em 2 formas de pagamento</div>

                            <!-- Forma 1 -->
                            <div style="margin-bottom:10px;">
                                <div style="font-size:0.78rem;font-weight:600;color:#666;margin-bottom:4px;">1ª Forma</div>
                                <div style="display:flex;gap:8px;align-items:center;">
                                    <select id="dual1Method" class="form-control" style="flex:1.2;font-size:0.83rem;" onchange="Sales.calcDual()">
                                        <option value="pix">PIX</option>
                                        <option value="cash">Dinheiro</option>
                                        <option value="debit">Débito</option>
                                        <option value="credit">Crédito</option>
                                        <option value="installment">Crediário</option>
                                    </select>
                                    <input type="number" id="dual1Value" class="form-control" placeholder="R$ 0,00" min="0" step="0.01"
                                        style="flex:1;font-size:0.9rem;font-weight:700;" oninput="Sales.calcDual()">
                                </div>
                                <div id="dual1Crediario" style="display:none;margin-top:8px;background:#fff3e0;border:1px solid #ffb74d;border-radius:8px;padding:10px;">
                                    <div style="font-size:0.78rem;font-weight:600;color:#e65100;margin-bottom:6px;">📅 Crediário — 1ª forma</div>
                                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;">
                                        <div><label style="font-size:11px;color:#666;">Entrada (R$)</label><input type="number" id="dual1Entry" class="form-control" value="0" min="0" step="0.01" style="font-size:0.83rem;" oninput="Sales.calcDual()"></div>
                                        <div><label style="font-size:11px;color:#666;">Retirada (R$)</label><input type="number" id="dual1Retirada" class="form-control" value="0" min="0" step="0.01" style="font-size:0.83rem;" oninput="Sales.calcDual()"></div>
                                        <div><label style="font-size:11px;color:#666;">Nº Parcelas</label><input type="number" id="dual1Parcelas" class="form-control" value="2" min="1" max="48" style="font-size:0.83rem;" oninput="Sales.calcDual()"></div>
                                    </div>
                                    <div style="margin-top:6px;font-size:0.78rem;color:#e65100;" id="dual1ParcelaInfo">—</div>
                                </div>
                            </div>

                            <!-- Forma 2 -->
                            <div style="margin-bottom:10px;">
                                <div style="font-size:0.78rem;font-weight:600;color:#666;margin-bottom:4px;">2ª Forma</div>
                                <div style="display:flex;gap:8px;align-items:center;">
                                    <select id="dual2Method" class="form-control" style="flex:1.2;font-size:0.83rem;" onchange="Sales.calcDual()">
                                        <option value="pix">PIX</option>
                                        <option value="cash" selected>Dinheiro</option>
                                        <option value="debit">Débito</option>
                                        <option value="credit">Crédito</option>
                                        <option value="installment">Crediário</option>
                                    </select>
                                    <input type="number" id="dual2Value" class="form-control" placeholder="R$ 0,00" min="0" step="0.01"
                                        style="flex:1;font-size:0.9rem;font-weight:700;" oninput="Sales.calcDual()">
                                </div>
                                <div id="dual2Crediario" style="display:none;margin-top:8px;background:#fff3e0;border:1px solid #ffb74d;border-radius:8px;padding:10px;">
                                    <div style="font-size:0.78rem;font-weight:600;color:#e65100;margin-bottom:6px;">📅 Crediário — 2ª forma</div>
                                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;">
                                        <div><label style="font-size:11px;color:#666;">Entrada (R$)</label><input type="number" id="dual2Entry" class="form-control" value="0" min="0" step="0.01" style="font-size:0.83rem;" oninput="Sales.calcDual()"></div>
                                        <div><label style="font-size:11px;color:#666;">Retirada (R$)</label><input type="number" id="dual2Retirada" class="form-control" value="0" min="0" step="0.01" style="font-size:0.83rem;" oninput="Sales.calcDual()"></div>
                                        <div><label style="font-size:11px;color:#666;">Nº Parcelas</label><input type="number" id="dual2Parcelas" class="form-control" value="2" min="1" max="48" style="font-size:0.83rem;" oninput="Sales.calcDual()"></div>
                                    </div>
                                    <div style="margin-top:6px;font-size:0.78rem;color:#e65100;" id="dual2ParcelaInfo">—</div>
                                </div>
                            </div>

                            <!-- Resumo -->
                            <div style="background:#fff;border-radius:8px;border:1px solid #ffe0b2;padding:10px;font-size:0.83rem;">
                                <div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span style="color:#666;">Total da OS:</span><strong id="dualTotalOS">R$ 0,00</strong></div>
                                <div style="display:flex;justify-content:space-between;margin-bottom:4px;"><span style="color:#666;">Total distribuído:</span><strong id="dualTotalDistrib">R$ 0,00</strong></div>
                                <div id="dualDiffRow" style="display:none;justify-content:space-between;padding:4px 8px;border-radius:6px;background:#ffebee;">
                                    <span style="color:#c62828;font-weight:700;">Falta / Excede:</span>
                                    <strong id="dualDiffVal" style="color:#c62828;">R$ 0,00</strong>
                                </div>
                                <div id="dualOkRow" style="display:none;padding:4px 8px;border-radius:6px;background:#e8f5e9;text-align:center;font-weight:700;color:#2e7d32;">✅ Valores conferem!</div>
                            </div>
                        </div>

                        <!-- ════════════════════════════════════════
                             PAINÉIS DE PAGAMENTO — reconstruídos zero
                             Status parcelas: 'aberto'|'pago'|'vencido'
                             PIX 5% e Dinheiro 3%: desconto salvo no total
                             ════════════════════════════════════════ -->

                        <!-- ── PIX ── -->
                        <div id="pixDetails" class="d-none">
                            <div style="background:#e8f9f3;border:1.5px solid #a5d6a7;border-radius:12px;padding:16px;margin-top:12px;">
                                <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                                    <i class="fas fa-qrcode" style="font-size:2.2rem;color:#00a884;"></i>
                                    <div style="flex:1;">
                                        <div style="font-weight:800;color:#00695c;font-size:14px;">Pagamento via PIX</div>
                                        <div style="font-size:12px;color:#555;margin-top:4px;">Chave: <strong id="companyPix">—</strong>
                                            <button type="button" onclick="Sales.copyPixKey()" style="margin-left:6px;padding:2px 8px;background:#00a884;color:white;border:none;border-radius:6px;font-size:11px;cursor:pointer;"><i class="fas fa-copy"></i> Copiar</button>
                                        </div>
                                        <label style="display:inline-flex;align-items:center;gap:6px;margin-top:6px;cursor:pointer;font-size:13px;color:#2e7d32;font-weight:600;">
                                            <input type="checkbox" id="pixDescontoAtivo" checked onchange="Sales.PAY.pixCalc.call(Sales.PAY)" style="width:16px;height:16px;cursor:pointer;">
                                            Aplicar desconto PIX (5%) — opcional
                                        </label>
                                    </div>
                                </div>
                                <div style="background:#fff;border-radius:8px;border:1px solid #c8e6c9;overflow:hidden;">
                                    <div style="display:flex;justify-content:space-between;padding:8px 14px;border-bottom:1px solid #e8f5e9;">
                                        <span style="color:#555;font-size:13px;">Valor bruto:</span>
                                        <span id="pixBruto" style="font-weight:700;font-size:13px;">R$ 0,00</span>
                                    </div>
                                    <div style="display:flex;justify-content:space-between;padding:8px 14px;border-bottom:1px solid #e8f5e9;">
                                        <span style="color:#2e7d32;font-size:13px;">Desconto PIX (5%):</span>
                                        <span id="pixDesconto" style="color:#2e7d32;font-weight:700;font-size:13px;">- R$ 0,00</span>
                                    </div>
                                    <div style="display:flex;justify-content:space-between;padding:10px 14px;background:#e8f9f3;">
                                        <span style="color:#00695c;font-weight:800;font-size:15px;">💰 Valor a pagar:</span>
                                        <span id="pixFinal" style="color:#00695c;font-weight:900;font-size:18px;">R$ 0,00</span>
                                    </div>
                                </div>
                                <div style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                                    <div>
                                        <label style="font-size:12px;font-weight:600;color:#555;display:block;margin-bottom:4px;">Entrada paga (R$)</label>
                                        <input type="number" id="pixEntrada" class="form-control" value="0" min="0" step="0.01" oninput="Sales.PAY.retirada('pix')">
                                    </div>
                                    <div>
                                        <label style="font-size:12px;font-weight:600;color:#555;display:block;margin-bottom:4px;">Restante na retirada</label>
                                        <div id="pixRetirada" class="form-control" style="font-weight:800;color:#c62828;font-size:1rem;">R$ 0,00</div>
                                    </div>
                                </div>
                                <div id="pixAlerta" class="retirada-alert" style="display:none;margin-top:8px;">
                                    <i class="fas fa-glasses"></i>
                                    <div><div style="font-size:12px;font-weight:700;color:#e65100;text-transform:uppercase;">⚠️ Cobrar na retirada</div>
                                    <div class="valor" id="pixAlertaVal">R$ 0,00</div></div>
                                </div>
                            </div>
                        </div>

                        <!-- ── DINHEIRO ── -->
                        <div id="cashDetails" class="d-none">
                            <div style="background:#f1f8e9;border:1.5px solid #aed581;border-radius:12px;padding:16px;margin-top:12px;">
                                <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
                                    <i class="fas fa-money-bill-wave" style="font-size:2rem;color:#2e7d32;"></i>
                                    <div style="flex:1;">
                                        <div style="font-weight:800;color:#1b5e20;font-size:14px;">Pagamento em Dinheiro</div>
                                        <label style="display:inline-flex;align-items:center;gap:6px;margin-top:6px;cursor:pointer;font-size:13px;color:#2e7d32;font-weight:600;">
                                            <input type="checkbox" id="cashDescontoAtivo" checked onchange="Sales.PAY.cashCalc.call(Sales.PAY)" style="width:16px;height:16px;cursor:pointer;">
                                            Aplicar desconto dinheiro (3%) — opcional
                                        </label>
                                    </div>
                                </div>
                                <div style="background:#fff;border-radius:8px;border:1px solid #dcedc8;overflow:hidden;margin-bottom:12px;">
                                    <div style="display:flex;justify-content:space-between;padding:8px 14px;border-bottom:1px solid #f1f8e9;">
                                        <span style="color:#555;font-size:13px;">Valor bruto:</span>
                                        <span id="cashBruto" style="font-weight:700;font-size:13px;">R$ 0,00</span>
                                    </div>
                                    <div style="display:flex;justify-content:space-between;padding:8px 14px;border-bottom:1px solid #f1f8e9;">
                                        <span style="color:#2e7d32;font-size:13px;">Desconto dinheiro (3%):</span>
                                        <span id="cashDesconto" style="color:#2e7d32;font-weight:700;font-size:13px;">- R$ 0,00</span>
                                    </div>
                                    <div style="display:flex;justify-content:space-between;padding:10px 14px;background:#f1f8e9;">
                                        <span style="color:#1b5e20;font-weight:800;font-size:15px;">💰 Valor a pagar:</span>
                                        <span id="cashFinal" style="color:#1b5e20;font-weight:900;font-size:18px;">R$ 0,00</span>
                                    </div>
                                </div>
                                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;">
                                    <div>
                                        <label style="font-size:12px;font-weight:600;color:#555;display:block;margin-bottom:4px;">Valor recebido (R$)</label>
                                        <input type="number" id="cashRecebido" class="form-control" value="0" min="0" step="0.01" oninput="Sales.PAY.cashChange()">
                                    </div>
                                    <div>
                                        <label style="font-size:12px;font-weight:600;color:#2e7d32;display:block;margin-bottom:4px;">Troco</label>
                                        <div id="cashTroco" class="form-control" style="font-weight:800;color:#2e7d32;font-size:1rem;">R$ 0,00</div>
                                    </div>
                                    <div>
                                        <label style="font-size:12px;font-weight:600;color:#555;display:block;margin-bottom:4px;">Entrada paga (R$)</label>
                                        <input type="number" id="cashEntrada" class="form-control" value="0" min="0" step="0.01" oninput="Sales.PAY.retirada('cash')">
                                    </div>
                                </div>
                                <div id="cashAlerta" class="retirada-alert" style="display:none;margin-top:8px;">
                                    <i class="fas fa-glasses"></i>
                                    <div><div style="font-size:12px;font-weight:700;color:#e65100;text-transform:uppercase;">⚠️ Cobrar na retirada</div>
                                    <div class="valor" id="cashAlertaVal">R$ 0,00</div></div>
                                </div>
                            </div>
                        </div>

                        <!-- ── DÉBITO ── -->
                        <div id="debitDetails" class="d-none">
                            <div style="background:#e3f2fd;border:1.5px solid #90caf9;border-radius:12px;padding:16px;margin-top:12px;">
                                <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
                                    <i class="fas fa-credit-card" style="font-size:2rem;color:#1565c0;"></i>
                                    <div style="font-weight:800;color:#0d47a1;font-size:14px;">Cartão de Débito — <span id="debitResumo" style="font-weight:700;">à vista</span></div>
                                </div>
                                <div style="background:#fff;border-radius:8px;border:1px solid #bbdefb;overflow:hidden;margin-bottom:12px;">
                                    <div style="display:flex;justify-content:space-between;padding:10px 14px;">
                                        <span style="color:#555;font-size:13px;">Valor a cobrar:</span>
                                        <span id="debitTotal" style="font-weight:900;font-size:18px;color:#0d47a1;">R$ 0,00</span>
                                    </div>
                                </div>
                                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;align-items:end;">
                                    <div>
                                        <label style="font-size:12px;font-weight:600;color:#555;display:block;margin-bottom:4px;">Bandeira</label>
                                        <select id="debitBandeira" class="form-control">
                                            <option value="visa">Visa</option>
                                            <option value="mastercard">Mastercard</option>
                                            <option value="elo">Elo</option>
                                            <option value="cabal">Cabal</option>
                                            <option value="outros">Outros</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="font-size:12px;font-weight:600;color:#555;display:block;margin-bottom:4px;">Entrada paga (R$)</label>
                                        <input type="number" id="debitEntrada" class="form-control" value="0" min="0" step="0.01" oninput="Sales.PAY.retirada('debit')">
                                    </div>
                                    <div>
                                        <label style="font-size:12px;font-weight:600;color:#555;display:block;margin-bottom:4px;">Restante na retirada</label>
                                        <div id="debitRetirada" class="form-control" style="font-weight:800;color:#c62828;font-size:1rem;">R$ 0,00</div>
                                    </div>
                                </div>
                                <div id="debitAlerta" class="retirada-alert" style="display:none;margin-top:8px;">
                                    <i class="fas fa-glasses"></i>
                                    <div><div style="font-size:12px;font-weight:700;color:#e65100;text-transform:uppercase;">⚠️ Cobrar na retirada</div>
                                    <div class="valor" id="debitAlertaVal">R$ 0,00</div></div>
                                </div>
                            </div>
                        </div>

                        <!-- ── CRÉDITO ── -->
                        <div id="creditDetails" class="d-none">
                            <div style="background:#f3e5f5;border:1.5px solid #ce93d8;border-radius:12px;padding:16px;margin-top:12px;">
                                <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;">
                                    <i class="far fa-credit-card" style="font-size:2rem;color:#6a1b9a;"></i>
                                    <div style="font-weight:800;color:#4a148c;font-size:14px;">Cartão de Crédito</div>
                                </div>
                                <div style="background:#fff;border-radius:8px;border:1px solid #e1bee7;overflow:hidden;margin-bottom:12px;">
                                    <div style="display:flex;justify-content:space-between;padding:10px 14px;">
                                        <span style="color:#555;font-size:13px;">Total a parcelar:</span>
                                        <span id="creditTotal" style="font-weight:900;font-size:18px;color:#4a148c;">R$ 0,00</span>
                                    </div>
                                </div>
                                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:12px;">
                                    <div>
                                        <label style="font-size:12px;font-weight:600;color:#555;display:block;margin-bottom:4px;">Bandeira</label>
                                        <select id="creditBandeira" class="form-control">
                                            <option value="visa">Visa</option>
                                            <option value="mastercard">Mastercard</option>
                                            <option value="elo">Elo</option>
                                            <option value="amex">American Express</option>
                                            <option value="hipercard">Hipercard</option>
                                            <option value="outros">Outros</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="font-size:12px;font-weight:600;color:#555;display:block;margin-bottom:4px;">Parcelas</label>
                                        <select id="creditParcelas" class="form-control" onchange="Sales.PAY.creditCalc()">
                                            <option value="1">1x — sem juros</option>
                                            <option value="2">2x — sem juros</option>
                                            <option value="3">3x — sem juros</option>
                                            <option value="4">4x — sem juros</option>
                                            <option value="5">5x — sem juros</option>
                                            <option value="6" selected>6x — 2,5% a.m.</option>
                                            <option value="7">7x — 2,5% a.m.</option>
                                            <option value="8">8x — 2,5% a.m.</option>
                                            <option value="9">9x — 2,5% a.m.</option>
                                            <option value="10">10x — 2,5% a.m.</option>
                                            <option value="11">11x — 2,5% a.m.</option>
                                            <option value="12">12x — 2,5% a.m.</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="font-size:12px;font-weight:600;color:#6a1b9a;display:block;margin-bottom:4px;">Valor por parcela</label>
                                        <div id="creditParcelaVal" class="form-control" style="font-weight:800;color:#4a148c;font-size:1.1rem;">R$ 0,00</div>
                                    </div>
                                </div>
                                <div id="creditResumoBox" style="background:#fff;border-radius:8px;border:1px solid #e1bee7;padding:10px 14px;font-size:12px;color:#555;margin-bottom:12px;"></div>
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                                    <div>
                                        <label style="font-size:12px;font-weight:600;color:#555;display:block;margin-bottom:4px;">Entrada paga (R$) — opcional</label>
                                        <input type="number" id="creditEntrada" class="form-control" value="0" min="0" step="0.01" oninput="Sales.PAY.retirada('credit')">
                                    </div>
                                    <div>
                                        <label style="font-size:12px;font-weight:600;color:#555;display:block;margin-bottom:4px;">Restante na retirada</label>
                                        <div id="creditRetirada" class="form-control" style="font-weight:800;color:#c62828;font-size:1rem;">R$ 0,00</div>
                                    </div>
                                </div>
                                <div id="creditAlerta" class="retirada-alert" style="display:none;margin-top:8px;">
                                    <i class="fas fa-glasses"></i>
                                    <div><div style="font-size:12px;font-weight:700;color:#e65100;text-transform:uppercase;">⚠️ Cobrar na retirada</div>
                                    <div class="valor" id="creditAlertaVal">R$ 0,00</div></div>
                                </div>
                            </div>
                        </div>

                        <!-- ── CREDIÁRIO ── -->
                        <div id="installmentDetails">
                            <div class="entrada-retirada-box" style="margin-top:12px;margin-bottom:14px;">
                                <h5><i class="fas fa-hand-holding-usd"></i> Entrada &amp; Retirada</h5>
                                <div class="form-row" style="margin-bottom:0;">
                                    <div class="form-group">
                                        <label>Entrada (%)</label>
                                        <div class="input-group">
                                            <input type="number" id="entryPercent" class="form-control" value="0" min="0" max="100" step="5" oninput="Sales.PAY.instFromPercent()">
                                            <span class="input-group-text">%</span>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>Valor da Entrada (R$)</label>
                                        <input type="text" inputmode="numeric" class="form-control" id="entryValue" style="font-weight:800;color:#2e7d32;font-size:1.05rem;" placeholder="0,00" oninput="Utils.maskMoney(this); Sales.PAY.instFromValue()" value="0">
                                    </div>
                                    <div class="form-group">
                                        <label>Valor na Retirada (R$)</label>
                                        <input type="text" inputmode="numeric" class="form-control" id="retiradaEntry" style="font-weight:800;color:#e65100;font-size:1.05rem;" placeholder="0,00" oninput="Utils.maskMoney(this); Sales.PAY.instFromValue()" value="0">
                                    </div>
                                    <div class="form-group">
                                        <label>Nº de Parcelas</label>
                                        <select id="installmentCount" class="form-control" onchange="Sales.PAY.instFromValue()">
                                            <option value="1">1x</option>
                                            <option value="2" selected>2x</option>
                                            <option value="3">3x</option>
                                            <option value="4">4x</option>
                                            <option value="5">5x</option>
                                            <option value="6">6x</option>
                                            <option value="7">7x</option>
                                            <option value="8">8x</option>
                                            <option value="9">9x</option>
                                            <option value="10">10x</option>
                                            <option value="11">11x</option>
                                            <option value="12">12x</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Valor da Parcela</label>
                                        <div class="form-control" id="installmentValue" style="background:var(--light);font-weight:800;color:var(--primary);font-size:1.05rem;">R$ 0,00</div>
                                    </div>
                                </div>
                            </div>
                            <div class="retirada-alert" id="retiradaAlert" style="display:none;">
                                <i class="fas fa-glasses"></i>
                                <div>
                                    <div style="font-size:12px;font-weight:700;color:#e65100;text-transform:uppercase;">⚠️ Valor a pagar na retirada</div>
                                    <div class="valor" id="retiradaValor">R$ 0,00</div>
                                    <div style="font-size:11px;color:#777;margin-top:2px;" id="retiradaInfo"></div>
                                </div>
                            </div>
                            <div class="form-row" style="margin-top:12px;">
                                <div class="form-group">
                                    <label for="lateFee">Multa por atraso (%)</label>
                                    <div class="input-group">
                                        <input type="number" id="lateFee" class="form-control" value="2" step="0.1" min="0" max="10">
                                        <span class="input-group-text danger">%</span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="dailyInterest">Juros ao dia (%)</label>
                                    <div class="input-group">
                                        <input type="number" id="dailyInterest" class="form-control" value="0.033" step="0.001" min="0" max="1">
                                        <span class="input-group-text warning">% a.d.</span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="firstDueDate">Primeiro Vencimento</label>
                                    <input type="date" id="firstDueDate" class="form-control" onchange="Sales.PAY.instFromValue()">
                                </div>
                                <div class="form-group">
                                    <label for="fixedDay">Dia Fixo</label>
                                    <select id="fixedDay" class="form-control" onchange="Sales.setFixedDay()">
                                        <option value="">Manter data original</option>
                                        <option value="5">Dia 5</option>
                                        <option value="10">Dia 10</option>
                                        <option value="15">Dia 15</option>
                                        <option value="20">Dia 20</option>
                                        <option value="25">Dia 25</option>
                                        <option value="30">Dia 30</option>
                                    </select>
                                </div>
                            </div>
                            <div class="resumo-crediario">
                                <div class="resumo-item"><div class="resumo-label">Total da Venda</div><div class="resumo-valor" id="totalSaleValue">R$ 0,00</div></div>
                                <div class="resumo-item"><div class="resumo-label">Entrada</div><div class="resumo-valor" id="entrySummary">R$ 0,00</div></div>
                                <div class="resumo-item"><div class="resumo-label">Saldo Parcelado</div><div class="resumo-valor" id="balanceSummary">R$ 0,00</div></div>
                                <div class="resumo-item"><div class="resumo-label">Parcelas</div><div class="resumo-valor" id="totalParcelsSummary">0x</div></div>
                            </div>
                            <div style="overflow-x:auto;margin-top:12px;border-radius:8px;border:1px solid #ebebeb;">
                                <table style="width:100%;border-collapse:collapse;font-size:12px;">
                                    <thead><tr style="background:linear-gradient(90deg,#e65100,#ff6b00);color:white;">
                                        <th style="padding:8px 10px;text-align:center;">Parcela</th>
                                        <th style="padding:8px 10px;text-align:center;">Vencimento</th>
                                        <th style="padding:8px 10px;text-align:right;">Valor</th>
                                        <th style="padding:8px 10px;text-align:center;">Status</th>
                                        <th style="padding:8px 10px;text-align:center;">Data Pag.</th>
                                        <th style="padding:8px 10px;text-align:right;">Valor Pago</th>
                                        <th style="padding:8px 10px;text-align:center;">Atraso</th>
                                        <th style="padding:8px 10px;text-align:right;">Multa+Juros</th>
                                        <th style="padding:8px 10px;text-align:center;">Ações</th>
                                    </tr></thead>
                                    <tbody id="installmentsTableBody"></tbody>
                                </table>
                            </div>
                        </div>

                    </div>
                    <!-- OBSERVAÇÕES -->
                    <div class="cliente-card">
                        <h3>📝 OBSERVAÇÕES</h3>
                        <textarea id="saleObservations" class="form-control" rows="3" placeholder="Observações sobre a OS, lentes, entregas..."></textarea>
                    </div>

                    <!-- BOTÕES DE AÇÃO -->
                    <div class="btn-group justify-between" style="margin-top: 20px;">
                        <div>
                            <button type="button" class="btn btn-secondary" onclick="Sales.clearForm()">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn btn-success" onclick="Sales.save()">
                                <i class="fas fa-save"></i> Salvar OS
                            </button>
                            <button type="button" class="btn btn-warning" onclick="Sales.finalize()">
                                <i class="fas fa-check"></i> Finalizar Venda
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Histórico de Vendas -->
                <div class="table-container no-print">
                    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:0.75rem;margin-bottom:1rem;">
                        <h3 style="margin:0;">Histórico de Vendas</h3>
                        <span class="sales-count-badge" id="salesCountBadge">0 OS</span>
                    </div>
                    <div class="sales-search-bar">
                        <input type="text" id="searchSaleHistory" placeholder="🔍 Buscar por OS, cliente, valor..." oninput="Sales.filterHistory()" autocomplete="off">
                        <select id="filterSaleStatus" onchange="Sales.filterHistory()">
                            <option value="">Todos os status</option>
                            <option value="orcamento">📋 Orçamento</option>
                            <option value="pendente">⏳ Pendente</option>
                            <option value="producao">🔧 Em Produção</option>
                            <option value="laboratorio">🔬 Laboratório</option>
                            <option value="tratamento">🧪 Tratamento</option>
                            <option value="atrasado">⚠️ Atrasado</option>
                            <option value="pronto">📦 Pronto p/ Retirada</option>
                            <option value="entregue">✅ Entregue</option>
                            <option value="cancelado">❌ Cancelado</option>
                        </select>
                        <select id="filterSalePeriod" onchange="Sales.filterHistory()">
                            <option value="">Qualquer período</option>
                            <option value="today">Hoje</option>
                            <option value="week">Esta semana</option>
                            <option value="month">Este mês</option>
                            <option value="year">Este ano</option>
                        </select>
                        <button class="btn btn-secondary btn-sm" onclick="Sales.clearHistoryFilter()" title="Limpar filtros"><i class="fas fa-times"></i> Limpar</button>
                    </div>
                    <table id="salesHistoryTable">
                        <thead>
                            <tr>
                                <th>Nº O.S</th>
                                <th>Cliente</th>
                                <th>Total</th>
                                <th>Pagamento</th>
                                <th>Status</th>
                                <th>Data</th>
                                <th>Ações</th>
                                <th><i class="fas fa-file-pdf" style="color:#dc3545"></i></th>
                                <th><i class="fab fa-whatsapp" style="color:#25d366"></i></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- Seção Clientes -->
            <section id="clients" class="section" aria-labelledby="pageTitle">
                <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem;margin-bottom:1.5rem;">
                    <div>
                        <h2 class="section-title" style="margin-bottom:0.25rem;border-bottom:none;">👥 Clientes</h2>
                        <span style="font-size:0.85rem;color:var(--gray);">Cadastro e gerenciamento de clientes</span>
                    </div>
                    <!-- Botões de exportar/importar -->
                    <div class="btn-group">
                        <button class="btn btn-info btn-sm" onclick="Clients.exportToExcel()"><i class="fas fa-file-excel"></i> Exportar Excel</button>
                        <button class="btn btn-success btn-sm" onclick="document.getElementById('importClientsFile').click()"><i class="fas fa-upload"></i> Importar</button>
                        <input type="file" id="importClientsFile" accept=".xlsx,.csv" class="d-none" onchange="Clients.importFromFile(event)">
                    </div>
                </div>

                <!-- Dados Pessoais -->
                <div class="cliente-card">
                    <h3>📋 DADOS PESSOAIS</h3>
                    <form id="clientForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="clientCode">Código</label>
                                <input type="text" id="clientCode" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label for="clientBirthDate">Data de Nascimento</label>
                                <input type="date" id="clientBirthDate" class="form-control">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="clientName" class="required">Nome</label>
                                <input type="text" id="clientName" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="clientPhone">Telefone</label>
                                <input type="text" id="clientPhone" class="form-control" oninput="App.maskPhone(this)">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="clientEmail">Email</label>
                                <input type="email" id="clientEmail" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="clientCpf">CPF/CNPJ</label>
                                <input type="text" id="clientCpf" class="form-control" oninput="App.maskCpfCnpj(this)">
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Endereço -->
                <div class="cliente-card">
                    <h3>📍 ENDEREÇO</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="clientCep">CEP</label>
                            <input type="text" id="clientCep" class="form-control" oninput="App.maskCep(this)" onblur="App.buscarCepCompleto(this)" maxlength="9" placeholder="00000-000">
                        </div>
                        <div class="form-group">
                            <label for="clientAddress">Logradouro</label>
                            <input type="text" id="clientAddress" class="form-control">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="clientNumber">Número</label>
                            <input type="text" id="clientNumber" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="clientComplement">Complemento</label>
                            <input type="text" id="clientComplement" class="form-control">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="clientNeighborhood">Bairro</label>
                            <input type="text" id="clientNeighborhood" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="clientCity">Cidade</label>
                            <input type="text" id="clientCity" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="clientState">Estado (UF)</label>
                            <input type="text" id="clientState" class="form-control" maxlength="2" style="text-transform:uppercase">
                        </div>
                    </div>
                </div>

                <!-- Receituário -->
                <div class="presc-container">
                    <div class="presc-header">
                        <div>
                            <div class="presc-title">RECEITUÁRIO</div>
                            <div class="presc-subtitle">Prescrição de Lentes Corretivas</div>
                        </div>
                        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
                            <button type="button" class="btn btn-pdf" onclick="Presc.exportClientPrescToPDF()">
                                <i class="fas fa-file-pdf"></i> GERAR PDF RECEITUÁRIO
                            </button>
                            <button type="button" class="btn" style="background:#25d366;color:white;border:none;" onclick="Sales.enviarReceituarioWhatsApp()">
                                <i class="fab fa-whatsapp"></i> ENVIAR VIA WHATSAPP
                            </button>
                        </div>
                    </div>
                    
                    <div class="presc-profissionais">
                        <div>
                            <label style="font-weight: 600; color: var(--primary);"><i class="fas fa-user-md"></i> Optometrista</label>
                            <input type="text" id="clientPrescOptometrist" class="form-control" placeholder="Nome do optometrista">
                        </div>
                        <div>
                            <label style="font-weight: 600; color: var(--primary);"><i class="fas fa-calendar"></i> Data da Consulta</label>
                            <input type="date" id="clientPrescDate" class="form-control">
                        </div>
                    </div>

                    <!-- Tabela LONGE -->
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: var(--primary);">LONGE</h4>
                        <div class="presc-scroll-hint"><i class="fas fa-arrows-left-right"></i> Deslize para ver mais</div>
                        <div class="presc-table-wrapper">
                        <table class="presc-table">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>ESF</th>
                                    <th>CIL</th>
                                    <th>EIXO</th>
                                    <th>ADIÇÃO</th>
                                    <th>DNP</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="font-weight: bold;">OD</td>
                                    <td>
                                        <div class="presc-stepper">
                                            <button type="button" onclick="Presc.stepValue('clientOdSph', -20, 20, 0.25, -1)" data-tooltip="Diminuir">−</button>
                                            <input type="text" id="clientOdSph" value="0.00" readonly class="presc-field" ondblclick="Presc.resetField('clientOdSph')" onchange="Presc.updateClientPertoOD()">
                                            <button type="button" onclick="Presc.stepValue('clientOdSph', -20, 20, 0.25, 1)" data-tooltip="Aumentar">+</button>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="presc-stepper">
                                            <button type="button" onclick="Presc.stepValue('clientOdCyl', -6, 0, 0.25, -1)" style="background: var(--danger);" data-tooltip="Diminuir">−</button>
                                            <input type="text" id="clientOdCyl" value="0.00" readonly class="presc-field negative" ondblclick="Presc.resetField('clientOdCyl')" onchange="Presc.updateClientPertoOD()">
                                        </div>
                                    </td>
                                    <td>
                                        <input type="text" id="clientOdAxis" class="presc-field" onblur="Presc.formatAxis(this)" onchange="Presc.updateClientPertoEixoOD()" placeholder="0°" ondblclick="this.value='0°'" data-tooltip="Duplo clique para zerar">
                                    </td>
                                    <td>
                                        <div class="presc-stepper">
                                            <input type="text" id="clientOdAdd" value="0.00" readonly class="presc-field positive" ondblclick="Presc.resetField('clientOdAdd')" onchange="Presc.updateClientPertoOD()">
                                            <button type="button" onclick="Presc.stepValue('clientOdAdd', 0, 4, 0.25, 1)" style="background: var(--success);" data-tooltip="Aumentar">+</button>
                                        </div>
                                    </td>
                                    <td>
                                        <input type="text" id="clientOdDnp" class="presc-field" onblur="Presc.validateDnp(this); Presc.updateClientPertoOD(); Presc.updateClientDP()" placeholder="20-40mm" ondblclick="this.value=''" data-tooltip="Duplo clique para limpar">
                                    </td>
                                </tr>
                                <tr>
                                    <td style="font-weight: bold;">OE</td>
                                    <td>
                                        <div class="presc-stepper">
                                            <button type="button" onclick="Presc.stepValue('clientOeSph', -20, 20, 0.25, -1)" data-tooltip="Diminuir">−</button>
                                            <input type="text" id="clientOeSph" value="0.00" readonly class="presc-field" ondblclick="Presc.resetField('clientOeSph')" onchange="Presc.updateClientPertoOE()">
                                            <button type="button" onclick="Presc.stepValue('clientOeSph', -20, 20, 0.25, 1)" data-tooltip="Aumentar">+</button>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="presc-stepper">
                                            <button type="button" onclick="Presc.stepValue('clientOeCyl', -6, 0, 0.25, -1)" style="background: var(--danger);" data-tooltip="Diminuir">−</button>
                                            <input type="text" id="clientOeCyl" value="0.00" readonly class="presc-field negative" ondblclick="Presc.resetField('clientOeCyl')" onchange="Presc.updateClientPertoOE()">
                                        </div>
                                    </td>
                                    <td>
                                        <input type="text" id="clientOeAxis" class="presc-field" onblur="Presc.formatAxis(this)" onchange="Presc.updateClientPertoEixoOE()" placeholder="0°" ondblclick="this.value='0°'" data-tooltip="Duplo clique para zerar">
                                    </td>
                                    <td>
                                        <div class="presc-stepper">
                                            <input type="text" id="clientOeAdd" value="0.00" readonly class="presc-field positive" ondblclick="Presc.resetField('clientOeAdd')" onchange="Presc.updateClientPertoOE()">
                                            <button type="button" onclick="Presc.stepValue('clientOeAdd', 0, 4, 0.25, 1)" style="background: var(--success);" data-tooltip="Aumentar">+</button>
                                        </div>
                                    </td>
                                    <td>
                                        <input type="text" id="clientOeDnp" class="presc-field" onblur="Presc.validateDnp(this); Presc.updateClientPertoOE(); Presc.updateClientDP()" placeholder="20-40mm" ondblclick="this.value=''" data-tooltip="Duplo clique para limpar">
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        </div>
                    </div>

                    <!-- Tabela PERTO -->
                    <div style="margin-bottom: 30px;">
                        <h4 style="color: var(--success);">PERTO</h4>
                        <div class="presc-scroll-hint"><i class="fas fa-arrows-left-right"></i> Deslize para ver mais</div>
                        <div class="presc-table-wrapper">
                        <table class="presc-table">
                            <thead>
                                <tr>
                                    <th style="background: var(--success);"></th>
                                    <th style="background: var(--success);">ESF</th>
                                    <th style="background: var(--success);">CIL</th>
                                    <th style="background: var(--success);">EIXO</th>
                                    <th style="background: var(--success);">DNP</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="font-weight: bold;">OD</td>
                                    <td><input type="text" id="clientOdNearSph" readonly value="0.00" class="presc-field" style="background: #f0f9f0;"></td>
                                    <td><input type="text" id="clientOdNearCyl" readonly value="0.00" class="presc-field negative" style="background: #f0f9f0;"></td>
                                    <td><input type="text" id="clientOdNearAxis" readonly value="0°" class="presc-field" style="background: #f0f9f0;"></td>
                                    <td><input type="text" id="clientOdNearDnp" readonly value="0.0" class="presc-field" style="background: #e7f3ff;"></td>
                                </tr>
                                <tr>
                                    <td style="font-weight: bold;">OE</td>
                                    <td><input type="text" id="clientOeNearSph" readonly value="0.00" class="presc-field" style="background: #f0f9f0;"></td>
                                    <td><input type="text" id="clientOeNearCyl" readonly value="0.00" class="presc-field negative" style="background: #f0f9f0;"></td>
                                    <td><input type="text" id="clientOeNearAxis" readonly value="0°" class="presc-field" style="background: #f0f9f0;"></td>
                                    <td><input type="text" id="clientOeNearDnp" readonly value="0.0" class="presc-field" style="background: #e7f3ff;"></td>
                                </tr>
                            </tbody>
                        </table>
                        </div>
                    </div>

                    <!-- Medidas -->
                    <div class="presc-medidas">
                        <div class="medida-card">
                            <div class="medida-icon primary"><i class="fas fa-ruler"></i></div>
                            <div class="medida-content">
                                <div class="medida-label">DP Longe</div>
                                <div class="medida-value">
                                    <input type="text" id="clientPrescDp" readonly value="0.0" class="form-control" style="width: 80px;"> <span class="medida-unit">mm</span>
                                </div>
                            </div>
                        </div>
                        <div class="medida-card">
                            <div class="medida-icon success"><i class="fas fa-arrows-alt-v"></i></div>
                            <div class="medida-content">
                                <div class="medida-label">Altura</div>
                                <div class="medida-value">
                                    <input type="text" id="clientPrescHeight" class="presc-field" onblur="Presc.validateNumber(this, 10, 35)" placeholder="0.0" style="width: 80px;" ondblclick="this.value=''" data-tooltip="Duplo clique para limpar">
                                    <span class="medida-unit">mm</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Observações -->
                    <div style="margin-top: 20px; background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 8px;">
                        <label style="font-weight: 600; color: #856404; margin-bottom: 10px;">
                            <i class="fas fa-sticky-note"></i> Observações
                        </label>
                        <textarea id="clientPrescNotes" class="presc-obs" rows="3" placeholder="Anotações sobre a prescrição, observações do cliente, recomendações especiais..."></textarea>
                    </div>

                    <!-- Botões do receituário -->
                    <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="Clients.clearPresc()">
                            <i class="fas fa-eraser"></i> LIMPAR
                        </button>
                    </div>

                    <!-- Botão salvar cliente -->
                    <div class="btn-group" style="margin-top: 20px;">
                        <button type="submit" form="clientForm" class="btn btn-primary">
                            <i class="fas fa-save"></i> SALVAR CLIENTE
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="Clients.clearForm()">
                            <i class="fas fa-broom"></i> LIMPAR
                        </button>
                    </div>
                </div>

                <!-- Tabela de Clientes (com coluna Receita) -->
                <div class="table-container">
                    <div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:1rem;flex-wrap:wrap;">
                        <div style="flex:1;min-width:200px;position:relative;">
                            <i class="fas fa-search" style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--gray);"></i>
                            <input type="text" id="searchClient" class="form-control" placeholder="Buscar por nome, CPF, telefone..." onkeyup="Clients.search()" style="padding-left:36px;">
                        </div>
                        <span id="clientsCountBadge" style="background:var(--primary);color:white;padding:4px 14px;border-radius:20px;font-size:0.82rem;font-weight:700;white-space:nowrap;"></span>
                    </div>
                    <table id="clientsTable">
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Nome</th>
                                <th>Telefone</th>
                                <th>CPF</th>
                                <th>Nascimento</th>
                                <th>Cidade/UF</th>
                                <th>Ações</th>
                                <th>Receita</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- Seção Produtos -->
            <section id="products" class="section" aria-labelledby="pageTitle">
                <h2 class="section-title">Produtos</h2>
                <div class="form-container">
                    <form id="productForm" novalidate>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="productCode">Código</label>
                                <input type="text" id="productCode" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="productCategory" class="required">Categoria</label>
                                <select id="productCategory" class="form-control" required>
                                    <option value="lentes">Lentes</option>
                                    <option value="armacoes">Armações</option>
                                    <option value="oculos_sol">Óculos de Sol</option>
                                    <option value="tratamentos">Tratamentos</option>
                                    <option value="coloracao">Coloração</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="productName" class="required">Nome</label>
                                <input type="text" id="productName" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="productCostPrice">Preço de Custo (R$)</label>
                                <input type="text" inputmode="numeric" id="productCostPrice" class="form-control" placeholder="0,00" oninput="Utils.maskMoney(this)" required>
                            </div>
                            <div class="form-group">
                                <label for="productPrice">Preço de Venda (R$)</label>
                                <input type="text" inputmode="numeric" id="productPrice" class="form-control" placeholder="0,00" oninput="Utils.maskMoney(this)" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="productQty">Estoque</label>
                                <input type="number" id="productQty" class="form-control" value="0" min="0">
                            </div>
                            <div class="form-group">
                                <label for="productMinQty">Estoque Mínimo</label>
                                <input type="number" id="productMinQty" class="form-control" value="5" min="0">
                            </div>
                            <div class="form-group">
                                <label for="productImage">Imagem</label>
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <div class="image-preview" id="productImagePreview" onclick="document.getElementById('productImageInput').click()">
                                        <img id="productImageImg" src="" style="display: none;">
                                        <i id="productImagePlaceholder" class="fas fa-camera"></i>
                                    </div>
                                    <input type="file" id="productImageInput" accept="image/*" class="d-none" onchange="Products.uploadImage(event)">
                                    <button type="button" class="btn btn-secondary btn-sm" onclick="Products.removeImage()">Remover</button>
                                </div>
                            </div>
                        </div>
                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary">Salvar</button>
                            <button type="button" class="btn btn-secondary" onclick="Products.clearForm()">Limpar</button>
                        </div>
                    </form>
                </div>
                <div class="table-container">
                    <input type="text" id="searchProduct" class="form-control" placeholder="🔍 Buscar produto..." onkeyup="Products.search()" style="margin-bottom: 1.5rem;">
                    <table id="productsTable">
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Imagem</th>
                                <th>Nome</th>
                                <th>Categoria</th>
                                <th>Custo</th>
                                <th>Preço</th>
                                <th>Estoque</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- Seção Serviços -->
            <section id="services" class="section" aria-labelledby="pageTitle">
                <h2 class="section-title">Serviços</h2>
                <div class="form-container">
                    <form id="serviceForm" novalidate>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="serviceCode">Código</label>
                                <input type="text" id="serviceCode" class="form-control" readonly>
                            </div>
                            <div class="form-group">
                                <label for="serviceName" class="required">Nome</label>
                                <input type="text" id="serviceName" class="form-control" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="serviceValue">Valor (R$)</label>
                                <input type="number" id="serviceValue" class="form-control" step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="serviceDesc">Descrição</label>
                            <textarea id="serviceDesc" class="form-control" rows="3"></textarea>
                        </div>
                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary">Salvar</button>
                            <button type="button" class="btn btn-secondary" onclick="Services.clearForm()">Limpar</button>
                        </div>
                    </form>
                </div>
                <div class="table-container">
                    <table id="servicesTable">
                        <thead><tr><th>Código</th><th>Nome</th><th>Valor</th><th>Ações</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- Seção Fornecedores (ATUALIZADA) -->
            <section id="suppliers" class="section" aria-labelledby="pageTitle">
                <h2 class="section-title">Fornecedores</h2>
                <div class="form-container">
                    <form id="supplierForm" novalidate>
                        <div class="form-row">
                            <div class="form-group"><label for="supplierCode">Código</label><input type="text" id="supplierCode" class="form-control" readonly></div>
                            <div class="form-group"><label for="supplierName" class="required">Nome</label><input type="text" id="supplierName" class="form-control" required></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label for="supplierCnpj">CNPJ</label>
                                <div style="display: flex; gap: 0.5rem;">
                                    <input type="text" id="supplierCnpj" class="form-control" oninput="App.maskCnpj(this)" onblur="App.buscarCnpjCompleto(this)" maxlength="18" placeholder="00.000.000/0000-00">
                                    <button type="button" class="btn btn-secondary" onclick="App.buscarCnpjCompleto(document.getElementById('supplierCnpj'))" title="Buscar dados do CNPJ">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="form-group"><label for="supplierIe">Inscrição Estadual</label><input type="text" id="supplierIe" class="form-control"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label for="supplierPhone">Telefone</label><input type="text" id="supplierPhone" class="form-control" oninput="App.maskPhone(this)"></div>
                            <div class="form-group"><label for="supplierEmail">Email</label><input type="email" id="supplierEmail" class="form-control"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label for="supplierCep">CEP</label><input type="text" id="supplierCep" class="form-control" oninput="App.maskCep(this)" onblur="App.buscarCepFornecedor(this)" maxlength="9" placeholder="00000-000"></div>
                            <div class="form-group"><label for="supplierAddress">Logradouro</label><input type="text" id="supplierAddress" class="form-control"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label for="supplierNumber">Número</label><input type="text" id="supplierNumber" class="form-control"></div>
                            <div class="form-group"><label for="supplierComplement">Complemento</label><input type="text" id="supplierComplement" class="form-control"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label for="supplierNeighborhood">Bairro</label><input type="text" id="supplierNeighborhood" class="form-control"></div>
                            <div class="form-group"><label for="supplierCity">Cidade</label><input type="text" id="supplierCity" class="form-control"></div>
                            <div class="form-group"><label for="supplierState">UF</label><input type="text" id="supplierState" class="form-control" maxlength="2" style="text-transform:uppercase"></div>
                        </div>
                        <div class="form-group"><label for="supplierProducts">Produtos / Observações</label><textarea id="supplierProducts" class="form-control" rows="3"></textarea></div>
                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary">Salvar</button>
                            <button type="button" class="btn btn-secondary" onclick="Suppliers.clearForm()">Limpar</button>
                        </div>
                    </form>
                </div>
                <div class="table-container">
                    <table id="suppliersTable">
                        <thead><tr><th>Código</th><th>Nome</th><th>CNPJ</th><th>Telefone</th><th>Cidade/UF</th><th>Ações</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- Seção Despesas (PROFISSIONALIZADA) -->
            <section id="expenses" class="section" aria-labelledby="pageTitle">
                <h2 class="section-title">Despesas</h2>
                <div class="form-container">
                    <form id="expenseForm" novalidate>
                        <div class="form-row">
                            <div class="form-group"><label for="expenseDate">Data</label><input type="date" id="expenseDate" class="form-control" required></div>
                            <div class="form-group"><label for="expenseDesc" class="required">Descrição</label><input type="text" id="expenseDesc" class="form-control" required></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label for="expenseCategory">Categoria</label>
                                <select id="expenseCategory" class="form-control">
                                    <option value="aluguel">Aluguel</option>
                                    <option value="agua">Água</option>
                                    <option value="energia">Energia</option>
                                    <option value="telefone">Telefone/Internet</option>
                                    <option value="salarios">Salários</option>
                                    <option value="impostos">Impostos</option>
                                    <option value="material">Material de Consumo</option>
                                    <option value="manutencao">Manutenção</option>
                                    <option value="marketing">Marketing</option>
                                    <option value="outros">Outros</option>
                                </select>
                            </div>
                            <div class="form-group"><label for="expenseSupplier">Fornecedor (opcional)</label>
                                <select id="expenseSupplier" class="form-control">
                                    <option value="">-- Selecione um fornecedor --</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label for="expenseValue" class="required">Valor (R$)</label><input type="text" inputmode="numeric" id="expenseValue" class="form-control" placeholder="0,00" oninput="Utils.maskMoney(this)" required></div>
                            <div class="form-group"><label for="expensePaymentMethod">Forma de Pagamento</label>
                                <select id="expensePaymentMethod" class="form-control">
                                    <option value="dinheiro">Dinheiro</option>
                                    <option value="pix">PIX</option>
                                    <option value="debito">Débito</option>
                                    <option value="credito">Crédito</option>
                                    <option value="boleto">Boleto</option>
                                </select>
                            </div>
                            <div class="form-group"><label for="expenseStatus">Status</label>
                                <select id="expenseStatus" class="form-control">
                                    <option value="pago">Pago</option>
                                    <option value="pendente">Pendente</option>
                                    <option value="vencido">Vencido</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group"><label for="expenseNotes">Observações</label><textarea id="expenseNotes" class="form-control" rows="2"></textarea></div>
                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary">Salvar Despesa</button>
                            <button type="button" class="btn btn-secondary" onclick="Expenses.clearForm()">Limpar</button>
                        </div>
                    </form>
                </div>
                <div class="table-container">
                    <h3 class="mb-3">Resumo do Mês</h3>
                    <div class="resumo-crediario" style="margin-bottom: 2rem;">
                        <div class="resumo-item"><div class="resumo-label">Total Despesas</div><div class="resumo-valor" id="expensesTotalMonth">R$ 0,00</div></div>
                        <div class="resumo-item"><div class="resumo-label">Pendentes</div><div class="resumo-valor" id="expensesPending">R$ 0,00</div></div>
                        <div class="resumo-item"><div class="resumo-label">Pagas</div><div class="resumo-valor" id="expensesPaid">R$ 0,00</div></div>
                    </div>
                    <table id="expensesTable">
                        <thead><tr><th>Data</th><th>Descrição</th><th>Categoria</th><th>Valor</th><th>Forma</th><th>Status</th><th>Ações</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>

            <!-- Seção Relatórios (ATUALIZADA) -->
            <section id="reports" class="section" aria-labelledby="pageTitle">
                <h2 class="section-title">Relatórios</h2>
                <div class="form-container">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="reportType">Tipo de Relatório</label>
                            <select id="reportType" class="form-control">
                                <optgroup label="📦 Vendas">
                                    <option value="sales">Todas as Vendas (O.S.)</option>
                                    <option value="sales_by_status">Vendas por Status</option>
                                    <option value="sales_by_client">Vendas por Cliente</option>
                                    <option value="sales_by_seller">Vendas por Vendedor</option>
                                    <option value="sales_crediario">Crediário em Aberto</option>
                                    <option value="overdue">O.S. Vencidas há mais de 1 ano</option>
                                </optgroup>
                                <optgroup label="💰 Financeiro">
                                    <option value="financial_summary">Resumo Financeiro</option>
                                    <option value="expenses">Despesas</option>
                                    <option value="expenses_by_category">Despesas por Categoria</option>
                                    <option value="profit">Faturamento vs Despesas</option>
                                </optgroup>
                                <optgroup label="📦 Estoque & Produtos">
                                    <option value="stock">Estoque Atual</option>
                                    <option value="stock_low">Estoque Baixo / Esgotado</option>
                                    <option value="products_sold">Produtos Mais Vendidos</option>
                                </optgroup>
                                <optgroup label="👥 Clientes">
                                    <option value="clients">Lista de Clientes</option>
                                    <option value="birthdays">Aniversariantes do Mês</option>
                                    <option value="clients_no_purchase">Clientes sem Compra Recente</option>
                                </optgroup>
                                <optgroup label="📦 Outros">
                                    <option value="services">Serviços Cadastrados</option>
                                    <option value="suppliers">Fornecedores</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="reportPeriod">Período</label>
                            <select id="reportPeriod" class="form-control">
                                <option value="today">Hoje</option>
                                <option value="week">Últimos 7 dias</option>
                                <option value="month" selected>Este mês</option>
                                <option value="last_month">Mês anterior</option>
                                <option value="quarter">Últimos 3 meses</option>
                                <option value="year">Este ano</option>
                                <option value="all">Todo o período</option>
                                <option value="custom">Período personalizado</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row" id="reportCustomDates" style="display:none;">
                        <div class="form-group">
                            <label for="reportDateFrom">Data Início</label>
                            <input type="date" id="reportDateFrom" class="form-control">
                        </div>
                        <div class="form-group">
                            <label for="reportDateTo">Data Fim</label>
                            <input type="date" id="reportDateTo" class="form-control">
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="Reports.generate()"><i class="fas fa-chart-bar"></i> Gerar Relatório</button>
                        <button class="btn btn-secondary" onclick="Reports.print()"><i class="fas fa-print"></i> Imprimir</button>
                        <button class="btn btn-secondary" onclick="Reports.exportCSV()"><i class="fas fa-file-csv"></i> Exportar CSV</button>
                    </div>
                </div>
                <div class="table-container" id="reportContainer" style="overflow-x:auto;"></div>
            </section>

            <!-- Seção Configurações -->
            <section id="config" class="section" aria-labelledby="pageTitle">
                <h2 class="section-title">Configurações do Sistema</h2>
                
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem; border-bottom: 2px solid var(--light-gray); padding-bottom: 0.5rem; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="Config.showTab('empresa', event)">
                        <i class="fas fa-building"></i> Empresa
                    </button>
                    <button class="btn btn-secondary" onclick="Config.showTab('financeiro', event)">
                        <i class="fas fa-chart-line"></i> Financeiro
                    </button>
                    <button class="btn btn-secondary" onclick="Config.showTab('notificacoes', event)">
                        <i class="fas fa-bell"></i> Notificações
                    </button>
                    <button class="btn btn-secondary" onclick="Config.showTab('backup', event)">
                        <i class="fas fa-database"></i> Backup
                    </button>
                    <button class="btn btn-secondary" onclick="Config.showTab('usuarios', event)">
                        <i class="fas fa-users-cog"></i> Usuários
                    </button>
                    <button class="btn btn-secondary" onclick="Config.showTab('wppMensagens', event); ConfigWpp.init()">
                        <i class="fab fa-whatsapp" style="color:#25d366"></i> Mensagens WhatsApp
                    </button>
                    <button class="btn btn-secondary" onclick="Config.showTab('fiscal', event)">
                        <i class="fas fa-file-invoice"></i> Fiscal / NF-e
                    </button>
                </div>

                <!-- Aba Empresa -->
                <div id="tabEmpresa" class="config-tab">
                    <div class="form-container">
                        <h3 style="color: var(--primary); margin-bottom: 1.5rem;">Dados da Empresa</h3>

                        <!-- SELETOR DE LOJA -->
                        <div style="background: linear-gradient(135deg, #fff3e0, #ffe0b2); border: 2px solid #ff6b00; border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem;">
                            <h4 style="color: #e55a00; margin-bottom: 1rem; display:flex; align-items:center; gap: 0.5rem;">
                                <i class="fas fa-store"></i> Selecionar Loja
                            </h4>
                            <p style="color: #6c757d; font-size: 0.88rem; margin-bottom: 1rem;">
                                Escolha uma loja para preencher automaticamente os dados cadastrais, ou preencha manualmente.
                            </p>
                            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                                <button type="button" class="btn btn-primary" onclick="Config.preencherLoja('barueri')" style="flex:1; min-width:180px;">
                                    <i class="fas fa-map-marker-alt"></i> Loja Barueri
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="Config.preencherLoja('caucaia')" style="flex:1; min-width:180px; background:#6610f2; color:white; border-color:#6610f2;">
                                    <i class="fas fa-map-marker-alt"></i> Loja Caucaia do Alto
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="Config.limparLoja()" style="flex:1; min-width:140px;">
                                    <i class="fas fa-eraser"></i> Limpar
                                </button>
                            </div>
                            <div id="lojaAtualBadge" style="display:none; margin-top:0.75rem; padding:0.5rem 1rem; background:white; border-radius:8px; font-size:0.85rem; font-weight:600; color:#e55a00; border:1px solid #ff6b00;">
                                <i class="fas fa-check-circle" style="color:#28a745;"></i> <span id="lojaAtualTxt"></span>
                            </div>
                        </div>

                        <form id="configForm" novalidate>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="configName" class="required">Nome Fantasia</label>
                                    <input type="text" id="configName" class="form-control" required>
                                </div>
                                <div class="form-group">
                                    <label for="configLegalName">Razão Social</label>
                                    <input type="text" id="configLegalName" class="form-control">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="configCnpj">CNPJ</label>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <input type="text" id="configCnpj" class="form-control" oninput="App.maskCnpj(this)" onblur="App.buscarCnpj(this)" maxlength="18" placeholder="00.000.000/0000-00">
                                        <button type="button" class="btn btn-secondary" onclick="App.buscarCnpj(document.getElementById('configCnpj'))" title="Buscar dados do CNPJ">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                    <small style="color: var(--gray);">Digite o CNPJ e clique na lupa para buscar</small>
                                </div>
                                <div class="form-group">
                                    <label for="configIe">Inscrição Estadual</label>
                                    <input type="text" id="configIe" class="form-control">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="configPhone">Telefone</label>
                                    <input type="text" id="configPhone" class="form-control" oninput="App.maskPhone(this)">
                                </div>
                                <div class="form-group">
                                    <label for="configWhatsapp">WhatsApp</label>
                                    <input type="text" id="configWhatsapp" class="form-control" oninput="App.maskPhone(this)">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="configEmail">E-mail</label>
                                    <input type="email" id="configEmail" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="configWebsite">Website</label>
                                    <input type="url" id="configWebsite" class="form-control">
                                </div>
                            </div>

                            <h4 style="color: var(--primary); margin: 1.5rem 0 1rem;">Endereço da Matriz</h4>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="configCep">CEP</label>
                                    <input type="text" id="configCep" class="form-control" oninput="App.maskCep(this)" onblur="App.buscarCepConfig(this)" maxlength="9" placeholder="00000-000">
                                </div>
                                <div class="form-group">
                                    <label for="configAddress">Logradouro</label>
                                    <input type="text" id="configAddress" class="form-control">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="configNumber">Número</label>
                                    <input type="text" id="configNumber" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="configComplement">Complemento</label>
                                    <input type="text" id="configComplement" class="form-control">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="configNeighborhood">Bairro</label>
                                    <input type="text" id="configNeighborhood" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="configCity">Cidade</label>
                                    <input type="text" id="configCity" class="form-control">
                                </div>
                                <div class="form-group">
                                    <label for="configState">UF</label>
                                    <input type="text" id="configState" class="form-control" maxlength="2" style="text-transform:uppercase">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="configPrimaryColor">Cor Primária</label>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <input type="color" id="configPrimaryColor" class="form-control" style="width: 60px; height: 45px; padding: 0.25rem;" value="#ff6b00">
                                        <input type="text" id="configPrimaryColorText" class="form-control" value="#ff6b00">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="configSecondaryColor">Cor Secundária</label>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <input type="color" id="configSecondaryColor" class="form-control" style="width: 60px; height: 45px; padding: 0.25rem;" value="#ffcc00">
                                        <input type="text" id="configSecondaryColorText" class="form-control" value="#ffcc00">
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Logo da Empresa</label>
                                <div style="display: flex; align-items: center; gap: 1.5rem; flex-wrap: wrap;">
                                    <div id="configLogoBox" style="width:100px;height:100px;border-radius:50%;overflow:hidden;border:3px dashed #ff6b00;display:flex;align-items:center;justify-content:center;background:var(--light);flex-shrink:0;cursor:pointer;" onclick="document.getElementById('configLogoUpload').click()">
                                        <img id="configLogoPreview" src="" style="width:100%;height:100%;object-fit:contain;object-position:center;display:none;border-radius:0;">
                                        <i id="configLogoPlaceholder" class="fas fa-image" style="font-size: 2.5rem; color: var(--gray);"></i>
                                    </div>
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('configLogoUpload').click()">
                                            <i class="fas fa-upload"></i> Selecionar Logo
                                        </button>
                                        <button type="button" class="btn btn-danger" onclick="Config.removeLogo()">
                                            <i class="fas fa-trash"></i> Remover
                                        </button>
                                        <input type="file" id="configLogoUpload" accept="image/*" class="d-none" onchange="Config.uploadLogo(event)">
                                    </div>
                                </div>
                            </div>

                            <div class="btn-group" style="margin-top: 1.5rem;">
                                <button type="submit" class="btn btn-success">Salvar Configurações</button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Aba Financeiro -->
                <div id="tabFinanceiro" class="config-tab" style="display: none;">
                    <div class="form-container">
                        <h3 style="color: var(--primary); margin-bottom: 1.5rem;">Configurações Financeiras</h3>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="configCreditTax">Juros Cartão de Crédito (% ao mês)</label>
                                <input type="number" id="configCreditTax" class="form-control" value="2.5" step="0.1" min="0" max="20">
                            </div>
                            <div class="form-group">
                                <label for="configWarranty">Garantia Padrão (dias)</label>
                                <input type="number" id="configWarranty" class="form-control" value="90" min="0" max="365">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="configCommission">Comissão Vendedores (%)</label>
                                <input type="number" id="configCommission" class="form-control" value="5" step="0.5" min="0" max="100">
                            </div>
                            <div class="form-group">
                                <label for="configDeliveryFee">Taxa de Entrega (R$)</label>
                                <input type="number" id="configDeliveryFee" class="form-control" value="0" step="0.01" min="0">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="configNextOs">Próximo Nº OS</label>
                                <input type="number" id="configNextOs" class="form-control" min="1">
                            </div>
                            <div class="form-group">
                                <label for="configNfSeries">Série da NF</label>
                                <input type="text" id="configNfSeries" class="form-control" value="001" maxlength="3">
                            </div>
                        </div>

                        <h4 style="color: var(--primary); margin: 1.5rem 0 1rem;">Formas de Pagamento</h4>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem;">
                            <label class="flex items-center gap-2"><input type="checkbox" id="configPaymentPix" checked> PIX</label>
                            <label class="flex items-center gap-2"><input type="checkbox" id="configPaymentCash" checked> Dinheiro</label>
                            <label class="flex items-center gap-2"><input type="checkbox" id="configPaymentDebit" checked> Débito</label>
                            <label class="flex items-center gap-2"><input type="checkbox" id="configPaymentCredit" checked> Crédito</label>
                            <label class="flex items-center gap-2"><input type="checkbox" id="configPaymentInstallment" checked> Crediário</label>
                        </div>

                        <div class="btn-group" style="margin-top: 1.5rem;">
                            <button type="button" class="btn btn-success" onclick="Config.saveFinanceiro()">Salvar Financeiro</button>
                        </div>
                    </div>
                </div>

                <!-- Aba Notificações -->
                <div id="tabNotificacoes" class="config-tab" style="display: none;">
                    <div class="form-container">
                        <h3 style="color: var(--primary); margin-bottom: 1.5rem;">Configurações de Notificações</h3>

                        <div style="margin-bottom: 1.5rem;">
                            <h4>Alertas de Estoque</h4>
                            <div style="display: grid; gap: 0.75rem; margin-top: 0.5rem;">
                                <label class="flex items-center gap-2"><input type="checkbox" id="configNotifyLowStock" checked> Notificar quando estoque estiver baixo</label>
                                <label class="flex items-center gap-2"><input type="checkbox" id="configNotifyOutOfStock" checked> Notificar quando produto esgotar</label>
                            </div>
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <h4>Ordens de Serviço</h4>
                            <div style="display: grid; gap: 0.75rem; margin-top: 0.5rem;">
                                <label class="flex items-center gap-2"><input type="checkbox" id="configNotifyOsReady" checked> Notificar quando OS ficar pronta</label>
                                <label class="flex items-center gap-2"><input type="checkbox" id="configNotifyOsDelay" checked> Notificar OS atrasadas</label>
                                <div class="form-group" style="margin-left: 1.5rem;">
                                    <label for="configOsDelayDays">Dias para considerar atraso:</label>
                                    <input type="number" id="configOsDelayDays" class="form-control" value="7" min="1" style="width: 100px;">
                                </div>
                            </div>
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <h4>Financeiro</h4>
                            <div style="display: grid; gap: 0.75rem; margin-top: 0.5rem;">
                                <label class="flex items-center gap-2"><input type="checkbox" id="configNotifyPaymentDue" checked> Notificar contas a vencer</label>
                                <label class="flex items-center gap-2"><input type="checkbox" id="configNotifyPaymentOverdue" checked> Notificar contas vencidas</label>
                            </div>
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <h4>WhatsApp</h4>
                            <div style="display: grid; gap: 0.75rem; margin-top: 0.5rem;">
                                <label class="flex items-center gap-2"><input type="checkbox" id="configWhatsappNotify"> Enviar notificações via WhatsApp</label>
                                <div class="form-group" style="margin-left: 1.5rem;">
                                    <label for="configWhatsappNumber">Número do WhatsApp (com DDD):</label>
                                    <input type="text" id="configWhatsappNumber" class="form-control" oninput="App.maskPhone(this)">
                                </div>
                            </div>
                        </div>

                        <div class="btn-group" style="margin-top: 1.5rem;">
                            <button type="button" class="btn btn-success" onclick="Config.saveNotificacoes()">Salvar Notificações</button>
                        </div>
                    </div>
                </div>

                <!-- Aba Backup -->
                <div id="tabBackup" class="config-tab" style="display: none;">
                    <div class="form-container">
                        <h3 style="color: var(--primary); margin-bottom: 1.5rem;"><i class="fas fa-database"></i> Backup e Restauração</h3>

                        <!-- AÇÕES RÁPIDAS -->
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.5rem;">
                            <button class="btn btn-primary" onclick="App.exportBackup()" style="padding:1rem;font-size:1rem;font-weight:700;border-radius:12px;display:flex;align-items:center;justify-content:center;gap:0.5rem;">
                                <i class="fas fa-download" style="font-size:1.2rem;"></i> Fazer Backup
                            </button>
                            <button class="btn btn-secondary" onclick="document.getElementById('importBackupConfig').click()" style="padding:1rem;font-size:1rem;font-weight:700;border-radius:12px;display:flex;align-items:center;justify-content:center;gap:0.5rem;">
                                <i class="fas fa-upload" style="font-size:1.2rem;"></i> Restaurar
                            </button>
                            <input type="file" id="importBackupConfig" class="d-none" accept=".json" onchange="App.importBackup(event)">
                        </div>

                        <!-- SYNC RÁPIDO -->
                        <div style="background: linear-gradient(135deg, #1e1e2e, #2a2a3e); border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem; display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:1rem;">
                            <div style="display:flex; align-items:center; gap:0.75rem;">
                                <div id="syncBtnStatusDot" style="width:12px;height:12px;border-radius:50%;background:#a6e3a1;box-shadow:0 0 6px #a6e3a1;flex-shrink:0;"></div>
                                <div>
                                    <div style="color:white;font-weight:700;font-size:0.95rem;">⚡ Local-First Sync</div>
                                    <div id="syncBtnStatusText" style="color:#a6adc8;font-size:0.78rem;margin-top:2px;">Último sync: <span id="syncBtnLastTime">—</span></div>
                                </div>
                            </div>
                            <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
                                <button class="btn btn-sm" style="background:#3ecf8e;color:#000;font-weight:700;" onclick="LocalFirst.sync('manual').then(()=>{ const t=new Date().toLocaleTimeString('pt-BR'); document.getElementById('syncBtnLastTime').textContent=t; Toast.show('Sync concluído!','success'); })">
                                    <i class="fas fa-sync"></i> Sincronizar Agora
                                </button>
                            </div>
                        </div>

                        <!-- STATUS DO BACKUP AUTOMÁTICO -->
                        <div id="backupStatusCard" style="background: var(--light); border-radius: 12px; padding: 1.25rem; margin-bottom: 1.5rem; border-left: 4px solid var(--gray);">
                            <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:0.75rem;">
                                <div style="display:flex; align-items:center; gap:0.75rem;">
                                    <div id="backupStatusIcon" style="width:42px;height:42px;border-radius:50%;background:#e9ecef;display:flex;align-items:center;justify-content:center;font-size:1.2rem;">⏸️</div>
                                    <div>
                                        <div id="backupStatusTitle" style="font-weight:700; font-size:0.95rem; color:var(--dark);">Backup automático desativado</div>
                                        <div id="backupStatusSub" style="font-size:0.8rem; color:var(--gray); margin-top:2px;">Ative para proteger seus dados diariamente</div>
                                    </div>
                                </div>
                                <div id="backupStatusBadge" style="padding:4px 14px;border-radius:20px;font-size:0.78rem;font-weight:700;background:#e9ecef;color:var(--gray);">INATIVO</div>
                            </div>
                        </div>

                        <!-- CONFIGURAÇÃO DO BACKUP DIÁRIO -->
                        <div style="background: var(--light); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid rgba(0,0,0,0.06);">
                            <h4 style="color: var(--primary); margin-bottom: 1.25rem; display:flex; align-items:center; gap:0.5rem;">
                                <i class="fas fa-clock"></i> Backup Automático Diário
                            </h4>

                            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:1.25rem; margin-bottom:1.25rem;">

                                <!-- Toggle ativar -->
                                <div class="form-group">
                                    <label style="font-weight:600; margin-bottom:0.5rem; display:block;">Status</label>
                                    <div style="display:flex; align-items:center; gap:0.75rem;">
                                        <label class="toggle-switch" style="position:relative;display:inline-block;width:52px;height:28px;cursor:pointer;">
                                            <input type="checkbox" id="configBackupAutoEnabled"
                                                style="opacity:0;width:0;height:0;position:absolute;"
                                                onchange="Config.saveBackupConfig()">
                                            <span style="position:absolute;inset:0;background:#ccc;border-radius:28px;transition:.3s;"
                                                id="toggleBg"></span>
                                            <span style="position:absolute;left:3px;top:3px;width:22px;height:22px;background:white;border-radius:50%;transition:.3s;box-shadow:0 1px 4px rgba(0,0,0,0.2);"
                                                id="toggleKnob"></span>
                                        </label>
                                        <span id="backupToggleLabel" style="font-size:0.88rem;color:var(--gray);">Desativado</span>
                                    </div>
                                </div>

                                <!-- Horário -->
                                <div class="form-group">
                                    <label for="configBackupHour" style="font-weight:600; margin-bottom:0.5rem; display:block;">
                                        Horário do backup
                                    </label>
                                    <select id="configBackupHour" class="form-control" onchange="Config.saveBackupConfig()">
                                        <option value="0">00:00 — Meia-noite</option>
                                        <option value="1">01:00</option>
                                        <option value="2">02:00</option>
                                        <option value="3" selected>03:00 — Recomendado</option>
                                        <option value="4">04:00</option>
                                        <option value="5">05:00</option>
                                        <option value="6">06:00 — Manhã cedo</option>
                                        <option value="12">12:00 — Meio-dia</option>
                                        <option value="18">18:00 — Final do dia</option>
                                        <option value="20">20:00 — Noite</option>
                                        <option value="22">22:00 — Antes de dormir</option>
                                        <option value="23">23:00</option>
                                    </select>
                                    <small style="color:var(--gray); font-size:0.76rem; margin-top:4px; display:block;">O sistema precisa estar aberto no horário configurado</small>
                                </div>

                                <!-- Retenção -->
                                <div class="form-group">
                                    <label for="configBackupKeepDays" style="font-weight:600; margin-bottom:0.5rem; display:block;">
                                        Manter histórico
                                    </label>
                                    <select id="configBackupKeepDays" class="form-control" onchange="Config.saveBackupConfig()">
                                        <option value="3">Últimos 3 backups</option>
                                        <option value="7" selected>Últimos 7 backups</option>
                                        <option value="14">Últimos 14 backups</option>
                                        <option value="30">Últimos 30 backups</option>
                                    </select>
                                    <small style="color:var(--gray); font-size:0.76rem; margin-top:4px; display:block;">Registros internos (não downlods automáticos)</small>
                                </div>

                            </div>

                            <!-- Info cards -->
                            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap:0.75rem; margin-top:0.5rem;">
                                <div style="background:white; border-radius:8px; padding:0.85rem; text-align:center; border:1px solid rgba(0,0,0,0.07);">
                                    <div style="font-size:0.75rem; color:var(--gray); margin-bottom:2px;">Último backup diário</div>
                                    <div id="backupInfoUltimo" style="font-weight:700; font-size:0.85rem; color:var(--dark);">Nunca</div>
                                </div>
                                <div style="background:white; border-radius:8px; padding:0.85rem; text-align:center; border:1px solid rgba(0,0,0,0.07);">
                                    <div style="font-size:0.75rem; color:var(--gray); margin-bottom:2px;">Próximo backup</div>
                                    <div id="backupInfoProximo" style="font-weight:700; font-size:0.85rem; color:var(--dark);">—</div>
                                </div>
                                <div style="background:white; border-radius:8px; padding:0.85rem; text-align:center; border:1px solid rgba(0,0,0,0.07);">
                                    <div style="font-size:0.75rem; color:var(--gray); margin-bottom:2px;">Backups no histórico</div>
                                    <div id="backupInfoContagem" style="font-weight:700; font-size:0.85rem; color:var(--dark);">0</div>
                                </div>
                            </div>
                        </div>

                        <!-- HISTÓRICO DE BACKUPS -->
                        <div style="background: var(--light); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid rgba(0,0,0,0.06);">
                            <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem; flex-wrap:wrap; gap:0.5rem;">
                                <h4 style="color: var(--primary); margin:0; display:flex; align-items:center; gap:0.5rem;">
                                    <i class="fas fa-history"></i> Histórico de Backups
                                </h4>
                                <button class="btn btn-sm btn-outline-secondary" onclick="Config.renderBackupStatus()" style="font-size:0.8rem;">
                                    <i class="fas fa-sync-alt"></i> Atualizar
                                </button>
                            </div>
                            <div id="backupHistoricoList" style="max-height:200px; overflow-y:auto;">
                                <p style="color:var(--gray); font-size:0.88rem; text-align:center; padding:1rem 0;">Nenhum backup registrado ainda</p>
                            </div>
                        </div>

                        <!-- EXPORTAR / RESTAURAR MANUAL -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 1.25rem; margin-bottom:1.5rem;">
                            <div style="background: var(--light); padding: 1.5rem; border-radius: 12px; border:1px solid rgba(0,0,0,0.06);">
                                <h4 style="color: var(--primary); margin-bottom: 1rem; display:flex;align-items:center;gap:0.5rem;">
                                    <i class="fas fa-download"></i> Exportar Backup Manual
                                </h4>
                                <p style="margin-bottom: 1rem; color: var(--gray); font-size:0.88rem;">
                                    Download completo dos dados em arquivo JSON.
                                </p>
                                <button class="btn btn-primary" onclick="App.exportBackup()" style="width: 100%;">
                                    <i class="fas fa-download"></i> Gerar Backup Agora
                                </button>
                                <button class="btn btn-outline-secondary" onclick="BackupManager.exportar()" style="width:100%; margin-top:0.5rem; font-size:0.85rem;">
                                    <i class="fas fa-clock"></i> Forçar Backup Diário
                                </button>
                            </div>

                            <div style="background: var(--light); padding: 1.5rem; border-radius: 12px; border:1px solid rgba(0,0,0,0.06);">
                                <h4 style="color: var(--primary); margin-bottom: 1rem; display:flex;align-items:center;gap:0.5rem;">
                                    <i class="fas fa-upload"></i> Restaurar Backup
                                </h4>
                                <p style="margin-bottom: 1rem; color: var(--gray); font-size:0.88rem;">
                                    Restaure dados a partir de um arquivo JSON de backup.
                                </p>
                                <button class="btn btn-secondary" onclick="document.getElementById('importBackupConfig2').click()" style="width: 100%;">
                                    <i class="fas fa-upload"></i> Selecionar Arquivo
                                </button>
                                <input type="file" id="importBackupConfig2" class="d-none" accept=".json" onchange="App.importBackup(event)">
                            </div>
                        </div>

                        <!-- SETUP SUPABASE -->
                        <div style="background: #e8f4fd; border: 1px solid #bee3f8; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                            <h4 style="color: #1a56db; margin-bottom: 0.75rem; display:flex; align-items:center; gap:0.5rem;">
                                <i class="fas fa-database"></i> Setup do Banco de Dados (Supabase)
                            </h4>
                            <p style="color: #1e429f; font-size: 0.85rem; margin-bottom: 1rem;">
                                Execute este SQL no <strong>Supabase SQL Editor</strong> para criar as <strong>8 tabelas</strong> que o app usa para sincronização: <code>clients</code>, <code>products</code>, <code>sales</code>, <code>expenses</code>, <code>prescriptions</code>, <code>suppliers</code>, <code>services</code> e <code>config</code>. Estrutura Local-First: <code>_data</code> em <strong>JSONB</strong> com <code>created_at</code> + <code>updated_at</code> automáticos. Seguro executar novamente — usa IF NOT EXISTS e migração sem perda de dados.
                            </p>
                            <div style="background:#1e1e2e;color:#a6e3a1;font-family:monospace;font-size:0.72rem;padding:1rem;border-radius:8px;max-height:320px;overflow-y:auto;line-height:1.5;margin-bottom:1rem;white-space:pre;" id="sqlSetup">-- ╔══════════════════════════════════════════════════════════════════╗
-- ║  ÓticaVision Pro — SQL Setup v3 (Local-First Sync)              ║
-- ║  Estrutura: id TEXT PK + _data JSONB + created_at + updated_at  ║
-- ║  Tabelas (8): clients, products, sales, expenses,               ║
-- ║               prescriptions, suppliers, services, config        ║
-- ║  Cole no Supabase SQL Editor e execute tudo de uma vez.         ║
-- ╚══════════════════════════════════════════════════════════════════╝

-- ── 1. FUNÇÃO updated_at automático ──────────────────────────────
CREATE OR REPLACE FUNCTION set_updated_at()
RETURNS TRIGGER AS $$
BEGIN NEW.updated_at = now(); RETURN NEW; END;
$$ LANGUAGE plpgsql;

-- ── 2. CRIA / ATUALIZA TABELAS ───────────────────────────────────
--    Estrutura Local-First: id (PK) + _data (JSONB) + timestamps
DO $$ DECLARE t TEXT;
BEGIN
  FOR t IN SELECT unnest(ARRAY[
    'clients','products','sales','expenses',
    'prescriptions','suppliers','services','config'
  ]) LOOP

    -- Cria tabela com colunas corretas
    EXECUTE format('
      CREATE TABLE IF NOT EXISTS %I (
        id         TEXT PRIMARY KEY,
        _data      JSONB NOT NULL DEFAULT ''{}''::jsonb,
        created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
        updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
      );
      -- Índices de performance
      CREATE INDEX IF NOT EXISTS idx_%I_updated_at ON %I(updated_at DESC);
      CREATE INDEX IF NOT EXISTS idx_%I_created_at ON %I(created_at DESC);
    ', t, t, t, t, t);

    -- Adiciona colunas novas em tabelas existentes (migração segura)
    BEGIN
      EXECUTE format('ALTER TABLE %I ADD COLUMN IF NOT EXISTS created_at TIMESTAMPTZ NOT NULL DEFAULT now();', t);
    EXCEPTION WHEN others THEN NULL; END;

    -- Trigger updated_at
    EXECUTE format('
      DROP TRIGGER IF EXISTS trg_%I_updated ON %I;
      CREATE TRIGGER trg_%I_updated
        BEFORE UPDATE ON %I
        FOR EACH ROW EXECUTE FUNCTION set_updated_at();
    ', t, t, t, t);

    -- Row Level Security
    EXECUTE format('ALTER TABLE %I ENABLE ROW LEVEL SECURITY;', t);
    BEGIN
      EXECUTE format('
        DROP POLICY IF EXISTS "anon_all" ON %I;
        CREATE POLICY "anon_all" ON %I
          FOR ALL TO anon USING (true) WITH CHECK (true);
      ', t, t);
    EXCEPTION WHEN duplicate_object THEN NULL;
    END;

  END LOOP;
END $$;

-- ── 3. REALTIME — só adiciona se ainda NÃO está na publicação ──────
--    (evita erro 42710: relation already member of publication)
DO $$ DECLARE t TEXT;
BEGIN
  FOR t IN SELECT unnest(ARRAY[
    'clients','products','sales','expenses',
    'prescriptions','suppliers','services','config'
  ]) LOOP
    IF NOT EXISTS (
      SELECT 1 FROM pg_publication_tables
      WHERE pubname = 'supabase_realtime' AND tablename = t
    ) THEN
      BEGIN
        EXECUTE format('ALTER PUBLICATION supabase_realtime ADD TABLE %I', t);
      EXCEPTION WHEN others THEN NULL;
      END;
    END IF;
  END LOOP;
END $$;

-- ── 4. VERIFICAÇÃO FINAL ─────────────────────────────────────────
SELECT
  t.table_name,
  (SELECT count(*) FROM information_schema.columns c
   WHERE c.table_name = t.table_name AND c.table_schema = 'public') AS colunas,
  CASE WHEN p.tablename IS NOT NULL THEN '✅ Realtime ON' ELSE '⚠️ Realtime OFF' END AS realtime
FROM information_schema.tables t
LEFT JOIN pg_publication_tables p
  ON p.tablename = t.table_name AND p.pubname = 'supabase_realtime'
WHERE t.table_schema = 'public'
  AND t.table_name IN (
    'clients','products','sales','expenses',
    'prescriptions','suppliers','services','config'
  )
ORDER BY t.table_name;
-- Resultado esperado: 8 linhas · 4 colunas · ✅ Realtime ON em todas</div>
                            <div style="position:relative;display:inline-block;margin-bottom:0.5rem;">
                                <button id="btnCopiarSQL" onclick="
                                    var sql = document.getElementById('sqlSetup').innerText;
                                    var btn = document.getElementById('btnCopiarSQL');
                                    function _ok(){ btn.innerHTML='<i class=\'fas fa-check\'></i> Copiado!'; btn.style.background='#28a745'; setTimeout(function(){ btn.innerHTML='<i class=\'fas fa-copy\'></i> Copiar SQL'; btn.style.background=''; btn.className='btn btn-primary'; },2500); Toast.show('✅ SQL copiado! Cole no Supabase SQL Editor.','success',4000); }
                                    if(navigator.clipboard){ navigator.clipboard.writeText(sql).then(_ok).catch(function(){ var t=document.createElement('textarea'); t.value=sql; document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t); _ok(); }); }
                                    else { var t=document.createElement('textarea'); t.value=sql; document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t); _ok(); }
                                " class="btn btn-primary">
                                    <i class="fas fa-copy"></i> Copiar SQL
                                </button>
                            </div>
                            <a href="https://supabase.com/dashboard/project/qhscxyistzlmxxnjrqao/sql/new" target="_blank" class="btn btn-secondary" style="margin-left:0.5rem;">
                                <i class="fas fa-external-link-alt"></i> Abrir SQL Editor
                            </a>
                            <div style="display:flex;gap:0.4rem;flex-wrap:wrap;margin-top:0.5rem;">
                                <button class="btn btn-sm" style="background:#3ecf8e;color:#000;font-weight:700;" onclick="SupaSync.syncDown()">
                                    <i class="fas fa-cloud-download-alt"></i> Sync Agora
                                </button>
                                <button class="btn btn-sm" style="background:#6366f1;color:#fff;font-weight:700;" onclick="SupaSync.verificarTabelas()">
                                    <i class="fas fa-table"></i> Verificar 8 Tabelas
                                </button>
                            </div>
                        </div>

                        <!-- ÁREA DE RISCO -->
                        <div class="risk-area" style="background: #fff3cd; border: 1px solid #ffeeba; border-radius: 10px; padding: 1.5rem;">
                            <h4 style="color: #856404; margin-bottom: 0.75rem;">
                                <i class="fas fa-exclamation-triangle"></i> Área de Risco
                            </h4>
                            <p style="color: #856404; margin-bottom: 1rem; font-size:0.88rem;">
                                Estas operações são <strong>irreversíveis</strong>. Faça um backup antes de prosseguir.
                            </p>
                            <div class="btn-group">
                                <button class="btn btn-danger" onclick="App.confirmClearData()">
                                    <i class="fas fa-trash-alt"></i> Limpar Todos os Dados
                                </button>
                                <button class="btn btn-warning" onclick="App.resetToSample()">
                                    <i class="fas fa-redo-alt"></i> Restaurar Dados de Exemplo
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Aba Usuários -->
                <div id="tabUsuarios" class="config-tab" style="display: none;">
                    <div class="form-container">
                        <h3 style="color: var(--primary); margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem; justify-content: space-between;">
                            <span><i class="fas fa-users-cog"></i> Gerenciar Usuários</span>
                            <button class="btn btn-success" onclick="Usuarios.showAddModal()">
                                <i class="fas fa-plus"></i> Novo Usuário
                            </button>
                        </h3>

                        <div style="overflow-x: auto;">
                            <table style="width: 100%; min-width: 600px;">
                                <thead>
                                    <tr>
                                        <th>Usuário</th>
                                        <th>Nome</th>
                                        <th>Perfil</th>
                                        <th>Último Acesso</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ══════════════════════════════════════════════════
                     ABA: MENSAGENS WHATSAPP
                ══════════════════════════════════════════════════ -->
                <div id="tabWppMensagens" class="config-tab" style="display: none;">
                    <div class="form-container">

                        <!-- Cabeçalho da aba -->
                        <div style="display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:1rem;margin-bottom:1.5rem;">
                            <div>
                                <h3 style="margin:0;color:#25d366;display:flex;align-items:center;gap:0.5rem;">
                                    <i class="fab fa-whatsapp"></i> Editor de Mensagens WhatsApp
                                </h3>
                                <p style="margin:6px 0 0;color:var(--gray);font-size:0.85rem;">
                                    Personalize cada mensagem. Use as <strong>variáveis</strong> que são substituídas automaticamente pelos dados reais ao enviar.
                                </p>
                            </div>
                            <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
                                <button class="btn btn-secondary" onclick="ConfigWpp.restaurarTodos()">
                                    <i class="fas fa-undo"></i> Restaurar Padrão
                                </button>
                                <button class="btn" style="background:#25d366;color:white;border:none;" onclick="ConfigWpp.salvarTodos()">
                                    <i class="fas fa-save"></i> Salvar Todas
                                </button>
                            </div>
                        </div>

                        <!-- Layout: sidebar + editor -->
                        <div class="wpp-editor-grid">

                            <!-- Sidebar de navegação -->
                            <div class="wpp-sidebar">
                                <div class="wpp-sidebar-header">
                                    <i class="fab fa-whatsapp"></i> Selecionar Mensagem
                                </div>
                                <div class="wpp-nav-item active" id="navAniversario" onclick="ConfigWpp.selectMsg('aniversario')">
                                    <div class="wpp-nav-icon" style="background:#fff3e0;">🎂</div>
                                    <div class="wpp-nav-label">
                                        Aniversário
                                        <div class="wpp-nav-desc">Dashboard · aniversariantes do dia</div>
                                    </div>
                                </div>
                                <div class="wpp-nav-item" id="navOculosVencido" onclick="ConfigWpp.selectMsg('oculosVencido')">
                                    <div class="wpp-nav-icon" style="background:#e3f2fd;">👓</div>
                                    <div class="wpp-nav-label">
                                        Óculos Vencido (+1 ano)
                                        <div class="wpp-nav-desc">Dashboard · renovação de lentes</div>
                                    </div>
                                </div>
                                <div class="wpp-nav-item" id="navStatusPedido" onclick="ConfigWpp.selectMsg('statusPedido')">
                                    <div class="wpp-nav-icon" style="background:#f3e5f5;">🔄</div>
                                    <div class="wpp-nav-label">
                                        Status do Pedido
                                        <div class="wpp-nav-desc">Histórico de vendas · por OS</div>
                                    </div>
                                </div>
                                <div class="wpp-nav-item" id="navReceituario" onclick="ConfigWpp.selectMsg('receituario')">
                                    <div class="wpp-nav-icon" style="background:#e8f5e9;">👁️</div>
                                    <div class="wpp-nav-label">
                                        Receituário
                                        <div class="wpp-nav-desc">Prescrição · lista de clientes</div>
                                    </div>
                                </div>
                                <div class="wpp-nav-item" id="navComprovante" onclick="ConfigWpp.selectMsg('comprovante')">
                                    <div class="wpp-nav-icon" style="background:#e8f5e9;">✅</div>
                                    <div class="wpp-nav-label">
                                        Comprovante
                                        <div class="wpp-nav-desc">Parcelas do crediário</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Painel editor -->
                            <div class="wpp-editor-panel">
                                <div class="wpp-editor-header">
                                    <div>
                                        <div class="wpp-editor-header-title" id="wppEditorTitle">🎂 Mensagem de Aniversário</div>
                                        <div class="wpp-editor-header-sub" id="wppEditorSub">Dashboard → botão "Parabéns" nos aniversariantes do dia</div>
                                    </div>
                                    <button class="btn btn-sm" style="background:rgba(255,255,255,0.2);color:white;border:1px solid rgba(255,255,255,0.4);font-size:0.8rem;" onclick="ConfigWpp.restaurarAtual()">
                                        <i class="fas fa-undo"></i> Restaurar este
                                    </button>
                                </div>

                                <div class="wpp-editor-body">
                                    <!-- Textarea principal -->
                                    <textarea class="wpp-textarea" id="wppTextarea" oninput="ConfigWpp.onInput()" placeholder="Digite a mensagem aqui..."></textarea>

                                    <!-- Chips de variáveis -->
                                    <div class="wpp-vars-section">
                                        <div class="wpp-vars-header">
                                            <i class="fas fa-tags"></i> Variáveis disponíveis — clique para inserir no cursor
                                        </div>
                                        <div class="wpp-vars-chips" id="wppVarsChips"></div>
                                    </div>

                                    <!-- Preview -->
                                    <div class="wpp-preview-section">
                                        <button class="wpp-preview-toggle" onclick="ConfigWpp.togglePreview()">
                                            <i class="fas fa-eye"></i> Pré-visualizar no WhatsApp
                                        </button>
                                        <div class="wpp-preview-bubble-wrap" id="wppPreviewWrap">
                                            <div class="wpp-preview-label">
                                                <i class="fab fa-whatsapp" style="color:#25d366;font-size:1rem;"></i>
                                                Como aparecerá no WhatsApp (variáveis mostradas como exemplo)
                                            </div>
                                            <div class="wpp-bubble" id="wppBubble"></div>
                                        </div>
                                    </div>
                                </div>

                                <div class="wpp-action-bar">
                                    <span class="wpp-char-count" id="wppCharCount">0 caracteres</span>
                                    <div style="display:flex;gap:0.5rem;">
                                        <button class="btn btn-secondary" onclick="ConfigWpp.restaurarAtual()">
                                            <i class="fas fa-undo"></i> Restaurar padrão
                                        </button>
                                        <button class="btn" style="background:#25d366;color:white;border:none;" onclick="ConfigWpp.salvarAtual()">
                                            <i class="fas fa-save"></i> Salvar esta mensagem
                                        </button>
                                    </div>
                                </div>
                            </div>

                        </div><!-- /grid -->
                    </div>
                </div>

                <!-- ── ABA FISCAL / NF-e ── -->
                <div id="tabFiscal" class="config-tab" style="display:none;">
                    <div class="form-container">

                        <!-- AMBIENTE SEFAZ -->
                        <div class="cliente-card">
                            <h3><i class="fas fa-server"></i> Ambiente SEFAZ</h3>
                            <div style="background:linear-gradient(135deg,#fff8e1,#fff3cd);border:1.5px solid #ffcc00;border-left:4px solid #ff6b00;border-radius:10px;padding:0.85rem 1rem;margin-bottom:1.25rem;font-size:0.83rem;color:#8a5000;">
                                <i class="fas fa-exclamation-triangle" style="color:#ff6b00;margin-right:0.4rem;"></i>
                                <strong>Atenção:</strong> Configure o ambiente de Homologação primeiro para testes. Só mude para Produção quando a emissão estiver validada.
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Ambiente</label>
                                    <select id="cfgNfeAmbiente" class="form-control" onchange="ConfigFiscal.salvarConfig()">
                                        <option value="2">🧪 Homologação (Testes)</option>
                                        <option value="1">🚀 Produção</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>UF Emitente</label>
                                    <select id="cfgNfeUF" class="form-control" onchange="ConfigFiscal.salvarConfig()">
                                        <option>SP</option><option>RJ</option><option>MG</option><option>RS</option>
                                        <option>PR</option><option>SC</option><option>BA</option><option>CE</option>
                                        <option>GO</option><option>PE</option><option>ES</option><option>AM</option>
                                        <option>PA</option><option>MT</option><option>MS</option><option>DF</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Versão do Layout</label>
                                    <select id="cfgNfeVersao" class="form-control" onchange="ConfigFiscal.salvarConfig()">
                                        <option value="4.00">NF-e 4.00 (atual)</option>
                                        <option value="3.10">NF-e 3.10</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group" style="flex:2;">
                                    <label>URL Webservice SEFAZ (SOAP)</label>
                                    <input type="url" id="cfgNfeUrlSefaz" class="form-control" placeholder="https://nfe.fazenda.sp.gov.br/ws/NfeAutorizacao4.asmx" onchange="ConfigFiscal.salvarConfig()">
                                </div>
                                <div class="form-group">
                                    <label>Token / Chave de API</label>
                                    <input type="password" id="cfgNfeToken" class="form-control" placeholder="Chave de acesso da API NF-e" onchange="ConfigFiscal.salvarConfig()">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group" style="flex:2;">
                                    <label>URL Servidor Intermediário (proxy/emissor)</label>
                                    <input type="url" id="cfgNfeUrlProxy" class="form-control" placeholder="https://seu-emissor.com.br/api/nfe" onchange="ConfigFiscal.salvarConfig()">
                                </div>
                                <div class="form-group" style="max-width:140px;">
                                    <label>Série Padrão</label>
                                    <input type="text" id="cfgNfeSerie" class="form-control" value="001" onchange="ConfigFiscal.salvarConfig()">
                                </div>
                            </div>
                        </div>

                        <!-- CERTIFICADO DIGITAL A1 -->
                        <div class="cliente-card">
                            <h3><i class="fas fa-certificate"></i> Certificado Digital A1</h3>
                            <div style="background:rgba(23,162,184,0.08);border:1.5px solid rgba(23,162,184,0.25);border-radius:10px;padding:0.85rem 1rem;margin-bottom:1.25rem;font-size:0.82rem;color:#0d7a8a;">
                                <i class="fas fa-info-circle" style="margin-right:0.4rem;"></i>
                                O certificado A1 é um arquivo <strong>.pfx ou .p12</strong> emitido por uma AC credenciada (Serasa, Certisign, etc.). Ele é necessário para assinar e transmitir NF-e para a SEFAZ.
                            </div>
                            <div class="form-row">
                                <div class="form-group" style="flex:2;">
                                    <label>Arquivo do Certificado (.pfx / .p12)</label>
                                    <div style="display:flex;gap:0.5rem;align-items:center;">
                                        <input type="file" id="cfgCertFile" accept=".pfx,.p12" class="form-control" style="flex:1;" onchange="ConfigFiscal.carregarCertificado(event)">
                                        <span id="cfgCertStatus" style="font-size:0.78rem;color:#888;white-space:nowrap;">Nenhum certificado carregado</span>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Senha do Certificado</label>
                                    <div style="position:relative;">
                                        <input type="password" id="cfgCertSenha" class="form-control" placeholder="••••••••" onchange="ConfigFiscal.salvarConfig()" style="padding-right:2.5rem;">
                                        <button onclick="ConfigFiscal.toggleSenha()" type="button"
                                            style="position:absolute;right:0.6rem;top:50%;transform:translateY(-50%);background:none;border:none;color:#888;cursor:pointer;font-size:0.9rem;">
                                            <i class="fas fa-eye" id="cfgCertSenhaIcon"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Validade do Certificado</label>
                                    <input type="text" id="cfgCertValidade" class="form-control" placeholder="Preenchido automaticamente" readonly style="background:#f5f5f5;">
                                </div>
                                <div class="form-group">
                                    <label>Titular (CN)</label>
                                    <input type="text" id="cfgCertTitular" class="form-control" placeholder="Preenchido automaticamente" readonly style="background:#f5f5f5;">
                                </div>
                            </div>
                            <div style="display:flex;gap:0.75rem;flex-wrap:wrap;">
                                <button class="btn btn-info btn-sm" onclick="ConfigFiscal.testarCertificado()">
                                    <i class="fas fa-flask"></i> Testar Certificado
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="ConfigFiscal.removerCertificado()">
                                    <i class="fas fa-trash-alt"></i> Remover
                                </button>
                            </div>
                        </div>

                        <!-- DADOS FISCAIS DA EMPRESA -->
                        <div class="cliente-card">
                            <h3><i class="fas fa-building"></i> Dados Fiscais da Empresa</h3>
                            <div class="form-row">
                                <div class="form-group" style="flex:2;">
                                    <label>Razão Social *</label>
                                    <input type="text" id="cfgRazaoSocial" class="form-control" placeholder="Nome completo da empresa" onchange="ConfigFiscal.salvarConfig()">
                                </div>
                                <div class="form-group">
                                    <label>CNPJ *</label>
                                    <div style="display:flex;gap:0.4rem;">
                                        <input type="text" id="cfgCNPJ" class="form-control" placeholder="00.000.000/0001-00" maxlength="18" onchange="ConfigFiscal.salvarConfig()">
                                        <button type="button" class="btn btn-primary btn-sm" onclick="ConfigFiscal.buscarCNPJ('cfgCNPJ','cfg')" title="Buscar CNPJ" style="white-space:nowrap;padding:0 0.75rem;">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Inscrição Estadual (IE)</label>
                                    <input type="text" id="cfgIE" class="form-control" placeholder="Inscrição Estadual" onchange="ConfigFiscal.salvarConfig()">
                                </div>
                                <div class="form-group">
                                    <label>Inscrição Municipal (IM)</label>
                                    <input type="text" id="cfgIM" class="form-control" placeholder="Inscrição Municipal" onchange="ConfigFiscal.salvarConfig()">
                                </div>
                                <div class="form-group">
                                    <label>CNAE Principal</label>
                                    <input type="text" id="cfgCNAE" class="form-control" placeholder="Ex: 4774-1/00" onchange="ConfigFiscal.salvarConfig()">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Regime Tributário</label>
                                    <select id="cfgRegime" class="form-control" onchange="ConfigFiscal.salvarConfig()">
                                        <option value="0">0 — MEI (Microempreendedor Individual)</option>
                                        <option value="1">1 — Simples Nacional</option>
                                        <option value="2">2 — Simples Nacional (Excesso)</option>
                                        <option value="3">3 — Regime Normal (Lucro Real/Presumido)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Alíquota ICMS Padrão (%)</label>
                                    <input type="number" id="cfgICMSPadrao" class="form-control" value="12" min="0" max="100" step="0.1" onchange="ConfigFiscal.salvarConfig()">
                                </div>
                                <div class="form-group">
                                    <label>CFOP Padrão (saída)</label>
                                    <input type="text" id="cfgCFOP" class="form-control" value="5102" maxlength="5" onchange="ConfigFiscal.salvarConfig()">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group" style="flex:2;">
                                    <label>Endereço Completo</label>
                                    <input type="text" id="cfgEnderecoFiscal" class="form-control" placeholder="Rua, número, bairro" onchange="ConfigFiscal.salvarConfig()">
                                </div>
                                <div class="form-group">
                                    <label>CEP</label>
                                    <input type="text" id="cfgCEP" class="form-control" placeholder="00000-000" maxlength="9" onchange="ConfigFiscal.salvarConfig()">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Município</label>
                                    <input type="text" id="cfgMunicipio" class="form-control" placeholder="Cidade" onchange="ConfigFiscal.salvarConfig()">
                                </div>
                                <div class="form-group">
                                    <label>Código IBGE Município</label>
                                    <input type="text" id="cfgCodIBGE" class="form-control" placeholder="Ex: 3550308" maxlength="7" onchange="ConfigFiscal.salvarConfig()">
                                </div>
                                <div class="form-group" style="max-width:100px;">
                                    <label>UF</label>
                                    <select id="cfgEstado" class="form-control" onchange="ConfigFiscal.salvarConfig()">
                                        <option>SP</option><option>RJ</option><option>MG</option><option>RS</option>
                                        <option>PR</option><option>SC</option><option>BA</option><option>CE</option>
                                        <option>GO</option><option>PE</option><option>ES</option><option>AM</option>
                                        <option>PA</option><option>MT</option><option>MS</option><option>DF</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Telefone</label>
                                    <input type="text" id="cfgTelFiscal" class="form-control" placeholder="(11) 99999-9999" onchange="ConfigFiscal.salvarConfig()">
                                </div>
                            </div>
                        </div>

                        <!-- LOGO DA NOTA FISCAL -->
                        <div class="cliente-card">
                            <h3><i class="fas fa-image"></i> Logo na Nota Fiscal (NF-e)</h3>
                            <div style="background:rgba(255,107,0,0.07);border:1.5px solid rgba(255,107,0,0.2);border-radius:10px;padding:0.85rem 1rem;margin-bottom:1.25rem;font-size:0.82rem;color:#8a4000;">
                                <i class="fas fa-info-circle" style="margin-right:0.4rem;"></i>
                                A logo será exibida no cabeçalho da NF-e impressa/PDF. Formatos aceitos: PNG, JPG ou SVG. Tamanho máximo: 2 MB.
                            </div>
                            <div class="form-row" style="align-items:flex-start;gap:1.5rem;">
                                <div class="form-group" style="flex:1;">
                                    <label>Selecionar Logo</label>
                                    <input type="file" id="cfgLogoNFeInput" class="form-control" accept="image/png,image/jpeg,image/svg+xml"
                                        style="padding:0.4rem;cursor:pointer;"
                                        onchange="ConfigFiscal.carregarLogoNFe(this)">
                                    <small style="color:var(--gray);font-size:0.76rem;margin-top:4px;display:block;">PNG, JPG ou SVG, máx. 2 MB</small>
                                </div>
                                <div class="form-group" style="flex:0 0 auto;text-align:center;">
                                    <label>Pré-visualização</label>
                                    <div id="cfgLogoNFePreview" style="width:120px;height:60px;border:2px dashed #ddd;border-radius:8px;display:flex;align-items:center;justify-content:center;background:#fafafa;overflow:hidden;">
                                        <span style="color:#bbb;font-size:0.75rem;" id="cfgLogoNFePreviewPlaceholder">Sem logo</span>
                                        <img id="cfgLogoNFeImg" src="" alt="Logo NF-e" style="display:none;max-width:100%;max-height:100%;object-fit:contain;">
                                    </div>
                                </div>
                                <div class="form-group" style="flex:0 0 auto;display:flex;flex-direction:column;gap:0.5rem;justify-content:flex-end;">
                                    <button class="btn btn-danger btn-sm" onclick="ConfigFiscal.removerLogoNFe()" style="font-size:0.8rem;padding:0.4rem 0.8rem;">
                                        <i class="fas fa-trash"></i> Remover Logo
                                    </button>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Posição da Logo na NF-e</label>
                                    <select id="cfgLogoPosicao" class="form-control" onchange="ConfigFiscal.salvarConfig()">
                                        <option value="esquerda">Esquerda (padrão)</option>
                                        <option value="centro">Centralizada</option>
                                        <option value="direita">Direita</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Exibir Logo na NF-e</label>
                                    <select id="cfgLogoExibir" class="form-control" onchange="ConfigFiscal.salvarConfig()">
                                        <option value="sim">Sim — mostrar logo</option>
                                        <option value="nao">Não — ocultar logo</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- API DE CONSULTA CNPJ -->
                        <div class="cliente-card">
                            <h3><i class="fas fa-plug"></i> API de Consulta de CNPJ</h3>
                            <div style="background:rgba(40,167,69,0.08);border:1.5px solid rgba(40,167,69,0.2);border-radius:10px;padding:0.85rem 1rem;margin-bottom:1.25rem;font-size:0.82rem;color:#1a7a3a;">
                                <i class="fas fa-check-circle" style="margin-right:0.4rem;"></i>
                                A busca de CNPJ usa a API pública <strong>BrasilAPI</strong> (gratuita, sem token). Opcionalmente configure uma API privada com mais dados.
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Provedor de API CNPJ</label>
                                    <select id="cfgCnpjProvider" class="form-control" onchange="ConfigFiscal.salvarConfig()">
                                        <option value="brasilapi">BrasilAPI (gratuita)</option>
                                        <option value="receitaws">ReceitaWS</option>
                                        <option value="cnpja">CNPJ.a (paga)</option>
                                        <option value="custom">URL personalizada</option>
                                    </select>
                                </div>
                                <div class="form-group" style="flex:2;">
                                    <label>URL Personalizada (se "URL personalizada")</label>
                                    <input type="url" id="cfgCnpjUrl" class="form-control" placeholder="https://api.exemplo.com/cnpj/{cnpj}" onchange="ConfigFiscal.salvarConfig()">
                                </div>
                                <div class="form-group">
                                    <label>Token API CNPJ (se necessário)</label>
                                    <input type="password" id="cfgCnpjToken" class="form-control" placeholder="Token opcional" onchange="ConfigFiscal.salvarConfig()">
                                </div>
                            </div>
                            <button class="btn btn-success btn-sm" onclick="ConfigFiscal.testarApiCnpj()">
                                <i class="fas fa-flask"></i> Testar API com CNPJ exemplo
                            </button>
                        </div>

                        <!-- BOTÕES -->
                        <div style="display:flex;gap:0.75rem;justify-content:flex-end;flex-wrap:wrap;">
                            <button class="btn btn-secondary" onclick="ConfigFiscal.limpar()">
                                <i class="fas fa-eraser"></i> Limpar
                            </button>
                            <button class="btn btn-primary" onclick="ConfigFiscal.salvarConfig(true)">
                                <i class="fas fa-save"></i> Salvar Configurações Fiscais
                            </button>
                        </div>

                    </div>
                </div>
                <!-- ── FIM ABA FISCAL ── -->

            </section>

            <!-- ═══════════════════════════════════════════════
                 SEÇÃO NF-e — NOTA FISCAL ELETRÔNICA
            ═══════════════════════════════════════════════ -->
            <section id="nfe" class="section" aria-labelledby="pageTitle">

                <!-- AVISO DE INTEGRAÇÃO -->
                <div id="nfeAvisoIntegracao" style="
                    background: linear-gradient(135deg,#fff8e1,#fff3cd);
                    border: 1.5px solid #ffcc00;
                    border-left: 5px solid #ff6b00;
                    border-radius: 12px;
                    padding: 1rem 1.4rem;
                    margin-bottom: 1.5rem;
                    display: flex;
                    align-items: center;
                    gap: 1rem;
                    flex-wrap: wrap;
                ">
                    <i class="fas fa-info-circle" style="color:#ff6b00;font-size:1.5rem;flex-shrink:0;"></i>
                    <div style="flex:1;">
                        <strong style="color:#8a5000;font-size:0.9rem;">Módulo NF-e — Pré-configuração</strong>
                        <p style="color:#8a5000;font-size:0.82rem;margin-top:2px;">
                            Para emissão real, configure seu certificado digital A1 e as credenciais da SEFAZ em 
                            <strong>Configurações → Fiscal</strong>. Enquanto isso, gerencie suas notas e simule emissões abaixo.
                        </p>
                    </div>
                    <button class="btn btn-sm" onclick="document.getElementById('nfeAvisoIntegracao').style.display='none'" 
                        style="background:rgba(255,107,0,0.1);color:#ff6b00;border:1px solid rgba(255,107,0,0.3);border-radius:8px;padding:6px 14px;font-size:0.8rem;cursor:pointer;flex-shrink:0;">
                        <i class="fas fa-times"></i> Fechar
                    </button>
                </div>

                <!-- CARDS RESUMO -->
                <div class="dashboard-cards" style="grid-template-columns: repeat(auto-fit,minmax(180px,1fr));margin-bottom:1.5rem;">
                    <div class="card" style="--card-accent:linear-gradient(90deg,#28a745,#20c997);">
                        <div class="card-header">
                            <div class="card-title">Emitidas</div>
                            <div class="card-icon" style="background:rgba(40,167,69,0.12);color:#28a745;"><i class="fas fa-check-circle"></i></div>
                        </div>
                        <div class="card-value" id="nfeCountEmitidas">0</div>
                        <div style="font-size:0.75rem;color:#999;margin-top:4px;">este mês</div>
                    </div>
                    <div class="card" style="--card-accent:linear-gradient(90deg,#ff6b00,#ffaa00);">
                        <div class="card-header">
                            <div class="card-title">Pendentes</div>
                            <div class="card-icon" style="background:rgba(255,107,0,0.12);color:#ff6b00;"><i class="fas fa-clock"></i></div>
                        </div>
                        <div class="card-value" id="nfeCountPendentes">0</div>
                        <div style="font-size:0.75rem;color:#999;margin-top:4px;">aguardando emissão</div>
                    </div>
                    <div class="card" style="--card-accent:linear-gradient(90deg,#dc3545,#c0392b);">
                        <div class="card-header">
                            <div class="card-title">Canceladas</div>
                            <div class="card-icon" style="background:rgba(220,53,69,0.12);color:#dc3545;"><i class="fas fa-times-circle"></i></div>
                        </div>
                        <div class="card-value" id="nfeCountCanceladas">0</div>
                        <div style="font-size:0.75rem;color:#999;margin-top:4px;">este mês</div>
                    </div>
                    <div class="card" style="--card-accent:linear-gradient(90deg,#17a2b8,#138496);">
                        <div class="card-header">
                            <div class="card-title">Total Emitido</div>
                            <div class="card-icon" style="background:rgba(23,162,184,0.12);color:#17a2b8;"><i class="fas fa-dollar-sign"></i></div>
                        </div>
                        <div class="card-value" id="nfeTotalEmitido">R$ 0</div>
                        <div style="font-size:0.75rem;color:#999;margin-top:4px;">este mês</div>
                    </div>
                </div>

                <!-- FORMULÁRIO NOVA NF-e -->
                <div class="form-container" style="margin-bottom:1.5rem;">
                    <h2 class="section-title" style="font-size:1.1rem;margin-bottom:1.2rem;">
                        <i class="fas fa-plus-circle" style="margin-right:0.5rem;"></i>Nova Nota Fiscal Eletrônica
                    </h2>

                    <!-- DADOS DO EMITENTE -->
                    <div class="cliente-card">
                        <h3><i class="fas fa-building"></i> Dados do Emitente</h3>
                        <div class="form-row">
                            <div class="form-group" style="flex:2;">
                                <label>Razão Social *</label>
                                <input type="text" id="nfeRazaoSocial" class="form-control" placeholder="Nome da empresa">
                            </div>
                            <div class="form-group">
                                <label>CNPJ *</label>
                                <div style="display:flex;gap:0.4rem;">
                                    <input type="text" id="nfeCnpj" class="form-control" placeholder="00.000.000/0000-00" maxlength="18">
                                    <button type="button" class="btn btn-primary btn-sm" onclick="ConfigFiscal.buscarCNPJ('nfeCnpj','nfeEmit')" title="Buscar dados pelo CNPJ" style="padding:0 0.75rem;white-space:nowrap;">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>IE (Inscrição Estadual)</label>
                                <input type="text" id="nfeIE" class="form-control" placeholder="Inscrição Estadual">
                            </div>
                            <div class="form-group">
                                <label>Regime Tributário</label>
                                <select id="nfeRegime" class="form-control">
                                    <option value="0">MEI — Microempreendedor Individual</option>
                                    <option value="1">Simples Nacional</option>
                                    <option value="2">Simples Nacional — Excesso</option>
                                    <option value="3">Regime Normal</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>UF</label>
                                <select id="nfeUF" class="form-control">
                                    <option>SP</option><option>RJ</option><option>MG</option><option>RS</option>
                                    <option>PR</option><option>SC</option><option>BA</option><option>CE</option>
                                    <option>GO</option><option>PE</option><option>ES</option><option>AM</option>
                                    <option>PA</option><option>MT</option><option>MS</option><option>DF</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- DADOS DO DESTINATÁRIO -->
                    <div class="cliente-card">
                        <h3><i class="fas fa-user"></i> Destinatário</h3>
                        <div class="form-row">
                            <div class="form-group" style="flex:2;">
                                <label>Nome / Razão Social *</label>
                                <input type="text" id="nfeDestNome" class="form-control" placeholder="Nome ou razão social">
                            </div>
                            <div class="form-group">
                                <label>CPF / CNPJ *</label>
                                <div style="display:flex;gap:0.4rem;">
                                    <input type="text" id="nfeDestDoc" class="form-control" placeholder="000.000.000-00 ou CNPJ">
                                    <button type="button" class="btn btn-primary btn-sm" onclick="ConfigFiscal.buscarCNPJ('nfeDestDoc','nfeDest')" title="Buscar dados pelo CNPJ (apenas para PJ)" style="padding:0 0.75rem;white-space:nowrap;">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group" style="flex:2;">
                                <label>Endereço</label>
                                <input type="text" id="nfeDestEnd" class="form-control" placeholder="Rua, número, bairro">
                            </div>
                            <div class="form-group">
                                <label>Município</label>
                                <input type="text" id="nfeDestMun" class="form-control" placeholder="Cidade">
                            </div>
                            <div class="form-group" style="max-width:120px;">
                                <label>UF</label>
                                <select id="nfeDestUF" class="form-control">
                                    <option>SP</option><option>RJ</option><option>MG</option><option>RS</option>
                                    <option>PR</option><option>SC</option><option>BA</option><option>CE</option>
                                    <option>GO</option><option>PE</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>E-mail (envio XML)</label>
                                <input type="email" id="nfeDestEmail" class="form-control" placeholder="email@cliente.com">
                            </div>
                            <div class="form-group">
                                <label>Telefone</label>
                                <input type="text" id="nfeDestTel" class="form-control" placeholder="(11) 99999-9999">
                            </div>
                        </div>
                    </div>

                    <!-- DADOS DA NOTA -->
                    <div class="cliente-card">
                        <h3><i class="fas fa-file-alt"></i> Dados da Nota</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Número NF-e</label>
                                <input type="text" id="nfeNumero" class="form-control" placeholder="Auto" readonly style="background:#f5f5f5;">
                            </div>
                            <div class="form-group">
                                <label>Série</label>
                                <input type="text" id="nfeSerie" class="form-control" value="001">
                            </div>
                            <div class="form-group">
                                <label>Data Emissão</label>
                                <input type="date" id="nfeDataEmissao" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>Natureza da Operação *</label>
                                <select id="nfeNatureza" class="form-control">
                                    <option>Venda de mercadoria</option>
                                    <option>Prestação de serviços</option>
                                    <option>Devolução de mercadoria</option>
                                    <option>Transferência</option>
                                    <option>Remessa para conserto</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Finalidade</label>
                                <select id="nfeFinalidade" class="form-control">
                                    <option value="1">NF-e Normal</option>
                                    <option value="2">NF-e Complementar</option>
                                    <option value="3">NF-e de Ajuste</option>
                                    <option value="4">Devolução/Retorno</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Forma de Pagamento</label>
                                <select id="nfeFormaPag" class="form-control">
                                    <option value="01">Dinheiro</option>
                                    <option value="02">Cheque</option>
                                    <option value="03">Cartão de Crédito</option>
                                    <option value="04">Cartão de Débito</option>
                                    <option value="05">Crédito Loja</option>
                                    <option value="10">Vale Alimentação</option>
                                    <option value="15">Boleto Bancário</option>
                                    <option value="17">PIX</option>
                                    <option value="90">Sem Pagamento</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>OS Vinculada</label>
                                <input type="text" id="nfeOSRef" class="form-control" placeholder="Ex: OS-001">
                            </div>
                        </div>
                    </div>

                    <!-- ITENS DA NOTA -->
                    <div class="cliente-card">
                        <h3><i class="fas fa-boxes"></i> Itens da Nota</h3>
                        <div id="nfeItens">
                            <!-- Itens adicionados dinamicamente -->
                        </div>
                        <div class="form-row" style="align-items:flex-end;gap:0.5rem;flex-wrap:wrap;">
                            <div class="form-group" style="flex:3;min-width:180px;">
                                <label>Descrição do Produto/Serviço</label>
                                <input type="text" id="nfeItemDesc" class="form-control" placeholder="Ex: Armação de óculos...">
                            </div>
                            <div class="form-group" style="max-width:80px;">
                                <label>NCM</label>
                                <input type="text" id="nfeItemNCM" class="form-control" placeholder="90041000" maxlength="10">
                            </div>
                            <div class="form-group" style="max-width:80px;">
                                <label>CFOP</label>
                                <input type="text" id="nfeItemCFOP" class="form-control" value="5102" maxlength="5">
                            </div>
                            <div class="form-group" style="max-width:70px;">
                                <label>Qtd</label>
                                <input type="number" id="nfeItemQtd" class="form-control" value="1" min="1" step="1">
                            </div>
                            <div class="form-group" style="max-width:110px;">
                                <label>Valor Unit. (R$)</label>
                                <input type="number" id="nfeItemValor" class="form-control" placeholder="0,00" step="0.01" min="0">
                            </div>
                            <div class="form-group" style="max-width:80px;">
                                <label>ICMS %</label>
                                <input type="number" id="nfeItemICMS" class="form-control" value="12" min="0" max="100" step="0.1">
                            </div>
                            <div style="padding-bottom:0.05rem;">
                                <button type="button" class="btn btn-primary btn-sm" onclick="NFeModule.addItem()">
                                    <i class="fas fa-plus"></i> Adicionar
                                </button>
                            </div>
                        </div>

                        <!-- Totais -->
                        <div id="nfeTotaisBox" style="display:none;margin-top:1rem;">
                            <div style="background:linear-gradient(135deg,#fff9f5,#fff5ec);border:2px solid rgba(255,107,0,0.2);border-radius:12px;padding:1rem 1.25rem;">
                                <div style="display:flex;justify-content:space-between;flex-wrap:wrap;gap:1rem;">
                                    <div style="text-align:center;">
                                        <div style="font-size:0.72rem;color:#888;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;">Subtotal</div>
                                        <div style="font-size:1.1rem;font-weight:800;color:#333;" id="nfeSubtotal">R$ 0,00</div>
                                    </div>
                                    <div style="text-align:center;">
                                        <div style="font-size:0.72rem;color:#888;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;">Total ICMS</div>
                                        <div style="font-size:1.1rem;font-weight:800;color:#17a2b8;" id="nfeTotalICMS">R$ 0,00</div>
                                    </div>
                                    <div style="text-align:center;">
                                        <div style="font-size:0.72rem;color:#888;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;">Desconto</div>
                                        <input type="number" id="nfeDesconto" class="form-control" style="max-width:120px;text-align:center;" placeholder="R$ 0,00" step="0.01" min="0" onchange="NFeModule.calcTotais()">
                                    </div>
                                    <div style="text-align:center;">
                                        <div style="font-size:0.72rem;color:#888;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;">TOTAL NF-e</div>
                                        <div style="font-size:1.6rem;font-weight:900;color:#ff6b00;" id="nfeTotalGeral">R$ 0,00</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- INFORMAÇÕES ADICIONAIS -->
                    <div class="cliente-card">
                        <h3><i class="fas fa-comment-alt"></i> Informações Adicionais</h3>
                        <div class="form-group">
                            <label>Informações Complementares</label>
                            <textarea id="nfeInfoCompl" class="form-control" rows="3" 
                                placeholder="Observações, referências, dados adicionais..." style="resize:vertical;"></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Chave de Acesso (gerada pela SEFAZ)</label>
                                <input type="text" id="nfeChave" class="form-control" placeholder="00 0000 00000000000000 00 000 000000000 0 00000000 0" readonly 
                                    style="font-family:monospace;font-size:0.8rem;background:#f5f5f5;">
                            </div>
                        </div>
                    </div>

                    <!-- BOTÕES DE AÇÃO -->
                    <div style="display:flex;gap:0.75rem;flex-wrap:wrap;justify-content:flex-end;margin-top:0.5rem;">
                        <button type="button" class="btn btn-secondary" onclick="NFeModule.limparForm()">
                            <i class="fas fa-eraser"></i> Limpar
                        </button>
                        <button type="button" class="btn btn-warning" onclick="NFeModule.salvarRascunho()">
                            <i class="fas fa-save"></i> Salvar Rascunho
                        </button>
                        <button type="button" class="btn btn-info" onclick="NFeModule.gerarXML()">
                            <i class="fas fa-code"></i> Gerar XML
                        </button>
                        <button type="button" class="btn btn-primary" onclick="NFeModule.emitir()" style="min-width:160px;">
                            <i class="fas fa-paper-plane"></i> Emitir NF-e
                        </button>
                    </div>
                </div>

                <!-- HISTÓRICO DE NOTAS -->
                <div class="table-container">
                    <div style="display:flex;align-items:center;justify-content:space-between;padding:1.2rem 1.5rem 0.75rem;flex-wrap:wrap;gap:0.75rem;">
                        <h3 style="margin:0;font-weight:800;">📄 Notas Fiscais Emitidas</h3>
                        <div style="display:flex;gap:0.5rem;flex-wrap:wrap;">
                            <input type="text" id="nfeBusca" class="form-control" style="max-width:220px;font-size:0.85rem;" 
                                placeholder="🔍 Buscar por nº, nome..." onkeyup="NFeModule.filtrarHistorico()">
                            <select id="nfeFiltroStatus" class="form-control" style="max-width:160px;font-size:0.85rem;" onchange="NFeModule.filtrarHistorico()">
                                <option value="">Todos os status</option>
                                <option value="emitida">✅ Emitida</option>
                                <option value="pendente">⏳ Pendente</option>
                                <option value="cancelada">❌ Cancelada</option>
                                <option value="rascunho">📝 Rascunho</option>
                            </select>
                            <button class="btn btn-sm btn-success" onclick="NFeModule.exportarCSV()">
                                <i class="fas fa-file-excel"></i> Exportar
                            </button>
                        </div>
                    </div>
                    <div style="overflow-x:auto;">
                    <table id="nfeHistoricoTable">
                        <thead>
                            <tr>
                                <th>Nº NF-e</th>
                                <th>Data</th>
                                <th>Destinatário</th>
                                <th>CPF/CNPJ</th>
                                <th>Valor Total</th>
                                <th>OS Ref.</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="nfeHistoricoBody">
                            <tr>
                                <td colspan="8" style="text-align:center;padding:3rem 1rem;color:#aaa;">
                                    <i class="fas fa-file-invoice" style="font-size:2.5rem;display:block;margin-bottom:0.75rem;opacity:0.3;"></i>
                                    Nenhuma nota fiscal emitida ainda.<br>
                                    <span style="font-size:0.82rem;">Preencha o formulário acima e clique em <strong>Emitir NF-e</strong></span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    </div>
                </div>

            </section>
            <!-- ═══ FIM NF-e ═══ -->

        </main>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>


    <!-- Cloud Sync Indicator -->
    <div id="cloudSyncIndicator" style="position:fixed;bottom:60px;right:20px;z-index:9998;background:#0f2a1a;color:#3ecf8e;border:1px solid #3ecf8e;border-radius:20px;padding:5px 14px;font-size:0.78rem;font-weight:700;display:none;align-items:center;gap:6px;">
        &#9729; <span id="cloudSyncText">Sincronizado</span>
    </div>


    <!-- Modal de confirmação WhatsApp -->
    <div class="wpp-confirm-modal" id="wppConfirmModal">
        <div class="wpp-confirm-box">
            <div class="wpp-confirm-header">
                <i class="fab fa-whatsapp"></i>
                <div>
                    <h3>Confirmar envio via WhatsApp</h3>
                    <small id="wppConfirmSubtitle">Verifique os dados antes de enviar</small>
                </div>
            </div>
            <div class="wpp-confirm-body">
                <div class="wpp-confirm-info">
                    <div class="wpp-confirm-info-item">
                        <small>👤 Destinatário</small>
                        <strong id="wppConfirmName">—</strong>
                    </div>
                    <div class="wpp-confirm-info-item">
                        <small>📱 Número</small>
                        <strong id="wppConfirmPhone">—</strong>
                    </div>
                </div>
                <div class="wpp-confirm-preview">
                    <div class="wpp-confirm-preview-label"><i class="fas fa-eye"></i> Prévia da mensagem</div>
                    <div class="wpp-confirm-bubble" id="wppConfirmPreview"></div>
                </div>
            </div>
            <div class="wpp-confirm-footer">
                <button class="btn btn-success" style="flex:1;" id="wppConfirmSendBtn">
                    <i class="fab fa-whatsapp"></i> Enviar agora
                </button>
                <button class="btn btn-secondary" onclick="WppConfirm.close()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modais -->
    <div class="modal" id="confirmModal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="confirmTitle">Confirmação</div>
                <button class="modal-close" onclick="Modal.close('confirmModal')" aria-label="Fechar">&times;</button>
            </div>
            <div class="modal-body" id="confirmMessage"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="Modal.close('confirmModal')">Cancelar</button>
                <button class="btn btn-danger" id="confirmAction">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal: Cliente salvo com sucesso -->
    <div class="modal" id="clienteSalvoModal" role="dialog" aria-modal="true" aria-labelledby="clienteSalvoTitle">
        <div class="modal-content" style="max-width:400px;text-align:center;overflow:hidden;padding:0;">
            <div style="background:linear-gradient(135deg,#28a745,#1e7e34);padding:1.5rem 1.5rem 1rem;position:relative;">
                <button onclick="Modal.close('clienteSalvoModal')" style="position:absolute;right:1rem;top:1rem;color:white;font-size:1.3rem;background:none;border:none;cursor:pointer;">&times;</button>
                <div style="width:60px;height:60px;background:rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.8rem;margin:0 auto 0.75rem;">✅</div>
                <div id="clienteSalvoTitle" style="color:white;font-size:1.1rem;font-weight:800;margin-bottom:0.2rem;">Cliente Salvo!</div>
                <div id="clienteSalvoNome" style="color:rgba(255,255,255,0.85);font-size:0.88rem;"></div>
            </div>
            <div style="padding:1.25rem 1.5rem;">
                <p style="color:#6c757d;font-size:0.85rem;margin-bottom:1.25rem;">O que deseja fazer agora?</p>
                <button onclick="Clients._criarVendaParaCliente()" style="width:100%;padding:0.85rem;border-radius:10px;border:none;background:linear-gradient(135deg,#ff6b00,#e55a00);color:white;font-size:0.95rem;font-weight:800;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:0.6rem;margin-bottom:0.6rem;box-shadow:0 4px 15px rgba(255,107,0,.35);">
                    <i class="fas fa-shopping-cart"></i> Criar Venda para este Cliente
                </button>
                <button onclick="Modal.close('clienteSalvoModal')" style="width:100%;padding:0.7rem;border-radius:10px;border:1px solid #dee2e6;background:white;color:#6c757d;font-size:0.85rem;font-weight:600;cursor:pointer;">
                    Continuar no Cadastro de Clientes
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Gerar O.S. após salvar venda -->
    <div class="modal" id="osGeradoModal" role="dialog" aria-modal="true" aria-labelledby="osGeradoTitle">
        <div class="modal-content" style="max-width:420px;text-align:center;">
            <div class="modal-header" style="justify-content:center;border-bottom:none;padding-bottom:0;">
                <div class="modal-title" id="osGeradoTitle" style="font-size:1.1rem;">✅ Venda Salva!</div>
                <button class="modal-close" onclick="Modal.close('osGeradoModal')" aria-label="Fechar" style="position:absolute;right:1rem;top:1rem;">&times;</button>
            </div>
            <div class="modal-body" style="padding:1.25rem 1.5rem 0.5rem;">
                <div style="font-size:2.5rem;margin-bottom:0.5rem;">✅</div>
                <p id="osGeradoNumero" style="font-size:1.1rem;font-weight:700;color:var(--primary);margin-bottom:0.25rem;"></p>
                <div style="background:#f8f9fa;border-radius:10px;padding:1rem;margin-bottom:1rem;border:1px solid #e9ecef;">
                    <p style="font-size:0.82rem;font-weight:700;color:#495057;margin-bottom:0.6rem;text-transform:uppercase;letter-spacing:.5px;">💰 Situação do Pagamento</p>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;">
                        <button id="osGeradoBtnPago" onclick="Sales._setOsGeradoPagamento('pago')" style="padding:0.65rem 0.5rem;border-radius:8px;border:2px solid #ddd;background:#fff;color:#555;font-weight:700;font-size:0.88rem;cursor:pointer;transition:all .2s;">✅ PAGO</button>
                        <button id="osGeradoBtnPendente" onclick="Sales._setOsGeradoPagamento('pendente')" style="padding:0.65rem 0.5rem;border-radius:8px;border:2px solid #ddd;background:#fff;color:#555;font-weight:600;font-size:0.88rem;cursor:pointer;transition:all .2s;">⏳ PENDENTE</button>
                    </div>
                    <p id="osGeradoPagtoLabel" style="font-size:0.78rem;color:#6c757d;margin-top:0.5rem;margin-bottom:0;">Selecione a situação — isso remove da lista de Contas a Receber</p>
                </div>
            </div>
            <div class="modal-footer" style="justify-content:center;border-top:none;padding-top:0;">
                <button class="btn btn-outline-secondary" style="width:100%;font-size:0.85rem;" onclick="Modal.close('osGeradoModal')">Fechar</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="viewModal" role="dialog" aria-modal="true" aria-labelledby="viewTitle">
        <div class="modal-content" style="max-width:700px;max-height:90vh;overflow-y:auto;">
            <div class="modal-header">
                <div class="modal-title" id="viewTitle"></div>
                <button class="modal-close" onclick="Modal.close('viewModal')" aria-label="Fechar">&times;</button>
            </div>
            <div class="modal-body" id="viewBody"></div>
        </div>
    </div>

    <div class="modal" id="userModal" role="dialog" aria-modal="true" aria-labelledby="userModalTitle">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <div class="modal-title" id="userModalTitle">Novo Usuário</div>
                <button class="modal-close" onclick="Modal.close('userModal')" aria-label="Fechar">&times;</button>
            </div>
            <div class="modal-body">
                <form id="userForm" novalidate>
                    <div class="form-group">
                        <label for="userFullName" class="required">Nome Completo</label>
                        <input type="text" id="userFullName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="userName" class="required">Usuário</label>
                        <input type="text" id="userName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="userPassword" class="required">Senha</label>
                        <input type="password" id="userPassword" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="userConfirmPassword" class="required">Confirmar Senha</label>
                        <input type="password" id="userConfirmPassword" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="userProfile">Perfil de Acesso</label>
                        <select id="userProfile" class="form-control">
                            <option value="admin">Administrador</option>
                            <option value="manager">Gerente</option>
                            <option value="seller">Vendedor</option>
                            <option value="financial">Financeiro</option>
                            <option value="viewer">Apenas Visualização</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="userStatus">Status</label>
                        <select id="userStatus" class="form-control">
                            <option value="active">Ativo</option>
                            <option value="inactive">Inativo</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="Modal.close('userModal')">Cancelar</button>
                <button class="btn btn-success" onclick="Usuarios.save()">Salvar</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONSTANTES E UTILITÁRIOS ====================
        const STORAGE_KEY = 'optic_pro_data';

        // ==================== SQLite OPFS Store + Zero-Conf Sync ====================
        // Estratégia de storage em camadas:
        //   1ª  SQLite via OPFS (arquivo .db real no disco do browser — mais rápido e confiável)
        //   2ª  IndexedDB (fallback automático se OPFS não disponível)
        // Zero-Conf Sync: sincroniza automaticamente sem intervenção do usuário.

        // ── IDB (IndexedDB — storage local confiável) ────────────────────────
        const IDB = {
            _db: null,
            _DB_NAME: 'opticvision_local',
            _STORE: 'keyval',

            async _open() {
                if (this._db) return this._db;
                return new Promise((res, rej) => {
                    const r = indexedDB.open(this._DB_NAME, 2);
                    r.onupgradeneeded = e => {
                        if (!e.target.result.objectStoreNames.contains(this._STORE))
                            e.target.result.createObjectStore(this._STORE);
                    };
                    r.onsuccess = e => { this._db = e.target.result; res(this._db); };
                    r.onerror   = e => rej(e.target.error);
                });
            },

            async get(key) {
                const db = await this._open();
                return new Promise((res, rej) => {
                    const r = db.transaction(this._STORE, 'readonly').objectStore(this._STORE).get(key);
                    r.onsuccess = () => res(r.result ?? null);
                    r.onerror   = e => rej(e.target.error);
                });
            },

            async set(key, val) {
                const db = await this._open();
                const s = (typeof val === 'string') ? val : JSON.stringify(val);
                return new Promise((res, rej) => {
                    const r = db.transaction(this._STORE, 'readwrite').objectStore(this._STORE).put(s, key);
                    r.onsuccess = () => res();
                    r.onerror   = e => rej(e.target.error);
                });
            },

            async remove(key) {
                const db = await this._open();
                return new Promise((res, rej) => {
                    const r = db.transaction(this._STORE, 'readwrite').objectStore(this._STORE).delete(key);
                    r.onsuccess = () => res();
                    r.onerror   = e => rej(e.target.error);
                });
            },

            async keys() {
                const db = await this._open();
                return new Promise((res, rej) => {
                    const r = db.transaction(this._STORE, 'readonly').objectStore(this._STORE).getAllKeys();
                    r.onsuccess = () => res(r.result || []);
                    r.onerror   = e => rej(e.target.error);
                });
            },

            observe() { return { unsubscribe: () => {} }; }
        };

        // ══════════════════════════════════════════════════════════════════════
        // LOCAL-FIRST SYNC ENGINE
        // Filosofia: dados vivem no IndexedDB (local). Supabase é backup/sync.
        // Salvar = sempre local primeiro → sync em background quando online.
        // Conflito = mais recente vence (por updated_at timestamp).
        // ══════════════════════════════════════════════════════════════════════
        const LocalFirst = {
            _syncing: false,
            _syncTimer: null,
            _SYNC_INTERVAL_MS: 60000, // auto-sync a cada 60s
            _TS_KEY: 'lf_last_sync_ts',

            // Tabelas sincronizáveis com Supabase (nome local → tabela Supabase)
            _TABLES: {
                clients:       'clients',
                products:      'products',
                sales:         'sales',
                expenses:      'expenses',
                prescriptions: 'prescriptions',
                suppliers:     'suppliers',
                services:      'services',
                config:        'config'
            },

            // ── INICIALIZAÇÃO ─────────────────────────────────────────────────
            _realtimeStatus: 'Conectando...',
            _realtimeChannel: null,

            boot() {
                // ── Limpa filas pendentes corrompidas (não-array) no boot ──
                const tableKeys = Object.keys(this._TABLES);
                Promise.all(tableKeys.map(k => this._getPending('lf_pending_' + k))).then(() => {
                    console.log('[LocalFirst] Filas pendentes verificadas');
                });

                window.addEventListener('online',  () => this._triggerSync('online'));
                window.addEventListener('focus',   () => this._triggerSync('focus'));
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden) this._triggerSync('visibility');
                });
                setInterval(() => {
                    if (navigator.onLine && !document.hidden) this._triggerSync('interval');
                }, this._SYNC_INTERVAL_MS);

                // Sync inicial ao abrir (sem bloquear a UI)
                setTimeout(() => this._triggerSync('boot'), 3000); // Aguarda push inicial antes de fazer pull

                // ── REALTIME: escuta mudancas em todas as tabelas ──
                this._initRealtime();

                console.log('[LocalFirst] Boot completo');
            },

            _initRealtime() {
                // Remove canal anterior se existir
                if (this._realtimeChannel) {
                    supabaseClient.removeChannel(this._realtimeChannel);
                    this._realtimeChannel = null;
                }

                const tables = Object.values(this._TABLES);
                let channel = supabaseClient.channel('lf-realtime-v1');

                tables.forEach(table => {
                    channel = channel.on(
                        'postgres_changes',
                        { event: '*', schema: 'public', table },
                        (payload) => {
                            console.log('[LocalFirst] Realtime evento em ' + table + ':', payload.eventType);
                            this._triggerSync('realtime');
                        }
                    );
                });

                channel.subscribe((status) => {
                    console.log('[LocalFirst] Realtime status:', status);
                    if (status === 'SUBSCRIBED') {
                        this._realtimeStatus = 'Ativo';
                    } else if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT') {
                        this._realtimeStatus = 'Erro';
                        // Tenta reconectar apos 10s
                        setTimeout(() => { if (navigator.onLine) this._initRealtime(); }, 10000);
                    } else if (status === 'CLOSED') {
                        this._realtimeStatus = 'Fechado';
                    } else {
                        this._realtimeStatus = 'Conectando...';
                    }
                    this._updatePanel();
                });

                this._realtimeChannel = channel;
            },

            // ── FLAGS anti-loop ───────────────────────────────────────────────
            _pushing: false,        // true enquanto estamos fazendo push (ignora Realtime próprio)
            _realtimeDebounce: null,// debounce separado para eventos Realtime
            _dirtyKeys: new Set(),  // stateKeys com mudanças locais pendentes de push

            // Debounce para evitar syncs em cascata
            _triggerSync(reason) {
                // Eventos Realtime gerados pelo próprio push → ignorar para quebrar o loop
                if (reason === 'realtime' && this._pushing) return;

                // Realtime usa debounce maior (2s) — podem chegar vários eventos juntos
                const delay = reason === 'realtime' ? 2000 : 800;
                if (this._syncTimer) clearTimeout(this._syncTimer);
                // Realtime só precisa de PULL (os dados já estão no Supabase)
                this._syncTimer = setTimeout(() => this.sync(reason), delay);
            },

            // Marca um stateKey como "sujo" (tem dados a enviar)
            _markDirty(stateKey) {
                this._dirtyKeys.add(stateKey);
            },

            // ── SYNC PRINCIPAL ────────────────────────────────────────────────
            // Push: registros dirty + flush da fila de deleções offline
            // Pull: mescla dados remotos; detecta tombstones (_deleted=true) e remove localmente
            async sync(reason = 'manual') {
                if (this._syncing) return;
                if (!navigator.onLine) { this._updatePanel(); return; }

                this._syncing = true;
                const btn = document.getElementById('headerSyncBtn');
                if (btn) { btn.classList.add('syncing'); btn.title = 'Sincronizando...'; }

                try {
                    // Se o estado local está vazio, força full sync para recuperar tudo do Supabase
                    const localIsEmpty = (!state.sales || state.sales.length === 0) && (!state.clients || state.clients.length === 0);
                    const storedSync = await IDB.get(this._TS_KEY);
                    const lastSync = (localIsEmpty || !storedSync) ? '1970-01-01T00:00:00.000Z' : storedSync;
                    if (localIsEmpty && storedSync) {
                        console.log('[LocalFirst] Estado local vazio — forçando full sync do Supabase');
                    }
                    const now = new Date().toISOString();

                    let pushed = 0, pulled = 0;
                    const dirtyNow = new Set(this._dirtyKeys);

                    for (const [stateKey, table] of Object.entries(this._TABLES)) {

                        // Config tem tratamento especial via pullConfig/pushConfig
                        if (stateKey === 'config') {
                            await this.pullConfig();
                            continue;
                        }

                        // ── FLUSH DELEÇÕES PENDENTES (fila offline) ───────────────
                        const deletedKey = 'lf_deleted_' + stateKey;
                        const pendingDeletes = await this._getPending(deletedKey);
                        if (pendingDeletes.length > 0) {
                            this._pushing = true;
                            const flushed = [];
                            for (const delId of pendingDeletes) {
                                try {
                                    const { error } = await supabaseClient
                                        .from(table)
                                        .upsert({
                                            id: delId,
                                            _data: JSON.stringify({ id: delId, _deleted: true }),
                                            updated_at: new Date().toISOString()
                                        }, { onConflict: 'id' });
                                    if (!error) { flushed.push(delId); pushed++; console.log('[LocalFirst] flush delete:', table, delId); }
                                } catch(e) {}
                            }
                            if (flushed.length > 0) {
                                await IDB.set(deletedKey, pendingDeletes.filter(id => !flushed.includes(id)));
                            }
                            await new Promise(r => setTimeout(r, 300));
                            this._pushing = false;
                        }

                        // ── PUSH: registros locais modificados ────────────────────
                        const shouldPush = (reason !== 'realtime') && dirtyNow.has(stateKey);
                        if (shouldPush) {
                            const pendingKey = 'lf_pending_' + stateKey;
                            const pendingIds = await this._getPending(pendingKey);
                            const pendingSet = new Set(pendingIds);
                            const localItems = (state[stateKey] || []).filter(item => pendingSet.has(item.id));

                            if (localItems.length > 0) {
                                this._pushing = true;
                                const rows = localItems.map(item => ({
                                    id: item.id,
                                    _data: JSON.stringify(item),
                                    updated_at: item.updated_at || now
                                }));
                                const { error } = await supabaseClient
                                    .from(table)
                                    .upsert(rows, { onConflict: 'id' });
                                if (!error) {
                                    pushed += localItems.length;
                                    await IDB.set(pendingKey, pendingIds.filter(id => !pendingSet.has(id)));
                                    this._dirtyKeys.delete(stateKey);
                                } else {
                                    console.warn('[LocalFirst] Push erro em', table, error.message);
                                }
                                await new Promise(r => setTimeout(r, 300));
                                this._pushing = false;
                            } else {
                                this._dirtyKeys.delete(stateKey);
                            }
                        }

                        // ── PULL: registros remotos mais novos que lastSync ───────
                        const { data, error: pullErr } = await supabaseClient
                            .from(table)
                            .select('id, _data, updated_at')
                            .gt('updated_at', lastSync);

                        if (pullErr) { console.warn('[LocalFirst] Pull erro em', table, pullErr.message); continue; }
                        if (!data || data.length === 0) continue;

                        const localMap = {};
                        (state[stateKey] || []).forEach(item => { localMap[item.id] = item; });

                        // Itens locais pendentes de push — nunca sobrescrever com dados remotos
                        const pendingIds = new Set(await this._getPending('lf_pending_' + stateKey));

                        let deletedCount = 0;
                        data.forEach(remote => {
                            try {
                                const remoteItem = typeof remote._data === 'string'
                                    ? JSON.parse(remote._data) : remote._data;

                                // Tombstone: remove do estado local (só se não for pendente local)
                                if (remoteItem && remoteItem._deleted === true) {
                                    if (localMap[remote.id] && !pendingIds.has(remote.id)) {
                                        delete localMap[remote.id];
                                        deletedCount++;
                                        console.log('[LocalFirst] Deleção remota aplicada:', table, remote.id);
                                    }
                                    return;
                                }

                                remoteItem._supabase_at = remote.updated_at;
                                const local = localMap[remote.id];
                                const remoteTs = remote.updated_at;
                                const localTs  = local?._supabase_at || local?.updated_at || '0';
                                // Nunca sobrescrever item que está na fila de push local
                                if (pendingIds.has(remote.id)) return;
                                if (!local || remoteTs > localTs) {
                                    localMap[remote.id] = remoteItem;
                                    pulled++;
                                }
                            } catch(e) {}
                        });

                        state[stateKey] = Object.values(localMap);

                        // Atualiza a UI se houve deleções remotas
                        if (deletedCount > 0) {
                            pulled += deletedCount;
                        }
                        // Atualiza UI sempre que houve qualquer pull nesta tabela
                        if (data && data.length > 0) {
                            this._refreshTableUI(stateKey);
                        }
                    }

                    if (pulled > 0) {
                        await App.saveData(true);
                    }
                    // Sempre atualiza o dashboard após sync
                    try { Dashboard.update?.(); } catch(e) {}
                    if (pulled > 0 && typeof ContasManager !== 'undefined') {
                        try { ContasManager.renderAll?.(); } catch(e) {}
                    }

                    await IDB.set(this._TS_KEY, now);
                    window._lastSyncTime = now;

                    if (pushed > 0 || pulled > 0) {
                        console.log(`[LocalFirst] Sync OK — ↑${pushed} push, ↓${pulled} pull (motivo: ${reason})`);
                    }

                } catch(e) {
                    console.warn('[LocalFirst] Sync falhou:', e.message);
                    this._pushing = false;
                } finally {
                    this._syncing = false;
                    if (btn) { btn.classList.remove('syncing'); btn.title = 'Status de sincronização'; }
                    this._updatePanel();
                }
            },

            // ── Atualiza UI da tabela após deleção remota ────────────────────
            _refreshTableUI(stateKey) {
                try {
                    switch(stateKey) {
                        case 'clients':
                            if (typeof Clients !== 'undefined') Clients.renderTable();
                            break;
                        case 'products':
                            if (typeof Products !== 'undefined') Products.renderTable();
                            break;
                        case 'sales':
                            if (typeof Sales !== 'undefined') Sales.renderHistory();
                            if (typeof ContasManager !== 'undefined') { try { ContasManager.renderAll?.(); } catch(e) {} }
                            break;
                        case 'services':
                            if (typeof Services !== 'undefined') Services.renderTable();
                            break;
                        case 'suppliers':
                            if (typeof Suppliers !== 'undefined') Suppliers.renderTable();
                            if (typeof App !== 'undefined') App.updateSupplierSelect?.();
                            break;
                        case 'expenses':
                            if (typeof Expenses !== 'undefined') {
                                Expenses.renderTable();
                                if (typeof Expenses.updateSummary === 'function') Expenses.updateSummary();
                            }
                            if (typeof ContasManager !== 'undefined') { try { ContasManager.renderAll?.(); } catch(e) {} }
                            break;
                        case 'prescriptions':
                            // Receituários são exibidos na tela do cliente — atualiza se cliente aberto
                            if (typeof Presc !== 'undefined' && typeof Presc.renderForm === 'function') {
                                try { Presc.renderForm(); } catch(e) {}
                            }
                            break;
                    }
                    // Sempre atualiza o dashboard após qualquer mudança remota
                    if (typeof Dashboard !== 'undefined') {
                        try { Dashboard.update?.(); } catch(e) {}
                    }
                } catch(e) {}
            },

            // ── Helper: lê fila pendente sempre como array ────────────────────
            async _getPending(key) {
                try {
                    const v = await IDB.get(key);
                    if (!v) return [];
                    if (Array.isArray(v)) return v;
                    // Valor corrompido (número, string, objeto) → limpa e retorna []
                    await IDB.set(key, []);
                    return [];
                } catch(e) { return []; }
            },

            // ── PUSH INDIVIDUAL (chamado ao salvar um registro) ───────────────
            async pushItem(table, item) {
                if (!item?.id) return;
                const pendingKey = 'lf_pending_' + table;

                // Enfileira o ID (garante array)
                try {
                    const existing = await this._getPending(pendingKey);
                    if (!existing.includes(item.id)) existing.push(item.id);
                    await IDB.set(pendingKey, existing);
                } catch(e) {}

                this._markDirty(table);

                if (!navigator.onLine) return;
                try {
                    this._pushing = true;
                    const row = {
                        id: item.id,
                        _data: JSON.stringify(item),
                        updated_at: item.updated_at || new Date().toISOString()
                    };
                    const { error } = await supabaseClient.from(this._TABLES[table] || table).upsert(row, { onConflict: 'id' });
                    if (!error) {
                        const existing = await this._getPending(pendingKey);
                        await IDB.set(pendingKey, existing.filter(id => id !== item.id));
                        this._dirtyKeys.delete(table);
                    }
                    await new Promise(r => setTimeout(r, 300));
                    this._pushing = false;
                } catch(e) {
                    this._pushing = false;
                    console.warn('[LocalFirst] pushItem falhou:', e.message);
                }
            },

            // ── DELETE: soft-delete com fila offline ──────────────────────────
            // Grava tombstone _deleted=true no Supabase (aparece no PULL dos outros devices)
            // Se offline: enfileira em lf_deleted_<table> e envia no próximo sync
            async deleteItem(table, id) {
                if (!id) return;
                const deletedKey = 'lf_deleted_' + table;

                // Salva na fila de deleções pendentes (persiste offline via IDB)
                try {
                    const existing = await this._getPending(deletedKey);
                    if (!existing.includes(id)) existing.push(id);
                    await IDB.set(deletedKey, existing);
                } catch(e) {}

                if (!navigator.onLine) {
                    console.warn('[LocalFirst] deleteItem offline — enfileirado:', table, id);
                    return;
                }

                // Online: envia tombstone imediatamente
                try {
                    this._pushing = true;
                    const tombstone = {
                        id: id,
                        _data: JSON.stringify({ id: id, _deleted: true }),
                        updated_at: new Date().toISOString()
                    };
                    const { error } = await supabaseClient
                        .from(this._TABLES[table] || table)
                        .upsert(tombstone, { onConflict: 'id' });
                    if (!error) {
                        const remaining = (await this._getPending(deletedKey)).filter(x => x !== id);
                        await IDB.set(deletedKey, remaining);
                        console.log('[LocalFirst] deleteItem OK (tombstone):', table, id);
                    } else {
                        console.warn('[LocalFirst] deleteItem falhou:', error.message);
                    }
                    await new Promise(r => setTimeout(r, 300));
                    this._pushing = false;
                } catch(e) {
                    this._pushing = false;
                    console.warn('[LocalFirst] deleteItem erro:', e.message);
                }
            },

            // ── CONFIG (dados da empresa — tabela separada) ───────────────────
            async pushConfig() {
                if (!navigator.onLine) return;
                try {
                    await supabaseClient.from('config').upsert({
                        id: 'empresa',
                        _data: JSON.stringify({
                            company:        state.company,
                            notificacoes:   state.notificacoes,
                            wppMensagens:   state.wppMensagens,
                            backupConfig:   state.backupConfig,
                            lastOsCounter:  state.lastOsCounter
                        }),
                        updated_at: new Date().toISOString()
                    }, { onConflict: 'id' });
                    console.log('[LocalFirst] pushConfig OK');
                } catch(e) { console.warn('[LocalFirst] pushConfig:', e.message); }
            },

            async pullConfig() {
                try {
                    const { data, error } = await supabaseClient
                        .from('config').select('_data, updated_at').eq('id', 'empresa').maybeSingle();
                    if (error || !data) return;

                    const cfg = typeof data._data === 'string' ? JSON.parse(data._data) : data._data;
                    if (!cfg) return;

                    // Só aplica se remoto for mais novo que local
                    const remoteTs = data.updated_at || '0';
                    const localTs  = state.company._supabase_at || '0';
                    if (remoteTs <= localTs) return;

                    if (cfg.company)      { Object.assign(state.company, cfg.company); state.company._supabase_at = remoteTs; }
                    if (cfg.notificacoes) Object.assign(state.notificacoes, cfg.notificacoes);
                    if (cfg.wppMensagens) Object.assign(state.wppMensagens, cfg.wppMensagens);
                    if (cfg.backupConfig) Object.assign(state.backupConfig, cfg.backupConfig);
                    if (cfg.lastOsCounter) Object.assign(state.lastOsCounter || {}, cfg.lastOsCounter);

                    // Atualiza UI após sync
                    await App.saveData(true);
                    App.updateCompanyDisplay();
                    if (typeof Config !== 'undefined') Config.load();
                    if (state.company.primaryColor) document.documentElement.style.setProperty('--primary', state.company.primaryColor);
                    if (state.company.secondaryColor) document.documentElement.style.setProperty('--secondary', state.company.secondaryColor);
                    try { Dashboard.update?.(); } catch(e) {}
                    console.log('[LocalFirst] Config sincronizada da nuvem (ts:', remoteTs, ')');
                } catch(e) { console.warn('[LocalFirst] pullConfig:', e.message); }
            },

            // ── ATUALIZA PAINEL DE STATUS ─────────────────────────────────────
            _updatePanel() {
                const panel = document.getElementById('syncStatusPanel');
                if (!panel?.classList.contains('show')) return;

                const online = navigator.onLine;
                const statusEl = document.getElementById('ss-status');
                if (statusEl) {
                    statusEl.textContent = online ? '🟢 Online' : '🟠 Offline';
                    statusEl.className   = online ? 'sync-ok' : 'sync-off';
                }
                const engineEl = document.getElementById('ss-engine');
                if (engineEl) { engineEl.textContent = 'IndexedDB'; engineEl.className = 'sync-ok'; }

                const realtimeEl = document.getElementById('ss-realtime');
                if (realtimeEl) {
                    const rs = this._realtimeStatus || 'Conectando...';
                    realtimeEl.textContent = rs;
                    realtimeEl.className = rs === 'Ativo' ? 'sync-ok' : rs === 'Erro' ? 'sync-off' : 'sync-ok';
                }

                const queueEl = document.getElementById('ss-queue');
                if (queueEl) {
                    // Conta total de IDs pendentes em todas as tabelas
                    let totalPending = 0;
                    const tableKeys = Object.keys(this._TABLES);
                    Promise.all(tableKeys.map(k => IDB.get('lf_pending_' + k).catch(() => [])))
                        .then(results => {
                            results.forEach(arr => { totalPending += (arr || []).length; });
                            queueEl.textContent = totalPending + ' ops';
                            queueEl.className = totalPending > 0 ? 'sync-off' : 'sync-ok';
                        });
                }

                const colMap = {
                    'ss-clients': 'clients', 'ss-products': 'products', 'ss-sales': 'sales',
                    'ss-expenses': 'expenses', 'ss-prescriptions': 'prescriptions', 'ss-suppliers': 'suppliers', 'ss-services': 'services'
                };
                for (const [elId, stateKey] of Object.entries(colMap)) {
                    const el = document.getElementById(elId);
                    if (!el) continue;
                    const arr = state[stateKey] || [];
                    el.textContent = arr.length + ' reg.';
                    el.className = 'sync-ok';
                }

                const lastEl = document.getElementById('ss-last');
                if (lastEl) {
                    lastEl.textContent = window._lastSyncTime
                        ? new Date(window._lastSyncTime).toLocaleTimeString('pt-BR') : '—';
                }
            }
        };

        // Expõe LocalFirst globalmente para botões do painel
        window.LocalFirst = LocalFirst;


        // Helpers de conveniência (legados)
        async function idbSave(key, value) { return IDB.set(key, value); }
        async function idbGet(key) { return IDB.get(key); }

        // ==================== CONTAS A RECEBER / A PAGAR ====================
        const ContasManager = {
            _key: 'contas_financeiras',

            async getAll() {
                try {
                    const raw = await IDB.get(this._key);
                    return raw ? JSON.parse(raw) : [];
                } catch(e) { return []; }
            },

            async saveAll(contas) {
                await IDB.set(this._key, JSON.stringify(contas));
            },

            fmt(v) {
                return 'R$ ' + parseFloat(v||0).toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2});
            },

            async renderAll() {
                const contas = await this.getAll();
                const hoje = new Date().toISOString().split('T')[0];

                // ── Injeta parcelas de vendas em Contas a Receber ──────────────
                const metodosAVista = ['pix', 'cash', 'debit', 'credit'];
                const metodoLabel   = {pix:'PIX', cash:'Dinheiro', debit:'Débito', credit:'Crédito', installment:'Crediário'};
                const contasVendas  = [];

                (state.sales || []).forEach(sale => {
                    if (sale.status === 'cancelado') return;
                    if (sale.paymentStatus === 'pago') return;

                    const client       = (state.clients || []).find(c => c.id === sale.clientId);
                    const nomeCliente  = client ? client.name : 'Cliente';
                    const det          = sale.paymentDetails || {};
                    const parcelas     = det.parcels || [];
                    const method       = sale.paymentMethod || '';

                    // ── Pagamento Duplo (2 formas) ─────────────────────────────
                    if (sale.paymentMode === 'dual' && sale.dualPayments?.length === 2) {
                        sale.dualPayments.forEach((slot, idx) => {
                            const slotLabel = idx === 0 ? '1ª' : '2ª';
                            const mLbl = {pix:'PIX',cash:'Dinheiro',debit:'Débito',credit:'Crédito',installment:'Crediário'}[slot.method] || slot.method;
                            if (slot.method === 'installment') {
                                // Parcelas do crediário desta forma
                                (slot.parcelas || []).forEach(p => {
                                    if (p.paid || p.status === 'pago' || p.status === 'paid') return;
                                    contasVendas.push({
                                        id: `venda_${sale.id}_dual${idx}_p${p.number}`,
                                        tipo: 'receber',
                                        descricao: `OS ${sale.number} — ${slotLabel} Forma (Crediário) Parcela ${p.number}/${slot.nParcelas||slot.parcelas.length}`,
                                        parte: nomeCliente,
                                        categoria: 'Crediário',
                                        valor: parseFloat(p.value || 0),
                                        vencimento: p.dueDate || '',
                                        pago: false,
                                        _readonly: true
                                    });
                                });
                                // Retirada desta forma de crediário
                                if ((slot.retirada || 0) > 0.01 && !sale[`retiradaPaga_dual${idx}`]) {
                                    contasVendas.push({
                                        id: `venda_${sale.id}_dual${idx}_retirada`,
                                        tipo: 'receber',
                                        descricao: `OS ${sale.number} — ${slotLabel} Forma (Crediário) Retirada`,
                                        parte: nomeCliente,
                                        categoria: 'Retirada',
                                        valor: parseFloat(slot.retirada),
                                        vencimento: sale.deliveryForecast || sale.date || '',
                                        pago: false,
                                        _readonly: true
                                    });
                                }
                            } else {
                                // À vista com retirada pendente
                                if ((slot.retirada || 0) > 0.01 && (slot.entry || 0) > 0.01 && !sale[`retiradaPaga_dual${idx}`]) {
                                    contasVendas.push({
                                        id: `venda_${sale.id}_dual${idx}_retirada`,
                                        tipo: 'receber',
                                        descricao: `OS ${sale.number} — ${slotLabel} Forma (${mLbl}) Retirada`,
                                        parte: nomeCliente,
                                        categoria: 'Retirada',
                                        valor: parseFloat(slot.retirada),
                                        vencimento: sale.deliveryForecast || sale.date || '',
                                        pago: false,
                                        _readonly: true
                                    });
                                }
                            }
                        });
                        return;
                    }

                    // ── Crediário ──────────────────────────────────────────────
                    if (method === 'installment') {
                        // Parcelas pendentes
                        parcelas.forEach(p => {
                            if (p.paid || p.status === 'pago' || p.status === 'paid') return;
                            contasVendas.push({
                                id: 'venda_' + sale.id + '_p' + p.number,
                                tipo: 'receber',
                                descricao: `OS ${sale.number} — Parcela ${p.number}/${parcelas.length}`,
                                parte: nomeCliente,
                                categoria: 'Crediário',
                                valor: parseFloat(p.value || 0),
                                vencimento: p.dueDate || '',
                                pago: false,
                                _readonly: true
                            });
                        });

                        // Valor na retirada do crediário
                        // Pode estar salvo em det.retiradaEntry (instFromValue) OU det.retiradaValue (instFromPercent)
                        const retiradaCrediario = parseFloat(det.retiradaEntry || 0) || parseFloat(det.retiradaValue || 0);
                        if (retiradaCrediario > 0.01 && !sale.retiradaPaga) {
                            contasVendas.push({
                                id: 'venda_' + sale.id + '_retirada',
                                tipo: 'receber',
                                descricao: `OS ${sale.number} — Pagamento na Retirada`,
                                parte: nomeCliente,
                                categoria: 'Retirada',
                                valor: retiradaCrediario,
                                vencimento: sale.deliveryForecast || sale.date || '',
                                pago: false,
                                _readonly: true
                            });
                        }
                        return;
                    }

                    // ── À vista (PIX / Dinheiro / Débito / Crédito) ────────────
                    if (metodosAVista.includes(method)) {
                        if (sale.status === 'entregue') return;
                        // Só gera conta a receber se foi explicitamente salvo um saldo de retirada
                        // (det.retiradaValue > 0) E a entrada foi menor que o total
                        const retiradaAVista = parseFloat(det.retiradaValue || 0);
                        const entradaAVista  = parseFloat(det.entradaValue  || 0);
                        if (retiradaAVista > 0.01 && entradaAVista > 0 && !sale.retiradaPaga) {
                            contasVendas.push({
                                id: 'venda_' + sale.id + '_retirada',
                                tipo: 'receber',
                                descricao: `OS ${sale.number} — Saldo na Retirada (${metodoLabel[method]||method})`,
                                parte: nomeCliente,
                                categoria: 'Retirada',
                                valor: retiradaAVista,
                                vencimento: sale.deliveryForecast || sale.date || '',
                                pago: false,
                                _readonly: true
                            });
                        }
                        // PIX/Dinheiro/Débito/Crédito integralmente pago → não gera nada
                        return;
                    }

                    // ── Outros métodos sem parcelamento ────────────────────────
                    if (parcelas.length === 0 && sale.total > 0 && sale.status !== 'entregue') {
                        contasVendas.push({
                            id: 'venda_' + sale.id + '_total',
                            tipo: 'receber',
                            descricao: `OS ${sale.number} — Total`,
                            parte: nomeCliente,
                            categoria: 'Venda',
                            valor: parseFloat(sale.total || 0),
                            vencimento: sale.deliveryForecast || sale.date || '',
                            pago: false,
                            _readonly: true
                        });
                    }
                });

                // ── Injeta despesas pendentes em Contas a Pagar ────────────────
                const contasDespesas = [];
                (state.expenses || []).forEach(exp => {
                    if (exp.status === 'pago' || exp.pago || exp.paid) return;
                    contasDespesas.push({
                        id: 'desp_' + exp.id,
                        tipo: 'pagar',
                        descricao: exp.desc || exp.description || 'Despesa',
                        parte: exp.supplierId || '',
                        categoria: exp.category || 'Despesa',
                        valor: parseFloat(exp.value || 0),
                        vencimento: exp.date || '',
                        pago: false,
                        _readonly: true
                    });
                });

                const receber = [...contas.filter(c => c.tipo === 'receber'), ...contasVendas];
                const pagar   = [...contas.filter(c => c.tipo === 'pagar'),   ...contasDespesas];

                const totalRec = receber.filter(c=>!c.pago).reduce((s,c)=>s+parseFloat(c.valor||0),0);
                const totalPag = pagar.filter(c=>!c.pago).reduce((s,c)=>s+parseFloat(c.valor||0),0);

                const elRec = document.getElementById('contasReceberTotal');
                const elPag = document.getElementById('contasPagarTotal');
                if(elRec) elRec.textContent = this.fmt(totalRec);
                if(elPag) elPag.textContent = this.fmt(totalPag);

                this._renderList('contasReceberList', receber, hoje);
                this._renderList('contasPagarList', pagar, hoje);
            },

            _renderList(elId, contas, hoje) {
                const el = document.getElementById(elId);
                if(!el) return;
                if(!contas.length) {
                    el.innerHTML = '<p style="color:var(--gray);font-size:0.85rem;text-align:center;padding:0.75rem 0;">Nenhum lançamento</p>';
                    return;
                }
                // Sort: pendentes primeiro, vencidas em destaque
                contas.sort((a,b)=>{
                    if(a.pago && !b.pago) return 1;
                    if(!a.pago && b.pago) return -1;
                    return (a.vencimento||'') < (b.vencimento||'') ? -1 : 1;
                });
                el.innerHTML = contas.map(c => {
                    const venc = c.vencimento || '';
                    const vencida = !c.pago && venc && venc < hoje;
                    const classes = ['conta-item', c.tipo, c.pago?'paga':'', vencida?'vencida':''].filter(Boolean).join(' ');
                    const vencLabel = venc ? new Date(venc+'T12:00:00').toLocaleDateString('pt-BR') : '—';
                    const statusBadge = c.pago
                        ? '<span style="background:#28a745;color:white;border-radius:10px;padding:2px 8px;font-size:0.72rem;font-weight:700;">✓ Pago</span>'
                        : vencida
                            ? '<span style="background:#ffc107;color:#000;border-radius:10px;padding:2px 8px;font-size:0.72rem;font-weight:700;">⚠ Vencida</span>'
                            : '<span style="background:#e9ecef;color:#555;border-radius:10px;padding:2px 8px;font-size:0.72rem;font-weight:700;">Pendente</span>';
                    return `<div class="${classes}">
                        <div class="conta-item-info">
                            <div class="conta-item-nome">${c.descricao||'—'}</div>
                            <div class="conta-item-det">${c.parte||''} ${c.categoria ? '· '+c.categoria : ''} · Venc: ${vencLabel} ${statusBadge}</div>
                        </div>
                        <span class="conta-item-valor">${this.fmt(c.valor)}</span>
                        <div class="conta-item-actions">
                            ${!c.pago && !c._readonly ? `<button class="btn btn-sm" style="background:#28a745;color:white;padding:4px 8px;font-size:0.75rem;" title="Dar Baixa" onclick="ContasManager.darBaixa('${c.id}')"><i class="fas fa-check"></i></button>` : ''}
                            ${!c.pago && c._readonly ? `<button class="btn btn-sm" style="background:#28a745;color:white;padding:4px 8px;font-size:0.75rem;" title="Dar Baixa" onclick="ContasManager.darBaixaVenda('${c.id}')"><i class="fas fa-check"></i></button>` : ''}
                            ${!c._readonly ? `<button class="btn btn-sm btn-secondary" style="padding:4px 8px;font-size:0.75rem;" title="Comprovante" onclick="ContasManager.gerarComprovante('${c.id}')"><i class="fas fa-receipt"></i></button>` : ''}
                            ${!c._readonly ? `<button class="btn btn-sm" style="background:#17a2b8;color:white;padding:4px 8px;font-size:0.75rem;" title="Editar" onclick="ContasManager.editarConta('${c.id}')"><i class="fas fa-pen"></i></button>` : ''}
                            ${!c._readonly ? `<button class="btn btn-sm btn-danger" style="padding:4px 8px;font-size:0.75rem;" title="Excluir" onclick="ContasManager.excluirConta('${c.id}')"><i class="fas fa-trash"></i></button>` : ''}
                            ${c._readonly ? `<span style="font-size:0.72rem;color:var(--gray);padding:4px 6px;" title="Gerado automaticamente pela venda">🔗 Auto</span>` : ''}
                        </div>
                    </div>`;
                }).join('');
            },

            showModal(tipo) {
                document.getElementById('contaEditId').value = '';
                document.getElementById('contaTipo').value = tipo;
                document.getElementById('contaDescricao').value = '';
                document.getElementById('contaValor').value = '';
                document.getElementById('contaVencimento').value = new Date().toISOString().split('T')[0];
                document.getElementById('contaParte').value = '';
                document.getElementById('contaCategoria').value = '';
                document.getElementById('contaObs').value = '';
                document.getElementById('modalContasTitulo').textContent = tipo === 'receber' ? '💰 Nova Conta a Receber' : '💸 Nova Conta a Pagar';
                document.getElementById('modalContas').style.display = 'flex';
            },

            closeModal() {
                document.getElementById('modalContas').style.display = 'none';
            },

            async saveConta() {
                const desc = document.getElementById('contaDescricao').value.trim();
                const valor = parseFloat(document.getElementById('contaValor').value);
                const venc  = document.getElementById('contaVencimento').value;
                if(!desc) { Toast.show('Informe a descrição','warning'); return; }
                if(!valor || valor <= 0) { Toast.show('Informe um valor válido','warning'); return; }
                if(!venc) { Toast.show('Informe o vencimento','warning'); return; }

                const contas = await this.getAll();
                const editId = document.getElementById('contaEditId').value;

                if(editId) {
                    const idx = contas.findIndex(c=>c.id===editId);
                    if(idx>=0) {
                        contas[idx] = { ...contas[idx],
                            descricao: desc, valor, vencimento: venc,
                            parte: document.getElementById('contaParte').value.trim(),
                            categoria: document.getElementById('contaCategoria').value.trim(),
                            obs: document.getElementById('contaObs').value.trim()
                        };
                    }
                    Toast.show('Conta atualizada!','success');
                } else {
                    contas.push({
                        id: 'conta_' + Date.now(),
                        tipo: document.getElementById('contaTipo').value,
                        descricao: desc, valor, vencimento: venc,
                        parte: document.getElementById('contaParte').value.trim(),
                        categoria: document.getElementById('contaCategoria').value.trim(),
                        obs: document.getElementById('contaObs').value.trim(),
                        pago: false,
                        criado: new Date().toISOString()
                    });
                    Toast.show('Conta adicionada!','success');
                }
                await this.saveAll(contas);
                this.closeModal();
                this.renderAll();
            },

            async darBaixa(id) {
                if(!confirm('Confirmar baixa nesta conta?')) return;
                const contas = await this.getAll();
                const idx = contas.findIndex(c=>c.id===id);
                if(idx>=0) {
                    contas[idx].pago = true;
                    contas[idx].dataPagamento = new Date().toISOString();
                    await this.saveAll(contas);
                    Toast.show('Baixa registrada!','success');
                    this.renderAll();
                    this.gerarComprovante(id);
                }
            },

            // Dar baixa em parcela ou retirada gerada automaticamente pela venda
            darBaixaVenda(itemId) {
                // Formato dos IDs:
                //   venda_{saleId}_p{N}       → parcela N do crediário
                //   venda_{saleId}_retirada   → pagamento na retirada
                //   venda_{saleId}_total      → total da venda (outros métodos)
                if (!confirm('Confirmar baixa neste item? Esta ação marca o pagamento como recebido.')) return;
                const parts = itemId.split('_');
                // parts: ["venda", saleId, "pN" | "retirada" | "total"]
                if (parts.length < 3) return;
                const saleId = parts[1];
                const tipo   = parts.slice(2).join('_'); // "p1", "p2", "retirada", "total"
                const sale   = (state.sales || []).find(s => s.id === saleId);
                if (!sale) { Toast.show('Venda não encontrada','warning'); return; }

                // Suporte ao modo dual: venda_{id}_dual{N}_p{M} ou venda_{id}_dual{N}_retirada
                if (tipo.startsWith('dual')) {
                    const dualParts = tipo.split('_'); // ['dual0','p1'] ou ['dual0','retirada']
                    const dualIdx   = parseInt(dualParts[0].replace('dual',''));
                    const dualSub   = dualParts.slice(1).join('_');
                    if (dualSub.startsWith('p') && /^p\d+$/.test(dualSub)) {
                        const num = parseInt(dualSub.slice(1));
                        if (sale.dualPayments?.[dualIdx]?.parcelas) {
                            const parc = sale.dualPayments[dualIdx].parcelas.find(p => p.number === num);
                            if (parc) {
                                parc.paid = true; parc.status = 'pago'; parc.paidDate = new Date().toISOString().slice(0,10);
                                App.saveData();
                                Toast.show(`Parcela ${num} quitada! ✅`, 'success');
                                this.renderAll();
                            }
                        }
                    } else if (dualSub === 'retirada') {
                        sale[`retiradaPaga_dual${dualIdx}`] = true;
                        App.saveData();
                        Toast.show('Retirada registrada! ✅', 'success');
                        this.renderAll();
                    }
                    return;
                }

                if (tipo.startsWith('p') && /^p\d+$/.test(tipo)) {
                    // Parcela de crediário
                    const num = parseInt(tipo.slice(1));
                    if (sale.paymentDetails && sale.paymentDetails.parcels) {
                        const parc = sale.paymentDetails.parcels.find(p => p.number === num);
                        if (parc) {
                            parc.paid     = true;
                            parc.status   = 'pago';
                            parc.paidDate = new Date().toISOString().slice(0,10);
                            // Verifica se todas as parcelas foram pagas
                            const todasPagas = sale.paymentDetails.parcels.every(p => p.paid || p.status === 'pago' || p.status === 'paid');
                            if (todasPagas && !sale.paymentDetails.retiradaEntry) {
                                sale.paymentStatus = 'pago';
                            }
                            App.saveData();
                            Toast.show(`Parcela ${num} quitada! ✅`, 'success');
                            this.renderAll();
                        }
                    }
                } else if (tipo === 'retirada') {
                    // Valor na retirada (crediário ou à vista com saldo)
                    if (sale.paymentDetails && sale.paymentDetails.retiradaEntry) {
                        sale.retiradaPaga = true;
                    } else if (sale.paymentDetails && sale.paymentDetails.retiradaValue) {
                        sale.paymentDetails.retiradaValue = 0;
                        sale.paymentStatus = 'pago';
                    }
                    App.saveData();
                    Toast.show('Pagamento na retirada registrado! ✅', 'success');
                    this.renderAll();
                } else if (tipo === 'total') {
                    sale.paymentStatus = 'pago';
                    App.saveData();
                    Toast.show('Pagamento registrado! ✅', 'success');
                    this.renderAll();
                }
            },

            async gerarComprovante(id) {
                const contas = await this.getAll();
                const c = contas.find(x=>x.id===id);
                if(!c) return;
                const emp = state.company || {};
                const dataPag = c.dataPagamento ? new Date(c.dataPagamento).toLocaleString('pt-BR') : '—';
                const vencFmt = c.vencimento ? new Date(c.vencimento+'T12:00:00').toLocaleDateString('pt-BR') : '—';
                const tipo = c.tipo === 'receber' ? 'RECEBIMENTO' : 'PAGAMENTO';
                const txt = [
                    '═══════════════════════════════',
                    `   ${emp.name || 'EMPRESA'}`,
                    `   CNPJ: ${emp.cnpj || '—'}`,
                    '═══════════════════════════════',
                    `   COMPROVANTE DE ${tipo}`,
                    '───────────────────────────────',
                    `Descrição : ${c.descricao}`,
                    `Valor     : ${this.fmt(c.valor)}`,
                    `Vencimento: ${vencFmt}`,
                    `${tipo === 'RECEBIMENTO' ? 'Cliente' : 'Fornecedor'}: ${c.parte || '—'}`,
                    `Categoria : ${c.categoria || '—'}`,
                    c.obs ? `Obs       : ${c.obs}` : null,
                    '───────────────────────────────',
                    `Status    : ${c.pago ? '✓ PAGO' : 'PENDENTE'}`,
                    c.pago ? `Data Pag. : ${dataPag}` : null,
                    '═══════════════════════════════',
                    `Emitido em: ${new Date().toLocaleString('pt-BR')}`,
                ].filter(Boolean).join('\n');
                document.getElementById('comprovanteContent').textContent = txt;
                document.getElementById('modalComprovante').style.display = 'flex';
            },

            imprimirComprovante() {
                const c = document.getElementById('comprovanteContent').textContent;
                const w = window.open('','_blank','width=400,height=600');
                w.document.write(`<html><head><title>Comprovante</title><style>body{font-family:monospace;padding:20px;white-space:pre;font-size:13px;}@media print{body{margin:0;}}</style></head><body>${c}</body></html>`);
                w.document.close();
                w.print();
            },

            async editarConta(id) {
                const contas = await this.getAll();
                const c = contas.find(x=>x.id===id);
                if(!c) return;
                document.getElementById('contaEditId').value = id;
                document.getElementById('contaTipo').value = c.tipo;
                document.getElementById('contaDescricao').value = c.descricao||'';
                document.getElementById('contaValor').value = c.valor||'';
                document.getElementById('contaVencimento').value = c.vencimento||'';
                document.getElementById('contaParte').value = c.parte||'';
                document.getElementById('contaCategoria').value = c.categoria||'';
                document.getElementById('contaObs').value = c.obs||'';
                document.getElementById('modalContasTitulo').textContent = c.tipo === 'receber' ? '✏️ Editar Conta a Receber' : '✏️ Editar Conta a Pagar';
                document.getElementById('modalContas').style.display = 'flex';
            },

            async excluirConta(id) {
                if(!confirm('Excluir esta conta?')) return;
                const contas = await this.getAll();
                await this.saveAll(contas.filter(c=>c.id!==id));
                Toast.show('Conta excluída','info');
                this.renderAll();
            }
        };
        window.ContasManager = ContasManager;
        const WppConfirm = {
            _url: '',

            show({ nome, phone, subtitle, msg, url }) {
                this._url = url;
                document.getElementById('wppConfirmName').textContent    = nome    || '—';
                document.getElementById('wppConfirmPhone').textContent   = this._formatPhone(phone);
                document.getElementById('wppConfirmSubtitle').textContent = subtitle || 'Verifique os dados antes de enviar';
                document.getElementById('wppConfirmPreview').textContent = msg     || '';
                document.getElementById('wppConfirmSendBtn').onclick = () => { this.send(); };
                document.getElementById('wppConfirmModal').classList.add('show');
            },

            send() {
                window.open(this._url, '_blank');
                this.close();
            },

            close() {
                document.getElementById('wppConfirmModal').classList.remove('show');
                this._url = '';
            },

            _formatPhone(raw = '') {
                const d = raw.replace(/\D/g, '');
                if (d.length === 11) return `(${d.slice(0,2)}) ${d.slice(2,7)}-${d.slice(7)}`;
                if (d.length === 10) return `(${d.slice(0,2)}) ${d.slice(2,6)}-${d.slice(6)}`;
                return raw || '—';
            }
        };

        // Fechar modal WppConfirm ao clicar fora
        document.getElementById('wppConfirmModal')?.addEventListener('click', (e) => {
            if (e.target === e.currentTarget) WppConfirm.close();
        });
        const Toast = {
            container: document.getElementById('toastContainer'),
            show(message, type = 'success', duration = 3000) {
                const id = 'toast_' + Date.now();
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.id = id;
                toast.innerHTML = `
                    <div class="toast-icon">
                        ${type === 'success' ? '<i class="fas fa-check-circle"></i>' : 
                          type === 'error' ? '<i class="fas fa-exclamation-circle"></i>' :
                          type === 'warning' ? '<i class="fas fa-exclamation-triangle"></i>' :
                          '<i class="fas fa-info-circle"></i>'}
                    </div>
                    <div class="toast-content">
                        <div class="toast-title">${type.charAt(0).toUpperCase() + type.slice(1)}</div>
                        <div class="toast-message">${message}</div>
                    </div>
                    <button class="toast-close" onclick="Toast.close('${id}')"><i class="fas fa-times"></i></button>
                `;
                this.container.appendChild(toast);
                setTimeout(() => { const el = document.getElementById(id); if (el) el.remove(); }, duration);
            },
            close(id) { document.getElementById(id)?.remove(); }
        };

        // ==================== ESTADO GLOBAL ====================
        const state = {
            company: {
                name: 'ÓticaVision Pro',
                legalName: '',
                cnpj: '12.345.678/0001-99',
                ie: '',
                phone: '(11) 9999-9999',
                whatsapp: '',
                email: 'contato@oticavision.com',
                website: '',
                cep: '',
                address: '',
                number: '',
                complement: '',
                neighborhood: '',
                city: '',
                state: '',
                primaryColor: '#ff6b00',
                secondaryColor: '#ffcc00',
                creditTax: 2.5,
                warrantyDays: 90,
                commission: 5,
                deliveryFee: 0,
                nfSeries: '001',
                paymentMethods: {
                    pix: true,
                    cash: true,
                    debit: true,
                    credit: true,
                    installment: true
                },
                pix: '12.345.678/0001-99',
                lateFee: 2,
                dailyInterest: 0.033,
                logo: null,
                lojaAtual: '' // 'barueri' | 'caucaia' | ''
            },
            clients: [],
            products: [],
            services: [],
            suppliers: [],
            sales: [],
            expenses: [],
            prescriptions: [],
            currentSale: {
                number: '',
                date: '',
                unit: 'barueri',
                seller: '',
                deliveryForecast: '',
                clientId: null,
                items: [],
                subtotal: 0,
                discount: 0,
                addition: 0,
                total: 0,
                paymentMethod: 'installment',
                paymentDetails: null,
                observations: '',
                status: 'orcamento',
                statusHistory: []
            },
            editingId: null,
            editingSaleId: null, // ID da venda sendo editada
            osModelo: 'colorido', // 'colorido' | 'semfundo' | 'pb'
            lastOsCounter: {},
            lastOsYear: new Date().getFullYear(),
            notificacoes: {
                lowStock: true,
                outOfStock: true,
                osReady: true,
                osDelay: true,
                osDelayDays: 7,
                paymentDue: true,
                paymentOverdue: true,
                whatsapp: false,
                whatsappNumber: ''
            },
            users: [
                { username: 'admin', fullName: 'Administrador', profile: 'admin', status: 'active', lastAccess: 'Nunca' }
            ],
            backupConfig: {
                autoEnabled: false,
                hour: 3,
                keepDays: 7,
                lastAutoBackup: null,
                nextAutoBackup: null
            },
            wppMensagens: {
                aniversario: "🎂 *Feliz Aniversário, {{NOME}}!* 🎉\n\nHoje, *{{DATA}}*, é um dia muito especial e nós da *{{EMPRESA}}* queremos celebrar junto com você! 🥳\n\nQue este novo ano seja repleto de muita saúde, alegria e visão nítida! 👁️✨\n\nTemos um presente especial esperando por você — venha nos visitar! 🎁\n\n━━━━━━━━━━━━━━━━━━━━\n*{{EMPRESA}}*\n📍 {{ENDERECO}}\n📞 {{TELEFONE}}",
                oculosVencido: "Olá *{{NOME}}*! 👋\n\nPassando para dar um recado importante! 😊\n\nVerificamos que faz aproximadamente *{{MESES}} meses* que você adquiriu seus óculos conosco (OS {{OS}} — {{DATA_VENDA}}).\n\n👓 Especialistas recomendam *revisão anual* da receita para garantir a saúde dos seus olhos e o conforto visual!\n\nQue tal agendar uma consulta de revisão? Temos condições especiais para clientes recorrentes! 🎁\n\n━━━━━━━━━━━━━━━━━━━━\n*{{EMPRESA}}*\n📍 {{ENDERECO}}\n📞 {{TELEFONE}}",
                statusPedido: "Olá *{{NOME}}*! 👋\n\nSegue a atualização do seu pedido:\n\n🏪 *{{EMPRESA}}*\n━━━━━━━━━━━━━━━━━━━━\n📋 *OS Nº:* {{OS}}\n📅 *Data da compra:* {{DATA_VENDA}}\n🚚 *Previsão de entrega:* {{PREVISAO}}\n\n🔄 *Status atual:*\n➡️ *{{STATUS}}*\n\n{{MSG_STATUS}}\n━━━━━━━━━━━━━━━━━━━━\nDúvidas? Fale conosco! 😊\n📞 {{TELEFONE}}",
                receituario: "👁️ *RECEITUÁRIO ÓPTICO*\n━━━━━━━━━━━━━━━━━━━━\n🏪 *{{EMPRESA}}*\n📍 {{ENDERECO}}\n📞 {{TELEFONE}}\n━━━━━━━━━━━━━━━━━━━━\n\n👤 *Paciente:* {{PACIENTE}}\n📅 *Data:* {{DATA}}\n\n*🔵 OLHO DIREITO (OD)*\n{{DADOS_OD}}\n\n*🔴 OLHO ESQUERDO (OE)*\n{{DADOS_OE}}\n\n{{DADOS_EXTRA}}\n━━━━━━━━━━━━━━━━━━━━\n_Documento gerado por {{EMPRESA}}_\n_Válido mediante assinatura do profissional._",
                comprovante: "✅ *COMPROVANTE DE PAGAMENTO*\n━━━━━━━━━━━━━━━━━━━━\n🏪 *{{EMPRESA}}*\n📍 {{ENDERECO}}\n━━━━━━━━━━━━━━━━━━━━\n\n👤 *Cliente:* {{NOME}}\n🆔 *CPF:* {{CPF}}\n\n📋 *OS Nº:* {{OS}}\n🔢 *Parcela:* {{PARCELA}}\n📅 *Vencimento:* {{VENCIMENTO}}\n📅 *Data Pagamento:* {{DATA_PAGAMENTO}}\n\n💵 *VALOR PAGO: {{VALOR}}*\n💳 *Forma:* {{FORMA_PAGAMENTO}}\n\n✅ *PAGAMENTO CONFIRMADO*\n\n━━━━━━━━━━━━━━━━━━━━\n📞 {{TELEFONE}}\n_Documento gerado por {{EMPRESA}}_"
            }
        };

        // ==================== UTILITÁRIOS ====================
        const Utils = {
            formatCurrency(value) {
                return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value || 0);
            },

            formatDate(dateString) {
                if (!dateString) return '';
                try {
                    const date = new Date(dateString + 'T12:00:00');
                    return date.toLocaleDateString('pt-BR');
                } catch {
                    return '';
                }
            },

            maskPhone(input) {
                let v = input.value.replace(/\D/g, '');
                v = v.slice(0, 11);
                v = v.replace(/^(\d{2})(\d)/g, '($1) $2');
                v = v.replace(/(\d{4,5})(\d{4})$/, '$1-$2');
                input.value = v;
            },

            maskMoney(input) {
                let v = input.value.replace(/\D/g, '');
                if (!v) { input.value = ''; return; }
                v = (parseInt(v, 10) / 100).toFixed(2);
                input.value = v.replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            },

            parseMoney(str) {
                if (!str) return 0;
                return parseFloat(String(str).replace(/\./g, '').replace(',', '.')) || 0;
            },

            maskCep(input) {
                let v = input.value.replace(/\D/g, '').slice(0, 8);
                v = v.replace(/^(\d{5})(\d)/, '$1-$2');
                input.value = v;
            },

            maskCpfCnpj(input) {
                let v = input.value.replace(/\D/g, '');
                if (v.length <= 11) {
                    v = v.slice(0, 11);
                    v = v.replace(/(\d{3})(\d)/, '$1.$2');
                    v = v.replace(/(\d{3})(\d)/, '$1.$2');
                    v = v.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
                } else {
                    v = v.slice(0, 14);
                    v = v.replace(/(\d{2})(\d)/, '$1.$2');
                    v = v.replace(/(\d{3})(\d)/, '$1.$2');
                    v = v.replace(/(\d{3})(\d)/, '$1.$2');
                    v = v.replace(/(\d{4})(\d{1,2})$/, '$1-$2');
                }
                input.value = v;
            },

            maskCnpj(input) {
                let v = input.value.replace(/\D/g, '').slice(0, 14);
                v = v.replace(/^(\d{2})(\d)/, '$1.$2');
                v = v.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
                v = v.replace(/\.(\d{3})(\d)/, '.$1/$2');
                v = v.replace(/(\d{4})(\d)/, '$1-$2');
                input.value = v;
            },

            sanitizeHTML(str) {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            },

            generateId(prefix) {
                return prefix + '-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            },

            updatePixKey() {
                const pixElement = document.getElementById('companyPix');
                if (pixElement) {
                    pixElement.innerText = state.company.cnpj || '12.345.678/0001-99';
                }
            },

            validateRequired(formId) {
                const form = document.getElementById(formId);
                if (!form) return true;
                
                let isValid = true;
                form.querySelectorAll('[required]').forEach(field => {
                    if (!field.value.trim()) {
                        field.classList.add('error');
                        const errorMsg = field.nextElementSibling;
                        if (errorMsg && errorMsg.classList.contains('error-message')) {
                            errorMsg.classList.remove('d-none');
                        }
                        isValid = false;
                    } else {
                        field.classList.remove('error');
                        const errorMsg = field.nextElementSibling;
                        if (errorMsg && errorMsg.classList.contains('error-message')) {
                            errorMsg.classList.add('d-none');
                        }
                    }
                });
                return isValid;
            },

            numeroPorExtenso(valor) {
                const unidades = ['', 'um', 'dois', 'três', 'quatro', 'cinco', 'seis', 'sete', 'oito', 'nove',
                                   'dez', 'onze', 'doze', 'treze', 'catorze', 'quinze', 'dezesseis', 'dezessete', 'dezoito', 'dezenove'];
                const dezenas  = ['', '', 'vinte', 'trinta', 'quarenta', 'cinquenta', 'sessenta', 'setenta', 'oitenta', 'noventa'];
                const centenas = ['', 'cento', 'duzentos', 'trezentos', 'quatrocentos', 'quinhentos',
                                   'seiscentos', 'setecentos', 'oitocentos', 'novecentos'];

                const inteiro   = Math.floor(valor);
                const centavos  = Math.round((valor - inteiro) * 100);

                if (inteiro === 0 && centavos === 0) return 'zero reais';

                // Converte grupos de até 3 dígitos em extenso
                const grupoParaExtenso = (n) => {
                    if (n === 0) return '';
                    if (n === 100) return 'cem';
                    let r = '';
                    if (n >= 100) {
                        r += centenas[Math.floor(n / 100)];
                        n = n % 100;
                        if (n > 0) r += ' e ';
                    }
                    if (n >= 20) {
                        r += dezenas[Math.floor(n / 10)];
                        if (n % 10 > 0) r += ' e ' + unidades[n % 10];
                    } else if (n > 0) {
                        r += unidades[n];
                    }
                    return r;
                };

                let extenso = '';

                if (inteiro === 0) {
                    extenso = 'zero';
                } else if (inteiro >= 1000000) {
                    const milhoes = Math.floor(inteiro / 1000000);
                    extenso += grupoParaExtenso(milhoes) + (milhoes === 1 ? ' milhão' : ' milhões');
                    const resto = inteiro % 1000000;
                    if (resto > 0) extenso += ' e ' + grupoParaExtenso(resto);  // simplificado
                } else if (inteiro >= 1000) {
                    const milhares = Math.floor(inteiro / 1000);
                    extenso += milhares === 1 ? 'um mil' : grupoParaExtenso(milhares) + ' mil';
                    const resto = inteiro % 1000;
                    if (resto > 0) extenso += (resto < 100 ? ' e ' : ' ') + grupoParaExtenso(resto);
                } else {
                    extenso = grupoParaExtenso(inteiro);
                }

                extenso += inteiro === 1 ? ' real' : ' reais';

                if (centavos > 0) {
                    extenso += ' e ' + centavos + (centavos === 1 ? ' centavo' : ' centavos');
                }

                return extenso;
            },

            showFeedback(message, type = 'success') {
                Toast.show(message, type);
            },

            // Funções de busca de CNPJ (reutilizáveis) - v2.1 corrigido
            async buscarCnpjCompleto(input, prefix) {
                const cnpj = input.value.replace(/\D/g, '');
                if (cnpj.length !== 14) {
                    Toast.show('CNPJ deve ter 14 dígitos', 'warning');
                    return;
                }

                const originalValue = input.value;
                input.value = 'Buscando...';
                input.disabled = true;

                // Mapeamento de campos por prefixo (evita getElementById null)
                const fieldMap = {
                    supplier: {
                        legalName: 'supplierName',   // fornecedor não tem campo razão social separado
                        name:      'supplierName',
                        phone:     'supplierPhone',
                        email:     'supplierEmail',
                        address:   'supplierAddress',
                        number:    'supplierNumber',
                        complement:'supplierComplement',
                        neighborhood:'supplierNeighborhood',
                        city:      'supplierCity',
                        state:     'supplierState',
                        cep:       'supplierCep'
                    },
                    config: {
                        legalName: 'configLegalName',
                        name:      'configName',
                        phone:     'configPhone',
                        email:     'configEmail',
                        address:   'configAddress',
                        number:    'configNumber',
                        complement:'configComplement',
                        neighborhood:'configNeighborhood',
                        city:      'configCity',
                        state:     'configState',
                        cep:       'configCep'
                    }
                };

                const fields = fieldMap[prefix] || {};

                const setField = (key, value) => {
                    const id = fields[key];
                    if (!id) return;
                    const el = document.getElementById(id);
                    if (el && value) el.value = value;
                };

                try {
                    // Tenta BrasilAPI primeiro, com fallback para ReceitaWS
                    let data = null;
                    let error1 = null;

                    try {
                        const res = await fetch(`https://brasilapi.com.br/api/cnpj/v1/${cnpj}`);
                        if (res.ok) {
                            const json = await res.json();
                            data = {
                                razao_social: json.razao_social,
                                nome_fantasia: json.nome_fantasia,
                                telefone: json.ddd_telefone_1 ? json.ddd_telefone_1 : '',
                                email: json.email,
                                logradouro: json.logradouro,
                                numero: json.numero,
                                complemento: json.complemento,
                                bairro: json.bairro,
                                municipio: json.municipio,
                                uf: json.uf,
                                cep: json.cep
                            };
                        } else {
                            error1 = 'BrasilAPI: ' + res.status;
                        }
                    } catch (e) {
                        error1 = e.message;
                    }

                    // Fallback: ReceitaWS (não requer CORS para localhost)
                    if (!data) {
                        try {
                            const res2 = await fetch(`https://www.receitaws.com.br/v1/cnpj/${cnpj}`);
                            if (res2.ok) {
                                const json2 = await res2.json();
                                if (json2.status !== 'ERROR') {
                                    data = {
                                        razao_social: json2.nome,
                                        nome_fantasia: json2.fantasia || json2.nome,
                                        telefone: json2.telefone || '',
                                        email: json2.email,
                                        logradouro: json2.logradouro,
                                        numero: json2.numero,
                                        complemento: json2.complemento,
                                        bairro: json2.bairro,
                                        municipio: json2.municipio,
                                        uf: json2.uf,
                                        cep: json2.cep ? json2.cep.replace(/\D/g,'').replace(/(\d{5})(\d{3})/, '$1-$2') : ''
                                    };
                                }
                            }
                        } catch (e2) {
                        }
                    }

                    if (!data) {
                        throw new Error(error1 || 'CNPJ não encontrado em nenhuma fonte');
                    }

                    // Preenche os campos usando o mapeamento seguro
                    setField('legalName', data.razao_social);
                    setField('name', data.nome_fantasia || data.razao_social);
                    setField('email', data.email);
                    setField('address', data.logradouro);
                    setField('number', data.numero);
                    setField('complement', data.complemento);
                    setField('neighborhood', data.bairro);
                    setField('city', data.municipio);
                    setField('state', data.uf);

                    if (data.telefone) {
                        const phoneId = fields['phone'];
                        if (phoneId) {
                            const phoneEl = document.getElementById(phoneId);
                            if (phoneEl) {
                                phoneEl.value = data.telefone;
                                this.maskPhone(phoneEl);
                            }
                        }
                    }

                    if (data.cep) {
                        const cepId = fields['cep'];
                        if (cepId) {
                            const cepEl = document.getElementById(cepId);
                            if (cepEl) {
                                cepEl.value = data.cep;
                                this.maskCep(cepEl);
                            }
                        }
                    }

                    Toast.show('Dados do CNPJ carregados com sucesso!');
                } catch (error) {
                    console.error('Erro ao buscar CNPJ:', error);
                    Toast.show('Erro ao buscar CNPJ: ' + error.message, 'error');
                } finally {
                    input.value = originalValue;
                    input.disabled = false;
                }
            },

            // Funções de busca de CEP (reutilizáveis) — com fallback triplo
            async _buscarDadosCep(cep) {
                try {
                    const c1 = new AbortController();
                    const t1 = setTimeout(() => c1.abort(), 5000);
                    const r1 = await fetch(`https://viacep.com.br/ws/${cep}/json/`, { signal: c1.signal });
                    clearTimeout(t1);
                    const d1 = await r1.json();
                    if (!d1.erro) return { logradouro: d1.logradouro, bairro: d1.bairro, localidade: d1.localidade, uf: d1.uf };
                } catch (e) {}
                try {
                    const c2 = new AbortController();
                    const t2 = setTimeout(() => c2.abort(), 5000);
                    const r2 = await fetch(`https://brasilapi.com.br/api/cep/v1/${cep}`, { signal: c2.signal });
                    clearTimeout(t2);
                    const d2 = await r2.json();
                    if (d2 && d2.city) return { logradouro: d2.street || '', bairro: d2.neighborhood || '', localidade: d2.city, uf: d2.state };
                } catch (e) {}
                try {
                    const c3 = new AbortController();
                    const t3 = setTimeout(() => c3.abort(), 5000);
                    const r3 = await fetch(`https://cep.awesomeapi.com.br/json/${cep}`, { signal: c3.signal });
                    clearTimeout(t3);
                    const d3 = await r3.json();
                    if (d3 && d3.city) return { logradouro: d3.address || '', bairro: d3.district || '', localidade: d3.city, uf: d3.state };
                } catch (e) {}
                return null;
            },

            async buscarCepCompleto(input, prefix) {
                const cep = input.value.replace(/\D/g, '');
                if (cep.length !== 8) return;
                const prevBg = input.style.background;
                input.style.background = '#fff9e6';
                input.disabled = true;
                try {
                    const data = await this._buscarDadosCep(cep);
                    if (data) {
                        const addr = document.getElementById(`${prefix}Address`);
                        const nbhd = document.getElementById(`${prefix}Neighborhood`);
                        const city = document.getElementById(`${prefix}City`);
                        const state = document.getElementById(`${prefix}State`);
                        if (addr)  addr.value  = data.logradouro || '';
                        if (nbhd)  nbhd.value  = data.bairro || '';
                        if (city)  city.value  = data.localidade || '';
                        if (state) state.value = data.uf || '';
                        Toast.show('Endereço preenchido com sucesso!');
                        input.style.background = '#f0fff0';
                    } else {
                        Toast.show('CEP não encontrado', 'warning');
                        input.style.background = prevBg;
                    }
                } catch (e) {
                    Toast.show('Erro ao buscar CEP', 'error');
                    input.style.background = prevBg;
                } finally {
                    input.disabled = false;
                }
            }
        };

        // ==================== AUTO-SAVE ====================

                // ==================== MOTOR DE PDF — ALTA QUALIDADE ====================
        // Configurações globais de qualidade
        const PDF_CONFIG = {
            SCALE:      3,          // 3× = ~285 DPI equivalente (impressão profissional nítida, ótima performance)
            PX_PER_MM:  3.7795275591,
            FORMAT:     'PNG',      // PNG sem perda — textos nítidos, sem artefatos JPEG
            COMPRESSION:'NONE',     // Sem compressão na imagem = máxima fidelidade
            JPEG_Q:     1.0,        // Fallback JPEG qualidade máxima
            RENDER_DELAY: 600,      // ms aguardar renderização completa do DOM + estilos injetados
        };

        // ── Coleta todos os CSS da página em uma string ─────────────────────
        function _coletarTodosCSS() {
            let css = '';
            try {
                Array.from(document.styleSheets).forEach(sheet => {
                    try {
                        Array.from(sheet.cssRules || []).forEach(rule => {
                            css += rule.cssText + '\n';
                        });
                    } catch(e) { /* cross-origin sheet, ignora */ }
                });
            } catch(e) {}
            return css;
        }
        let _cssCache = null;

        // ── Prepara container de renderização fora da tela ──────────────────
        function _criarContainerPDF(elemento, larguraMM) {
            const container = document.createElement('div');
            container.style.cssText = [
                'position:fixed',
                'top:0',
                'left:-9999px',
                `width:${larguraMM}mm`,
                'min-height:1px',
                'background:#ffffff',
                'color:#000000',
                'z-index:99999',
                '-webkit-print-color-adjust:exact',
                'print-color-adjust:exact',
                'font-smoothing:antialiased',
                '-webkit-font-smoothing:antialiased',
                'text-rendering:geometricPrecision',
            ].join(';');

            // Injeta TODOS os estilos da página para garantir que classes CSS sejam aplicadas
            if (!_cssCache) _cssCache = _coletarTodosCSS();
            if (_cssCache) {
                const styleEl = document.createElement('style');
                styleEl.textContent = _cssCache +
                    `* { -webkit-print-color-adjust:exact!important; print-color-adjust:exact!important;
                         -webkit-font-smoothing:antialiased!important; text-rendering:geometricPrecision!important;
                         font-family:Arial,Helvetica,sans-serif!important; }`;
                container.appendChild(styleEl);
            }

            container.appendChild(elemento);
            document.body.appendChild(container);
            return container;
        }

        // ── html2canvas com configurações de máxima qualidade ───────────────
        async function _capturarCanvas(elemento, opcoes = {}) {
            const { PX_PER_MM, SCALE } = PDF_CONFIG;
            const larguraMM = opcoes.larguraMM || 210;
            const pxW = Math.round(larguraMM * PX_PER_MM);

            return await html2canvas(elemento, {
                scale:           SCALE,
                backgroundColor: '#ffffff',
                logging:         false,
                useCORS:         true,
                allowTaint:      true,
                imageTimeout:    0,           // sem timeout para imagens
                removeContainer: true,
                x:               opcoes.x      || 0,
                y:               opcoes.y      || 0,
                width:           opcoes.width  || pxW,
                height:          opcoes.height || elemento.scrollHeight,
                windowWidth:     pxW,
                windowHeight:    opcoes.height || elemento.scrollHeight,
                scrollX:         0,
                scrollY:         0,
                onclone(clonedDoc) {
                    // Garante cores e fontes no clone
                    const style = clonedDoc.createElement('style');
                    style.textContent = `
                        * {
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                            color-adjust: exact !important;
                            -webkit-font-smoothing: antialiased !important;
                            text-rendering: geometricPrecision !important;
                        }
                        body, * { font-family: Arial, Helvetica, sans-serif !important; }
                        @font-face { font-display: block; }
                    `;
                    clonedDoc.head.appendChild(style);
                    // Força visibilidade de todos os elementos
                    clonedDoc.querySelectorAll('*').forEach(el => {
                        const cs = window.getComputedStyle(el);
                        if (cs.opacity !== '1' && cs.opacity !== '') {
                            el.style.opacity = '1';
                        }
                    });
                }
            });
        }

        // ── PNG base64 de alta qualidade a partir do canvas ─────────────────
        function _canvasParaImagem(canvas) {
            // Tenta PNG primeiro (sem perda). Fallback JPEG qualidade máxima.
            try {
                const png = canvas.toDataURL('image/png');
                // PNG pode ser muito grande para documentos com logos; usa PNG sempre pois qualidade é prioridade
                return { data: png, format: 'PNG' };
            } catch(e) {
                return { data: canvas.toDataURL('image/jpeg', PDF_CONFIG.JPEG_Q), format: 'JPEG' };
            }
        }

        // ═══════════════════════════════════════════════════════════════════
        // gerarPDF — A4, com paginação automática, máxima qualidade
        // ═══════════════════════════════════════════════════════════════════
        async function gerarPDF(elemento, nomeArquivo, opcoes = {}) {
            const { jsPDF } = window.jspdf;
            const { PX_PER_MM, SCALE, RENDER_DELAY } = PDF_CONFIG;
            const PAGE_W_MM = 210;
            const PAGE_H_MM = opcoes.pageHeight || 297;
            const PAGE_W_PX = Math.round(PAGE_W_MM * PX_PER_MM);
            const PAGE_H_PX = Math.round(PAGE_H_MM * PX_PER_MM);

            Toast.show('Gerando PDF em alta qualidade...', 'info');

            const container = _criarContainerPDF(elemento, PAGE_W_MM);
            await new Promise(r => setTimeout(r, RENDER_DELAY));

            try {
                const totalH_px = elemento.scrollHeight;
                // Para conteúdo menor que 1 página: renderiza tudo de uma vez (mais nítido)
                const pagesNeeded = Math.ceil(totalH_px / PAGE_H_PX);

                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: [PAGE_W_MM, PAGE_H_MM],
                    compress: false,    // sem compressão interna do PDF
                    putOnlyUsedFonts: true,
                });
                pdf.setProperties({ title: nomeArquivo, creator: 'ÓticaVision Pro' });

                if (pagesNeeded === 1) {
                    // ── Página única: captura completa de uma vez ──
                    const canvas = await _capturarCanvas(elemento, { larguraMM: PAGE_W_MM, height: totalH_px });
                    const { data, format } = _canvasParaImagem(canvas);
                    const imgH_mm = (totalH_px / PAGE_H_PX) * PAGE_H_MM;
                    pdf.addImage(data, format, 0, 0, PAGE_W_MM, Math.min(imgH_mm, PAGE_H_MM), '', 'NONE');
                } else {
                    // ── Multi-página: captura região exata de cada página ──
                    for (let pg = 0; pg < pagesNeeded; pg++) {
                        const clipY_px  = pg * PAGE_H_PX; // coordenada Y em pixels para a página atual
                        const clipH_px  = Math.min(PAGE_H_PX, totalH_px - pg * PAGE_H_PX);

                        const canvas = await _capturarCanvas(elemento, {
                            larguraMM: PAGE_W_MM,
                            x: 0, y: clipY_px,
                            width: PAGE_W_PX, height: clipH_px
                        });
                        const { data, format } = _canvasParaImagem(canvas);
                        const imgH_mm = (clipH_px / PAGE_H_PX) * PAGE_H_MM;

                        if (pg > 0) pdf.addPage([PAGE_W_MM, PAGE_H_MM]);
                        pdf.addImage(data, format, 0, 0, PAGE_W_MM, imgH_mm, `pg${pg}`, 'NONE');
                    }
                }

                pdf.save(`${nomeArquivo}.pdf`);
                Toast.show('PDF gerado com sucesso!', 'success');
            } catch (err) {
                console.error('[PDF] Erro:', err);
                Toast.show('Erro ao gerar PDF: ' + err.message, 'error');
            } finally {
                if (document.body.contains(container)) document.body.removeChild(container);
            }
        }

        // ═══════════════════════════════════════════════════════════════════
        // gerarPDFTamanhoReal — comprovante, cupom, tamanho personalizado
        // ═══════════════════════════════════════════════════════════════════
        async function gerarPDFTamanhoReal(elemento, nomeArquivo, larguraMM = 80) {
            const { jsPDF } = window.jspdf;
            const { PX_PER_MM, RENDER_DELAY } = PDF_CONFIG;

            Toast.show('Gerando PDF em alta qualidade...', 'info');

            const container = _criarContainerPDF(elemento, larguraMM);
            await new Promise(r => setTimeout(r, RENDER_DELAY));

            try {
                const pxW            = Math.round(larguraMM * PX_PER_MM);
                const alturaConteudo = elemento.scrollHeight;
                const alturaMM       = alturaConteudo / PX_PER_MM;

                const canvas = await _capturarCanvas(elemento, {
                    larguraMM,
                    width: pxW,
                    height: alturaConteudo
                });
                const { data, format } = _canvasParaImagem(canvas);

                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: [larguraMM, alturaMM],
                    compress: false,
                });
                pdf.setProperties({ title: nomeArquivo, creator: 'ÓticaVision Pro' });
                pdf.addImage(data, format, 0, 0, larguraMM, alturaMM, '', 'NONE');
                pdf.save(`${nomeArquivo}.pdf`);
                Toast.show('PDF gerado com sucesso!', 'success');
            } catch (err) {
                console.error('[PDF] Erro:', err);
                Toast.show('Erro ao gerar PDF: ' + err.message, 'error');
            } finally {
                if (document.body.contains(container)) document.body.removeChild(container);
            }
        }

        // ═══════════════════════════════════════════════════════════════════
        // gerarPDFPorVias — OS, cada via em página separada
        // ═══════════════════════════════════════════════════════════════════
        async function gerarPDFPorVias(vias, nomeArquivo) {
            const { jsPDF } = window.jspdf;
            const { RENDER_DELAY } = PDF_CONFIG;
            const PAGE_W_MM = 210;

            Toast.show('Gerando PDF em alta qualidade...', 'info');

            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4',
                compress: false,
            });
            pdf.setProperties({ title: nomeArquivo, creator: 'ÓticaVision Pro' });
            let first = true;

            try {
                for (const via of vias) {
                    const container = _criarContainerPDF(via, PAGE_W_MM);
                    await new Promise(r => setTimeout(r, RENDER_DELAY));

                    try {
                        const h  = via.scrollHeight;
                        const canvas = await _capturarCanvas(via, { larguraMM: PAGE_W_MM, height: h });
                        const { data, format } = _canvasParaImagem(canvas);
                        const hMM = Math.min((h / (PAGE_W_MM * PDF_CONFIG.PX_PER_MM)) * PAGE_W_MM * (297/210), 297);
                        // Calcula altura real em mm
                        const hMM_real = Math.min(h / PDF_CONFIG.PX_PER_MM, 297);

                        if (!first) pdf.addPage('a4', 'portrait');
                        pdf.addImage(data, format, 0, 0, PAGE_W_MM, hMM_real, `via${first?0:1}`, 'NONE');
                        first = false;
                    } finally {
                        if (document.body.contains(container)) document.body.removeChild(container);
                    }
                }

                pdf.save(`${nomeArquivo}.pdf`);
                Toast.show('PDF gerado com sucesso!', 'success');
            } catch (err) {
                console.error('[PDF] Erro:', err);
                Toast.show('Erro ao gerar PDF: ' + err.message, 'error');
            }
        }

        // ==================== RECEITUÁRIO ====================
        const Presc = {
            stepValue(id, min, max, step, dir) {
                const el = document.getElementById(id);
                if (!el) return;
                
                let val = (parseFloat(el.value) || 0) + step * dir;
                val = Math.max(min, Math.min(max, Math.round(val * 4) / 4));
                el.value = val.toFixed(2);
                
                this.updateColor(el, id);
                
                if (id.startsWith('od')) {
                    this.updateAllPertoOD();
                    this.updateDP();
                }
                if (id.startsWith('oe')) {
                    this.updateAllPertoOE();
                    this.updateDP();
                }
                if (id.startsWith('clientOd')) this.updateClientPertoOD();
                if (id.startsWith('clientOe')) this.updateClientPertoOE();
            },

            resetField(id) {
                const el = document.getElementById(id);
                if (el) {
                    el.value = '0.00';
                    this.updateColor(el, id);
                }
            },

            updateColor(el, id) {
                const val = parseFloat(el.value) || 0;
                if (id.includes('Cyl')) {
                    el.style.color = val < 0 ? '#dc3545' : (val > 0 ? '#1565c0' : '#000');
                } else if (id.includes('Add')) {
                    el.style.color = val > 0 ? '#1565c0' : '#000';
                } else {
                    if (val < 0) el.style.color = '#dc3545';
                    else if (val > 0) el.style.color = '#1565c0';
                    else el.style.color = '#000';
                }
            },

            formatAxis(el) {
                let v = el.value.replace(/\D/g, '');
                if (!v) {
                    el.value = '0°';
                    return;
                }
                let n = Math.max(0, Math.min(180, parseInt(v)));
                el.value = n + '°';
            },

            validateDnp(el) {
                let v = parseFloat(el.value.replace(',', '.'));
                if (isNaN(v)) {
                    el.value = '';
                    return;
                }
                v = Math.max(20, Math.min(40, Math.round(v * 2) / 2));
                el.value = v.toFixed(1);
            },

            validateNumber(el, min, max) {
                let v = parseFloat(el.value);
                if (isNaN(v)) return;
                if (v < min || v > max) el.value = '';
            },

            updateAllPertoOD() {
                const sph = parseFloat(document.getElementById('odSph')?.value) || 0;
                const cyl = parseFloat(document.getElementById('odCyl')?.value) || 0;
                const axis = document.getElementById('odAxis')?.value || '0°';
                const addRaw = document.getElementById('odAdd')?.value || '';
                const add = parseFloat(addRaw) || 0;
                const dnp = parseFloat(document.getElementById('odDnp')?.value) || 0;

                // Só preenche campos de perto se a adição estiver preenchida e > 0
                if (!addRaw || addRaw.trim() === '' || addRaw === '0.00' || add === 0) return;

                const nearSph = sph + add;
                const nearDnp = dnp > 0 ? (dnp - 2.5).toFixed(1) : '';

                const nearSphEl = document.getElementById('odNearSph');
                const nearCylEl = document.getElementById('odNearCyl');
                const nearAxisEl = document.getElementById('odNearAxis');
                const nearDnpEl = document.getElementById('odNearDnp');

                if (nearSphEl) { nearSphEl.value = nearSph.toFixed(2); this.updateColor(nearSphEl, 'nearSph'); }
                if (nearCylEl) { nearCylEl.value = cyl.toFixed(2); this.updateColor(nearCylEl, 'nearCyl'); }
                if (nearAxisEl) nearAxisEl.value = axis;
                if (nearDnpEl) nearDnpEl.value = nearDnp;
            },

            updateAllPertoOE() {
                const sph = parseFloat(document.getElementById('oeSph')?.value) || 0;
                const cyl = parseFloat(document.getElementById('oeCyl')?.value) || 0;
                const axis = document.getElementById('oeAxis')?.value || '0°';
                const addRaw = document.getElementById('oeAdd')?.value || '';
                const add = parseFloat(addRaw) || 0;
                const dnp = parseFloat(document.getElementById('oeDnp')?.value) || 0;

                // Só preenche campos de perto se a adição estiver preenchida e > 0
                if (!addRaw || addRaw.trim() === '' || addRaw === '0.00' || add === 0) return;

                const nearSph = sph + add;
                const nearDnp = dnp > 0 ? (dnp - 2.5).toFixed(1) : '';

                const nearSphEl = document.getElementById('oeNearSph');
                const nearCylEl = document.getElementById('oeNearCyl');
                const nearAxisEl = document.getElementById('oeNearAxis');
                const nearDnpEl = document.getElementById('oeNearDnp');

                if (nearSphEl) { nearSphEl.value = nearSph.toFixed(2); this.updateColor(nearSphEl, 'nearSph'); }
                if (nearCylEl) { nearCylEl.value = cyl.toFixed(2); this.updateColor(nearCylEl, 'nearCyl'); }
                if (nearAxisEl) nearAxisEl.value = axis;
                if (nearDnpEl) nearDnpEl.value = nearDnp;
            },

            // Alias: atualiza apenas o eixo perto (OD longe)
            updatePertoEixoOD() { this.updateAllPertoOD(); },
            // Alias: atualiza apenas o eixo perto (OE longe)
            updatePertoEixoOE() { this.updateAllPertoOE(); },
            // Alias: atualiza apenas o eixo perto (OD cliente)
            updateClientPertoEixoOD() { this.updateClientPertoOD(); },
            // Alias: atualiza apenas o eixo perto (OE cliente)
            updateClientPertoEixoOE() { this.updateClientPertoOE(); },

            updateDP() {
                const odDnp = parseFloat(document.getElementById('odDnp')?.value) || 0;
                const oeDnp = parseFloat(document.getElementById('oeDnp')?.value) || 0;
                const dp = odDnp + oeDnp;
                const dpEl = document.getElementById('prescDp');
                if (dpEl) dpEl.value = dp.toFixed(1);
            },

            updateClientPertoOD() {
                const sph = parseFloat(document.getElementById('clientOdSph')?.value) || 0;
                const cyl = parseFloat(document.getElementById('clientOdCyl')?.value) || 0;
                const axis = document.getElementById('clientOdAxis')?.value || '0°';
                const addRaw = document.getElementById('clientOdAdd')?.value || '';
                const add = parseFloat(addRaw) || 0;
                const dnp = parseFloat(document.getElementById('clientOdDnp')?.value) || 0;

                if (!addRaw || addRaw.trim() === '' || addRaw === '0.00' || add === 0) return;

                const nearSph = sph + add;
                const nearDnp = dnp > 0 ? (dnp - 2.5).toFixed(1) : '';

                const nearSphEl = document.getElementById('clientOdNearSph');
                const nearCylEl = document.getElementById('clientOdNearCyl');
                const nearAxisEl = document.getElementById('clientOdNearAxis');
                const nearDnpEl = document.getElementById('clientOdNearDnp');

                if (nearSphEl) { nearSphEl.value = nearSph.toFixed(2); this.updateColor(nearSphEl, 'nearSph'); }
                if (nearCylEl) { nearCylEl.value = cyl.toFixed(2); this.updateColor(nearCylEl, 'nearCyl'); }
                if (nearAxisEl) nearAxisEl.value = axis;
                if (nearDnpEl) nearDnpEl.value = nearDnp;
            },

            updateClientPertoOE() {
                const sph = parseFloat(document.getElementById('clientOeSph')?.value) || 0;
                const cyl = parseFloat(document.getElementById('clientOeCyl')?.value) || 0;
                const axis = document.getElementById('clientOeAxis')?.value || '0°';
                const addRaw = document.getElementById('clientOeAdd')?.value || '';
                const add = parseFloat(addRaw) || 0;
                const dnp = parseFloat(document.getElementById('clientOeDnp')?.value) || 0;

                if (!addRaw || addRaw.trim() === '' || addRaw === '0.00' || add === 0) return;

                const nearSph = sph + add;
                const nearDnp = dnp > 0 ? (dnp - 2.5).toFixed(1) : '';

                const nearSphEl = document.getElementById('clientOeNearSph');
                const nearCylEl = document.getElementById('clientOeNearCyl');
                const nearAxisEl = document.getElementById('clientOeNearAxis');
                const nearDnpEl = document.getElementById('clientOeNearDnp');

                if (nearSphEl) { nearSphEl.value = nearSph.toFixed(2); this.updateColor(nearSphEl, 'nearSph'); }
                if (nearCylEl) { nearCylEl.value = cyl.toFixed(2); this.updateColor(nearCylEl, 'nearCyl'); }
                if (nearAxisEl) nearAxisEl.value = axis;
                if (nearDnpEl) nearDnpEl.value = nearDnp;
            },

            updateClientDP() {
                const odDnp = parseFloat(document.getElementById('clientOdDnp')?.value) || 0;
                const oeDnp = parseFloat(document.getElementById('clientOeDnp')?.value) || 0;
                const dp = odDnp + oeDnp;
                const dpEl = document.getElementById('clientPrescDp');
                if (dpEl) dpEl.value = dp.toFixed(1);
            },

            exportClientPrescToPDF() {
                const clientName   = document.getElementById('clientName')?.value || '___________________';
                const birthDate    = document.getElementById('clientBirthDate')?.value;
                const consultDate  = document.getElementById('clientPrescDate')?.value || new Date().toISOString().slice(0,10);
                const optometrist  = document.getElementById('clientPrescOptometrist')?.value || '___________________';

                const odSph    = document.getElementById('clientOdSph')?.value    || '0.00';
                const odCyl    = document.getElementById('clientOdCyl')?.value    || '0.00';
                const odAxis   = document.getElementById('clientOdAxis')?.value   || '0°';
                const odAdd    = document.getElementById('clientOdAdd')?.value    || '0.00';
                const odDnp    = document.getElementById('clientOdDnp')?.value    || '';

                const oeSph    = document.getElementById('clientOeSph')?.value    || '0.00';
                const oeCyl    = document.getElementById('clientOeCyl')?.value    || '0.00';
                const oeAxis   = document.getElementById('clientOeAxis')?.value   || '0°';
                const oeAdd    = document.getElementById('clientOeAdd')?.value    || '0.00';
                const oeDnp    = document.getElementById('clientOeDnp')?.value    || '';

                const odNearSph  = document.getElementById('clientOdNearSph')?.value  || '0.00';
                const odNearCyl  = document.getElementById('clientOdNearCyl')?.value  || '0.00';
                const odNearAxis = document.getElementById('clientOdNearAxis')?.value || '0°';
                const odNearDnp  = document.getElementById('clientOdNearDnp')?.value  || '';

                const oeNearSph  = document.getElementById('clientOeNearSph')?.value  || '0.00';
                const oeNearCyl  = document.getElementById('clientOeNearCyl')?.value  || '0.00';
                const oeNearAxis = document.getElementById('clientOeNearAxis')?.value || '0°';
                const oeNearDnp  = document.getElementById('clientOeNearDnp')?.value  || '';

                const dp     = document.getElementById('clientPrescDp')?.value     || '—';
                const height = document.getElementById('clientPrescHeight')?.value  || '—';
                const notes  = document.getElementById('clientPrescNotes')?.value   || '';

                const company = state.company;
                const cName   = company.name || 'ÓticaVision Pro';
                const cAddr   = [company.address, company.number, company.neighborhood, (company.city||'')+'/'+(company.state||'')].filter(Boolean).join(', ');
                const cCep    = company.cep ? 'CEP: '+company.cep : '';
                const cPhone  = company.phone || '';
                const cWpp    = company.whatsapp || '';
                const cEmail  = company.email || '';
                const cSite   = company.website || '';

                const fmtD = d => d ? new Date(d+'T12:00:00').toLocaleDateString('pt-BR') : '—';

                // Calcular validade (1 ano a partir da data da consulta)
                const validade = (() => {
                    try {
                        const d = new Date(consultDate+'T12:00:00');
                        d.setFullYear(d.getFullYear()+1);
                        return d.toLocaleDateString('pt-BR');
                    } catch(e) { return '—'; }
                })();

                const html = `
                <div class="receituario-pdf">
                    <div class="rec-faixa-topo"></div>

                    <!-- Cabeçalho -->
                    <div class="header">
                        <div class="header-logo">
                            ${company.logo
                                ? `<div class="rec-logo-circulo" style="background-image:url('${company.logo}')"></div>`
                                : `<div class="rec-logo-circulo"><span>👁️</span></div>`}
                            <div>
                                <div class="header-empresa-nome">${Utils.sanitizeHTML(cName)}</div>
                                <div class="header-empresa-sub">ESTABELECIMENTO ÓPTICO</div>
                                <div class="header-empresa-info">${Utils.sanitizeHTML(cAddr)} — ${cCep}</div>
                                <div class="header-empresa-info">
                                    ${cPhone ? '📞 '+cPhone : ''}
                                    ${cWpp ? ' &nbsp;|&nbsp; 📱 '+cWpp : ''}
                                    ${cEmail ? ' &nbsp;|&nbsp; ✉️ '+cEmail : ''}
                                    ${cSite ? ' &nbsp;|&nbsp; 🌐 '+cSite : ''}
                                </div>
                            </div>
                        </div>
                        <div class="header-right">
                            <div class="header-doc-label">Documento</div>
                            <div class="header-doc-title">RECEITUÁRIO</div>
                            <div class="header-doc-sub">Prescrição de Lentes Corretivas</div>
                        </div>
                    </div>

                    <!-- Faixa paciente -->
                    <div class="faixa-paciente">
                        <span>DADOS DO PACIENTE</span>
                        <span>Data: <strong>${fmtD(consultDate)}</strong> &nbsp;|&nbsp; Validade: <strong>${validade}</strong></span>
                    </div>

                    <!-- Dados paciente / profissional -->
                    <div class="dados-bloco">
                        <div class="dado-item">
                            <div class="dado-label">Paciente</div>
                            <div class="dado-valor">${Utils.sanitizeHTML(clientName)}</div>
                        </div>
                        <div class="dado-item">
                            <div class="dado-label">Data de Nascimento</div>
                            <div class="dado-valor">${birthDate ? fmtD(birthDate) : '___/___/_____'}</div>
                        </div>
                        <div class="dado-item">
                            <div class="dado-label">Optometrista / Oftalmologista</div>
                            <div class="dado-valor">${Utils.sanitizeHTML(optometrist)}</div>
                        </div>
                        <div class="dado-item">
                            <div class="dado-label">Data da Consulta</div>
                            <div class="dado-valor">${fmtD(consultDate)}</div>
                        </div>
                    </div>

                    <div class="corpo">

                        <!-- ── TABELA LONGE ── -->
                        <div class="secao-titulo" style="margin-bottom:0;">👁 VISÃO DE LONGE</div>
                        <table>
                            <thead><tr>
                                <th style="width:12%"></th>
                                <th>ESF (D)</th><th>CIL (D)</th><th>EIXO (°)</th><th>ADIÇÃO (D)</th><th>DNP (mm)</th>
                            </tr></thead>
                            <tbody>
                                <tr>
                                    <td class="olho-label">OD</td>
                                    <td>${Utils.sanitizeHTML(odSph)}</td>
                                    <td>${Utils.sanitizeHTML(odCyl)}</td>
                                    <td>${Utils.sanitizeHTML(odAxis)}</td>
                                    <td>${Utils.sanitizeHTML(odAdd)}</td>
                                    <td>${odDnp ? Utils.sanitizeHTML(odDnp) : '—'}</td>
                                </tr>
                                <tr>
                                    <td class="olho-label">OE</td>
                                    <td>${Utils.sanitizeHTML(oeSph)}</td>
                                    <td>${Utils.sanitizeHTML(oeCyl)}</td>
                                    <td>${Utils.sanitizeHTML(oeAxis)}</td>
                                    <td>${Utils.sanitizeHTML(oeAdd)}</td>
                                    <td>${oeDnp ? Utils.sanitizeHTML(oeDnp) : '—'}</td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- ── TABELA PERTO ── -->
                        <div class="secao-titulo verde" style="margin-bottom:0;">👁 VISÃO DE PERTO</div>
                        <table class="tabela-verde">
                            <thead><tr>
                                <th style="width:12%"></th>
                                <th>ESF (D)</th><th>CIL (D)</th><th>EIXO (°)</th><th>DNP Perto (mm)</th>
                            </tr></thead>
                            <tbody>
                                <tr>
                                    <td class="olho-label">OD</td>
                                    <td>${Utils.sanitizeHTML(odNearSph)}</td>
                                    <td>${Utils.sanitizeHTML(odNearCyl)}</td>
                                    <td>${Utils.sanitizeHTML(odNearAxis)}</td>
                                    <td>${odNearDnp ? Utils.sanitizeHTML(odNearDnp) : '—'}</td>
                                </tr>
                                <tr>
                                    <td class="olho-label">OE</td>
                                    <td>${Utils.sanitizeHTML(oeNearSph)}</td>
                                    <td>${Utils.sanitizeHTML(oeNearCyl)}</td>
                                    <td>${Utils.sanitizeHTML(oeNearAxis)}</td>
                                    <td>${oeNearDnp ? Utils.sanitizeHTML(oeNearDnp) : '—'}</td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- ── MEDIDAS ── -->
                        <div class="secao-titulo azul" style="margin-bottom:2mm;">📐 MEDIDAS COMPLEMENTARES</div>
                        <div class="medidas-grid">
                            <div class="medida-card">
                                <div class="medida-label">DP Longe</div>
                                <div class="medida-valor">${Utils.sanitizeHTML(dp)} <span class="medida-unidade">mm</span></div>
                            </div>
                            <div class="medida-card">
                                <div class="medida-label">Altura</div>
                                <div class="medida-valor">${Utils.sanitizeHTML(height)} <span class="medida-unidade">mm</span></div>
                            </div>
                            <div class="medida-card">
                                <div class="medida-label">DP Perto OD</div>
                                <div class="medida-valor">${odNearDnp ? Utils.sanitizeHTML(odNearDnp) : '—'} <span class="medida-unidade">${odNearDnp?'mm':''}</span></div>
                            </div>
                            <div class="medida-card">
                                <div class="medida-label">DP Perto OE</div>
                                <div class="medida-valor">${oeNearDnp ? Utils.sanitizeHTML(oeNearDnp) : '—'} <span class="medida-unidade">${oeNearDnp?'mm':''}</span></div>
                            </div>
                        </div>

                        <!-- ── ADAPTAÇÃO DE LENTES ── -->
                        <div class="secao-titulo roxo" style="margin-bottom:2mm;">🔧 ADAPTAÇÃO DE LENTES</div>
                        <div class="adaptacao-grid">
                            <div class="adaptacao-item">
                                <div class="adaptacao-label">Tipo de Lente</div>
                                <div class="adaptacao-linha"></div>
                                <div style="font-size:7px;color:#bbb;margin-top:1mm;">Ex: Monofocal, Bifocal, Progressiva</div>
                            </div>
                            <div class="adaptacao-item">
                                <div class="adaptacao-label">Material</div>
                                <div class="adaptacao-linha"></div>
                                <div style="font-size:7px;color:#bbb;margin-top:1mm;">Ex: CR-39, Policarbonato, Hi-Index</div>
                            </div>
                            <div class="adaptacao-item">
                                <div class="adaptacao-label">Tratamento</div>
                                <div class="adaptacao-linha"></div>
                                <div style="font-size:7px;color:#bbb;margin-top:1mm;">Ex: AR, Fotossensível, Blue-cut</div>
                            </div>
                            <div class="adaptacao-item">
                                <div class="adaptacao-label">Índice de Refração</div>
                                <div class="adaptacao-linha"></div>
                                <div style="font-size:7px;color:#bbb;margin-top:1mm;">Ex: 1.50 / 1.56 / 1.60 / 1.67 / 1.74</div>
                            </div>
                            <div class="adaptacao-item">
                                <div class="adaptacao-label">Armação / Modelo</div>
                                <div class="adaptacao-linha"></div>
                            </div>
                            <div class="adaptacao-item">
                                <div class="adaptacao-label">Laboratório</div>
                                <div class="adaptacao-linha"></div>
                            </div>
                        </div>
                        <!-- Linha prazo e observação de adaptação -->
                        <div style="display:flex;gap:2mm;margin-bottom:3mm;">
                            <div class="adaptacao-item" style="flex:1;border:1px solid #e8e8e8;border-radius:4px;padding:2mm 2.5mm;background:#fafafa;">
                                <div class="adaptacao-label">Prazo de Entrega</div>
                                <div class="adaptacao-linha"></div>
                            </div>
                            <div class="adaptacao-item" style="flex:2;border:1px solid #e8e8e8;border-radius:4px;padding:2mm 2.5mm;background:#fafafa;">
                                <div class="adaptacao-label">Observações da Adaptação</div>
                                <div class="adaptacao-linha"></div>
                                <div class="adaptacao-linha" style="margin-top:1.5mm;"></div>
                            </div>
                        </div>

                        <!-- ── OBSERVAÇÕES DO RECEITUÁRIO ── -->
                        <div class="observacoes">
                            <div class="obs-titulo">📝 Observações Clínicas</div>
                            <div>${Utils.sanitizeHTML(notes) || 'Sem observações.'}</div>
                        </div>

                        <!-- Validade -->
                        <div class="validade-box">
                            ✅ <strong>Validade da Prescrição:</strong> &nbsp; Esta receita é válida por <strong>12 meses</strong> a partir da data de emissão. &nbsp;|&nbsp; Vence em: <strong>${validade}</strong>
                        </div>

                        <!-- Assinatura -->
                        <div class="assinatura-bloco">
                            <div class="linha-assinatura"></div>
                            <div class="assinatura-nome">${Utils.sanitizeHTML(optometrist)}</div>
                            <div class="assinatura-info">Optometrista / Oftalmologista &nbsp;|&nbsp; CRO/CBO: _______________</div>
                            <div class="assinatura-role">Assinatura e Carimbo obrigatórios para validade do documento</div>
                        </div>
                    </div>

                    <!-- Rodapé -->
                    <div class="rodape">
                        ${Utils.sanitizeHTML(cName)} &nbsp;|&nbsp; ${Utils.sanitizeHTML(cAddr)} — ${cCep}<br>
                        ${cPhone ? '📞 '+cPhone : ''} ${cWpp ? ' | 📱 '+cWpp : ''} ${cEmail ? ' | ✉️ '+cEmail : ''}<br>
                        <em>Documento válido mediante assinatura e carimbo do profissional responsável.</em>
                    </div>
                    <div class="rec-faixa-base"></div>
                </div>`;

                const elemento = document.createElement('div');
                elemento.innerHTML = html;
                elemento.className = 'receituario-pdf';
                gerarPDF(elemento, `RECEITUARIO_${clientName.replace(/\s+/g,'_')}`);
            },

            exportClientPrescToPDFForClient(clientId) {
                const client = state.clients.find(c => c.id === clientId);
                const presc = state.prescriptions.find(p => p.clientId === clientId);
                
                if (!presc) {
                    Toast.show('Cliente não possui receituário cadastrado', 'warning');
                    return;
                }
                
                // Preencher temporariamente os campos do formulário com os dados da receita
                const originalValues = {};
                const fields = ['clientName', 'clientBirthDate', 'clientPrescDate', 'clientPrescOptometrist',
                    'clientOdSph', 'clientOdCyl', 'clientOdAxis', 'clientOdAdd', 'clientOdDnp',
                    'clientOeSph', 'clientOeCyl', 'clientOeAxis', 'clientOeAdd', 'clientOeDnp',
                    'clientPrescDp', 'clientPrescHeight', 'clientPrescNotes'];
                
                fields.forEach(f => {
                    const el = document.getElementById(f);
                    if (el) {
                        originalValues[f] = el.value;
                    }
                });
                
                // Preencher com os dados da receita
                document.getElementById('clientName').value = client.name || '';
                document.getElementById('clientBirthDate').value = client.birthDate || '';
                document.getElementById('clientPrescDate').value = presc.date || '';
                document.getElementById('clientPrescOptometrist').value = presc.optometrist || '';
                document.getElementById('clientOdSph').value = presc.od?.sph || '0.00';
                document.getElementById('clientOdCyl').value = presc.od?.cyl || '0.00';
                document.getElementById('clientOdAxis').value = presc.od?.axis || '';
                document.getElementById('clientOdAdd').value = presc.od?.add || '0.00';
                document.getElementById('clientOdDnp').value = presc.od?.dnp || '';
                document.getElementById('clientOeSph').value = presc.oe?.sph || '0.00';
                document.getElementById('clientOeCyl').value = presc.oe?.cyl || '0.00';
                document.getElementById('clientOeAxis').value = presc.oe?.axis || '';
                document.getElementById('clientOeAdd').value = presc.oe?.add || '0.00';
                document.getElementById('clientOeDnp').value = presc.oe?.dnp || '';
                document.getElementById('clientPrescDp').value = presc.dp || '';
                document.getElementById('clientPrescHeight').value = presc.height || '';
                document.getElementById('clientPrescNotes').value = presc.notes || '';
                
                Presc.updateClientPertoOD();
                Presc.updateClientPertoOE();
                
                // Chamar a função de impressão
                this.exportClientPrescToPDF();
                
                // Restaurar valores originais
                setTimeout(() => {
                    fields.forEach(f => {
                        const el = document.getElementById(f);
                        if (el && originalValues[f] !== undefined) {
                            el.value = originalValues[f];
                        }
                    });
                }, 1000);
            }
        };


        // ==================== SUPABASE SYNC MODULE (stub de compatibilidade) ====================
        // Todas as chamadas legadas como SupaSync.upsertCliente(), SupaSync.inserirVenda() etc.
        // são no-ops. A sincronização real é feita pelo LocalFirst engine.
        const SupaSync = {
            _queue: [],
            async init() {},
            async upsertCliente(c)    { return LocalFirst.pushItem('clients', c); },
            async upsertProduto(p)    { return LocalFirst.pushItem('products', p); },
            async inserirVenda(v)     { return LocalFirst.pushItem('sales', v); },
            async upsertPrescricao(p) { return LocalFirst.pushItem('prescriptions', p); },
            async upsertDespesa(e)    { return LocalFirst.pushItem('expenses', e); },
            async upsertFornecedor(s) { return LocalFirst.pushItem('suppliers', s); },
            async upsertServico(s)    { return LocalFirst.pushItem('services', s); },
            async upsertConfig()      { return LocalFirst.pushConfig(); },
            async deletarCliente(id)  { return LocalFirst.deleteItem('clients', id); },
            async deletarProduto(id)  { return LocalFirst.deleteItem('products', id); },
            async deletarFornecedor(id) { return LocalFirst.deleteItem('suppliers', id); },
            async deletarServico(id)  { return LocalFirst.deleteItem('services', id); },
            async deletarDespesa(id)  { return LocalFirst.deleteItem('expenses', id); },
            async verificarTabelas() {
                const tabelas = ['clients','products','sales','expenses','prescriptions','suppliers','services','config'];
                Toast.show('Verificando tabelas no Supabase...', 'info');
                const resultados = [];
                for (const t of tabelas) {
                    try {
                        const { error } = await supabaseClient.from(t).select('id', { count: 'exact', head: true });
                        resultados.push({ tabela: t, ok: !error, erro: error?.message });
                    } catch(e) {
                        resultados.push({ tabela: t, ok: false, erro: e.message });
                    }
                }
                const erros = resultados.filter(r => !r.ok);
                if (erros.length === 0) {
                    Toast.show(`✅ Todas as 8 tabelas verificadas com sucesso!`, 'success');
                } else {
                    Toast.show(`⚠️ Tabelas com problema: ${erros.map(r=>r.tabela).join(', ')}. Execute o SQL Setup.`, 'warning');
                }
            },
            async syncDown() {
                const btn = document.getElementById('headerSyncBtn');
                if (btn) btn.classList.add('syncing');
                try {
                    await LocalFirst.sync('manual');
                    Toast.show('✅ Sync concluído!', 'success', 2500);
                } catch(e) {
                    Toast.show('❌ Erro no sync: ' + e.message, 'error');
                } finally {
                    if (btn) btn.classList.remove('syncing');
                }
            },
            async syncDelta()         { return LocalFirst.sync('delta'); },
            async migrarParaSupabase(){ return LocalFirst.sync('manual'); },
            async _flushQueue()       {}
        };
        // ==================== /SUPABASE SYNC MODULE ====================

        // ==================== APP ====================
        const App = {
            async init() {
                await this.loadData();
                this.updateCompanyDisplay(); // Atualiza logo e nome da empresa após carregar
                await this.initTheme();
                this.initNavigation();
                this.updateDateTime();
                setInterval(() => this.updateDateTime(), 1000);
                
                document.getElementById('clientForm')?.addEventListener('submit', (e) => { e.preventDefault(); Clients.save(); });
                document.getElementById('productForm')?.addEventListener('submit', (e) => { e.preventDefault(); Products.save(); });
                document.getElementById('serviceForm')?.addEventListener('submit', (e) => { e.preventDefault(); Services.save(); });
                document.getElementById('supplierForm')?.addEventListener('submit', (e) => { e.preventDefault(); Suppliers.save(); });
                document.getElementById('expenseForm')?.addEventListener('submit', (e) => { e.preventDefault(); Expenses.save(); });
                document.getElementById('configForm')?.addEventListener('submit', (e) => { e.preventDefault(); Config.save(); });
                
                const today = new Date().toISOString().slice(0, 10);
                document.getElementById('clientBirthDate') && (document.getElementById('clientBirthDate').value = today);
                document.getElementById('expenseDate') && (document.getElementById('expenseDate').value = today);
                
                document.getElementById('configPrimaryColor')?.addEventListener('input', (e) => {
                    document.getElementById('configPrimaryColorText').value = e.target.value;
                });
                
                document.getElementById('configPrimaryColorText')?.addEventListener('input', (e) => {
                    if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                        document.getElementById('configPrimaryColor').value = e.target.value;
                    }
                });
                
                document.getElementById('configSecondaryColor')?.addEventListener('input', (e) => {
                    document.getElementById('configSecondaryColorText').value = e.target.value;
                });
                
                document.getElementById('configSecondaryColorText')?.addEventListener('input', (e) => {
                    if (/^#[0-9A-F]{6}$/i.test(e.target.value)) {
                        document.getElementById('configSecondaryColor').value = e.target.value;
                    }
                });
                
                Sales.init();
                Config.load();

                // ── Local-First Sync Engine ──
                // Dados já foram carregados do IDB. Sync com Supabase em background.
                LocalFirst.boot();
                Utils.updatePixKey();


                // ── Listener para período personalizado nos relatórios ──
                document.getElementById('reportPeriod')?.addEventListener('change', (e) => {
                    const custom = document.getElementById('reportCustomDates');
                    if (custom) custom.style.display = e.target.value === 'custom' ? 'flex' : 'none';
                });

                // Tenta salvar ao fechar/recarregar
                // O beforeunload apenas dispara uma última tentativa assíncrona.
                window.addEventListener('beforeunload', () => {
                    try { App.saveData(true); } catch(e) {}
                });

                // Menu hambúrguer
                document.getElementById('menuToggle')?.addEventListener('click', () => {
                    document.getElementById('sidebar').classList.add('open');
                });
                
                document.getElementById('closeSidebar')?.addEventListener('click', () => {
                    document.getElementById('sidebar').classList.remove('open');
                });

                // Preencher select de fornecedores no formulário de despesas
                this.updateSupplierSelect();
            },

            updateCompanyDisplay() {
                document.getElementById('companyName').innerText = state.company.name || 'ÓticaVision Pro';
                var wrapper     = document.getElementById('logoWrapper');
                var placeholder = document.getElementById('logoPlaceholder');
                if (state.company.logo) {
                    if (wrapper) {
                        wrapper.style.backgroundImage = 'url(' + state.company.logo + ')';
                        wrapper.classList.remove('d-none');
                    }
                    if (placeholder) placeholder.classList.add('d-none');
                } else {
                    if (wrapper) {
                        wrapper.style.backgroundImage = '';
                        wrapper.classList.add('d-none');
                    }
                    if (placeholder) placeholder.classList.remove('d-none');
                }
            },

            async loadData() {
                // LOCAL-FIRST: sempre carrega do IndexedDB primeiro (instantâneo)
                let saved = null;
                try { saved = await IDB.get(STORAGE_KEY); } catch(e) {}

                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        Object.keys(parsed).forEach(key => {
                            if (key in state) {
                                if (typeof parsed[key] === 'object' && parsed[key] !== null && !Array.isArray(parsed[key])) {
                                    state[key] = Object.assign({}, state[key], parsed[key]);
                                } else {
                                    state[key] = parsed[key];
                                }
                            }
                        });
                        Utils.updatePixKey();
                        console.log('[App] ✅ Dados carregados do IndexedDB (local-first)');
                    } catch(e) {
                        console.error('[App] ❌ Erro ao parsear dados locais:', e);
                        this.initSampleData();
                        Toast.show('Erro ao carregar dados. Usando dados de exemplo.', 'warning');
                    }
                } else {
                    this.initSampleData();
                    Toast.show('Bem-vindo! Configure sua ótica em Configurações.', 'info', 5000);
                }
                // O sync com Supabase acontece em background via LocalFirst.boot()
            },

            async saveData(silent = false) {
                try {
                    const now = new Date().toISOString();
                    ['clients','products','sales','expenses','prescriptions','suppliers','services'].forEach(key => {
                        if (Array.isArray(state[key])) {
                            state[key].forEach(item => {
                                if (!item.updated_at) item.updated_at = now;
                            });
                        }
                    });
                    // Retroativamente adiciona id nos receituários antigos que não tinham
                    if (Array.isArray(state.prescriptions)) {
                        state.prescriptions.forEach(p => {
                            if (!p.id && p.clientId) p.id = 'PRESC-' + p.clientId;
                        });
                    }
                    const dataStr = JSON.stringify(state);
                    await IDB.set(STORAGE_KEY, dataStr);
                    await IDB.set(STORAGE_KEY + '_ts', now);
                    if (!silent) Toast.show('Dados salvos!', 'success', 1500);
                } catch(e) {
                    console.error('[App] ❌ Erro ao salvar:', e);
                    if (!silent) Toast.show('Erro ao salvar: ' + e.message, 'error');
                }
            },

            initSampleData() {
                const currentYear = new Date().getFullYear();
                state.lastOsCounter = { [currentYear]: 5 };
                state.clients = [
                    { 
                        id: 'CLI-001', 
                        code: 'CLI-001', 
                        name: 'João Silva', 
                        phone: '(11) 99999-9999', 
                        cpf: '123.456.789-00', 
                        birthDate: new Date().toISOString().slice(0,10),
                        cep: '01310-100',
                        address: 'Av. Paulista',
                        number: '1000',
                        complement: 'Apto 123',
                        neighborhood: 'Bela Vista',
                        city: 'São Paulo',
                        state: 'SP'
                    }
                ];
                state.products = [
                    { id: 'PROD-001', code: 'PROD-001', name: 'Lente Transitions', category: 'lentes', price: 450, costPrice: 300, qty: 25, minQty: 5, image: null },
                    { id: 'PROD-002', code: 'PROD-002', name: 'Lente Anti-Reflexo', category: 'lentes', price: 280, costPrice: 150, qty: 30, minQty: 5, image: null },
                    { id: 'PROD-003', code: 'PROD-003', name: 'Armação Titanium', category: 'armacoes', price: 350, costPrice: 200, qty: 15, minQty: 3, image: null }
                ];
                state.services = [
                    { id: 'SERV-001', code: 'SERV-001', name: 'Ajuste de armação', value: 50, desc: '' }
                ];
                state.suppliers = [
                    { id: 'SUP-001', code: 'SUP-001', name: 'Fornecedor Exemplo', cnpj: '12.345.678/0001-99', phone: '(11) 99999-8888', city: 'São Paulo', state: 'SP' }
                ];
                state.expenses = [];
                state.sales = [];
                state.prescriptions = [];
                Utils.updatePixKey();
            },

            async initTheme() {
                let theme = null;
                try { theme = await IDB.get('theme'); } catch(e) {}
                if (theme === 'dark') {
                    document.body.classList.add('dark-mode');
                    document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun"></i><span>Modo Claro</span>';
                }
                document.getElementById('themeToggle').addEventListener('click', App.toggleTheme);
            },

            toggleTheme() {
                document.body.classList.toggle('dark-mode');
                const isDark = document.body.classList.contains('dark-mode');
                IDB.set('theme', isDark ? 'dark' : 'light').catch(() => {});
                document.getElementById('themeToggle').innerHTML = isDark ?
                    '<i class="fas fa-sun"></i><span>Modo Claro</span>' :
                    '<i class="fas fa-moon"></i><span>Modo Escuro</span>';
                Toast.show(`Modo ${isDark ? 'escuro' : 'claro'} ativado`);
            },

            initNavigation() {
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const section = item.dataset.section;


                        document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
                        item.classList.add('active');
                        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                        document.getElementById(section).classList.add('active');
                        document.getElementById('pageTitle').innerText = item.querySelector('span').innerText;
                        
                        if (section === 'dashboard') Dashboard.update();
                        else if (section === 'sales') {
                            Sales.renderHistory();
                            Sales.populateSaleSelects();
                            document.getElementById('saleNumber') && (document.getElementById('saleNumber').value = Sales.generateOsNumber());
                        }
                        else if (section === 'clients') Clients.renderTable();
                        else if (section === 'products') Products.renderTable();
                        else if (section === 'services') Services.renderTable();
                        else if (section === 'suppliers') Suppliers.renderTable();
                        else if (section === 'expenses') {
                            Expenses.renderTable();
                            Expenses.updateSummary();
                        }
                        else if (section === 'config') Config.showTab('empresa');
                    });
                });
            },

            updateDateTime() {
                const now = new Date();
                document.getElementById('currentTime').innerText = now.toLocaleTimeString('pt-BR');
                document.getElementById('currentDate').innerText = now.toLocaleDateString('pt-BR', { 
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
                });
            },

            updateLogo(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        state.company.logo = e.target.result;
                        this.updateCompanyDisplay();
                        this.saveData();
                        Toast.show('Logo atualizada com sucesso!');
                    };
                    reader.readAsDataURL(file);
                }
            },

            async _buscarCepDados(cep) {
                // Tenta ViaCEP primeiro
                try {
                    const c1 = new AbortController();
                    const t1 = setTimeout(() => c1.abort(), 5000);
                    const r1 = await fetch(`https://viacep.com.br/ws/${cep}/json/`, { signal: c1.signal });
                    clearTimeout(t1);
                    const d1 = await r1.json();
                    if (!d1.erro) return { logradouro: d1.logradouro, bairro: d1.bairro, localidade: d1.localidade, uf: d1.uf };
                } catch (e) { /* fallback */ }
                // Tenta BrasilAPI como fallback
                try {
                    const c2 = new AbortController();
                    const t2 = setTimeout(() => c2.abort(), 5000);
                    const r2 = await fetch(`https://brasilapi.com.br/api/cep/v1/${cep}`, { signal: c2.signal });
                    clearTimeout(t2);
                    const d2 = await r2.json();
                    if (d2 && d2.city) return { logradouro: d2.street || '', bairro: d2.neighborhood || '', localidade: d2.city, uf: d2.state };
                } catch (e) { /* fallback */ }
                // Tenta AwesomeAPI como segundo fallback
                try {
                    const c3 = new AbortController();
                    const t3 = setTimeout(() => c3.abort(), 5000);
                    const r3 = await fetch(`https://cep.awesomeapi.com.br/json/${cep}`, { signal: c3.signal });
                    clearTimeout(t3);
                    const d3 = await r3.json();
                    if (d3 && d3.city) return { logradouro: d3.address || '', bairro: d3.district || '', localidade: d3.city, uf: d3.state };
                } catch (e) { /* esgotado */ }
                return null;
            },

            async buscarCepCompleto(input) {
                const cep = input.value.replace(/\D/g, '');
                if (cep.length !== 8) return;
                const prevBg = input.style.background;
                const prevPh = input.placeholder;
                input.style.background = '#fff9e6';
                input.placeholder = 'Buscando...';
                input.disabled = true;
                try {
                    const data = await this._buscarCepDados(cep);
                    if (data) {
                        document.getElementById('clientAddress').value = data.logradouro || '';
                        document.getElementById('clientNeighborhood').value = data.bairro || '';
                        document.getElementById('clientCity').value = data.localidade || '';
                        document.getElementById('clientState').value = data.uf || '';
                        Toast.show('Endereço preenchido com sucesso!');
                        input.style.background = '#f0fff0';
                    } else {
                        Toast.show('CEP não encontrado', 'warning');
                        input.style.background = prevBg;
                    }
                } catch (e) {
                    Toast.show('Erro ao buscar CEP', 'error');
                    input.style.background = prevBg;
                } finally {
                    input.disabled = false;
                    input.placeholder = prevPh;
                }
            },

            async buscarCepConfig(input) {
                const cep = input.value.replace(/\D/g, '');
                if (cep.length !== 8) return;
                const prevBg = input.style.background;
                const prevPh = input.placeholder;
                input.style.background = '#fff9e6';
                input.placeholder = 'Buscando...';
                input.disabled = true;
                try {
                    const data = await this._buscarCepDados(cep);
                    if (data) {
                        document.getElementById('configAddress').value = data.logradouro || '';
                        document.getElementById('configNeighborhood').value = data.bairro || '';
                        document.getElementById('configCity').value = data.localidade || '';
                        document.getElementById('configState').value = data.uf || '';
                        Toast.show('Endereço preenchido com sucesso!');
                        input.style.background = '#f0fff0';
                    } else {
                        Toast.show('CEP não encontrado', 'warning');
                        input.style.background = prevBg;
                    }
                } catch (e) {
                    Toast.show('Erro ao buscar CEP', 'error');
                    input.style.background = prevBg;
                } finally {
                    input.disabled = false;
                    input.placeholder = prevPh;
                }
            },

            async buscarCepFornecedor(input) {
                await Utils.buscarCepCompleto(input, 'supplier');
            },

            async buscarCnpj(input) {
                await Utils.buscarCnpjCompleto(input, 'config');
            },

            async buscarCnpjCompleto(input) {
                await Utils.buscarCnpjCompleto(input, 'supplier');
            },

            updateSupplierSelect() {
                const select = document.getElementById('expenseSupplier');
                if (!select) return;
                select.innerHTML = '<option value="">-- Selecione um fornecedor --</option>';
                state.suppliers.forEach(s => {
                    select.innerHTML += `<option value="${s.id}">${Utils.sanitizeHTML(s.name)}</option>`;
                });
            },

            exportBackup() {
                const dataStr = JSON.stringify(state, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `backup_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                Toast.show('Backup gerado com sucesso!');
            },

            importBackup(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                Modal.showConfirm('Isso substituirá todos os dados atuais. Continuar?', () => {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const newData = JSON.parse(e.target.result);
                            Object.assign(state, newData);
                            await this.saveData();
                            Config.load();
                            Utils.updatePixKey();
                            this.updateSupplierSelect();
                            this.updateCompanyDisplay();
                            Toast.show('Dados importados com sucesso!');
                        } catch (err) {
                            Toast.show('Arquivo inválido', 'error');
                        }
                    };
                    reader.readAsText(file);
                });
            },

            confirmClearData() {
                Modal.showConfirm('Limpar todos os dados? Esta ação é irreversível.', () => {
                    state.clients = []; 
                    state.products = []; 
                    state.services = []; 
                    state.suppliers = []; 
                    state.sales = []; 
                    state.expenses = []; 
                    state.prescriptions = [];
                    state.lastOsCounter = { [new Date().getFullYear()]: 1 };
                    this.saveData();
                    Utils.updatePixKey();
                    this.updateSupplierSelect();
                    this.updateCompanyDisplay();
                    Toast.show('Todos os dados foram limpos');
                });
            },

            resetToSample() {
                Modal.showConfirm('Restaurar dados de exemplo? Isso substituirá todos os dados atuais.', () => {
                    this.initSampleData();
                    this.saveData();
                    Config.load();
                    Utils.updatePixKey();
                    this.updateSupplierSelect();
                    this.updateCompanyDisplay();
                    Toast.show('Dados de exemplo restaurados');
                });
            }
        };

        App.maskPhone = Utils.maskPhone;
        App.maskCep = Utils.maskCep;
        App.maskCpfCnpj = Utils.maskCpfCnpj;
        App.maskCnpj = Utils.maskCnpj;

        // ==================== DASHBOARD ====================
        const Dashboard = {
            _period: 'month',   // periodo ativo: 'today' | 'week' | 'month' | 'year' | 'all' | 'custom'
            _from: null,
            _to: null,

            update() {
                this.updateCards();
                this.updateSalesChart();
                this.updateProductsChart();
                this.updateRecentSales();
                this.updateBirthdayAlerts();
                this.updateGlassesAlerts();
                if (typeof ContasManager !== 'undefined') ContasManager.renderAll();
            },

            setPeriod(period, btn) {
                this._period = period;
                document.querySelectorAll('.dash-period-btn').forEach(b => b.classList.remove('active'));
                btn?.classList.add('active');
                const custom = document.getElementById('dashCustomRange');
                if (period === 'custom') {
                    custom?.classList.add('show');
                    return; // aguarda datas
                } else {
                    custom?.classList.remove('show');
                    this._from = null;
                    this._to   = null;
                }
                this.update();
            },

            applyCustomPeriod() {
                this._from = document.getElementById('dashDateFrom')?.value || null;
                this._to   = document.getElementById('dashDateTo')?.value   || null;
                if (this._from && this._to) this.update();
            },

            // Retorna as vendas filtradas pelo período ativo
            _filteredSales() {
                const now  = new Date();
                const p    = this._period;
                return (state.sales || []).filter(s => {
                    const d = new Date(s.date + 'T12:00:00');
                    if (p === 'today') {
                        return d.toDateString() === now.toDateString();
                    } else if (p === 'week') {
                        const startOfWeek = new Date(now);
                        startOfWeek.setDate(now.getDate() - now.getDay());
                        startOfWeek.setHours(0,0,0,0);
                        return d >= startOfWeek;
                    } else if (p === 'month') {
                        return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                    } else if (p === 'year') {
                        return d.getFullYear() === now.getFullYear();
                    } else if (p === 'custom' && this._from && this._to) {
                        const from = new Date(this._from + 'T00:00:00');
                        const to   = new Date(this._to   + 'T23:59:59');
                        return d >= from && d <= to;
                    }
                    return true; // 'all'
                });
            },

            _filteredExpenses() {
                const now = new Date();
                const p   = this._period;
                return (state.expenses || []).filter(e => {
                    const d = new Date(e.date + 'T12:00:00');
                    if (p === 'today')  return d.toDateString() === now.toDateString();
                    if (p === 'week')   { const s=new Date(now); s.setDate(now.getDate()-now.getDay()); s.setHours(0,0,0,0); return d>=s; }
                    if (p === 'month')  return d.getMonth()===now.getMonth() && d.getFullYear()===now.getFullYear();
                    if (p === 'year')   return d.getFullYear()===now.getFullYear();
                    if (p === 'custom' && this._from && this._to) { return d>=new Date(this._from+'T00:00:00') && d<=new Date(this._to+'T23:59:59'); }
                    return true;
                });
            },

            _periodLabel() {
                const labels = { today:'Hoje', week:'Esta Semana', month:'Este Mês', year:'Este Ano', all:'Total Histórico', custom:'Período Personalizado' };
                return labels[this._period] || '';
            },

            // ── Aniversariantes do dia ──
            updateBirthdayAlerts() {
                const today = new Date();
                const todayMonth = today.getMonth() + 1;
                const todayDay   = today.getDate();
                const company    = state.company;

                const aniversariantes = state.clients.filter(c => {
                    if (!c.birthDate) return false;
                    const b = new Date(c.birthDate + 'T12:00:00');
                    return b.getMonth() + 1 === todayMonth && b.getDate() === todayDay;
                });

                const count = document.getElementById('bdayCount');
                const list  = document.getElementById('bdayList');
                if (!list) return;

                if (count) count.textContent = aniversariantes.length;

                if (aniversariantes.length === 0) {
                    list.innerHTML = '<div class="dash-alert-empty">🎉 Nenhum aniversariante hoje</div>';
                    return;
                }

                list.innerHTML = aniversariantes.map(c => {
                    const phone = (c.whatsapp || c.phone || '').replace(/\D/g, '');
                    const hasPhone = !!phone;
                    const bDate = new Date(c.birthDate + 'T12:00:00');
                    const idade = today.getFullYear() - bDate.getFullYear() - 
                        (today < new Date(today.getFullYear(), bDate.getMonth(), bDate.getDate()) ? 1 : 0);
                    return `
                        <div class="dash-alert-item">
                            <div>
                                <div class="dash-alert-name">🎂 ${Utils.sanitizeHTML(c.name)}</div>
                                <div class="dash-alert-info">${idade} anos · ${c.phone || 'sem telefone'}</div>
                            </div>
                            ${hasPhone ? `
                            <button class="btn-wpp-sm" onclick="Dashboard.enviarMsgAniversario('${c.id}')" title="Enviar parabéns por WhatsApp">
                                <i class="fab fa-whatsapp"></i> Parabéns
                            </button>` : `<span style="color:#aaa;font-size:0.75rem;">sem telefone</span>`}
                        </div>`;
                }).join('');
            },

            enviarMsgAniversario(clientId) {
                const client  = state.clients.find(c => c.id === clientId);
                const company = state.company;
                if (!client) return;

                const phone = (client.whatsapp || client.phone || '').replace(/\D/g, '');
                if (!phone) { Toast.show('Cliente sem WhatsApp/telefone', 'warning'); return; }

                const endereco = [company.address, company.number ? ', ' + company.number : '', company.city ? ' — ' + company.city : '', company.state ? '/' + company.state : ''].filter(Boolean).join('');

                let msg = ConfigWpp.get('aniversario')
                    .replace(/{{NOME}}/g,     client.name.split(' ')[0])
                    .replace(/{{DATA}}/g,     new Date().toLocaleDateString('pt-BR'))
                    .replace(/{{EMPRESA}}/g,  company.name || '')
                    .replace(/{{ENDERECO}}/g, endereco)
                    .replace(/{{TELEFONE}}/g, company.whatsapp || company.phone || '');

                WppConfirm.show({
                    nome:     client.name,
                    phone:    phone,
                    subtitle: '🎂 Mensagem de Aniversário',
                    msg:      msg,
                    url:      `https://wa.me/55${phone}?text=${encodeURIComponent(msg)}`
                });
            },

            // ── Óculos entregues há mais de 1 ano ──
            updateGlassesAlerts() {
                const today     = new Date();
                const oneYearAgo = new Date();
                oneYearAgo.setFullYear(today.getFullYear() - 1);

                const ENTREGUES = ['entregue', 'delivered'];

                const vencidos = (state.sales || [])
                    .filter(s => ENTREGUES.includes(s.status) && new Date(s.date + 'T12:00:00') < oneYearAgo)
                    .map(s => ({
                        sale:   s,
                        client: state.clients.find(c => c.id === s.clientId)
                    }))
                    .filter(x => x.client)
                    .sort((a, b) => new Date(a.sale.date) - new Date(b.sale.date)); // mais antigos primeiro

                const count = document.getElementById('glassesCount');
                const list  = document.getElementById('glassesList');
                if (!list) return;

                if (count) count.textContent = vencidos.length;

                if (vencidos.length === 0) {
                    list.innerHTML = '<div class="dash-alert-empty">✅ Nenhum óculos vencido no momento</div>';
                    return;
                }

                list.innerHTML = vencidos.map(({ sale, client }) => {
                    const phone    = (client.whatsapp || client.phone || '').replace(/\D/g, '');
                    const hasPhone = !!phone;
                    const saleDate = new Date(sale.date + 'T12:00:00');
                    const meses    = Math.floor((today - saleDate) / (1000 * 60 * 60 * 24 * 30));
                    return `
                        <div class="dash-alert-item">
                            <div>
                                <div class="dash-alert-name">👓 ${Utils.sanitizeHTML(client.name)}</div>
                                <div class="dash-alert-info">OS ${sale.number} · Há ${meses} meses · ${client.phone || 'sem telefone'}</div>
                            </div>
                            ${hasPhone ? `
                            <button class="btn-wpp-sm" onclick="Dashboard.enviarMsgOculosVencido('${sale.id}')" title="Enviar mensagem de renovação por WhatsApp">
                                <i class="fab fa-whatsapp"></i> Renovar
                            </button>` : `<span style="color:#aaa;font-size:0.75rem;">sem telefone</span>`}
                        </div>`;
                }).join('');
            },

            enviarMsgOculosVencido(saleId) {
                const sale    = state.sales.find(s => s.id === saleId);
                const client  = state.clients.find(c => c.id === sale?.clientId);
                const company = state.company;
                if (!sale || !client) return;

                const phone = (client.whatsapp || client.phone || '').replace(/\D/g, '');
                if (!phone) { Toast.show('Cliente sem WhatsApp/telefone', 'warning'); return; }

                const fd = d => d ? new Date(d + 'T12:00:00').toLocaleDateString('pt-BR') : '—';
                const meses = Math.floor((new Date() - new Date(sale.date + 'T12:00:00')) / (1000 * 60 * 60 * 24 * 30));
                const endereco = [company.address, company.number ? ', ' + company.number : '', company.city ? ' — ' + company.city : '', company.state ? '/' + company.state : ''].filter(Boolean).join('');

                let msg = ConfigWpp.get('oculosVencido')
                    .replace(/{{NOME}}/g,       client.name.split(' ')[0])
                    .replace(/{{MESES}}/g,      String(meses))
                    .replace(/{{OS}}/g,         sale.number || '')
                    .replace(/{{DATA_VENDA}}/g, fd(sale.date))
                    .replace(/{{EMPRESA}}/g,    company.name || '')
                    .replace(/{{ENDERECO}}/g,   endereco)
                    .replace(/{{TELEFONE}}/g,   company.whatsapp || company.phone || '');

                WppConfirm.show({
                    nome:     client.name,
                    phone:    phone,
                    subtitle: `👓 Renovação de óculos — ${meses} meses`,
                    msg:      msg,
                    url:      `https://wa.me/55${phone}?text=${encodeURIComponent(msg)}`
                });
            },

            updateCards() {
                console.log('[Dashboard] updateCards — state.sales:', (state.sales||[]).length, 'itens, período:', this._period);
                const sales    = this._filteredSales();
                const expenses = this._filteredExpenses();
                const label    = this._periodLabel();
                console.log('[Dashboard] vendas filtradas:', sales.length, '| despesas:', expenses.length);

                const totalSales    = sales.reduce((a, s) => a + (s.total || 0), 0);
                const totalExpenses = expenses.reduce((a, e) => a + (e.value || 0), 0);
                const profit        = totalSales - totalExpenses;
                const countSales    = sales.length;
                const ticketMedio   = countSales ? totalSales / countSales : 0;
                const totalClients  = (state.clients || []).length;
                const totalPresc    = (state.prescriptions || []).length;
                const salesEntregues = (state.sales || []).filter(s => s.status === 'entregue').length;
                const salesPendentes = (state.sales || []).filter(s => ['pendente','producao','laboratorio','pronto'].includes(s.status)).length;
                const payMethodCounts = {};
                (state.sales||[]).forEach(s => { payMethodCounts[s.paymentMethod] = (payMethodCounts[s.paymentMethod]||0) + 1; });
                const topPay = Object.entries(payMethodCounts).sort((a,b)=>b[1]-a[1])[0];
                const payLabels = { pix:'PIX', cash:'Dinheiro', debit:'Débito', credit:'Crédito', installment:'Crediário' };
                const company = state.company || {};
                const addrParts = [company.address, company.number, company.neighborhood, company.city, company.state].filter(Boolean);
                const companyAddress = addrParts.join(', ') || 'Endereço não configurado';

                document.getElementById('dashboardCards').innerHTML = `
                    <div class="card" style="--card-accent:#ff6b00;">
                        <div class="card-header">
                            <span class="card-title">Vendas — ${label}</span>
                            <div class="card-icon" style="background:#fff5ee;color:#ff6b00;"><i class="fas fa-arrow-trend-up"></i></div>
                        </div>
                        <div class="card-value">${Utils.formatCurrency(totalSales)}</div>
                        <div style="font-size:0.76rem;color:var(--gray);">${countSales} OS &nbsp;·&nbsp; Ticket: <strong>${Utils.formatCurrency(ticketMedio)}</strong></div>
                    </div>
                    <div class="card" style="--card-accent:#dc3545;">
                        <div class="card-header">
                            <span class="card-title">Despesas — ${label}</span>
                            <div class="card-icon" style="background:#fff0f1;color:#dc3545;"><i class="fas fa-receipt"></i></div>
                        </div>
                        <div class="card-value">${Utils.formatCurrency(totalExpenses)}</div>
                        <div style="font-size:0.76rem;color:var(--gray);">${expenses.length} lançamento${expenses.length !== 1 ? 's' : ''}</div>
                    </div>
                    <div class="card" style="--card-accent:${profit >= 0 ? '#22c55e' : '#dc3545'};">
                        <div class="card-header">
                            <span class="card-title">Resultado — ${label}</span>
                            <div class="card-icon" style="background:${profit >= 0 ? '#f0fdf4' : '#fff0f1'};color:${profit >= 0 ? '#22c55e' : '#dc3545'};"><i class="fas fa-${profit >= 0 ? 'coins' : 'exclamation-triangle'}"></i></div>
                        </div>
                        <div class="card-value" style="color:${profit >= 0 ? '#22c55e' : '#dc3545'};">${Utils.formatCurrency(profit)}</div>
                        <div style="font-size:0.76rem;color:var(--gray);">${profit >= 0 ? '▲ Positivo' : '▼ Negativo'}</div>
                    </div>
                    <div class="card" style="--card-accent:#0ea5e9;">
                        <div class="card-header">
                            <span class="card-title">OS em Aberto</span>
                            <div class="card-icon" style="background:#f0f9ff;color:#0ea5e9;"><i class="fas fa-file-alt"></i></div>
                        </div>
                        <div class="card-value" style="color:#0ea5e9;">${salesPendentes}</div>
                        <div style="font-size:0.76rem;color:var(--gray);">${salesEntregues} entregue${salesEntregues !== 1 ? 's' : ''} no período</div>
                    </div>
                    <div class="card" style="--card-accent:#10b981;grid-column:span 2;">
                        <div class="card-header">
                            <span class="card-title" style="font-size:0.8rem;font-weight:700;color:var(--dark);">${company.name || 'ÓticaVision Pro'}</span>
                            <div class="card-icon" style="background:#f0fdf4;color:#10b981;"><i class="fas fa-store"></i></div>
                        </div>
                        <div style="font-size:0.8rem;color:var(--gray);display:flex;flex-wrap:wrap;gap:0.5rem 1.5rem;">
                            <span><i class="fas fa-map-marker-alt" style="color:#dc3545;margin-right:4px;width:14px;text-align:center;"></i>${companyAddress}</span>
                            ${company.phone ? `<span><i class="fas fa-phone" style="color:#22c55e;margin-right:4px;width:14px;text-align:center;"></i>${company.phone}</span>` : ''}
                            ${company.cnpj  ? `<span><i class="fas fa-id-card" style="color:#0ea5e9;margin-right:4px;width:14px;text-align:center;"></i>CNPJ: ${company.cnpj}</span>` : ''}
                            ${company.pix   ? `<span><i class="fas fa-qrcode" style="color:#8b5cf6;margin-right:4px;width:14px;text-align:center;"></i>PIX: ${company.pix}</span>` : ''}
                        </div>
                    </div>
                `;
            },

            updateSalesChart() {
                const chart = document.getElementById('salesChart');
                if (!chart) return;
                chart.innerHTML = '';
                
                const days = [];
                for (let i = 6; i >= 0; i--) {
                    const d = new Date(); 
                    d.setDate(d.getDate() - i);
                    days.push(d.toLocaleDateString('pt-BR', { weekday: 'short' }));
                }
                
                const salesData = days.map((_, idx) => {
                    const day = new Date(); 
                    day.setDate(day.getDate() - (6 - idx));
                    const dayStr = day.toDateString();
                    return (state.sales || [])
                        .filter(s => new Date(s.date + 'T12:00:00').toDateString() === dayStr)
                        .reduce((acc, s) => acc + (s.total || 0), 0);
                });
                
                const max = Math.max(...salesData) || 1;
                salesData.forEach((val, i) => {
                    const bar = document.createElement('div');
                    bar.className = 'bar';
                    bar.style.height = (val / max * 150) + 'px';
                    bar.innerHTML = `<div class="bar-value">${Utils.formatCurrency(val)}</div><div class="bar-label">${days[i]}</div>`;
                    chart.appendChild(bar);
                });
            },

            updateProductsChart() {
                const chart = document.getElementById('productsChart');
                if (!chart) return;
                chart.innerHTML = '';
                
                const prodCount = {};
                (state.sales || []).forEach(s => (s.items || []).forEach(item => {
                    if (item && item.name) prodCount[item.name] = (prodCount[item.name] || 0) + (item.qty || 0);
                }));
                
                const sorted = Object.entries(prodCount).sort((a,b) => b[1] - a[1]).slice(0,5);
                if (sorted.length === 0) { 
                    chart.innerHTML = '<div style="text-align:center; padding-top:80px;">Sem dados</div>'; 
                    return; 
                }
                
                const max = Math.max(...sorted.map(p => p[1]));
                sorted.forEach(([name, qty]) => {
                    const bar = document.createElement('div');
                    bar.className = 'bar';
                    bar.style.height = (qty / max * 150) + 'px';
                    bar.innerHTML = `<div class="bar-value">${qty}</div><div class="bar-label">${name.substring(0,10)}</div>`;
                    chart.appendChild(bar);
                });
            },

            updateRecentSales() {
                const tbody = document.querySelector('#recentSalesTable tbody');
                if (!tbody) return;
                tbody.innerHTML = '';
                
                const recentSales = [...(state.sales || [])]
                    .sort((a, b) => new Date(b.date + 'T12:00:00') - new Date(a.date + 'T12:00:00'))
                    .slice(0, 5);
                recentSales.forEach(s => {
                    const client = state.clients.find(c => c.id === s.clientId)?.name || '';
                    tbody.innerHTML += `<tr>
                        <td>${s.number}</td>
                        <td>${Utils.sanitizeHTML(client)}</td>
                        <td>${Utils.formatCurrency(s.total)}</td>
                        <td><span class="badge badge-info">${s.status}</span></td>
                        <td>${Utils.formatDate(s.date)}</td>
                    </tr>`;
                });
            }
        };

        // ==================== CLIENTES ====================
        const Clients = {
            renderTable() {
                const tbody = document.querySelector('#clientsTable tbody');
                if (!tbody) return;
                tbody.innerHTML = '';
                const badge = document.getElementById('clientsCountBadge');
                if (badge) badge.textContent = state.clients.length + ' cliente' + (state.clients.length !== 1 ? 's' : '');
                
                state.clients.forEach(c => {
                    const hasPresc = state.prescriptions.some(p => p.clientId === c.id);
                    tbody.innerHTML += `<tr>
                        <td>${c.code || c.id}</td>
                        <td>${Utils.sanitizeHTML(c.name)}</td>
                        <td>${c.phone || ''}</td>
                        <td>${c.cpf || ''}</td>
                        <td>${c.birthDate ? Utils.formatDate(c.birthDate) : ''}</td>
                        <td>${c.city || ''}${c.city && c.state ? '/' : ''}${c.state || ''}</td>
                        <td class="action-buttons">
                            <button class="btn-icon btn-view" onclick="Clients.view('${c.id}')" title="Visualizar"><i class="fas fa-eye"></i></button>
                            <button class="btn-icon btn-edit" onclick="Clients.edit('${c.id}')" title="Editar"><i class="fas fa-edit"></i></button>
                            <button class="btn-icon btn-delete" onclick="Clients.delete('${c.id}')" title="Excluir"><i class="fas fa-trash"></i></button>
                        </td>
                        <td class="action-buttons">
                            ${hasPresc ? `<button class="btn-icon btn-pdf-icon" onclick="Presc.exportClientPrescToPDFForClient('${c.id}')" title="Exportar Receita PDF"><i class="fas fa-file-pdf"></i></button>` : ''}
                            ${hasPresc ? `<button class="btn-icon" style="background:rgba(37,211,102,0.15);color:#25d366;" onclick="Sales.enviarReceituarioWhatsApp('${c.id}')" title="Enviar Receituário WhatsApp"><i class="fab fa-whatsapp"></i></button>` : ''}
                        </td>
                    </tr>`;
                });
            },

            save() {
                if (!Utils.validateRequired('clientForm')) {
                    Toast.show('Preencha todos os campos obrigatórios', 'warning');
                    return;
                }
                
                const client = {
                    id: state.editingId || 'CLI-' + (state.clients.length + 1).toString().padStart(3, '0'),
                    code: document.getElementById('clientCode').value,
                    birthDate: document.getElementById('clientBirthDate').value,
                    name: document.getElementById('clientName').value,
                    phone: document.getElementById('clientPhone').value,
                    email: document.getElementById('clientEmail').value,
                    cpf: document.getElementById('clientCpf').value,
                    cep: document.getElementById('clientCep').value,
                    address: document.getElementById('clientAddress').value,
                    number: document.getElementById('clientNumber').value,
                    complement: document.getElementById('clientComplement').value,
                    neighborhood: document.getElementById('clientNeighborhood').value,
                    city: document.getElementById('clientCity').value,
                    state: document.getElementById('clientState').value,
                    updated_at: new Date().toISOString()
                };
                
                if (state.editingId) {
                    const index = state.clients.findIndex(c => c.id === state.editingId);
                    if (index !== -1) state.clients[index] = client;
                } else {
                    state.clients.push(client);
                }
                
                const presc = {
                    id: 'PRESC-' + client.id,
                    clientId: client.id,
                    date: document.getElementById('clientPrescDate').value,
                    optometrist: document.getElementById('clientPrescOptometrist').value,
                    od: {
                        sph: document.getElementById('clientOdSph').value,
                        cyl: document.getElementById('clientOdCyl').value,
                        axis: document.getElementById('clientOdAxis').value,
                        add: document.getElementById('clientOdAdd').value,
                        dnp: document.getElementById('clientOdDnp').value
                    },
                    oe: {
                        sph: document.getElementById('clientOeSph').value,
                        cyl: document.getElementById('clientOeCyl').value,
                        axis: document.getElementById('clientOeAxis').value,
                        add: document.getElementById('clientOeAdd').value,
                        dnp: document.getElementById('clientOeDnp').value
                    },
                    dp: document.getElementById('clientPrescDp').value,
                    height: document.getElementById('clientPrescHeight').value,
                    notes: document.getElementById('clientPrescNotes').value
                };
                
                // Só substitui o receituário se houver dados reais preenchidos — preserva receituário anterior
                const hasRealPrescData = presc.optometrist || 
                    (presc.od.sph && presc.od.sph !== '0.00') ||
                    (presc.oe.sph && presc.oe.sph !== '0.00') ||
                    (presc.od.cyl && presc.od.cyl !== '0.00') ||
                    (presc.oe.cyl && presc.oe.cyl !== '0.00');

                if (hasRealPrescData) {
                    state.prescriptions = state.prescriptions.filter(p => p.clientId !== client.id);
                    state.prescriptions.push(presc);
                }
                // Se não há dados de receituário preenchidos, mantém o receituário anterior intacto
                
                App.saveData();
                SupaSync.upsertCliente(client);
                if (hasRealPrescData) {
                    SupaSync.upsertPrescricao(presc);
                }
                this.clearForm();
                this.renderTable();
                Clients._ultimoClienteSalvo = client;
                var _nEl = document.getElementById('clienteSalvoNome');
                if (_nEl) _nEl.textContent = client.name || '';
                Modal.show('clienteSalvoModal');
            },

            _ultimoClienteSalvo: null,

            _criarVendaParaCliente() {
                Modal.close('clienteSalvoModal');
                var client = Clients._ultimoClienteSalvo;
                var menuSales = document.querySelector('.menu-item[data-section="sales"]');
                if (menuSales) menuSales.click();
                setTimeout(function() {
                    if (!client) return;
                    var searchEl = document.getElementById('searchClientSale');
                    if (searchEl) {
                        searchEl.value = client.name;
                        searchEl.dispatchEvent(new Event('input'));
                        setTimeout(function() {
                            if (typeof Sales !== 'undefined' && Sales.selectClient) {
                                Sales.selectClient(client.id);
                            }
                        }, 300);
                    }
                    Toast.show('Cliente ' + client.name + ' selecionado!', 'success');
                }, 400);
            },

            edit(id) {
                const client = state.clients.find(c => c.id === id);
                if (!client) return;
                
                state.editingId = id;
                document.getElementById('clientCode').value = client.code || id;
                document.getElementById('clientBirthDate').value = client.birthDate || '';
                document.getElementById('clientName').value = client.name;
                document.getElementById('clientPhone').value = client.phone || '';
                document.getElementById('clientEmail').value = client.email || '';
                document.getElementById('clientCpf').value = client.cpf || '';
                document.getElementById('clientCep').value = client.cep || '';
                document.getElementById('clientAddress').value = client.address || '';
                document.getElementById('clientNumber').value = client.number || '';
                document.getElementById('clientComplement').value = client.complement || '';
                document.getElementById('clientNeighborhood').value = client.neighborhood || '';
                document.getElementById('clientCity').value = client.city || '';
                document.getElementById('clientState').value = client.state || '';
                
                const presc = state.prescriptions.filter(p => p.clientId === id).pop();
                if (presc) {
                    document.getElementById('clientPrescDate').value = presc.date || '';
                    document.getElementById('clientPrescOptometrist').value = presc.optometrist || '';
                    document.getElementById('clientOdSph').value = presc.od?.sph || '0.00';
                    document.getElementById('clientOdCyl').value = presc.od?.cyl || '0.00';
                    document.getElementById('clientOdAxis').value = presc.od?.axis || '';
                    document.getElementById('clientOdAdd').value = presc.od?.add || '0.00';
                    document.getElementById('clientOdDnp').value = presc.od?.dnp || '';
                    document.getElementById('clientOeSph').value = presc.oe?.sph || '0.00';
                    document.getElementById('clientOeCyl').value = presc.oe?.cyl || '0.00';
                    document.getElementById('clientOeAxis').value = presc.oe?.axis || '';
                    document.getElementById('clientOeAdd').value = presc.oe?.add || '0.00';
                    document.getElementById('clientOeDnp').value = presc.oe?.dnp || '';
                    document.getElementById('clientPrescDp').value = presc.dp || '';
                    document.getElementById('clientPrescHeight').value = presc.height || '';
                    document.getElementById('clientPrescNotes').value = presc.notes || '';
                    
                    Presc.updateClientPertoOD();
                    Presc.updateClientPertoOE();
                }
            },

            delete(id) {
                Modal.showConfirm('Excluir este cliente?', () => {
                    state.clients = state.clients.filter(c => c.id !== id);
                    state.prescriptions = state.prescriptions.filter(p => p.clientId !== id);
                    App.saveData();
                    SupaSync.deletarCliente(id);
                    this.renderTable();
                    Toast.show('Cliente excluído com sucesso!');
                });
            },

            view(id) {
                const client = state.clients.find(c => c.id === id);
                if (!client) return;
                
                const presc = state.prescriptions.filter(p => p.clientId === id).pop();
                const vendas = state.sales.filter(s => s.clientId === id);
                const totalGasto = vendas.reduce((s, v) => s + (v.total || 0), 0);

                let html = `
                <div style="font-family:inherit;">
                  <!-- DADOS PESSOAIS -->
                  <div style="background:var(--light);border-radius:8px;padding:1rem;margin-bottom:1rem;">
                    <h4 style="color:var(--primary);margin-bottom:0.75rem;border-bottom:2px solid var(--primary);padding-bottom:0.4rem;">
                      <i class="fas fa-user"></i> Dados do Cliente
                    </h4>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;">
                      <div><small style="color:var(--gray);">CÓDIGO</small><br><strong>${client.code || client.id}</strong></div>
                      <div><small style="color:var(--gray);">CPF</small><br><strong>${client.cpf || '—'}</strong></div>
                      <div><small style="color:var(--gray);">TELEFONE</small><br><strong>${client.phone || '—'}</strong></div>
                      <div><small style="color:var(--gray);">WHATSAPP</small><br><strong>${client.whatsapp || client.phone || '—'}</strong></div>
                      <div><small style="color:var(--gray);">E-MAIL</small><br><strong>${client.email || '—'}</strong></div>
                      <div><small style="color:var(--gray);">NASCIMENTO</small><br><strong>${client.birthDate ? Utils.formatDate(client.birthDate) : '—'}</strong></div>
                    </div>
                    ${(client.address) ? `<div style="margin-top:0.5rem;"><small style="color:var(--gray);">ENDEREÇO</small><br><strong>${client.address}${client.number ? ', '+client.number : ''}${client.complement ? ' – '+client.complement : ''}, ${client.neighborhood || ''} — ${client.city || ''}/${client.state || ''} ${client.cep ? '(CEP '+client.cep+')' : ''}</strong></div>` : ''}
                    <div style="margin-top:0.5rem;display:flex;gap:1rem;">
                      <div><small style="color:var(--gray);">COMPRAS</small><br><strong>${vendas.length}</strong></div>
                      <div><small style="color:var(--gray);">TOTAL GASTO</small><br><strong style="color:var(--success);">${Utils.formatCurrency(totalGasto)}</strong></div>
                    </div>
                  </div>`;

                if (presc) {
                    const fmt = v => (v && v !== '0.00') ? v : '—';
                    html += `
                  <!-- RECEITUÁRIO -->
                  <div style="background:var(--light);border-radius:8px;padding:1rem;margin-bottom:1rem;">
                    <h4 style="color:var(--primary);margin-bottom:0.75rem;border-bottom:2px solid var(--primary);padding-bottom:0.4rem;">
                      <i class="fas fa-eye"></i> Receituário — ${presc.date ? Utils.formatDate(presc.date) : 'sem data'}
                    </h4>
                    <div style="overflow-x:auto;-webkit-overflow-scrolling:touch;margin-bottom:0.75rem;">
                    <table style="width:100%;min-width:320px;border-collapse:collapse;font-size:0.85rem;">
                      <thead>
                        <tr style="background:var(--primary);color:white;text-align:center;">
                          <th style="padding:6px 4px;border-radius:4px 0 0 0;white-space:nowrap;"></th>
                          <th style="padding:6px 4px;white-space:nowrap;">ESF</th>
                          <th style="padding:6px 4px;white-space:nowrap;">CIL</th>
                          <th style="padding:6px 4px;white-space:nowrap;">EIXO</th>
                          <th style="padding:6px 4px;white-space:nowrap;">ADD</th>
                          <th style="padding:6px 4px;border-radius:0 4px 0 0;white-space:nowrap;">DNP</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr style="text-align:center;background:#fff3ec;">
                          <td style="padding:6px 4px;font-weight:700;color:#cc4400;">OD</td>
                          <td style="padding:6px 4px;">${fmt(presc.od?.sph)}</td>
                          <td style="padding:6px 4px;">${fmt(presc.od?.cyl)}</td>
                          <td style="padding:6px 4px;">${fmt(presc.od?.axis)}°</td>
                          <td style="padding:6px 4px;">${fmt(presc.od?.add)}</td>
                          <td style="padding:6px 4px;">${fmt(presc.od?.dnp)}</td>
                        </tr>
                        <tr style="text-align:center;">
                          <td style="padding:6px 4px;font-weight:700;color:#0044cc;">OE</td>
                          <td style="padding:6px 4px;">${fmt(presc.oe?.sph)}</td>
                          <td style="padding:6px 4px;">${fmt(presc.oe?.cyl)}</td>
                          <td style="padding:6px 4px;">${fmt(presc.oe?.axis)}°</td>
                          <td style="padding:6px 4px;">${fmt(presc.oe?.add)}</td>
                          <td style="padding:6px 4px;">${fmt(presc.oe?.dnp)}</td>
                        </tr>
                      </tbody>
                    </table>
                    </div><!-- /overflow-x:auto -->
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.5rem;font-size:0.85rem;">
                      <div><small style="color:var(--gray);">DP TOTAL</small><br><strong>${presc.dp || '—'} mm</strong></div>
                      <div><small style="color:var(--gray);">ALTURA</small><br><strong>${presc.height || '—'} mm</strong></div>
                      <div><small style="color:var(--gray);">PROFISSIONAL</small><br><strong>${presc.optometrist || '—'}</strong></div>
                    </div>
                    ${presc.notes ? `<div style="margin-top:0.5rem;background:#fffbe6;border-left:3px solid #ffc107;padding:0.5rem;border-radius:4px;font-size:0.85rem;"><small style="color:var(--gray);">OBSERVAÇÕES</small><br>${presc.notes}</div>` : ''}
                  </div>`;
                } else {
                    html += `<div style="text-align:center;padding:1rem;color:var(--gray);background:var(--light);border-radius:8px;"><i class="fas fa-info-circle"></i> Nenhum receituário cadastrado.</div>`;
                }

                html += `</div>`;
                Modal.show('viewModal', html);
                document.getElementById('viewTitle').innerText = 'Detalhes do Cliente';
            },

            search() {
                const term = document.getElementById('searchClient').value.toLowerCase();
                document.querySelectorAll('#clientsTable tbody tr').forEach(row => {
                    row.style.display = row.innerText.toLowerCase().includes(term) ? '' : 'none';
                });
            },

            clearForm() {
                document.getElementById('clientForm').reset();
                state.editingId = null;
                // Limpa explicitamente todos os campos de texto do cliente
                ['clientName','clientPhone','clientEmail','clientCpf','clientCep',
                 'clientAddress','clientNumber','clientComplement','clientNeighborhood',
                 'clientCity','clientState'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = '';
                });
                document.getElementById('clientCode').value = 'CLI-' + (state.clients.length + 1).toString().padStart(3, '0');
                document.getElementById('clientBirthDate').value = new Date().toISOString().slice(0,10);
                // Limpa receituário silenciosamente (sem confirm) ao resetar o formulário
                this._resetPrescFields();
            },

            // Limpa campos de prescrição SEM pedir confirmação (uso interno após salvar)
            _resetPrescFields() {
                // Campos longe (OD e OE) — esférico, cilíndrico, adição
                ['clientOdSph','clientOdCyl','clientOdAdd','clientOeSph','clientOeCyl','clientOeAdd',
                 // Campos perto (near) calculados automaticamente
                 'clientOdNearSph','clientOdNearCyl','clientOeNearSph','clientOeNearCyl'].forEach(id => {
                    const el = document.getElementById(id); if (el) el.value = '0.00';
                });
                ['clientOdAxis','clientOeAxis','clientOdDnp','clientOeDnp',
                 'clientOdNearAxis','clientOdNearDnp','clientOeNearAxis','clientOeNearDnp',
                 'clientPrescDp','clientPrescHeight','clientPrescNotes','clientPrescOptometrist'].forEach(id => {
                    const el = document.getElementById(id); if (el) el.value = '';
                });
                document.getElementById('clientPrescDate').value = new Date().toISOString().slice(0,10);
            },

            // Botão LIMPAR manual — pede confirmação
            clearPresc() {
                if (!confirm('Limpar receituário?')) return;
                this._resetPrescFields();
                Toast.show('Receituário limpo');
            },

            exportToExcel() {
                if (state.clients.length === 0) {
                    Toast.show('Nenhum cliente para exportar', 'warning');
                    return;
                }

                // Cabeçalho
                const headers = ['Código', 'Nome', 'Telefone', 'Email', 'CPF', 'Data Nascimento', 'CEP', 'Logradouro', 'Número', 'Complemento', 'Bairro', 'Cidade', 'UF'];

                // Linhas de dados
                const rows = state.clients.map(c => [
                    c.code || c.id,
                    c.name || '',
                    c.phone || '',
                    c.email || '',
                    c.cpf || '',
                    c.birthDate || '',
                    c.cep || '',
                    c.address || '',
                    c.number || '',
                    c.complement || '',
                    c.neighborhood || '',
                    c.city || '',
                    c.state || ''
                ]);

                // Montar planilha com SheetJS
                const wsData = [headers, ...rows];
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(wsData);

                // Larguras de coluna automáticas
                ws['!cols'] = headers.map((h, i) => {
                    const max = Math.max(h.length, ...rows.map(r => String(r[i] || '').length));
                    return { wch: Math.min(max + 2, 40) };
                });

                XLSX.utils.book_append_sheet(wb, ws, 'Clientes');
                XLSX.writeFile(wb, `clientes_${new Date().toISOString().slice(0,10)}.xlsx`);
                Toast.show('Clientes exportados em Excel com sucesso!');
            },

            exportToCSV() {
                if (state.clients.length === 0) {
                    Toast.show('Nenhum cliente para exportar', 'warning');
                    return;
                }

                // Cabeçalho do CSV
                const headers = ['Código', 'Nome', 'Telefone', 'Email', 'CPF', 'Data Nascimento', 'CEP', 'Logradouro', 'Número', 'Complemento', 'Bairro', 'Cidade', 'UF'];
                
                // Linhas de dados
                const rows = state.clients.map(c => [
                    c.code || c.id,
                    c.name || '',
                    c.phone || '',
                    c.email || '',
                    c.cpf || '',
                    c.birthDate || '',
                    c.cep || '',
                    c.address || '',
                    c.number || '',
                    c.complement || '',
                    c.neighborhood || '',
                    c.city || '',
                    c.state || ''
                ]);

                // Converter para CSV
                let csvContent = headers.join(';') + '\n';
                rows.forEach(row => {
                    // Escapar aspas e ponto e vírgula
                    const escapedRow = row.map(cell => {
                        const cellStr = String(cell ?? '');
                        if (cellStr.includes(';') || cellStr.includes('"') || cellStr.includes('\n')) {
                            return `"${cellStr.replace(/"/g, '""')}"`;
                        }
                        return cellStr;
                    });
                    csvContent += escapedRow.join(';') + '\n';
                });

                // Download
                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' }); // BOM para acentos
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.href = url;
                link.download = `clientes_${new Date().toISOString().slice(0,10)}.csv`;
                link.click();
                URL.revokeObjectURL(url);
                Toast.show('Clientes exportados com sucesso!');
            },

            importFromFile(event) {
                const file = event.target.files[0];
                if (!file) return;
                const isExcel = file.name.toLowerCase().endsWith('.xlsx') || file.name.toLowerCase().endsWith('.xls');
                const expectedHeaders = ['Código','Nome','Telefone','Email','CPF','Data Nascimento','CEP','Logradouro','Número','Complemento','Bairro','Cidade','UF'];
                const self = this;

                const processRows = (rows) => {
                    if (rows.length < 2) { Toast.show('Arquivo inválido ou sem dados', 'error'); return; }
                    let imported = 0, errors = 0;
                    for (let i = 1; i < rows.length; i++) {
                        const fields = rows[i].map(f => String(f || '').trim());
                        if (fields.every(f => f === '')) continue;
                        const name = fields[1] || '';
                        if (!name) { errors++; continue; }
                        const client = {
                            id: 'CLI-' + (state.clients.length + 1 + imported).toString().padStart(3,'0'),
                            code: fields[0] || '', name,
                            phone: fields[2] || '', email: fields[3] || '',
                            cpf: fields[4] || '', birthDate: fields[5] || '',
                            cep: fields[6] || '', address: fields[7] || '',
                            number: fields[8] || '', complement: fields[9] || '',
                            neighborhood: fields[10] || '', city: fields[11] || '',
                            state: fields[12] || ''
                        };
                        state.clients.push(client);
                        imported++;
                    }
                    App.saveData();
                    self.renderTable();
                    Toast.show(`${imported} clientes importados. ${errors} erros.`, imported > 0 ? 'success' : 'warning');
                };

                if (isExcel) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const wb = XLSX.read(data, { type: 'array' });
                            const ws = wb.Sheets[wb.SheetNames[0]];
                            const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
                            processRows(rows);
                        } catch(err) {
                            Toast.show('Erro ao ler Excel: ' + err.message, 'error');
                        }
                    };
                    reader.readAsArrayBuffer(file);
                } else {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const content = e.target.result;
                        const clean = content.charCodeAt(0) === 0xFEFF ? content.slice(1) : content;
                        const lines = clean.split('\n').filter(l => l.trim() !== '');
                        const rows = lines.map(line => {
                            const regex = /(".*?"|[^;]+)(?=\s*;|\s*$)/g;
                            const fields = [];
                            let m;
                            while ((m = regex.exec(line)) !== null) {
                                fields.push(m[1].replace(/^"|"$/g,'').replace(/""/g,'"'));
                            }
                            return fields;
                        });
                        processRows(rows);
                    };
                    reader.readAsText(file);
                }
                event.target.value = '';
            },

            importFromCSV(event) {
                this.importFromFile(event);
            }
        };

        // ==================== PRODUTOS ====================
        const Products = {
            renderTable() {
                const tbody = document.querySelector('#productsTable tbody');
                if (!tbody) return;
                tbody.innerHTML = '';
                
                state.products.forEach(p => {
                    const status = p.qty === 0 ? 'danger' : (p.qty <= p.minQty ? 'warning' : 'success');
                    const statusText = p.qty === 0 ? 'Esgotado' : (p.qty <= p.minQty ? 'Baixo' : 'Normal');
                    tbody.innerHTML += `<tr>
                        <td>${p.code}</td>
                        <td style="text-align: center;">
                            ${p.image ? `<img src="${p.image}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;">` : '<i class="fas fa-box" style="color: var(--gray);"></i>'}
                        </td>
                        <td>${Utils.sanitizeHTML(p.name)}</td>
                        <td>${p.category}</td>
                        <td>${Utils.formatCurrency(p.costPrice || 0)}</td>
                        <td>${Utils.formatCurrency(p.price)}</td>
                        <td>${p.qty}</td>
                        <td><span class="badge badge-${status}">${statusText}</span></td>
                        <td class="action-buttons">
                            <button class="btn-icon btn-edit" onclick="Products.edit('${p.id}')" title="Editar"><i class="fas fa-edit"></i></button>
                            <button class="btn-icon btn-delete" onclick="Products.delete('${p.id}')" title="Excluir"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                });
            },

            uploadImage(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        document.getElementById('productImageImg').src = e.target.result;
                        document.getElementById('productImageImg').style.display = 'block';
                        document.getElementById('productImagePlaceholder').style.display = 'none';
                        document.getElementById('productImageInput').dataset.image = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            },

            removeImage() {
                document.getElementById('productImageImg').src = '';
                document.getElementById('productImageImg').style.display = 'none';
                document.getElementById('productImagePlaceholder').style.display = 'flex';
                document.getElementById('productImageInput').value = '';
                delete document.getElementById('productImageInput').dataset.image;
            },

            save() {
                if (!Utils.validateRequired('productForm')) {
                    Toast.show('Preencha todos os campos obrigatórios', 'warning');
                    return;
                }
                
                const product = {
                    id: state.editingId || 'PROD-' + (state.products.length + 1).toString().padStart(3, '0'),
                    code: document.getElementById('productCode').value,
                    category: document.getElementById('productCategory').value,
                    name: document.getElementById('productName').value,
                    costPrice: Utils.parseMoney(document.getElementById('productCostPrice').value) || 0,
                    price: Utils.parseMoney(document.getElementById('productPrice').value) || 0,
                    qty: parseInt(document.getElementById('productQty').value) || 0,
                    minQty: parseInt(document.getElementById('productMinQty').value) || 5,
                    image: document.getElementById('productImageInput').dataset.image || null,
                    updated_at: new Date().toISOString()
                };
                
                if (product.price <= 0) {
                    Toast.show('Preço de venda deve ser maior que zero', 'warning');
                    return;
                }
                
                if (state.editingId) {
                    const idx = state.products.findIndex(p => p.id === state.editingId);
                    if (idx !== -1) state.products[idx] = product;
                } else {
                    state.products.push(product);
                }
                
                App.saveData();
                SupaSync.upsertProduto(product);
                this.clearForm();
                this.renderTable();
                Sales.populateSaleSelects();
                Toast.show('Produto salvo com sucesso!');
            },

            edit(id) {
                const p = state.products.find(p => p.id === id);
                if (!p) return;
                
                state.editingId = id;
                document.getElementById('productCode').value = p.code;
                document.getElementById('productCategory').value = p.category;
                document.getElementById('productName').value = p.name;
                document.getElementById('productCostPrice').value = p.costPrice || '';
                document.getElementById('productPrice').value = p.price;
                document.getElementById('productQty').value = p.qty;
                document.getElementById('productMinQty').value = p.minQty;
                
                if (p.image) {
                    document.getElementById('productImageImg').src = p.image;
                    document.getElementById('productImageImg').style.display = 'block';
                    document.getElementById('productImagePlaceholder').style.display = 'none';
                    document.getElementById('productImageInput').dataset.image = p.image;
                } else {
                    this.removeImage();
                }
            },

            delete(id) {
                Modal.showConfirm('Excluir este produto?', () => {
                    state.products = state.products.filter(p => p.id !== id);
                    App.saveData();
                    SupaSync.deletarProduto(id);
                    this.renderTable();
                    Toast.show('Produto excluído com sucesso!');
                });
            },

            clearForm() {
                document.getElementById('productForm').reset();
                state.editingId = null;
                document.getElementById('productCode').value = 'PROD-' + (state.products.length + 1).toString().padStart(3, '0');
                this.removeImage();
            },

            search() {
                const term = document.getElementById('searchProduct').value.toLowerCase();
                document.querySelectorAll('#productsTable tbody tr').forEach(row => {
                    row.style.display = row.innerText.toLowerCase().includes(term) ? '' : 'none';
                });
            }
        };

        // ==================== SERVIÇOS ====================
        const Services = {
            renderTable() {
                const tbody = document.querySelector('#servicesTable tbody');
                if (!tbody) return;
                tbody.innerHTML = '';
                
                state.services.forEach(s => {
                    tbody.innerHTML += `<tr>
                        <td>${s.code}</td>
                        <td>${Utils.sanitizeHTML(s.name)}</td>
                        <td>${Utils.formatCurrency(s.value)}</td>
                        <td class="action-buttons">
                            <button class="btn-icon btn-edit" onclick="Services.edit('${s.id}')" title="Editar"><i class="fas fa-edit"></i></button>
                            <button class="btn-icon btn-delete" onclick="Services.delete('${s.id}')" title="Excluir"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                });
            },

            save() {
                if (!Utils.validateRequired('serviceForm')) {
                    Toast.show('Preencha todos os campos obrigatórios', 'warning');
                    return;
                }
                
                const service = {
                    id: state.editingId || 'SERV-' + (state.services.length + 1).toString().padStart(3, '0'),
                    code: document.getElementById('serviceCode').value,
                    name: document.getElementById('serviceName').value,
                    value: parseFloat(document.getElementById('serviceValue').value) || 0,
                    desc: document.getElementById('serviceDesc').value,
                    updated_at: new Date().toISOString()
                };
                
                if (service.value <= 0) {
                    Toast.show('Valor deve ser maior que zero', 'warning');
                    return;
                }
                
                if (state.editingId) {
                    const idx = state.services.findIndex(s => s.id === state.editingId);
                    if (idx !== -1) state.services[idx] = service;
                } else {
                    state.services.push(service);
                }
                
                App.saveData();
                SupaSync.upsertServico(service);
                this.clearForm();
                this.renderTable();
                Sales.populateSaleSelects();
                Toast.show('Serviço salvo com sucesso!');
            },

            edit(id) {
                const s = state.services.find(s => s.id === id);
                if (!s) return;
                
                state.editingId = id;
                document.getElementById('serviceCode').value = s.code;
                document.getElementById('serviceName').value = s.name;
                document.getElementById('serviceValue').value = s.value;
                document.getElementById('serviceDesc').value = s.desc || '';
            },

            delete(id) {
                Modal.showConfirm('Excluir este serviço?', () => {
                    state.services = state.services.filter(s => s.id !== id);
                    App.saveData();
                    SupaSync.deletarServico(id);
                    this.renderTable();
                    Toast.show('Serviço excluído com sucesso!');
                });
            },

            clearForm() {
                document.getElementById('serviceForm').reset();
                state.editingId = null;
                document.getElementById('serviceCode').value = 'SERV-' + (state.services.length + 1).toString().padStart(3, '0');
            }
        };

        // ==================== FORNECEDORES ====================
        const Suppliers = {
            renderTable() {
                const tbody = document.querySelector('#suppliersTable tbody');
                if (!tbody) return;
                tbody.innerHTML = '';
                
                state.suppliers.forEach(s => {
                    tbody.innerHTML += `<tr>
                        <td>${s.code}</td>
                        <td>${Utils.sanitizeHTML(s.name)}</td>
                        <td>${s.cnpj || ''}</td>
                        <td>${s.phone || ''}</td>
                        <td>${s.city || ''}${s.city && s.state ? '/' : ''}${s.state || ''}</td>
                        <td class="action-buttons">
                            <button class="btn-icon btn-edit" onclick="Suppliers.edit('${s.id}')" title="Editar"><i class="fas fa-edit"></i></button>
                            <button class="btn-icon btn-delete" onclick="Suppliers.delete('${s.id}')" title="Excluir"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                });
            },

            save() {
                if (!Utils.validateRequired('supplierForm')) {
                    Toast.show('Preencha todos os campos obrigatórios', 'warning');
                    return;
                }
                
                const supplier = {
                    id: state.editingId || 'SUP-' + (state.suppliers.length + 1).toString().padStart(3, '0'),
                    code: document.getElementById('supplierCode').value,
                    name: document.getElementById('supplierName').value,
                    cnpj: document.getElementById('supplierCnpj').value,
                    ie: document.getElementById('supplierIe').value,
                    phone: document.getElementById('supplierPhone').value,
                    email: document.getElementById('supplierEmail').value,
                    cep: document.getElementById('supplierCep').value,
                    address: document.getElementById('supplierAddress').value,
                    number: document.getElementById('supplierNumber').value,
                    complement: document.getElementById('supplierComplement').value,
                    neighborhood: document.getElementById('supplierNeighborhood').value,
                    city: document.getElementById('supplierCity').value,
                    state: document.getElementById('supplierState').value,
                    products: document.getElementById('supplierProducts').value,
                    updated_at: new Date().toISOString()
                };
                
                if (state.editingId) {
                    const idx = state.suppliers.findIndex(s => s.id === state.editingId);
                    if (idx !== -1) state.suppliers[idx] = supplier;
                } else {
                    state.suppliers.push(supplier);
                }
                
                App.saveData();
                SupaSync.upsertFornecedor(supplier);
                App.updateSupplierSelect();
                this.clearForm();
                this.renderTable();
                Toast.show('Fornecedor salvo com sucesso!');
            },

            edit(id) {
                const s = state.suppliers.find(s => s.id === id);
                if (!s) return;
                
                state.editingId = id;
                document.getElementById('supplierCode').value = s.code;
                document.getElementById('supplierName').value = s.name;
                document.getElementById('supplierCnpj').value = s.cnpj || '';
                document.getElementById('supplierIe').value = s.ie || '';
                document.getElementById('supplierPhone').value = s.phone || '';
                document.getElementById('supplierEmail').value = s.email || '';
                document.getElementById('supplierCep').value = s.cep || '';
                document.getElementById('supplierAddress').value = s.address || '';
                document.getElementById('supplierNumber').value = s.number || '';
                document.getElementById('supplierComplement').value = s.complement || '';
                document.getElementById('supplierNeighborhood').value = s.neighborhood || '';
                document.getElementById('supplierCity').value = s.city || '';
                document.getElementById('supplierState').value = s.state || '';
                document.getElementById('supplierProducts').value = s.products || '';
            },

            delete(id) {
                Modal.showConfirm('Excluir este fornecedor?', () => {
                    state.suppliers = state.suppliers.filter(s => s.id !== id);
                    App.saveData();
                    SupaSync.deletarFornecedor(id);
                    App.updateSupplierSelect();
                    this.renderTable();
                    Toast.show('Fornecedor excluído com sucesso!');
                });
            },

            clearForm() {
                document.getElementById('supplierForm').reset();
                state.editingId = null;
                document.getElementById('supplierCode').value = 'SUP-' + (state.suppliers.length + 1).toString().padStart(3, '0');
            }
        };

        // ==================== DESPESAS ====================
        const Expenses = {
            renderTable() {
                const tbody = document.querySelector('#expensesTable tbody');
                if (!tbody) return;
                tbody.innerHTML = '';
                
                state.expenses.forEach(e => {
                    // Buscar nome do fornecedor
                    let supplierName = '';
                    if (e.supplierId) {
                        const supplier = state.suppliers.find(s => s.id === e.supplierId);
                        supplierName = supplier ? supplier.name : '';
                    }

                    const statusClass = e.status === 'pago' ? 'success' : (e.status === 'pendente' ? 'warning' : 'danger');
                    tbody.innerHTML += `<tr>
                        <td>${Utils.formatDate(e.date)}</td>
                        <td>${Utils.sanitizeHTML(e.desc)}</td>
                        <td>${e.category}</td>
                        <td>${Utils.formatCurrency(e.value)}</td>
                        <td>${e.paymentMethod || '-'}</td>
                        <td><span class="badge badge-${statusClass}">${e.status}</span></td>
                        <td class="action-buttons">
                            <button class="btn-icon btn-edit" onclick="Expenses.edit('${e.id}')" title="Editar"><i class="fas fa-edit"></i></button>
                            <button class="btn-icon btn-delete" onclick="Expenses.delete('${e.id}')" title="Excluir"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                });
            },

            updateSummary() {
                const month = new Date().getMonth();
                const year = new Date().getFullYear();
                let total = 0, pending = 0, paid = 0;

                state.expenses.forEach(e => {
                    const d = new Date(e.date);
                    if (d.getMonth() === month && d.getFullYear() === year) {
                        total += e.value;
                        if (e.status === 'pago') paid += e.value;
                        else if (e.status === 'pendente') pending += e.value;
                        // vencido conta como pendente? por simplicidade, somamos em pending
                    }
                });

                document.getElementById('expensesTotalMonth').innerText = Utils.formatCurrency(total);
                document.getElementById('expensesPending').innerText = Utils.formatCurrency(pending);
                document.getElementById('expensesPaid').innerText = Utils.formatCurrency(paid);
            },

            save() {
                if (!Utils.validateRequired('expenseForm')) {
                    Toast.show('Preencha todos os campos obrigatórios', 'warning');
                    return;
                }
                
                const expense = {
                    id: state.editingId || 'EXP-' + Date.now(),
                    date: document.getElementById('expenseDate').value,
                    desc: document.getElementById('expenseDesc').value,
                    category: document.getElementById('expenseCategory').value,
                    supplierId: document.getElementById('expenseSupplier').value || null,
                    value: Utils.parseMoney(document.getElementById('expenseValue').value) || 0,
                    paymentMethod: document.getElementById('expensePaymentMethod').value,
                    status: document.getElementById('expenseStatus').value,
                    notes: document.getElementById('expenseNotes').value,
                    updated_at: new Date().toISOString()
                };
                
                if (expense.value <= 0) {
                    Toast.show('Valor deve ser maior que zero', 'warning');
                    return;
                }
                
                if (state.editingId) {
                    const idx = state.expenses.findIndex(e => e.id === state.editingId);
                    if (idx !== -1) state.expenses[idx] = expense;
                } else {
                    state.expenses.push(expense);
                }
                
                App.saveData();
                SupaSync.upsertDespesa(expense);
                this.clearForm();
                this.renderTable();
                this.updateSummary();
                Dashboard.update();
                Toast.show('Despesa salva com sucesso!');
            },

            edit(id) {
                const e = state.expenses.find(e => e.id === id);
                if (!e) return;
                
                state.editingId = id;
                document.getElementById('expenseDate').value = e.date;
                document.getElementById('expenseDesc').value = e.desc;
                document.getElementById('expenseCategory').value = e.category;
                document.getElementById('expenseSupplier').value = e.supplierId || '';
                document.getElementById('expenseValue').value = e.value;
                document.getElementById('expensePaymentMethod').value = e.paymentMethod || 'dinheiro';
                document.getElementById('expenseStatus').value = e.status || 'pago';
                document.getElementById('expenseNotes').value = e.notes || '';
            },

            delete(id) {
                Modal.showConfirm('Excluir esta despesa?', () => {
                    state.expenses = state.expenses.filter(e => e.id !== id);
                    App.saveData();
                    LocalFirst.deleteItem('expenses', id);
                    this.renderTable();
                    this.updateSummary();
                    Dashboard.update();
                    Toast.show('Despesa excluída com sucesso!');
                });
            },

            clearForm() {
                document.getElementById('expenseForm').reset();
                state.editingId = null;
                document.getElementById('expenseDate').value = new Date().toISOString().slice(0,10);
                document.getElementById('expensePaymentMethod').value = 'dinheiro';
                document.getElementById('expenseStatus').value = 'pago';
            }
        };

        // ==================== EDITOR MENSAGENS WHATSAPP ====================
        const WPP_DEFAULTS = {
            aniversario: "🎂 *Feliz Aniversário, {{NOME}}!* 🎉\n\nHoje, *{{DATA}}*, é um dia muito especial e nós da *{{EMPRESA}}* queremos celebrar junto com você! 🥳\n\nQue este novo ano seja repleto de muita saúde, alegria e visão nítida! 👁️✨\n\nTemos um presente especial esperando por você — venha nos visitar! 🎁\n\n━━━━━━━━━━━━━━━━━━━━\n*{{EMPRESA}}*\n📍 {{ENDERECO}}\n📞 {{TELEFONE}}",
            oculosVencido: "Olá *{{NOME}}*! 👋\n\nPassando para dar um recado importante! 😊\n\nVerificamos que faz aproximadamente *{{MESES}} meses* que você adquiriu seus óculos conosco (OS {{OS}} — {{DATA_VENDA}}).\n\n👓 Especialistas recomendam *revisão anual* da receita para garantir a saúde dos seus olhos e o conforto visual!\n\nQue tal agendar uma consulta de revisão? Temos condições especiais para clientes recorrentes! 🎁\n\n━━━━━━━━━━━━━━━━━━━━\n*{{EMPRESA}}*\n📍 {{ENDERECO}}\n📞 {{TELEFONE}}",
            statusPedido: "Olá *{{NOME}}*! 👋\n\nSegue a atualização do seu pedido:\n\n🏪 *{{EMPRESA}}*\n━━━━━━━━━━━━━━━━━━━━\n📋 *OS Nº:* {{OS}}\n📅 *Data da compra:* {{DATA_VENDA}}\n🚚 *Previsão de entrega:* {{PREVISAO}}\n\n🔄 *Status atual:*\n➡️ *{{STATUS}}*\n\n{{MSG_STATUS}}\n━━━━━━━━━━━━━━━━━━━━\nDúvidas? Fale conosco! 😊\n📞 {{TELEFONE}}",
            receituario: "👁️ *RECEITUÁRIO ÓPTICO*\n━━━━━━━━━━━━━━━━━━━━\n🏪 *{{EMPRESA}}*\n📍 {{ENDERECO}}\n📞 {{TELEFONE}}\n━━━━━━━━━━━━━━━━━━━━\n\n👤 *Paciente:* {{PACIENTE}}\n📅 *Data:* {{DATA}}\n\n*🔵 OLHO DIREITO (OD)*\n{{DADOS_OD}}\n\n*🔴 OLHO ESQUERDO (OE)*\n{{DADOS_OE}}\n\n{{DADOS_EXTRA}}\n━━━━━━━━━━━━━━━━━━━━\n_Documento gerado por {{EMPRESA}}_\n_Válido mediante assinatura do profissional._",
            comprovante: "✅ *COMPROVANTE DE PAGAMENTO*\n━━━━━━━━━━━━━━━━━━━━\n🏪 *{{EMPRESA}}*\n📍 {{ENDERECO}}\n━━━━━━━━━━━━━━━━━━━━\n\n👤 *Cliente:* {{NOME}}\n🆔 *CPF:* {{CPF}}\n\n📋 *OS Nº:* {{OS}}\n🔢 *Parcela:* {{PARCELA}}\n📅 *Vencimento:* {{VENCIMENTO}}\n📅 *Data Pagamento:* {{DATA_PAGAMENTO}}\n\n💵 *VALOR PAGO: {{VALOR}}*\n💳 *Forma:* {{FORMA_PAGAMENTO}}\n\n✅ *PAGAMENTO CONFIRMADO*\n\n━━━━━━━━━━━━━━━━━━━━\n📞 {{TELEFONE}}\n_Documento gerado por {{EMPRESA}}_"
        };

        const WPP_META = {
            aniversario: {
                title:  '🎂 Mensagem de Aniversário',
                sub:    'Dashboard → botão "Parabéns" nos aniversariantes do dia',
                vars:   ['{{NOME}}','{{DATA}}','{{EMPRESA}}','{{ENDERECO}}','{{TELEFONE}}'],
                exemplo:{ '{{NOME}}':'João', '{{DATA}}':'01/01/2025', '{{EMPRESA}}':'Ótica Exemplo', '{{ENDERECO}}':'Av. Paulista, 100 — São Paulo/SP', '{{TELEFONE}}':'(11) 9999-9999' }
            },
            oculosVencido: {
                title:  '👓 Óculos Vencido (+1 ano)',
                sub:    'Dashboard → botão "Renovar" nos óculos entregues há mais de 1 ano',
                vars:   ['{{NOME}}','{{MESES}}','{{OS}}','{{DATA_VENDA}}','{{EMPRESA}}','{{ENDERECO}}','{{TELEFONE}}'],
                exemplo:{ '{{NOME}}':'João', '{{MESES}}':'14', '{{OS}}':'2024/001', '{{DATA_VENDA}}':'10/01/2024', '{{EMPRESA}}':'Ótica Exemplo', '{{ENDERECO}}':'Av. Paulista, 100 — São Paulo/SP', '{{TELEFONE}}':'(11) 9999-9999' }
            },
            statusPedido: {
                title:  '🔄 Status do Pedido',
                sub:    'Histórico de Vendas → botão WhatsApp em cada OS',
                vars:   ['{{NOME}}','{{OS}}','{{STATUS}}','{{MSG_STATUS}}','{{DATA_VENDA}}','{{PREVISAO}}','{{EMPRESA}}','{{TELEFONE}}'],
                exemplo:{ '{{NOME}}':'João', '{{OS}}':'2025/042', '{{STATUS}}':'📦 PRONTO PARA RETIRADA!', '{{MSG_STATUS}}':'🎉 Seu pedido está pronto! Compareça à nossa loja para retirar.', '{{DATA_VENDA}}':'15/01/2025', '{{PREVISAO}}':'20/01/2025', '{{EMPRESA}}':'Ótica Exemplo', '{{TELEFONE}}':'(11) 9999-9999' }
            },
            receituario: {
                title:  '👁️ Receituário Óptico',
                sub:    'Seção Prescrição e lista de Clientes → botão WhatsApp',
                vars:   ['{{PACIENTE}}','{{DATA}}','{{DADOS_OD}}','{{DADOS_OE}}','{{DADOS_EXTRA}}','{{EMPRESA}}','{{ENDERECO}}','{{TELEFONE}}'],
                exemplo:{ '{{PACIENTE}}':'João Silva', '{{DATA}}':'10/01/2025', '{{DADOS_OD}}':'  ESF: -2.00 | CIL: -0.50 | EIXO: 180°', '{{DADOS_OE}}':'  ESF: -1.75 | CIL: -0.25 | EIXO: 175°', '{{DADOS_EXTRA}}':'📏 DP Total: 64 mm', '{{EMPRESA}}':'Ótica Exemplo', '{{ENDERECO}}':'Av. Paulista, 100 — São Paulo/SP', '{{TELEFONE}}':'(11) 9999-9999' }
            },
            comprovante: {
                title:  '✅ Comprovante de Pagamento',
                sub:    'Tabela de parcelas do crediário → botão WhatsApp',
                vars:   ['{{NOME}}','{{CPF}}','{{OS}}','{{PARCELA}}','{{VENCIMENTO}}','{{DATA_PAGAMENTO}}','{{VALOR}}','{{FORMA_PAGAMENTO}}','{{EMPRESA}}','{{ENDERECO}}','{{TELEFONE}}'],
                exemplo:{ '{{NOME}}':'João Silva', '{{CPF}}':'123.456.789-00', '{{OS}}':'2025/042', '{{PARCELA}}':'2 de 5', '{{VENCIMENTO}}':'10/02/2025', '{{DATA_PAGAMENTO}}':'10/02/2025', '{{VALOR}}':'R$ 250,00', '{{FORMA_PAGAMENTO}}':'Dinheiro', '{{EMPRESA}}':'Ótica Exemplo', '{{ENDERECO}}':'Av. Paulista, 100 — São Paulo/SP', '{{TELEFONE}}':'(11) 9999-9999' }
            }
        };

        const ConfigWpp = {
            _current: 'aniversario',
            _previewOpen: false,

            init() {
                this.selectMsg('aniversario');
            },

            selectMsg(key) {
                this._current = key;
                this._previewOpen = false;

                // Atualizar nav ativo
                document.querySelectorAll('.wpp-nav-item').forEach(el => el.classList.remove('active'));
                const navId = 'nav' + key.charAt(0).toUpperCase() + key.slice(1);
                document.getElementById(navId)?.classList.add('active');

                // Atualizar header
                const meta = WPP_META[key];
                document.getElementById('wppEditorTitle').textContent = meta.title;
                document.getElementById('wppEditorSub').textContent   = meta.sub;

                // Carregar texto salvo ou padrão
                const saved = state.wppMensagens?.[key] ?? WPP_DEFAULTS[key];
                const ta = document.getElementById('wppTextarea');
                ta.value = saved;

                // Gerar chips de variáveis
                const chips = document.getElementById('wppVarsChips');
                chips.innerHTML = meta.vars.map(v =>
                    `<span class="wpp-chip" onclick="ConfigWpp.inserirVar('${v}')" title="Inserir ${v}">${v}</span>`
                ).join('');

                // Fechar preview
                const pw = document.getElementById('wppPreviewWrap');
                if (pw) { pw.classList.remove('show'); }

                this.updateCount();
            },

            onInput() {
                this.updateCount();
                if (this._previewOpen) this.renderPreview();
            },

            updateCount() {
                const ta = document.getElementById('wppTextarea');
                const cnt = document.getElementById('wppCharCount');
                if (ta && cnt) cnt.textContent = ta.value.length + ' caracteres';
            },

            inserirVar(variavel) {
                const ta = document.getElementById('wppTextarea');
                if (!ta) return;
                const start = ta.selectionStart;
                const end   = ta.selectionEnd;
                const before = ta.value.substring(0, start);
                const after  = ta.value.substring(end);
                ta.value = before + variavel + after;
                ta.selectionStart = ta.selectionEnd = start + variavel.length;
                ta.focus();
                this.onInput();
                Toast.show('Variável inserida: ' + variavel, 'success', 1500);
            },

            togglePreview() {
                this._previewOpen = !this._previewOpen;
                const pw = document.getElementById('wppPreviewWrap');
                if (this._previewOpen) {
                    pw.classList.add('show');
                    this.renderPreview();
                } else {
                    pw.classList.remove('show');
                }
            },

            renderPreview() {
                const ta     = document.getElementById('wppTextarea');
                const bubble = document.getElementById('wppBubble');
                if (!ta || !bubble) return;
                const meta = WPP_META[this._current];
                let text = ta.value;
                // Substituir variáveis por exemplos
                Object.entries(meta.exemplo).forEach(([v, ex]) => {
                    text = text.split(v).join(ex);
                });
                // Renderizar *negrito* e _itálico_ básico para preview
                const safe = text
                    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
                    .replace(/\*([^*\n]+)\*/g, '<strong>$1</strong>')
                    .replace(/_([^_\n]+)_/g, '<em>$1</em>')
                    .replace(/\n/g, '<br>');
                bubble.innerHTML = safe;
            },

            salvarAtual() {
                const ta  = document.getElementById('wppTextarea');
                const key = this._current;
                if (!ta) return;
                if (!state.wppMensagens) state.wppMensagens = {};
                state.wppMensagens[key] = ta.value;
                App.saveData(true);
                Toast.show('✅ Mensagem "' + WPP_META[key].title + '" salva!', 'success');
            },

            salvarTodos() {
                if (!state.wppMensagens) state.wppMensagens = {};
                // Salva a mensagem atualmente aberta no editor antes de salvar tudo
                const ta  = document.getElementById('wppTextarea');
                if (ta) state.wppMensagens[this._current] = ta.value;
                App.saveData(true);
                Toast.show('✅ Todas as mensagens salvas!', 'success');
            },

            restaurarAtual() {
                const key = this._current;
                if (!confirm('Restaurar a mensagem "' + WPP_META[key].title + '" para o texto padrão?')) return;
                if (!state.wppMensagens) state.wppMensagens = {};
                state.wppMensagens[key] = WPP_DEFAULTS[key];
                document.getElementById('wppTextarea').value = WPP_DEFAULTS[key];
                App.saveData(true);
                this.onInput();
                Toast.show('↩️ Mensagem restaurada para o padrão.', 'info');
            },

            restaurarTodos() {
                if (!confirm('Restaurar TODAS as mensagens para o texto padrão? As suas personalizações serão perdidas.')) return;
                state.wppMensagens = { ...WPP_DEFAULTS };
                App.saveData(true);
                // Recarregar a mensagem atual no editor
                document.getElementById('wppTextarea').value = WPP_DEFAULTS[this._current];
                this.onInput();
                Toast.show('↩️ Todas as mensagens restauradas para o padrão.', 'info');
            },

            // Helper: retorna template atual (salvo ou padrão)
            get(key) {
                return state.wppMensagens?.[key] ?? WPP_DEFAULTS[key] ?? '';
            }
        };

        // ==================== CONFIGURAÇÕES ====================
        const Config = {
            showTab(tabName, event) {
                document.querySelectorAll('.config-tab').forEach(tab => {
                    tab.style.display = 'none';
                });
                
                document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).style.display = 'block';
                
                if (event) {
                    document.querySelectorAll('[onclick^="Config.showTab"]').forEach(btn => {
                        btn.classList.remove('btn-primary');
                        btn.classList.add('btn-secondary');
                    });
                    event.target.classList.remove('btn-secondary');
                    event.target.classList.add('btn-primary');
                }

                // Renderiza painel de backup ao abrir a aba
                if (tabName === 'backup') {
                    this.renderBackupStatus();
                    // Atualiza o widget de sync
                    setTimeout(() => { if(window.LocalFirst) LocalFirst._updatePanel(); }, 100);
                }

                // Mostra badge da loja ativa ao abrir aba empresa
                if (tabName === 'empresa' && state.company.lojaAtual) {
                    const loja = this._lojas[state.company.lojaAtual];
                    const badge = document.getElementById('lojaAtualBadge');
                    const txt   = document.getElementById('lojaAtualTxt');
                    if (badge && loja) { badge.style.display = 'block'; if(txt) txt.textContent = 'Loja ativa: ' + loja.label; }
                }
            },

            // ── LOJAS PRÉ-DEFINIDAS ─────────────────────────────────────────
            _lojas: {
                barueri: {
                    label: 'Loja Barueri',
                    name: 'ÓticaVision Pro — Barueri',
                    legalName: '',
                    cnpj: '',
                    ie: '',
                    phone: '',
                    whatsapp: '',
                    email: '',
                    website: '',
                    cep: '',
                    address: '',
                    number: '',
                    complement: '',
                    neighborhood: '',
                    city: 'Barueri',
                    state: 'SP'
                },
                caucaia: {
                    label: 'Loja Caucaia do Alto',
                    name: 'ÓticaVision Pro — Caucaia do Alto',
                    legalName: '',
                    cnpj: '',
                    ie: '',
                    phone: '',
                    whatsapp: '',
                    email: '',
                    website: '',
                    cep: '',
                    address: '',
                    number: '',
                    complement: '',
                    neighborhood: '',
                    city: 'Caucaia do Alto',
                    state: 'SP'
                }
            },

            preencherLoja(lojaId) {
                const loja = this._lojas[lojaId];
                if (!loja) return;

                // Preenche apenas campos que a loja tem definidos (não sobrescreve campos vazios com vazio)
                const campos = ['name','legalName','city','state'];
                campos.forEach(campo => {
                    const id = 'config' + campo.charAt(0).toUpperCase() + campo.slice(1);
                    const el = document.getElementById(id);
                    if (el && loja[campo]) el.value = loja[campo];
                });

                // Atualiza state
                state.company.lojaAtual = lojaId;
                App.saveData(true);

                // Mostra badge da loja ativa
                const badge = document.getElementById('lojaAtualBadge');
                const txt   = document.getElementById('lojaAtualTxt');
                if (badge) badge.style.display = 'block';
                if (txt)   txt.textContent = 'Loja ativa: ' + loja.label + ' — dados carregados. Ajuste CNPJ, endereço e dados específicos, depois salve.';

                Toast.show('Dados da ' + loja.label + ' selecionados! Complete os dados específicos e salve.', 'info', 5000);
            },

            limparLoja() {
                const campos = ['name','legalName','cnpj','ie','phone','whatsapp','email','website','cep','address','number','complement','neighborhood','city','state'];
                campos.forEach(campo => {
                    const id = 'config' + campo.charAt(0).toUpperCase() + campo.slice(1);
                    const el = document.getElementById(id);
                    if (el) el.value = '';
                });
                state.company.lojaAtual = '';
                const badge = document.getElementById('lojaAtualBadge');
                if (badge) badge.style.display = 'none';
                Toast.show('Campos limpos. Preencha manualmente.', 'info');
            },

            save() {
                state.company = {
                    ...state.company,
                    name: document.getElementById('configName').value,
                    legalName: document.getElementById('configLegalName').value,
                    cnpj: document.getElementById('configCnpj').value,
                    ie: document.getElementById('configIe').value,
                    phone: document.getElementById('configPhone').value,
                    whatsapp: document.getElementById('configWhatsapp').value,
                    email: document.getElementById('configEmail').value,
                    website: document.getElementById('configWebsite').value,
                    cep: document.getElementById('configCep').value,
                    address: document.getElementById('configAddress').value,
                    number: document.getElementById('configNumber').value,
                    complement: document.getElementById('configComplement').value,
                    neighborhood: document.getElementById('configNeighborhood').value,
                    city: document.getElementById('configCity').value,
                    state: document.getElementById('configState').value,
                    primaryColor: document.getElementById('configPrimaryColor').value,
                    secondaryColor: document.getElementById('configSecondaryColor').value
                };
                
                state.company.pix = state.company.cnpj;
                
                App.saveData();
                App.updateCompanyDisplay(); // Atualiza nome e logo
                document.documentElement.style.setProperty('--primary', state.company.primaryColor);
                document.documentElement.style.setProperty('--secondary', state.company.secondaryColor);
                
                Utils.updatePixKey();
                // Sincroniza configurações com Supabase
                SupaSync.upsertConfig().catch(() => {});
                Toast.show('Configurações salvas com sucesso!');
            },

            saveFinanceiro() {
                state.company = {
                    ...state.company,
                    creditTax: parseFloat(document.getElementById('configCreditTax').value) || 2.5,
                    warrantyDays: parseInt(document.getElementById('configWarranty').value) || 90,
                    commission: parseFloat(document.getElementById('configCommission').value) || 5,
                    deliveryFee: parseFloat(document.getElementById('configDeliveryFee').value) || 0,
                    nfSeries: document.getElementById('configNfSeries').value || '001',
                    paymentMethods: {
                        pix: document.getElementById('configPaymentPix').checked,
                        cash: document.getElementById('configPaymentCash').checked,
                        debit: document.getElementById('configPaymentDebit').checked,
                        credit: document.getElementById('configPaymentCredit').checked,
                        installment: document.getElementById('configPaymentInstallment').checked
                    }
                };
                
                const currentYear = new Date().getFullYear();
                const nextOs = parseInt(document.getElementById('configNextOs').value);
                if (nextOs && nextOs > 0) {
                    state.lastOsCounter = state.lastOsCounter || {};
                    state.lastOsCounter[currentYear] = nextOs - 1;
                }
                
                App.saveData();
                Utils.updatePixKey();
                SupaSync.upsertConfig().catch(() => {});
                Toast.show('Configurações financeiras salvas!');
            },

            // ── BACKUP CONFIG ──────────────────────────────────────────────
            saveBackupConfig() {
                const enabled  = document.getElementById('configBackupAutoEnabled').checked;
                const hour     = parseInt(document.getElementById('configBackupHour').value) || 3;
                const keepDays = parseInt(document.getElementById('configBackupKeepDays').value) || 7;

                const wasEnabled = state.backupConfig.autoEnabled;
                state.backupConfig.autoEnabled = enabled;
                state.backupConfig.hour        = hour;
                state.backupConfig.keepDays    = keepDays;
                SupaSync.upsertConfig().catch(() => {});

                App.saveData(true);

                // Reagendar se necessário
                if (enabled) {
                    BackupManager._agendarBackupDiario();
                } else {
                    clearTimeout(BackupManager._dailyTimer);
                    state.backupConfig.nextAutoBackup = null;
                }

                this.renderBackupStatus();

                const msg = enabled
                    ? `✅ Backup automático ativado — todo dia às ${String(hour).padStart(2,'0')}:00`
                    : '⏸️ Backup automático desativado';
                Toast.show(msg, enabled ? 'success' : 'info');
            },

            // Renderiza status + histórico do backup na aba
            renderBackupStatus: async function() {
                const cfg  = state.backupConfig;
                const card = document.getElementById('backupStatusCard');
                const icon = document.getElementById('backupStatusIcon');
                const title= document.getElementById('backupStatusTitle');
                const sub  = document.getElementById('backupStatusSub');
                const badge= document.getElementById('backupStatusBadge');

                // Toggle visual state
                const chk = document.getElementById('configBackupAutoEnabled');
                if (chk) chk.checked = cfg.autoEnabled;
                const sel = document.getElementById('configBackupHour');
                if (sel) sel.value = cfg.hour;
                const selK = document.getElementById('configBackupKeepDays');
                if (selK) selK.value = cfg.keepDays;

                // Toggle knob style
                const toggleBg   = document.getElementById('toggleBg');
                const toggleKnob = document.getElementById('toggleKnob');
                const toggleLbl  = document.getElementById('backupToggleLabel');
                if (toggleBg && toggleKnob) {
                    if (cfg.autoEnabled) {
                        toggleBg.style.background   = 'var(--primary)';
                        toggleKnob.style.left       = '27px';
                        if (toggleLbl) { toggleLbl.textContent = 'Ativado'; toggleLbl.style.color = 'var(--primary)'; }
                    } else {
                        toggleBg.style.background   = '#ccc';
                        toggleKnob.style.left       = '3px';
                        if (toggleLbl) { toggleLbl.textContent = 'Desativado'; toggleLbl.style.color = 'var(--gray)'; }
                    }
                }

                // Status card
                if (cfg.autoEnabled) {
                    if (card)  card.style.borderLeftColor = '#28a745';
                    if (icon)  icon.innerHTML = '✅'; icon.style.background = '#d4edda';
                    if (title) title.textContent = 'Backup automático ativo — todo dia às ' + String(cfg.hour).padStart(2,'0') + ':00';
                    if (sub)   sub.textContent = cfg.lastAutoBackup
                        ? 'Último: ' + new Date(cfg.lastAutoBackup).toLocaleString('pt-BR')
                        : 'Aguardando primeiro backup';
                    if (badge) { badge.textContent = 'ATIVO'; badge.style.background = '#d4edda'; badge.style.color = '#28a745'; }
                } else {
                    if (card)  card.style.borderLeftColor = '#6c757d';
                    if (icon)  { icon.innerHTML = '⏸️'; icon.style.background = '#e9ecef'; }
                    if (title) title.textContent = 'Backup automático desativado';
                    if (sub)   sub.textContent = 'Ative para proteger seus dados diariamente';
                    if (badge) { badge.textContent = 'INATIVO'; badge.style.background = '#e9ecef'; badge.style.color = '#6c757d'; }
                }

                // Info cards
                const elUltimo  = document.getElementById('backupInfoUltimo');
                const elProximo = document.getElementById('backupInfoProximo');
                const elCount   = document.getElementById('backupInfoContagem');

                if (elUltimo)  elUltimo.textContent  = cfg.lastAutoBackup
                    ? new Date(cfg.lastAutoBackup).toLocaleString('pt-BR', {day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'})
                    : 'Nunca';

                if (elProximo) {
                    if (cfg.autoEnabled && cfg.nextAutoBackup) {
                        elProximo.textContent = new Date(cfg.nextAutoBackup).toLocaleString('pt-BR', {day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'});
                    } else {
                        elProximo.textContent = cfg.autoEnabled ? '—' : 'Inativo';
                    }
                }

                // Histórico
                const historico = await BackupManager.getHistorico();
                if (elCount) elCount.textContent = historico.length;

                const listEl = document.getElementById('backupHistoricoList');
                if (listEl) {
                    if (historico.length === 0) {
                        listEl.innerHTML = '<p style="color:var(--gray); font-size:0.88rem; text-align:center; padding:1rem 0;">Nenhum backup registrado ainda</p>';
                    } else {
                        listEl.innerHTML = historico.map((b, i) => {
                            const dt = new Date(b.timestamp);
                            const dateStr = dt.toLocaleString('pt-BR', {day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});
                            const sizeKB  = (b.tamanho / 1024).toFixed(1);
                            const tipoIcon = b.tipo === 'diario' ? '🕐' : '💾';
                            const tipoLabel = b.tipo === 'diario' ? 'Automático' : 'Manual';
                            return `<div style="display:flex; align-items:center; justify-content:space-between; padding:0.6rem 0.75rem; background:${i%2===0?'white':'var(--light)'}; border-radius:6px; margin-bottom:4px; font-size:0.84rem;">
                                <div style="display:flex; align-items:center; gap:0.5rem;">
                                    <span>${tipoIcon}</span>
                                    <div>
                                        <div style="font-weight:600; color:var(--dark);">${dateStr}</div>
                                        <div style="color:var(--gray); font-size:0.76rem;">${tipoLabel} • ${sizeKB} KB</div>
                                    </div>
                                </div>
                                <span style="background:${b.tipo==='diario'?'#d4edda':'#cfe2ff'}; color:${b.tipo==='diario'?'#28a745':'#0d6efd'}; padding:2px 10px; border-radius:12px; font-size:0.75rem; font-weight:600;">${tipoLabel}</span>
                            </div>`;
                        }).join('');
                    }
                }
            },

            saveNotificacoes() {
                state.notificacoes = {
                    lowStock: document.getElementById('configNotifyLowStock').checked,
                    outOfStock: document.getElementById('configNotifyOutOfStock').checked,
                    osReady: document.getElementById('configNotifyOsReady').checked,
                    osDelay: document.getElementById('configNotifyOsDelay').checked,
                    osDelayDays: parseInt(document.getElementById('configOsDelayDays').value) || 7,
                    paymentDue: document.getElementById('configNotifyPaymentDue').checked,
                    paymentOverdue: document.getElementById('configNotifyPaymentOverdue').checked,
                    whatsapp: document.getElementById('configWhatsappNotify').checked,
                    whatsappNumber: document.getElementById('configWhatsappNumber').value
                };
                
                IDB.set('notificacoes', JSON.stringify(state.notificacoes)).catch(() => {});
                App.saveData(true);
                SupaSync.upsertConfig().catch(() => {});
                Toast.show('Configurações de notificações salvas!');
            },

            uploadLogo(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const prev = document.getElementById('configLogoPreview');
                        const ph   = document.getElementById('configLogoPlaceholder');
                        if (prev) { prev.src = e.target.result; prev.style.display = 'block'; }
                        if (ph)   ph.style.display = 'none';
                        state.company.logo = e.target.result;
                        App.saveData();
                        App.updateCompanyDisplay();
                        SupaSync.upsertConfig().catch(() => {});
                        Toast.show('Logo atualizada com sucesso!');
                    };
                    reader.readAsDataURL(file);
                }
            },

            removeLogo() {
                const prev = document.getElementById('configLogoPreview');
                const ph   = document.getElementById('configLogoPlaceholder');
                if (prev) { prev.src = ''; prev.style.display = 'none'; }
                if (ph)   ph.style.display = 'flex';
                delete state.company.logo;
                App.saveData();
                App.updateCompanyDisplay();
                Toast.show('Logo removida');
            },

            load() {
                document.getElementById('configName').value = state.company.name || '';
                document.getElementById('configLegalName').value = state.company.legalName || '';
                document.getElementById('configCnpj').value = state.company.cnpj || '';
                document.getElementById('configIe').value = state.company.ie || '';
                document.getElementById('configPhone').value = state.company.phone || '';
                document.getElementById('configWhatsapp').value = state.company.whatsapp || '';
                document.getElementById('configEmail').value = state.company.email || '';
                document.getElementById('configWebsite').value = state.company.website || '';
                document.getElementById('configCep').value = state.company.cep || '';
                document.getElementById('configAddress').value = state.company.address || '';
                document.getElementById('configNumber').value = state.company.number || '';
                document.getElementById('configComplement').value = state.company.complement || '';
                document.getElementById('configNeighborhood').value = state.company.neighborhood || '';
                document.getElementById('configCity').value = state.company.city || '';
                document.getElementById('configState').value = state.company.state || '';
                document.getElementById('configPrimaryColor').value = state.company.primaryColor || '#ff6b00';
                document.getElementById('configPrimaryColorText').value = state.company.primaryColor || '#ff6b00';
                document.getElementById('configSecondaryColor').value = state.company.secondaryColor || '#ffcc00';
                document.getElementById('configSecondaryColorText').value = state.company.secondaryColor || '#ffcc00';
                
                if (state.company.logo) {
                    const prev = document.getElementById('configLogoPreview');
                    const ph   = document.getElementById('configLogoPlaceholder');
                    if (prev) { prev.src = state.company.logo; prev.style.display = 'block'; }
                    if (ph)   ph.style.display = 'none';
                }
                
                document.getElementById('configCreditTax').value = state.company.creditTax || 2.5;
                document.getElementById('configWarranty').value = state.company.warrantyDays || 90;
                document.getElementById('configCommission').value = state.company.commission || 5;
                document.getElementById('configDeliveryFee').value = state.company.deliveryFee || 0;
                
                const currentYear = new Date().getFullYear();
                const nextOs = (state.lastOsCounter && state.lastOsCounter[currentYear]) ? state.lastOsCounter[currentYear] + 1 : 1;
                document.getElementById('configNextOs').value = nextOs;
                document.getElementById('configNfSeries').value = state.company.nfSeries || '001';
                
                if (state.company.paymentMethods) {
                    document.getElementById('configPaymentPix').checked = state.company.paymentMethods.pix !== false;
                    document.getElementById('configPaymentCash').checked = state.company.paymentMethods.cash !== false;
                    document.getElementById('configPaymentDebit').checked = state.company.paymentMethods.debit !== false;
                    document.getElementById('configPaymentCredit').checked = state.company.paymentMethods.credit !== false;
                    document.getElementById('configPaymentInstallment').checked = state.company.paymentMethods.installment !== false;
                }
                
                document.getElementById('configNotifyLowStock').checked = state.notificacoes.lowStock !== false;
                document.getElementById('configNotifyOutOfStock').checked = state.notificacoes.outOfStock !== false;
                document.getElementById('configNotifyOsReady').checked = state.notificacoes.osReady !== false;
                document.getElementById('configNotifyOsDelay').checked = state.notificacoes.osDelay !== false;
                document.getElementById('configOsDelayDays').value = state.notificacoes.osDelayDays || 7;
                document.getElementById('configNotifyPaymentDue').checked = state.notificacoes.paymentDue !== false;
                document.getElementById('configNotifyPaymentOverdue').checked = state.notificacoes.paymentOverdue !== false;
                document.getElementById('configWhatsappNotify').checked = state.notificacoes.whatsapp || false;
                document.getElementById('configWhatsappNumber').value = state.notificacoes.whatsappNumber || '';
                
                Utils.updatePixKey();

                // Exibir badge da loja ativa se configurado
                if (state.company.lojaAtual && this._lojas[state.company.lojaAtual]) {
                    const loja = this._lojas[state.company.lojaAtual];
                    const badge = document.getElementById('lojaAtualBadge');
                    const txt   = document.getElementById('lojaAtualTxt');
                    if (badge) badge.style.display = 'block';
                    if (txt)   txt.textContent = 'Loja ativa: ' + loja.label;
                }
            }
        };

        // ==================== RELATÓRIOS ====================
        const Reports = {
            _getDateRange() {
                const period = document.getElementById('reportPeriod').value;
                const today = new Date();
                today.setHours(23,59,59,999);
                let from = new Date(0);

                if (period === 'custom') {
                    const f = document.getElementById('reportDateFrom').value;
                    const t = document.getElementById('reportDateTo').value;
                    if (f) { from = new Date(f + 'T00:00:00'); }
                    if (t) { today.setFullYear(0); const td = new Date(t + 'T23:59:59'); today.setTime(td.getTime()); }
                } else if (period === 'today') {
                    from = new Date(); from.setHours(0,0,0,0);
                } else if (period === 'week') {
                    from = new Date(); from.setDate(from.getDate() - 7); from.setHours(0,0,0,0);
                } else if (period === 'month') {
                    from = new Date(today.getFullYear(), today.getMonth(), 1);
                } else if (period === 'last_month') {
                    from = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    today.setTime(new Date(today.getFullYear(), today.getMonth(), 0, 23, 59, 59, 999).getTime());
                } else if (period === 'quarter') {
                    from = new Date(); from.setMonth(from.getMonth() - 3); from.setHours(0,0,0,0);
                } else if (period === 'year') {
                    from = new Date(today.getFullYear(), 0, 1);
                } else if (period === 'all') {
                    from = new Date(0);
                }
                return { from, to: today };
            },

            _filterByDate(arr, dateField = 'date') {
                const { from, to } = this._getDateRange();
                return arr.filter(item => {
                    const d = item[dateField] ? new Date(item[dateField] + 'T12:00:00') : null;
                    return d && d >= from && d <= to;
                });
            },

            _th(...cols) { return '<tr>' + cols.map(c => `<th style="background:var(--primary);color:white;padding:9px 12px;text-align:left;white-space:nowrap;">${c}</th>`).join('') + '</tr>'; },
            _tr(...cols) { return '<tr>' + cols.map((c,i) => `<td style="padding:8px 12px;border-bottom:1px solid #f0f0f0;${i===0?'':''};">${c ?? '—'}</td>`).join('') + '</tr>'; },
            _table(headers, rows, summary='') {
                return `<table style="width:100%;border-collapse:collapse;font-size:0.9rem;margin-top:1rem;">
                    <thead>${this._th(...headers)}</thead>
                    <tbody>${rows.join('')}</tbody>
                    ${summary ? `<tfoot><tr><td colspan="${headers.length}" style="padding:10px 12px;font-weight:700;background:#f8f9fa;border-top:2px solid var(--primary);">${summary}</td></tr></tfoot>` : ''}
                </table>`;
            },
            _fmt: v => new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v||0),
            _fmtDate: d => d ? new Date(d+'T12:00:00').toLocaleDateString('pt-BR') : '—',

            generate() {
                const type = document.getElementById('reportType').value;
                const period = document.getElementById('reportPeriod').value;
                document.getElementById('reportCustomDates').style.display = period === 'custom' ? 'flex' : 'none';
                
                const ST_LABELS = {'orcamento':'Orçamento','pendente':'Pendente','producao':'Em Produção','production':'Em Produção','laboratorio':'Laboratório','tratamento':'Tratamento','atrasado':'Atrasado','pronto':'Pronto p/ Retirada','ready':'Pronto','entregue':'Entregue','delivered':'Entregue','cancelado':'Cancelado'};
                let html = '';
                const { from, to } = this._getDateRange();
                const periodLabel = document.getElementById('reportPeriod').selectedOptions[0]?.text || '';

                const salesAll = this._filterByDate(state.sales, 'date');

                // ── VENDAS ─────────────────────────────────────────────
                if (type === 'sales') {
                    const total = salesAll.reduce((a, s) => a + (s.total||0), 0);
                    const rows = salesAll.map(s => {
                        const client = state.clients.find(c => c.id === s.clientId)?.name || s.clientName || '—';
                        return this._tr(s.number||'—', Utils.sanitizeHTML(client), this._fmtDate(s.date), this._fmtDate(s.deliveryForecast), ST_LABELS[s.status]||s.status||'—', s.seller||'—', s.paymentMethod||'—', this._fmt(s.total));
                    });
                    html = `<h3>📋 Vendas — ${periodLabel}</h3>`;
                    html += this._table(['Nº O.S.','Cliente','Abertura','Prev. Entrega','Status','Vendedor','Pagamento','Total'], rows, `Total: ${this._fmt(total)} | ${salesAll.length} vendas`);

                } else if (type === 'sales_by_status') {
                    const grupos = {};
                    salesAll.forEach(s => {
                        const k = ST_LABELS[s.status]||s.status||'Sem status';
                        if (!grupos[k]) grupos[k] = { count: 0, total: 0 };
                        grupos[k].count++;
                        grupos[k].total += s.total||0;
                    });
                    const rows = Object.entries(grupos).map(([status, d]) => this._tr(status, d.count, this._fmt(d.total)));
                    html = `<h3>📊 Vendas por Status — ${periodLabel}</h3>`;
                    html += this._table(['Status','Qtd. OS','Total'], rows);

                } else if (type === 'sales_by_client') {
                    const grupos = {};
                    salesAll.forEach(s => {
                        const client = state.clients.find(c => c.id === s.clientId)?.name || s.clientName || 'Não identificado';
                        if (!grupos[client]) grupos[client] = { count: 0, total: 0 };
                        grupos[client].count++;
                        grupos[client].total += s.total||0;
                    });
                    const sorted = Object.entries(grupos).sort((a,b) => b[1].total - a[1].total);
                    const rows = sorted.map(([client, d]) => this._tr(Utils.sanitizeHTML(client), d.count, this._fmt(d.total)));
                    html = `<h3>👥 Vendas por Cliente — ${periodLabel}</h3>`;
                    html += this._table(['Cliente','Qtd. OS','Total Gasto'], rows);

                } else if (type === 'sales_by_seller') {
                    const grupos = {};
                    salesAll.forEach(s => {
                        const k = s.seller || 'Não informado';
                        if (!grupos[k]) grupos[k] = { count: 0, total: 0 };
                        grupos[k].count++;
                        grupos[k].total += s.total||0;
                    });
                    const rows = Object.entries(grupos).sort((a,b) => b[1].total - a[1].total).map(([seller, d]) => this._tr(Utils.sanitizeHTML(seller), d.count, this._fmt(d.total)));
                    html = `<h3>🧑‍💼 Vendas por Vendedor — ${periodLabel}</h3>`;
                    html += this._table(['Vendedor','Qtd. OS','Total'], rows);

                } else if (type === 'sales_crediario') {
                    const rows = [];
                    state.sales.forEach(s => {
                        if (!s.paymentDetails || !s.paymentDetails.parcels) return;
                        const parcelasAbertas = s.paymentDetails.parcels.filter(p => p.status !== 'pago' && p.status !== 'paid');
                        if (!parcelasAbertas.length) return;
                        const client = state.clients.find(c => c.id === s.clientId)?.name || s.clientName || '—';
                        parcelasAbertas.forEach(p => {
                            const venc = p.dueDate ? new Date(p.dueDate + 'T12:00:00') : null;
                            const atrasado = venc && venc < new Date();
                            rows.push(this._tr(s.number||'—', Utils.sanitizeHTML(client), `${p.number}/${s.paymentDetails.installments}`, this._fmtDate(p.dueDate), this._fmt(p.value), atrasado ? '🔴 Vencida' : '⏳ A vencer'));
                        });
                    });
                    const totalAberto = rows.length; // approximate
                    html = `<h3>💳 Crediário em Aberto</h3>`;
                    html += this._table(['Nº O.S.','Cliente','Parcela','Vencimento','Valor','Status'], rows);

                } else if (type === 'overdue') {
                    const oneYearAgo = new Date(); oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
                    const rows = state.sales
                        .filter(s => new Date((s.date||'')+'T12:00:00') < oneYearAgo && (s.status === 'delivered' || s.status === 'entregue'))
                        .map(s => {
                            const client = state.clients.find(c => c.id === s.clientId)?.name || '—';
                            return this._tr(s.number||'—', Utils.sanitizeHTML(client), this._fmtDate(s.date), ST_LABELS[s.status]||s.status, this._fmt(s.total));
                        });
                    html = `<h3>📅 O.S. Vencidas há mais de 1 ano</h3>`;
                    html += this._table(['Nº O.S.','Cliente','Data','Status','Total'], rows);

                // ── FINANCEIRO ─────────────────────────────────────────
                } else if (type === 'financial_summary') {
                    const expenses = this._filterByDate(state.expenses, 'date');
                    const totalVendas = salesAll.reduce((a,s) => a+(s.total||0), 0);
                    const totalDespesas = expenses.reduce((a,e) => a+(e.amount||e.value||0), 0);
                    const lucro = totalVendas - totalDespesas;
                    const ticketMedio = salesAll.length ? totalVendas/salesAll.length : 0;
                    html = `<h3>💰 Resumo Financeiro — ${periodLabel}</h3>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem;margin:1rem 0;">
                        ${[['Faturamento Total','#28a745',this._fmt(totalVendas)],['Total de Despesas','#dc3545',this._fmt(totalDespesas)],['Lucro Estimado',lucro>=0?'#28a745':'#dc3545',this._fmt(lucro)],['Nº de Vendas','#17a2b8',salesAll.length],['Ticket Médio','#ff6b00',this._fmt(ticketMedio)]].map(([label,cor,val]) =>
                            `<div style="background:white;padding:1.25rem;border-radius:10px;border-left:5px solid ${cor};box-shadow:0 2px 8px rgba(0,0,0,0.08);">
                                <div style="font-size:0.8rem;color:#888;text-transform:uppercase;">${label}</div>
                                <div style="font-size:1.5rem;font-weight:800;color:${cor};margin-top:4px;">${val}</div>
                            </div>`
                        ).join('')}
                    </div>`;

                } else if (type === 'expenses') {
                    const expenses = this._filterByDate(state.expenses, 'date');
                    const total = expenses.reduce((a,e) => a+(e.amount||e.value||0), 0);
                    const rows = expenses.map(e => {
                        const sup = e.supplierId ? (state.suppliers.find(s => s.id === e.supplierId)?.name || '—') : '—';
                        return this._tr(this._fmtDate(e.date), Utils.sanitizeHTML(e.desc||e.description||''), Utils.sanitizeHTML(e.category||''), Utils.sanitizeHTML(sup), this._fmt(e.amount||e.value||0));
                    });
                    html = `<h3>💸 Despesas — ${periodLabel}</h3>`;
                    html += this._table(['Data','Descrição','Categoria','Fornecedor','Valor'], rows, `Total: ${this._fmt(total)} | ${expenses.length} lançamentos`);

                } else if (type === 'expenses_by_category') {
                    const expenses = this._filterByDate(state.expenses, 'date');
                    const grupos = {};
                    expenses.forEach(e => {
                        const k = e.category || 'Sem categoria';
                        if (!grupos[k]) grupos[k] = { count: 0, total: 0 };
                        grupos[k].count++;
                        grupos[k].total += (e.amount||e.value||0);
                    });
                    const totalGeral = Object.values(grupos).reduce((a,d) => a+d.total, 0);
                    const rows = Object.entries(grupos).sort((a,b)=>b[1].total-a[1].total).map(([cat,d]) =>
                        this._tr(Utils.sanitizeHTML(cat), d.count, this._fmt(d.total), totalGeral ? (d.total/totalGeral*100).toFixed(1)+'%' : '0%')
                    );
                    html = `<h3>📊 Despesas por Categoria — ${periodLabel}</h3>`;
                    html += this._table(['Categoria','Qtd.','Total','% do Total'], rows, `Total Geral: ${this._fmt(totalGeral)}`);

                } else if (type === 'profit') {
                    const expenses = this._filterByDate(state.expenses, 'date');
                    const totalV = salesAll.reduce((a,s)=>a+(s.total||0),0);
                    const totalD = expenses.reduce((a,e)=>a+(e.amount||e.value||0),0);
                    const lucro = totalV - totalD;
                    const rows = [
                        this._tr('💰 Faturamento Total', salesAll.length + ' vendas', `<strong style="color:#28a745">${this._fmt(totalV)}</strong>`),
                        this._tr('💸 Despesas Totais', expenses.length + ' lançamentos', `<strong style="color:#dc3545">${this._fmt(totalD)}</strong>`),
                        this._tr(`${lucro>=0?'✅':'⚠️'} Resultado`, '', `<strong style="color:${lucro>=0?'#28a745':'#dc3545'};font-size:1.1rem;">${this._fmt(lucro)}</strong>`)
                    ];
                    html = `<h3>📈 Faturamento vs Despesas — ${periodLabel}</h3>`;
                    html += this._table(['Item','Detalhes','Valor'], rows);

                // ── ESTOQUE ────────────────────────────────────────────
                } else if (type === 'stock') {
                    const rows = state.products.map(p => {
                        const qty = p.qty ?? p.stock ?? 0;
                        const min = p.minQty ?? 0;
                        const status = qty === 0 ? '🔴 Esgotado' : qty <= min ? '🟡 Baixo' : '🟢 OK';
                        return this._tr(p.code||p.id, Utils.sanitizeHTML(p.name), Utils.sanitizeHTML(p.category||''), qty, min, this._fmt(p.price||0), status);
                    });
                    html = `<h3>📦 Estoque Atual</h3>`;
                    html += this._table(['Código','Produto','Categoria','Qtd.','Mín.','Preço','Status'], rows);

                } else if (type === 'stock_low') {
                    const prods = state.products.filter(p => {
                        const qty = p.qty ?? p.stock ?? 0;
                        return qty <= (p.minQty ?? 0);
                    });
                    const rows = prods.map(p => {
                        const qty = p.qty ?? p.stock ?? 0;
                        return this._tr(Utils.sanitizeHTML(p.name), p.category||'', qty, p.minQty||0, qty===0?'🔴 Esgotado':'🟡 Baixo');
                    });
                    html = `<h3>⚠️ Estoque Baixo / Esgotado (${prods.length} produtos)</h3>`;
                    html += this._table(['Produto','Categoria','Qtd. Atual','Qtd. Mínima','Status'], rows);

                } else if (type === 'products_sold') {
                    const contagem = {};
                    salesAll.forEach(s => (s.items||[]).forEach(item => {
                        const k = item.name||'Sem nome';
                        if (!contagem[k]) contagem[k] = { qty: 0, total: 0 };
                        contagem[k].qty += (item.qty||1);
                        contagem[k].total += (item.subtotal||0);
                    }));
                    const rows = Object.entries(contagem).sort((a,b)=>b[1].qty-a[1].qty).map(([name,d]) =>
                        this._tr(Utils.sanitizeHTML(name), d.qty, this._fmt(d.total))
                    );
                    html = `<h3>🏆 Produtos Mais Vendidos — ${periodLabel}</h3>`;
                    html += this._table(['Produto','Qtd. Vendida','Total Faturado'], rows);

                // ── CLIENTES ───────────────────────────────────────────
                } else if (type === 'clients') {
                    const rows = state.clients.map(c => this._tr(
                        c.code||c.id, Utils.sanitizeHTML(c.name), c.phone||'—', c.cpf||'—',
                        c.birthDate ? this._fmtDate(c.birthDate) : '—',
                        [c.city,c.state].filter(Boolean).join('/')
                    ));
                    html = `<h3>👥 Clientes Cadastrados (${state.clients.length})</h3>`;
                    html += this._table(['Código','Nome','Telefone','CPF','Nascimento','Cidade/UF'], rows);

                } else if (type === 'birthdays') {
                    const m = new Date().getMonth() + 1;
                    const anivs = state.clients.filter(c => {
                        if (!c.birthDate) return false;
                        return new Date(c.birthDate+'T12:00:00').getMonth()+1 === m;
                    }).sort((a,b) => {
                        const da = new Date(a.birthDate+'T12:00:00').getDate();
                        const db = new Date(b.birthDate+'T12:00:00').getDate();
                        return da - db;
                    });
                    const rows = anivs.map(c => this._tr(
                        new Date(c.birthDate+'T12:00:00').getDate() + '/' + (new Date().getMonth()+1).toString().padStart(2,'0'),
                        Utils.sanitizeHTML(c.name), c.phone||'—', c.email||'—'
                    ));
                    html = `<h3>🎂 Aniversariantes — ${new Date().toLocaleDateString('pt-BR',{month:'long'})} (${anivs.length})</h3>`;
                    html += this._table(['Dia','Nome','Telefone','E-mail'], rows);

                } else if (type === 'clients_no_purchase') {
                    const diasSemCompra = 180; // 6 meses
                    const limite = new Date(); limite.setDate(limite.getDate() - diasSemCompra);
                    const rows = state.clients.map(c => {
                        const vendas = state.sales.filter(s => s.clientId === c.id);
                        if (!vendas.length) return { c, ultima: null, dias: Infinity };
                        const ultima = vendas.reduce((a,b) => new Date(a.date+'T12:00:00') > new Date(b.date+'T12:00:00') ? a : b);
                        return { c, ultima: ultima.date, dias: Math.floor((new Date()-new Date(ultima.date+'T12:00:00'))/(86400000)) };
                    }).filter(r => !r.ultima || new Date(r.ultima+'T12:00:00') < limite)
                      .sort((a,b) => b.dias - a.dias)
                      .map(r => this._tr(Utils.sanitizeHTML(r.c.name), r.c.phone||'—', r.ultima ? this._fmtDate(r.ultima) : 'Nunca comprou', r.ultima ? r.dias+' dias' : '—'));
                    html = `<h3>💤 Clientes sem Compra nos últimos ${diasSemCompra} dias (${rows.length})</h3>`;
                    html += this._table(['Cliente','Telefone','Última Compra','Sem compra há'], rows);

                // ── OUTROS ─────────────────────────────────────────────
                } else if (type === 'services') {
                    const rows = state.services.map(s => this._tr(s.code||s.id, Utils.sanitizeHTML(s.name), this._fmt(s.value), Utils.sanitizeHTML(s.desc||'')));
                    html = `<h3>🔧 Serviços Cadastrados (${state.services.length})</h3>`;
                    html += this._table(['Código','Nome','Valor','Descrição'], rows);

                } else if (type === 'suppliers') {
                    const rows = state.suppliers.map(s => this._tr(s.code||s.id, Utils.sanitizeHTML(s.name), s.cnpj||'—', s.phone||'—', s.email||'—', [s.city,s.state].filter(Boolean).join('/')));
                    html = `<h3>🏭 Fornecedores Cadastrados (${state.suppliers.length})</h3>`;
                    html += this._table(['Código','Nome','CNPJ','Telefone','E-mail','Cidade/UF'], rows);
                }

                document.getElementById('reportContainer').innerHTML = html || '<p style="padding:2rem;text-align:center;color:#888;">Nenhum dado encontrado para o período selecionado.</p>';

                // Guarda dados para export CSV
                this._lastHtml = html;
                this._lastRows = document.querySelectorAll('#reportContainer table tbody tr');
            },

            print() {
                // Impressão de relatório em janela dedicada — máxima qualidade
                const container = document.getElementById('reportContainer');
                if (!container || !container.innerHTML.trim()) {
                    Toast.show('Gere um relatório antes de imprimir', 'warning');
                    return;
                }
                const company = state.company;
                const titulo  = document.getElementById('reportType')?.options[document.getElementById('reportType')?.selectedIndex]?.text || 'Relatório';
                const data    = new Date().toLocaleDateString('pt-BR', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' });

                const win = window.open('', '_blank', 'width=900,height=700');
                win.document.write(`<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>${titulo} — ${company.name}</title>
<style>
  @page { size: A4 portrait; margin: 15mm 12mm 12mm 12mm; }
  * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; box-sizing: border-box; }
  body { font-family: Arial, Helvetica, sans-serif; font-size: 10pt; color: #000; background: #fff; margin: 0; padding: 0; }
  .print-header { border-bottom: 2px solid #ff6b00; padding-bottom: 4mm; margin-bottom: 5mm; display: flex; justify-content: space-between; align-items: flex-start; }
  .print-header .empresa { font-size: 14pt; font-weight: bold; color: #ff6b00; }
  .print-header .sub { font-size: 8pt; color: #555; margin-top: 1mm; }
  .print-header .meta { text-align: right; font-size: 8pt; color: #555; }
  .print-title { font-size: 13pt; font-weight: bold; margin: 0 0 4mm 0; color: #333; }
  table { width: 100%; border-collapse: collapse; margin-top: 3mm; font-size: 9pt; }
  th { background: #ff6b00 !important; color: #fff !important; padding: 2mm 2.5mm; text-align: left; font-weight: bold; font-size: 8.5pt; }
  td { padding: 1.8mm 2.5mm; border-bottom: 0.5pt solid #ddd; vertical-align: top; }
  tr:nth-child(even) td { background: #fafafa !important; }
  tr:last-child td { border-bottom: 1pt solid #ccc; }
  h3 { font-size: 11pt; color: #333; margin: 5mm 0 2mm 0; border-left: 3px solid #ff6b00; padding-left: 2mm; }
  .print-footer { margin-top: 6mm; padding-top: 2mm; border-top: 0.5pt solid #ccc; font-size: 7.5pt; color: #777; text-align: center; }
  .no-print { display: none !important; }
  @media print {
    .no-print { display: none !important; }
    body { font-size: 9.5pt; }
  }
</style>
</head>
<body>
<div class="print-header">
  <div>
    <div class="empresa">${company.name || 'ÓticaVision Pro'}</div>
    <div class="sub">${[company.address, company.city, company.state].filter(Boolean).join(', ') || ''}</div>
    <div class="sub">${company.phone ? 'Tel: ' + company.phone : ''} ${company.cnpj ? '| CNPJ: ' + company.cnpj : ''}</div>
  </div>
  <div class="meta">
    <div style="font-size:10pt;font-weight:bold;">${titulo}</div>
    <div>Emitido em: ${data}</div>
  </div>
</div>
<div class="print-title">${titulo}</div>
${container.innerHTML}
<div class="print-footer">ÓticaVision Pro — Sistema de Gestão — ${data}</div>
<script>window.onload = function(){ window.print(); window.onafterprint = function(){ window.close(); }; }<\/script>
</body></html>`);
                win.document.close();
            },

            exportCSV() {
                const table = document.querySelector('#reportContainer table');
                if (!table) { Toast.show('Gere um relatório primeiro', 'warning'); return; }
                const rows = [];
                table.querySelectorAll('tr').forEach(tr => {
                    const cols = [];
                    tr.querySelectorAll('th,td').forEach(td => cols.push('"' + td.innerText.replace(/"/g, '""') + '"'));
                    rows.push(cols.join(';'));
                });
                const blob = new Blob(['\uFEFF' + rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'relatorio_oticavision_' + new Date().toISOString().slice(0,10) + '.csv';
                a.click();
                Toast.show('CSV exportado com sucesso!', 'success');
            }
        };

        // ==================== USUÁRIOS ====================
        const Usuarios = {
            showAddModal() {
                document.getElementById('userModalTitle').innerText = 'Novo Usuário';
                document.getElementById('userForm').reset();
                document.getElementById('userPassword').required = true;
                document.getElementById('userConfirmPassword').required = true;
                document.getElementById('userModal').classList.add('active');
            },

            save() {
                const fullName = document.getElementById('userFullName').value;
                const username = document.getElementById('userName').value;
                const password = document.getElementById('userPassword').value;
                const confirmPassword = document.getElementById('userConfirmPassword').value;
                
                if (!fullName || !username || !password) {
                    Toast.show('Preencha todos os campos obrigatórios', 'warning');
                    return;
                }
                
                if (password !== confirmPassword) {
                    Toast.show('As senhas não conferem', 'warning');
                    return;
                }
                
                if (password.length < 6) {
                    Toast.show('A senha deve ter no mínimo 6 caracteres', 'warning');
                    return;
                }
                
                if (state.users.some(u => u.username === username)) {
                    Toast.show('Nome de usuário já existe', 'warning');
                    return;
                }
                
                state.users.push({
                    username: username,
                    fullName: fullName,
                    profile: document.getElementById('userProfile').value,
                    status: document.getElementById('userStatus').value,
                    lastAccess: 'Nunca'
                });
                
                App.saveData();
                this.renderTable();
                Modal.close('userModal');
                Toast.show('Usuário salvo com sucesso!');
            },

            edit(username) {
                const user = state.users.find(u => u.username === username);
                if (!user) return;
                
                document.getElementById('userModalTitle').innerText = 'Editar Usuário';
                document.getElementById('userFullName').value = user.fullName;
                document.getElementById('userName').value = user.username;
                document.getElementById('userProfile').value = user.profile;
                document.getElementById('userStatus').value = user.status;
                
                document.getElementById('userPassword').required = false;
                document.getElementById('userConfirmPassword').required = false;
                
                document.getElementById('userModal').classList.add('active');
            },

            delete(username) {
                if (username === 'admin') {
                    Toast.show('Não é possível excluir o administrador padrão', 'warning');
                    return;
                }
                
                Modal.showConfirm(`Excluir usuário ${username}?`, () => {
                    state.users = state.users.filter(u => u.username !== username);
                    App.saveData();
                    this.renderTable();
                    Toast.show('Usuário excluído com sucesso!');
                });
            },

            renderTable() {
                const tbody = document.getElementById('usersTableBody');
                if (!tbody) return;
                tbody.innerHTML = '';
                
                state.users.forEach(user => {
                    tbody.innerHTML += `<tr>
                        <td>${user.username}</td>
                        <td>${Utils.sanitizeHTML(user.fullName)}</td>
                        <td><span class="badge badge-${user.profile}">${user.profile}</span></td>
                        <td>${user.lastAccess || 'Nunca'}</td>
                        <td><span class="badge badge-${user.status === 'active' ? 'success' : 'danger'}">${user.status}</span></td>
                        <td class="action-buttons">
                            <button class="btn-icon btn-edit" onclick="Usuarios.edit('${user.username}')" title="Editar"><i class="fas fa-edit"></i></button>
                            <button class="btn-icon btn-delete" onclick="Usuarios.delete('${user.username}')" title="Excluir"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                });
            }
        };

        // ==================== MODAIS ====================
        const Modal = {
            show(modalId, content) {
                if (content) {
                    const viewBody = document.getElementById('viewBody');
                    if (viewBody) viewBody.innerHTML = content;
                }
                const modal = document.getElementById(modalId);
                if (modal) modal.classList.add('active');
            },

            close(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) modal.classList.remove('active');
            },

            showConfirm(message, onConfirm) {
                const msgEl = document.getElementById('confirmMessage');
                const actEl = document.getElementById('confirmAction');
                if (msgEl) msgEl.innerText = message;
                if (actEl) actEl.onclick = () => {
                    onConfirm();
                    this.close('confirmModal');
                };
                this.show('confirmModal');
            }
        };

        // ==================== VENDAS (COM PDF) ====================
        const Sales = {
            init() {
                this.generateOsNumber();
                this.setDefaultDates();
                this.populateSaleSelects();
                this.renderItems();
                this.calculateTotal();
                this.selectPayment('installment');
                this.calculateInstallments();
                this.renderHistory();
                Utils.updatePixKey();
                state.editingSaleId = null;
            },

            // Popula os selects de lentes, armações e serviços com dados reais do state
            populateSaleSelects() {
                const Utils2 = { fmt: v => 'R$ ' + (v || 0).toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2}) };

                // Lentes: produtos da categoria 'lentes'
                const selLente = document.getElementById('lenteSelect');
                if (selLente) {
                    selLente.innerHTML = '<option value="">Selecione uma lente</option>';
                    const lentes = (state.products || []).filter(p => p.category === 'lentes');
                    if (lentes.length > 0) {
                        lentes.forEach(p => {
                            const opt = document.createElement('option');
                            opt.value = p.id + '|' + p.price;
                            opt.textContent = p.name + ' - ' + Utils2.fmt(p.price) + (p.qty <= 0 ? ' (sem estoque)' : '');
                            if (p.qty <= 0) opt.disabled = true;
                            selLente.appendChild(opt);
                        });
                    } else {
                        selLente.innerHTML += '<option disabled>— Nenhuma lente cadastrada —</option>';
                    }
                }

                // Armações: produtos das categorias 'armacoes' e 'oculos_sol'
                const selArmacao = document.getElementById('armacaoSelect');
                if (selArmacao) {
                    selArmacao.innerHTML = '<option value="">Selecione uma armação</option>';
                    const armacoes = (state.products || []).filter(p => p.category === 'armacoes' || p.category === 'oculos_sol');
                    if (armacoes.length > 0) {
                        armacoes.forEach(p => {
                            const opt = document.createElement('option');
                            opt.value = p.id + '|' + p.price;
                            opt.textContent = p.name + ' - ' + Utils2.fmt(p.price) + (p.qty <= 0 ? ' (sem estoque)' : '');
                            if (p.qty <= 0) opt.disabled = true;
                            selArmacao.appendChild(opt);
                        });
                    } else {
                        selArmacao.innerHTML += '<option disabled>— Nenhuma armação cadastrada —</option>';
                    }
                }

                // Serviços: todos do state.services
                const selServico = document.getElementById('servicoSelect');
                if (selServico) {
                    selServico.innerHTML = '<option value="">Selecione um serviço</option>';
                    const servs = (state.services || []);
                    if (servs.length > 0) {
                        servs.forEach(s => {
                            const opt = document.createElement('option');
                            opt.value = s.id + '|' + s.value;
                            opt.textContent = s.name + ' - ' + Utils2.fmt(s.value);
                            selServico.appendChild(opt);
                        });
                    } else {
                        selServico.innerHTML += '<option disabled>— Nenhum serviço cadastrado —</option>';
                    }
                }
            },

            generateOsNumber() {
                const currentYear = new Date().getFullYear();
                if (!state.lastOsCounter) state.lastOsCounter = {};

                // Recalcula o próximo número baseado nas vendas existentes para evitar duplicatas
                const osPrefix = `OS-${currentYear}-`;
                const usedNumbers = (state.sales || [])
                    .map(s => s.number || '')
                    .filter(n => n.startsWith(osPrefix))
                    .map(n => parseInt(n.replace(osPrefix, ''), 10))
                    .filter(n => !isNaN(n));

                const maxUsed = usedNumbers.length > 0 ? Math.max(...usedNumbers) : 0;
                const counterValue = state.lastOsCounter[currentYear] || 1;
                const nextNumber = Math.max(counterValue, maxUsed + 1);

                state.lastOsCounter[currentYear] = nextNumber;

                const sequential = String(nextNumber).padStart(4, '0');
                const osNumber = `OS-${currentYear}-${sequential}`;

                const el = document.getElementById('saleNumber');
                if (el) el.value = osNumber;

                return osNumber;
            },

            setDefaultDates() {
                const today = new Date().toISOString().slice(0, 10);
                const nextWeek = new Date();
                nextWeek.setDate(nextWeek.getDate() + 7);
                
                const saleDateEl = document.getElementById('saleDate');
                const deliveryForecastEl = document.getElementById('deliveryForecast');
                
                if (saleDateEl) saleDateEl.value = today;
                if (deliveryForecastEl) deliveryForecastEl.value = nextWeek.toISOString().slice(0, 10);
            },

            renderHistory() {
                const tbody = document.querySelector('#salesHistoryTable tbody');
                if (!tbody) return;
                tbody.innerHTML = '';

                // Aplicar filtros se existirem
                this.filterHistory();
            },

            filterHistory() {
                const tbody = document.querySelector('#salesHistoryTable tbody');
                if (!tbody) return;

                const term    = (document.getElementById('searchSaleHistory')?.value || '').toLowerCase().trim();
                const status  = document.getElementById('filterSaleStatus')?.value  || '';
                const period  = document.getElementById('filterSalePeriod')?.value   || '';
                const now     = new Date();

                const STATUS_MAP = {
                    'orcamento':   { label: '📋 Orçamento',         cls: 'info'      },
                    'pendente':    { label: '⏳ Pendente',           cls: 'warning'   },
                    'producao':    { label: '🔧 Em Produção',        cls: 'secondary' },
                    'production':  { label: '🔧 Em Produção',        cls: 'secondary' },
                    'laboratorio': { label: '🔬 Laboratório',        cls: 'info'      },
                    'tratamento':  { label: '🧪 Tratamento',         cls: 'secondary' },
                    'atrasado':    { label: '⚠️ Atrasado',           cls: 'danger'    },
                    'pronto':      { label: '📦 Pronto p/ Retirada', cls: 'warning'   },
                    'ready':       { label: '📦 Pronto',             cls: 'warning'   },
                    'entregue':    { label: '✅ Entregue',           cls: 'success'   },
                    'delivered':   { label: '✅ Entregue',           cls: 'success'   },
                    'cancelado':   { label: '❌ Cancelado',          cls: 'danger'    },
                };

                let filtered = state.sales.slice().reverse().filter(s => {
                    const client     = state.clients.find(c => c.id === s.clientId);
                    const clientName = (client?.name || '').toLowerCase();
                    const sNum       = (s.number || '').toLowerCase();
                    const sTotal     = Utils.formatCurrency(s.total).toLowerCase();

                    // Filtro texto
                    if (term && !clientName.includes(term) && !sNum.includes(term) && !sTotal.includes(term)) return false;

                    // Filtro status
                    if (status && s.status !== status && !(status === 'producao' && s.status === 'production') && !(status === 'entregue' && s.status === 'delivered') && !(status === 'pronto' && s.status === 'ready')) return false;

                    // Filtro período
                    if (period) {
                        const d = new Date((s.date || '') + 'T12:00:00');
                        if (period === 'today' && d.toDateString() !== now.toDateString()) return false;
                        if (period === 'week')  { const s2=new Date(now); s2.setDate(now.getDate()-now.getDay()); s2.setHours(0,0,0,0); if (d < s2) return false; }
                        if (period === 'month'  && (d.getMonth() !== now.getMonth() || d.getFullYear() !== now.getFullYear())) return false;
                        if (period === 'year'   && d.getFullYear() !== now.getFullYear()) return false;
                    }

                    return true;
                });

                // Atualiza badge de contagem
                const badge = document.getElementById('salesCountBadge');
                if (badge) badge.textContent = `${filtered.length} OS${filtered.length !== state.sales.length ? ` de ${state.sales.length}` : ''}`;

                tbody.innerHTML = '';
                if (filtered.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;padding:2rem;color:var(--gray);">
                        <i class="fas fa-search" style="font-size:2rem;display:block;margin-bottom:0.5rem;opacity:0.3;"></i>
                        Nenhuma OS encontrada com esses filtros.
                    </td></tr>`;
                    return;
                }

                filtered.forEach(s => {
                    const client = state.clients.find(c => c.id === s.clientId);
                    const clientName = client?.name || 'N/A';
                    const st = STATUS_MAP[s.status] || { label: s.status || '—', cls: 'secondary' };
                    const hasPhone = !!(client?.whatsapp || client?.phone);
                    tbody.innerHTML += `<tr>
                        <td>${s.number}</td>
                        <td>${Utils.sanitizeHTML(clientName)}</td>
                        <td>${Utils.formatCurrency(s.total)}</td>
                        <td>${{'pix':'PIX','cash':'Dinheiro','debit':'Débito','credit':'Crédito','installment':'Crediário'}[s.paymentMethod] || s.paymentMethod || '—'}</td>
                        <td><span class="badge badge-${st.cls}">${st.label}</span></td>
                        <td>${Utils.formatDate(s.date)}</td>
                        <td class="action-buttons">
                            <button class="btn-icon btn-view" onclick="Sales.view('${s.id}')" title="Visualizar"><i class="fas fa-eye"></i></button>
                            <button class="btn-icon btn-edit" onclick="Sales.edit('${s.id}')" title="Editar"><i class="fas fa-edit"></i></button>
                            <button class="btn-icon btn-delete" onclick="Sales.delete('${s.id}')" title="Excluir"><i class="fas fa-trash"></i></button>
                        </td>
                        <td class="action-buttons">
                            <button class="btn-icon" style="background:rgba(255,107,0,0.12);color:#ff6b00;" onclick="Sales._setPdfTarget('${s.id}');Sales.gerarPDF_OS('via1')" title="PDF Via Ótica"><i class="fas fa-file-pdf"></i></button>
                            <button class="btn-icon" style="background:rgba(40,167,69,0.12);color:#28a745;" onclick="Sales._setPdfTarget('${s.id}');Sales.gerarPDF_OS('via2')" title="PDF Via Cliente"><i class="fas fa-file-pdf"></i></button>
                        </td>
                        <td class="action-buttons">
                            <button class="btn-icon" style="background:${hasPhone ? 'rgba(37,211,102,0.15)' : 'rgba(0,0,0,0.05)'};color:${hasPhone ? '#25d366' : '#aaa'};"
                                onclick="Sales.enviarStatusPedidoWhatsApp('${s.id}')"
                                title="${hasPhone ? 'Enviar status do pedido por WhatsApp' : 'Cliente sem WhatsApp/telefone'}">
                                <i class="fab fa-whatsapp"></i>
                            </button>
                        </td>
                    </tr>`;
                });
            },

            clearHistoryFilter() {
                const s = document.getElementById('searchSaleHistory');
                const st = document.getElementById('filterSaleStatus');
                const p = document.getElementById('filterSalePeriod');
                if (s)  s.value  = '';
                if (st) st.value = '';
                if (p)  p.value  = '';
                this.filterHistory();
            },

            searchClient() {
                const term = document.getElementById('searchClientSale').value.toLowerCase();
                if (term.length < 3) {
                    document.getElementById('clientSearchResults').style.display = 'none';
                    return;
                }
                
                const results = state.clients.filter(c => 
                    c.name?.toLowerCase().includes(term) || 
                    c.cpf?.includes(term) || 
                    c.phone?.includes(term)
                );
                
                const select = document.getElementById('clientSelect');
                if (!select) return;
                
                select.innerHTML = '<option value="">Selecione um cliente</option>';
                results.forEach(c => {
                    select.innerHTML += `<option value="${c.id}">${Utils.sanitizeHTML(c.name)} - ${c.cpf || ''}</option>`;
                });
                
                document.getElementById('clientSearchResults').style.display = 'block';
            },

            loadClientData() {
                const clientId = document.getElementById('clientSelect').value;
                if (!clientId) return;
                
                const client = state.clients.find(c => c.id === clientId);
                if (!client) return;
                
                state.currentSale.clientId = clientId;
                
                document.getElementById('clientNameDisplay').innerText = client.name || '';
                document.getElementById('clientDocDisplay').innerText = `CPF: ${client.cpf || ''}`;
                document.getElementById('clientContactDisplay').innerHTML = `📞 ${client.phone || ''} ${client.email ? '| 📧 ' + client.email : ''}`;
                document.getElementById('clientAddressDisplay').innerHTML = `📍 ${client.address || ''} - ${client.neighborhood || ''} - ${client.city || ''}/${client.state || ''}`;
                
                document.getElementById('selectedClientData').style.display = 'block';
            },

            loadClientPrescription() {
                const client = state.clients.find(c => c.id === state.currentSale.clientId);
                if (!client) return;
                
                const presc = state.prescriptions.filter(p => p.clientId === client.id).pop();
                if (!presc) {
                    Toast.show('Cliente não possui receituário cadastrado', 'warning');
                    return;
                }
                
                document.getElementById('prescClientName').innerText = client.name || '';
                document.getElementById('prescDate').innerText = Utils.formatDate(presc.date);
                document.getElementById('prescOptometrist').value = presc.optometrist || '';
                
                document.getElementById('odSph').value = presc.od?.sph || '0.00';
                document.getElementById('odCyl').value = presc.od?.cyl || '0.00';
                document.getElementById('odAxis').value = presc.od?.axis || '';
                document.getElementById('odAdd').value = presc.od?.add || '0.00';
                document.getElementById('odDnp').value = presc.od?.dnp || '';
                document.getElementById('oeSph').value = presc.oe?.sph || '0.00';
                document.getElementById('oeCyl').value = presc.oe?.cyl || '0.00';
                document.getElementById('oeAxis').value = presc.oe?.axis || '';
                document.getElementById('oeAdd').value = presc.oe?.add || '0.00';
                document.getElementById('oeDnp').value = presc.oe?.dnp || '';
                document.getElementById('prescDp').value = presc.dp || '0.0';
                document.getElementById('prescHeight').value = presc.height || '';
                
                document.getElementById('prescSection').style.display = 'block';
                
                Presc.updateAllPertoOD();
                Presc.updateAllPertoOE();
                Presc.updateDP();
            },

            renderItems() {
                const container = document.getElementById('saleItemsContainer');
                if (!container) return;
                const hint = document.getElementById('emptyItemsHint');
                const badge = document.getElementById('itemCountBadge');
                const count = state.currentSale.items.length;
                if (badge) badge.textContent = count + (count === 1 ? ' item' : ' itens');

                if (count === 0) {
                    container.innerHTML = '';
                    if (hint) hint.style.display = 'flex';
                    return;
                }
                if (hint) hint.style.display = 'none';

                const typeIcon = { lente:'fa-eye', armacao:'fa-glasses', servico:'fa-tools', default:'fa-tag' };
                const typeColor = { lente:'#ff6b00', armacao:'#2e7d32', servico:'#0277bd', default:'#888' };
                const typeBg   = { lente:'#fff3e0', armacao:'#e8f5e9', servico:'#e1f5fe', default:'#f5f5f5' };

                let html = `<div style="padding:8px 0 4px;">`;
                state.currentSale.items.forEach((item, i) => {
                    const t     = item.type || 'default';
                    const icon  = typeIcon[t]  || typeIcon.default;
                    const color = typeColor[t] || typeColor.default;
                    const bg    = typeBg[t]    || typeBg.default;
                    html += `
                    <div style="display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid #f0f0f0;animation:fadeIn 0.2s ease;">
                        <div style="width:34px;height:34px;border-radius:10px;background:${bg};display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                            <i class="fas ${icon}" style="color:${color};font-size:13px;"></i>
                        </div>
                        <div style="flex:1;min-width:0;">
                            <div style="font-weight:700;font-size:0.83rem;color:#333;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${Utils.sanitizeHTML(item.name)}</div>
                            <div style="font-size:0.72rem;color:#888;margin-top:1px;">${item.qty}× ${Utils.formatCurrency(item.price)}</div>
                        </div>
                        <div style="font-weight:800;font-size:0.9rem;color:${color};white-space:nowrap;">${Utils.formatCurrency(item.subtotal)}</div>
                        <button onclick="Sales.removeItem(${i})" title="Remover"
                            style="width:28px;height:28px;border-radius:8px;border:none;background:#fff0f0;color:#dc3545;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
                            <i class="fas fa-trash" style="font-size:11px;"></i>
                        </button>
                    </div>`;
                });
                html += `</div>`;
                container.innerHTML = html;
            },

            // Controle de quantidade com botões +/−
            changeQty(inputId, delta) {
                const el = document.getElementById(inputId);
                if (!el) return;
                const val = parseInt(el.value) || 1;
                el.value = Math.max(1, val + delta);
            },

            // Troca de aba de item (lente / armação / serviço)
            showItemTab(tab) {
                const tabs   = { lente:'itemTabLente', armacao:'itemTabArmacao', servico:'itemTabServico' };
                const btns   = { lente:'tabBtnLente',  armacao:'tabBtnArmacao',  servico:'tabBtnServico' };
                const colors = { lente:['#ff6b00','#ff6b00'], armacao:['#43a047','#2e7d32'], servico:['#039be5','#0277bd'] };
                Object.keys(tabs).forEach(key => {
                    const panel = document.getElementById(tabs[key]);
                    const btn   = document.getElementById(btns[key]);
                    if (!panel || !btn) return;
                    if (key === tab) {
                        panel.style.display = 'block';
                        const [c1, c2] = colors[key];
                        btn.style.background = `linear-gradient(135deg,${c1},${c2})`;
                        btn.style.borderColor = c2;
                        btn.style.color = '#fff';
                    } else {
                        panel.style.display = 'none';
                        btn.style.background = '#fff';
                        btn.style.borderColor = '#ddd';
                        btn.style.color = '#888';
                    }
                });
            },

            addLente() {
                const select = document.getElementById('lenteSelect');
                const qty = parseInt(document.getElementById('lenteQty').value) || 1;
                if (!select || !select.value) { Toast.show('Selecione uma lente', 'warning'); return; }
                const [prodId, priceStr] = select.value.split('|');
                const price = parseFloat(priceStr);
                const prod = state.products.find(p => p.id === prodId);
                const name = prod ? prod.name : select.options[select.selectedIndex].text.split(' - ')[0];
                if (prod && prod.qty < qty) { Toast.show('Estoque insuficiente! Disponível: ' + prod.qty, 'warning'); return; }
                state.currentSale.items.push({ type: 'lente', productId: prodId, name, qty, price, subtotal: price * qty });
                select.value = '';
                document.getElementById('lenteQty').value = 1;
                this.renderItems(); this.calculateTotal();
                Toast.show('Lente adicionada!');
            },

            addArmacao() {
                const select = document.getElementById('armacaoSelect');
                const qty = parseInt(document.getElementById('armacaoQty').value) || 1;
                if (!select || !select.value) { Toast.show('Selecione uma armação', 'warning'); return; }
                const [prodId, priceStr] = select.value.split('|');
                const price = parseFloat(priceStr);
                const prod = state.products.find(p => p.id === prodId);
                const name = prod ? prod.name : select.options[select.selectedIndex].text.split(' - ')[0];
                if (prod && prod.qty < qty) { Toast.show('Estoque insuficiente! Disponível: ' + prod.qty, 'warning'); return; }
                state.currentSale.items.push({ type: 'armacao', productId: prodId, name, qty, price, subtotal: price * qty });
                select.value = '';
                document.getElementById('armacaoQty').value = 1;
                this.renderItems(); this.calculateTotal();
                Toast.show('Armação adicionada!');
            },

            addServico() {
                const select = document.getElementById('servicoSelect');
                const qty = parseInt(document.getElementById('servicoQty').value) || 1;
                if (!select || !select.value) { Toast.show('Selecione um serviço', 'warning'); return; }
                const [servId, priceStr] = select.value.split('|');
                const price = parseFloat(priceStr);
                const serv = state.services.find(s => s.id === servId);
                const name = serv ? serv.name : select.options[select.selectedIndex].text.split(' - ')[0];
                state.currentSale.items.push({ type: 'servico', serviceId: servId, name, qty, price, subtotal: price * qty });
                select.value = '';
                document.getElementById('servicoQty').value = 1;
                this.renderItems(); this.calculateTotal();
                Toast.show('Serviço adicionado!');
            },

            removeItem(index) {
                state.currentSale.items.splice(index, 1);
                this.renderItems();
                this.calculateTotal();
                Toast.show('Item removido');
            },

            // ══════════════════════════════════════════════════════════════
            // PAY — objeto centralizador de todos os cálculos de pagamento
            // Regras:
            //   PIX     5% desc → aplica no state.currentSale.total (salvo)
            //   Dinheiro 3% desc→ aplica no state.currentSale.total (salvo)
            //   Débito  sem desc → retirada opcional
            //   Crédito sem desc → parcelas Tabela Price se > 5x
            //   Crediário        → entrada + retirada + parcelas mensais
            //   Status parcelas  → 'aberto' | 'pago' | 'vencido'
            // ══════════════════════════════════════════════════════════════
            PAY: {
                // Formata moeda
                fmt(v) { return 'R$ ' + Math.max(0, isNaN(v)?0:v).toFixed(2).replace('.',',').replace(/\B(?=(\d{3})+(?!\d))/g,'.'); },

                // Lê o total bruto (antes de qualquer desconto de método)
                grossTotal() { return state.currentSale._grossTotal || state.currentSale.total || 0; },

                // Aplica desconto no total E salva no state
                applyDiscount(pct) {
                    const bruto = state.currentSale._grossTotal || state.currentSale.total || 0;
                    const desc  = bruto * pct;
                    state.currentSale.total   = Math.max(0, bruto - desc);
                    state.currentSale.discount = (state.currentSale.discount || 0);
                    // Atualiza display do total
                    const el = document.getElementById('totalDisplay');
                    if (el) el.innerText = this.fmt(state.currentSale.total);
                },

                // Remove desconto de método (volta ao bruto)
                removeDiscount() {
                    if (state.currentSale._grossTotal) {
                        state.currentSale.total = state.currentSale._grossTotal;
                        const el = document.getElementById('totalDisplay');
                        if (el) el.innerText = this.fmt(state.currentSale.total);
                    }
                },

                // Cálculo de retirada: total do método - entrada paga
                retirada(method) {
                    const ids = {
                        pix:   { entrada: 'pixEntrada',    display: 'pixRetirada',    alerta: 'pixAlerta',    alertaVal: 'pixAlertaVal' },
                        cash:  { entrada: 'cashEntrada',   display: 'cashRetirada',   alerta: 'cashAlerta',   alertaVal: 'cashAlertaVal' },
                        debit: { entrada: 'debitEntrada',  display: 'debitRetirada',  alerta: 'debitAlerta',  alertaVal: 'debitAlertaVal' },
                        credit:{ entrada: 'creditEntrada', display: 'creditRetirada', alerta: 'creditAlerta', alertaVal: 'creditAlertaVal' },
                    };
                    const cfg = ids[method]; if (!cfg) return;
                    const total    = state.currentSale.total || 0;
                    const entrada  = parseFloat(document.getElementById(cfg.entrada)?.value) || 0;
                    const restante = Math.max(0, total - entrada);
                    const dispEl   = document.getElementById(cfg.display);
                    if (dispEl) dispEl.textContent = this.fmt(restante);
                    const alertEl  = document.getElementById(cfg.alerta);
                    if (alertEl) alertEl.style.display = restante > 0.01 ? 'flex' : 'none';
                    const alertVal = document.getElementById(cfg.alertaVal);
                    if (alertVal) alertVal.textContent = this.fmt(restante);
                },

                // PIX — desconto 5% opcional
                pixCalc() {
                    const bruto = state.currentSale._grossTotal || state.currentSale.total || 0;
                    const ativo = document.getElementById('pixDescontoAtivo')?.checked !== false;
                    const desc  = ativo ? bruto * 0.05 : 0;
                    const final = bruto - desc;
                    // Atualiza state com total já com desconto
                    state.currentSale.total = final;
                    // Atualiza display principal
                    const tdEl = document.getElementById('totalDisplay');
                    if (tdEl) tdEl.innerText = this.fmt(final);
                    // Atualiza painel PIX
                    const b = document.getElementById('pixBruto'); if (b) b.innerText = this.fmt(bruto);
                    const d = document.getElementById('pixDesconto'); if (d) d.innerText = ativo ? '- ' + this.fmt(desc) : '— (não aplicado)';
                    const f = document.getElementById('pixFinal'); if (f) f.innerText = this.fmt(final);
                    // Atualiza chave PIX
                    const pix = state.company?.pix || state.company?.cnpj || '—';
                    const kEl = document.getElementById('companyPix'); if (kEl) kEl.textContent = pix;
                    this.retirada('pix');
                },

                // Dinheiro — desconto 3% opcional
                cashCalc() {
                    const bruto = state.currentSale._grossTotal || state.currentSale.total || 0;
                    const ativo = document.getElementById('cashDescontoAtivo')?.checked !== false;
                    const desc  = ativo ? bruto * 0.03 : 0;
                    const final = bruto - desc;
                    // Atualiza state com total já com desconto
                    state.currentSale.total = final;
                    // Atualiza display principal
                    const tdEl = document.getElementById('totalDisplay');
                    if (tdEl) tdEl.innerText = this.fmt(final);
                    // Atualiza painel Dinheiro
                    const b = document.getElementById('cashBruto'); if (b) b.innerText = this.fmt(bruto);
                    const d = document.getElementById('cashDesconto'); if (d) d.innerText = ativo ? '- ' + this.fmt(desc) : '— (não aplicado)';
                    const f = document.getElementById('cashFinal'); if (f) f.innerText = this.fmt(final);
                    this.cashChange();
                    this.retirada('cash');
                },

                // Troco do dinheiro
                cashChange() {
                    const total    = state.currentSale.total || 0;
                    const recebido = parseFloat(document.getElementById('cashRecebido')?.value) || 0;
                    const troco    = Math.max(0, recebido - total);
                    const el = document.getElementById('cashTroco'); if (el) el.textContent = this.fmt(troco);
                },

                // Débito
                debitCalc() {
                    const total = state.currentSale.total || 0;
                    const el = document.getElementById('debitTotal'); if (el) el.innerText = this.fmt(total);
                    const rs = document.getElementById('debitResumo'); if (rs) rs.textContent = this.fmt(total) + ' à vista';
                    this.retirada('debit');
                },

                // Crédito — Tabela Price para parcelas > 5x
                creditCalc() {
                    const total = state.currentSale.total || 0;
                    const creditTax = parseFloat(state.company?.creditTax) || 2.5;
                    const taxa = creditTax / 100;
                    const n = parseInt(document.getElementById('creditParcelas')?.value || 6);

                    let valorParc, totalFinal, jurosStr;
                    if (n <= 5) {
                        valorParc = total / n;
                        totalFinal = total;
                        jurosStr = 'Sem juros';
                    } else {
                        // Tabela Price
                        valorParc = total * (taxa * Math.pow(1+taxa, n)) / (Math.pow(1+taxa, n) - 1);
                        totalFinal = valorParc * n;
                        jurosStr = creditTax + '% a.m. (Tabela Price)';
                    }

                    // Update select options with values
                    const sel = document.getElementById('creditParcelas');
                    if (sel) {
                        Array.from(sel.options).forEach(opt => {
                            const ni = parseInt(opt.value);
                            if (ni <= 5) {
                                opt.text = ni + 'x de ' + this.fmt(total / ni) + ' — sem juros';
                            } else {
                                const pmt = total * (taxa * Math.pow(1+taxa, ni)) / (Math.pow(1+taxa, ni) - 1);
                                opt.text = ni + 'x de ' + this.fmt(pmt) + ' — ' + creditTax + '% a.m.';
                            }
                        });
                    }

                    const pEl = document.getElementById('creditParcelaVal'); if (pEl) pEl.innerText = this.fmt(valorParc);
                    const tEl = document.getElementById('creditTotal'); if (tEl) tEl.innerText = this.fmt(total);
                    const rEl = document.getElementById('creditResumoBox');
                    if (rEl) rEl.innerHTML = '<strong>' + n + 'x de ' + this.fmt(valorParc) + '</strong>' +
                        (n > 5 ? ' · Total com juros: <strong>' + this.fmt(totalFinal) + '</strong>' : ' · Sem juros') +
                        ' · <span style="color:#888;">' + jurosStr + '</span>';
                    this.retirada('credit');
                },

                // ── CREDIÁRIO: calcula por % ──────────────────────────────────
                instFromPercent() {
                    const total = state.currentSale.total || 0;
                    const pct   = parseFloat(document.getElementById('entryPercent')?.value) || 0;
                    const val   = total * pct / 100;
                    const el    = document.getElementById('entryValue');
                    if (el) el.value = val.toFixed(2).replace('.', ',');
                    this.instCalc();
                },

                // ── CREDIÁRIO: calcula por valor ─────────────────────────────
                instFromValue() {
                    const total     = state.currentSale.total || 0;
                    const entryVal  = Utils.parseMoney(document.getElementById('entryValue')?.value)   || 0;
                    const pct       = total > 0 ? (entryVal / total * 100) : 0;
                    const pctEl     = document.getElementById('entryPercent');
                    if (pctEl) pctEl.value = Math.round(pct);
                    this.instCalc();
                },

                // ── CREDIÁRIO: recalcula tudo ────────────────────────────────
                instCalc() {
                    const total      = state.currentSale.total || 0;
                    const entryVal   = Utils.parseMoney(document.getElementById('entryValue')?.value)   || 0;
                    const retiradaV  = Utils.parseMoney(document.getElementById('retiradaEntry')?.value) || 0;
                    const remaining  = Math.max(0, total - entryVal - retiradaV);
                    const nParcelas  = parseInt(document.getElementById('installmentCount')?.value) || 2;
                    const parcValue  = nParcelas > 0 ? remaining / nParcelas : 0;

                    // Atualiza resumo
                    const f = v => this.fmt(v);
                    const setEl = (id, t) => { const e = document.getElementById(id); if (e) e.innerText = t; };
                    setEl('totalSaleValue',    f(total));
                    setEl('entrySummary',       f(entryVal));
                    setEl('balanceSummary',     f(remaining));
                    setEl('totalParcelsSummary', nParcelas + 'x');
                    setEl('installmentValue',  f(parcValue));

                    // Alerta retirada
                    const alertEl  = document.getElementById('retiradaAlert');
                    const valorEl  = document.getElementById('retiradaValor');
                    const infoEl   = document.getElementById('retiradaInfo');
                    if (alertEl) alertEl.style.display = (retiradaV > 0.01 || remaining > 0.01) ? 'flex' : 'none';
                    if (valorEl) valorEl.textContent   = f(retiradaV > 0 ? retiradaV : remaining);
                    if (infoEl)  infoEl.textContent    = 'Entrada: ' + f(entryVal) +
                        (retiradaV > 0 ? ' | Retirada: ' + f(retiradaV) : '') +
                        ' | ' + nParcelas + 'x de ' + f(parcValue);

                    // Datas
                    let firstDate = document.getElementById('firstDueDate')?.value;
                    if (!firstDate) {
                        const fd = new Date();
                        fd.setDate(fd.getDate() + 30);
                        firstDate = fd.toISOString().slice(0,10);
                        const fdEl = document.getElementById('firstDueDate');
                        if (fdEl) fdEl.value = firstDate;
                    }

                    const lateFee      = parseFloat(document.getElementById('lateFee')?.value)      || 0;
                    const dailyInterest= parseFloat(document.getElementById('dailyInterest')?.value) || 0;
                    const fixedDay     = parseInt(document.getElementById('fixedDay')?.value)        || 0;

                    const parcels = [];
                    for (let i = 1; i <= nParcelas; i++) {
                        const dueDate = new Date(firstDate + 'T12:00:00');
                        dueDate.setMonth(dueDate.getMonth() + (i - 1));
                        if (fixedDay) {
                            const maxDay = new Date(dueDate.getFullYear(), dueDate.getMonth() + 1, 0).getDate();
                            dueDate.setDate(Math.min(fixedDay, maxDay));
                        }
                        const today = new Date();
                        const diffMs = today - dueDate;
                        const daysLate = diffMs > 0 ? Math.ceil(diffMs / 86400000) : 0;
                        let multaJuros = 0;
                        if (daysLate > 0) {
                            multaJuros = parcValue * (lateFee/100) + parcValue * (dailyInterest/100) * daysLate;
                        }
                        const status = daysLate > 0 ? 'vencido' : 'aberto';
                        parcels.push({
                            number: i,
                            dueDate: dueDate.toISOString().slice(0,10),
                            value: parcValue,
                            paidDate: null,
                            paidValue: null,
                            status,
                            daysLate,
                            lateFee,
                            dailyInterest,
                            multaJuros
                        });
                    }

                    state.currentSale.paymentDetails = {
                        entryValue, retiradaValue: retiradaV,
                        installments: nParcelas,
                        installmentValue: parcValue,
                        parcels,
                        totalParcelas: parcValue * nParcelas,
                    };

                    Sales.renderInstallmentsTable();
                },
            },

            calculateTotal() {
                let subtotal = state.currentSale.items.reduce((acc, i) => acc + i.subtotal, 0);
                const discount = Utils.parseMoney(document.getElementById('discountValue').value) || 0;
                const addition = Utils.parseMoney(document.getElementById('additionValue').value) || 0;
                const bruto = Math.max(0, subtotal - discount + addition);

                state.currentSale.subtotal   = subtotal;
                state.currentSale.discount   = discount;
                state.currentSale.addition   = addition;
                state.currentSale.total      = bruto;
                state.currentSale._grossTotal = bruto; // guarda bruto para descontos de método

                document.getElementById('subtotalDisplay').innerText = Utils.formatCurrency(subtotal);
                document.getElementById('totalDisplay').innerText    = Utils.formatCurrency(bruto);

                // Recalcula painel do método ativo com bruto atualizado
                const method = state.currentSale.paymentMethod;
                if      (method === 'pix')         this.PAY.pixCalc.call(this.PAY);
                else if (method === 'cash')         this.PAY.cashCalc.call(this.PAY);
                else if (method === 'debit')        this.PAY.debitCalc.call(this.PAY);
                else if (method === 'credit')       this.PAY.creditCalc.call(this.PAY);
                else if (method === 'installment')  this.PAY.instCalc.call(this.PAY);
            },

            selectPayment(method) {
                state.currentSale.paymentMethod = method;

                document.querySelectorAll('.payment-card').forEach(c => c.classList.remove('active'));
                const card = document.querySelector('[data-method="' + method + '"]');
                if (card) card.classList.add('active');

                // Oculta todos os painéis
                ['pixDetails','cashDetails','debitDetails','creditDetails','installmentDetails']
                    .forEach(id => document.getElementById(id)?.classList.add('d-none'));

                // Restaura total bruto antes de qualquer novo desconto de método
                if (state.currentSale._grossTotal) {
                    state.currentSale.total = state.currentSale._grossTotal;
                    const tdEl = document.getElementById('totalDisplay');
                    if (tdEl) tdEl.innerText = Utils.formatCurrency(state.currentSale.total);
                }

                if (method === 'pix') {
                    document.getElementById('pixDetails')?.classList.remove('d-none');
                    this.PAY.pixCalc.call(this.PAY);
                } else if (method === 'cash') {
                    document.getElementById('cashDetails')?.classList.remove('d-none');
                    this.PAY.cashCalc.call(this.PAY);
                } else if (method === 'debit') {
                    document.getElementById('debitDetails')?.classList.remove('d-none');
                    this.PAY.debitCalc.call(this.PAY);
                } else if (method === 'credit') {
                    document.getElementById('creditDetails')?.classList.remove('d-none');
                    this.PAY.creditCalc.call(this.PAY);
                } else if (method === 'installment') {
                    document.getElementById('installmentDetails')?.classList.remove('d-none');
                    this.PAY.instCalc.call(this.PAY);
                }
            },

            // Aliases para compatibilidade com código legado (setFixedDay, renderInstallmentsTable etc.)
            calculateInstallments()         { this.PAY.instFromPercent.call(this.PAY); },
            calculateInstallmentsFromValue(){ this.PAY.instFromValue.call(this.PAY); },
            calculateCredit()               { this.PAY.creditCalc.call(this.PAY); },
            calculateCreditInterest()       { this.PAY.creditCalc.call(this.PAY); },
            calculatePixDiscount()          { this.PAY.pixCalc.call(this.PAY); },
            calculateCashDiscount()         { this.PAY.cashCalc.call(this.PAY); },
            calcCashChange()                { this.PAY.cashChange.call(this.PAY); },
            calcCreditRetirada()            { this.PAY.retirada.call(this.PAY, 'credit'); },
            calcDebitRetirada()             { this.PAY.retirada.call(this.PAY, 'debit'); },
            calcPixRetirada()               { this.PAY.retirada.call(this.PAY, 'pix'); },
            calcCashRetirada()              { this.PAY.retirada.call(this.PAY, 'cash'); },
            _fmtBRL(v)                      { return this.PAY.fmt(v); },
            _updateDebitSummary()           { this.PAY.debitCalc.call(this.PAY); },
            copyPixKey() {
                const pixKey = document.getElementById('companyPix')?.textContent?.trim();
                if (pixKey && pixKey !== '—') {
                    navigator.clipboard.writeText(pixKey).then(() => Toast.show('Chave PIX copiada!'))
                        .catch(() => Toast.show('Chave PIX: ' + pixKey));
                }
            },

            // ── MODO DE PAGAMENTO (único) ────────────────────────────
            setPaymentMode(mode) {
                const single = document.getElementById('paymentSingleMode');
                if (single) single.classList.remove('d-none');
                state.currentSale.paymentMode = 'single';
                this.selectPayment(state.currentSale.paymentMethod || 'installment');
            },

            addMixedRow() {
                const container = document.getElementById('mixedPaymentRows');
                if (!container) return;
                const idx = container.querySelectorAll('.mixed-row').length;
                const row = document.createElement('div');
                row.className = 'mixed-row';
                row.style.cssText = 'display:flex;gap:6px;align-items:center;';
                row.innerHTML = `
                    <select class="form-control mixed-method" style="flex:1.2;font-size:0.82rem;" onchange="Sales.updateMixedTotals()">
                        <option value="pix">PIX</option>
                        <option value="cash">Dinheiro</option>
                        <option value="debit" ${idx===0?'selected':''}>Débito</option>
                        <option value="credit" ${idx===1?'selected':''}>Crédito</option>
                        <option value="installment">Crediário</option>
                    </select>
                    <input type="text" inputmode="numeric" class="form-control mixed-value" placeholder="0,00" style="flex:1;font-size:0.82rem;font-weight:700;"
                        oninput="Utils.maskMoney(this); Sales.updateMixedTotals()">
                    <button type="button" onclick="this.parentElement.remove(); Sales.updateMixedTotals();"
                        style="background:#dc3545;color:#fff;border:none;border-radius:6px;width:28px;height:28px;cursor:pointer;font-size:14px;flex-shrink:0;">✕</button>`;
                container.appendChild(row);
                this.updateMixedTotals();
            },

            updateMixedTotals() {
                const total = state.currentSale.total || 0;
                let distribTotal = 0;
                document.querySelectorAll('.mixed-value').forEach(inp => {
                    distribTotal += Utils.parseMoney(inp.value) || 0;
                });
                const diff = total - distribTotal;
                const elOS     = document.getElementById('mixedTotalOS');
                const elDistrib= document.getElementById('mixedTotalDistrib');
                const elDiff   = document.getElementById('mixedDiff');
                const elDiffLbl= document.getElementById('mixedDiffLabel');
                if (elOS)     elOS.textContent      = Utils.formatCurrency(total);
                if (elDistrib) elDistrib.textContent = Utils.formatCurrency(distribTotal);
                if (Math.abs(diff) > 0.01) {
                    if (elDiff)    elDiff.textContent = Utils.formatCurrency(Math.abs(diff)) + (diff > 0 ? ' faltando' : ' excedente');
                    if (elDiffLbl) elDiffLbl.style.display = 'inline';
                } else {
                    if (elDiffLbl) elDiffLbl.style.display = 'none';
                }
                // Salva no state
                const rows = [];
                document.querySelectorAll('.mixed-row').forEach(row => {
                    const method = row.querySelector('.mixed-method')?.value;
                    const value  = Utils.parseMoney(row.querySelector('.mixed-value')?.value) || 0;
                    if (method && value > 0) rows.push({ method, value });
                });
                state.currentSale.mixedPayments = rows;
            },

            getMixedPaymentSummary() {
                const labels = { pix:'PIX', cash:'Dinheiro', debit:'Débito', credit:'Crédito', installment:'Crediário' };
                return (state.currentSale.mixedPayments || [])
                    .map(r => `${labels[r.method]||r.method}: ${Utils.formatCurrency(r.value)}`).join(' + ');
            },

            // ── PAGAMENTO DUPLO ──────────────────────────────────────────────
            setDualMode(isDual) {
                const panel  = document.getElementById('dualPaymentPanel');
                const single = document.getElementById('paymentSingleMode');
                const btnS   = document.getElementById('btnModoSimples');
                const btnD   = document.getElementById('btnModoDuplo');
                state.currentSale._dualMode = isDual;
                if (isDual) {
                    if (panel)  panel.style.display  = 'block';
                    if (single) single.style.display = 'none';
                    if (btnS) { btnS.style.background='#fff'; btnS.style.color='var(--primary)'; }
                    if (btnD) { btnD.style.background='var(--primary)'; btnD.style.color='#fff'; }
                    // Oculta painéis individuais de pagamento
                    ['pixDetails','cashDetails','debitDetails','creditDetails','installmentDetails']
                        .forEach(id => document.getElementById(id)?.classList.add('d-none'));
                    this.calcDual();
                } else {
                    if (panel)  panel.style.display  = 'none';
                    if (single) single.style.display = 'block';
                    if (btnS) { btnS.style.background='var(--primary)'; btnS.style.color='#fff'; }
                    if (btnD) { btnD.style.background='#fff'; btnD.style.color='var(--primary)'; }
                    state.currentSale._dualPayments = null;
                    this.selectPayment(state.currentSale.paymentMethod || 'installment');
                }
            },

            calcDual() {
                const lbl   = {pix:'PIX',cash:'Dinheiro',debit:'Débito',credit:'Crédito',installment:'Crediário'};
                const total = state.currentSale._grossTotal || state.currentSale.total || 0;
                const m1    = document.getElementById('dual1Method')?.value || 'pix';
                const m2    = document.getElementById('dual2Method')?.value || 'cash';
                const v1    = parseFloat(document.getElementById('dual1Value')?.value) || 0;
                const v2    = parseFloat(document.getElementById('dual2Value')?.value) || 0;
                const sum   = v1 + v2;
                const diff  = total - sum;

                // Mostra/oculta painel crediário por forma
                const c1 = document.getElementById('dual1Crediario');
                const c2 = document.getElementById('dual2Crediario');
                if (c1) c1.style.display = (m1 === 'installment') ? 'block' : 'none';
                if (c2) c2.style.display = (m2 === 'installment') ? 'block' : 'none';

                // Resumo crediário forma 1
                if (m1 === 'installment' && v1 > 0) {
                    const entry1    = parseFloat(document.getElementById('dual1Entry')?.value) || 0;
                    const ret1      = parseFloat(document.getElementById('dual1Retirada')?.value) || 0;
                    const nparc1    = parseInt(document.getElementById('dual1Parcelas')?.value) || 2;
                    const saldo1    = Math.max(0, v1 - entry1 - ret1);
                    const parcVal1  = nparc1 > 0 ? saldo1 / nparc1 : 0;
                    const el1 = document.getElementById('dual1ParcelaInfo');
                    if (el1) el1.textContent = `Entrada: R$ ${entry1.toFixed(2).replace('.',',')} | Retirada: R$ ${ret1.toFixed(2).replace('.',',')} | ${nparc1}x de R$ ${parcVal1.toFixed(2).replace('.',',')}`;
                }
                // Resumo crediário forma 2
                if (m2 === 'installment' && v2 > 0) {
                    const entry2    = parseFloat(document.getElementById('dual2Entry')?.value) || 0;
                    const ret2      = parseFloat(document.getElementById('dual2Retirada')?.value) || 0;
                    const nparc2    = parseInt(document.getElementById('dual2Parcelas')?.value) || 2;
                    const saldo2    = Math.max(0, v2 - entry2 - ret2);
                    const parcVal2  = nparc2 > 0 ? saldo2 / nparc2 : 0;
                    const el2 = document.getElementById('dual2ParcelaInfo');
                    if (el2) el2.textContent = `Entrada: R$ ${entry2.toFixed(2).replace('.',',')} | Retirada: R$ ${ret2.toFixed(2).replace('.',',')} | ${nparc2}x de R$ ${parcVal2.toFixed(2).replace('.',',')}`;
                }

                // Resumo geral
                const fmt = v => 'R$ ' + v.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g,'.');
                const eTotalOS     = document.getElementById('dualTotalOS');
                const eTotalDistrib= document.getElementById('dualTotalDistrib');
                const eDiffRow     = document.getElementById('dualDiffRow');
                const eDiffVal     = document.getElementById('dualDiffVal');
                const eOkRow       = document.getElementById('dualOkRow');
                if (eTotalOS)      eTotalOS.textContent      = fmt(total);
                if (eTotalDistrib) eTotalDistrib.textContent = fmt(sum);
                if (Math.abs(diff) > 0.01) {
                    if (eDiffRow) eDiffRow.style.display = 'flex';
                    if (eOkRow)  eOkRow.style.display   = 'none';
                    if (eDiffVal) eDiffVal.textContent   = fmt(Math.abs(diff)) + (diff > 0 ? ' faltando' : ' excedendo');
                } else {
                    if (eDiffRow) eDiffRow.style.display = 'none';
                    if (eOkRow)  eOkRow.style.display   = 'block';
                }

                // Salva no state para o save() usar
                state.currentSale._dualPayments = [
                    { method: m1, value: v1,
                      entry: parseFloat(document.getElementById('dual1Entry')?.value) || 0,
                      retirada: parseFloat(document.getElementById('dual1Retirada')?.value) || 0,
                      parcelas: parseInt(document.getElementById('dual1Parcelas')?.value) || 2 },
                    { method: m2, value: v2,
                      entry: parseFloat(document.getElementById('dual2Entry')?.value) || 0,
                      retirada: parseFloat(document.getElementById('dual2Retirada')?.value) || 0,
                      parcelas: parseInt(document.getElementById('dual2Parcelas')?.value) || 2 }
                ];
            },

            // Gera parcelas para uma das formas do pagamento duplo
            _gerarParcelasDual(slot, firstDateStr) {
                if (!slot || slot.method !== 'installment' || slot.value <= 0) return [];
                const saldo    = Math.max(0, slot.value - (slot.entry || 0) - (slot.retirada || 0));
                const nParc    = slot.parcelas || 2;
                const parcVal  = nParc > 0 ? saldo / nParc : 0;
                const parcelas = [];
                for (let i = 1; i <= nParc; i++) {
                    const due = new Date(firstDateStr + 'T12:00:00');
                    due.setMonth(due.getMonth() + (i - 1));
                    parcelas.push({
                        number: i, dueDate: due.toISOString().slice(0,10),
                        value: parcVal, paidDate: null, paidValue: null,
                        status: 'aberto', daysLate: 0, lateFee: 2, dailyInterest: 0.033, multaJuros: 0
                    });
                }
                return parcelas;
            },

            // Calcula com base no % da entrada (quando o usuário altera o %)
            calculateInstallments() {
                const total = state.currentSale.total;
                document.getElementById('totalSaleValue').innerText = Utils.formatCurrency(total);
                
                const entryPercent = parseFloat(document.getElementById('entryPercent').value) / 100;
                const entryValue = total * entryPercent;
                // Sincroniza o campo de entrada editável
                const entryEl = document.getElementById('entryValue');
                if (entryEl) { 
                    const v = entryValue.toFixed(2);
                    entryEl.value = v.replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                }
                this.calculateInstallmentsFromValue();
            },

            // Calcula parcelas usando o valor de entrada digitado diretamente
            calculateInstallmentsFromValue() {
                const total = state.currentSale.total;
                document.getElementById('totalSaleValue').innerText = Utils.formatCurrency(total);

                const entryValue = Utils.parseMoney(document.getElementById('entryValue')?.value) || 0;
                const retiradaEntry = Utils.parseMoney(document.getElementById('retiradaEntry')?.value) || 0;
                // Sincroniza percentual
                const entryPercent = total > 0 ? (entryValue / total * 100) : 0;
                const entryPercentEl = document.getElementById('entryPercent');
                if (entryPercentEl) entryPercentEl.value = Math.round(entryPercent);

                const remaining = Math.max(0, total - entryValue - retiradaEntry);
                const installments = parseInt(document.getElementById('installmentCount').value);
                const installmentValue = installments > 0 ? remaining / installments : 0;
                
                document.getElementById('installmentValue').innerText = Utils.formatCurrency(installmentValue);
                document.getElementById('entrySummary').innerText = Utils.formatCurrency(entryValue);
                document.getElementById('balanceSummary').innerText = Utils.formatCurrency(remaining);
                document.getElementById('totalParcelsSummary').innerText = installments + 'x';

                // Alerta de retirada
                const alertEl = document.getElementById('retiradaAlert');
                const valorEl = document.getElementById('retiradaValor');
                const infoEl  = document.getElementById('retiradaInfo');
                const totalRetirada = retiradaEntry;
                if (alertEl) alertEl.style.display = (retiradaEntry > 0.01 || remaining > 0.01) ? 'flex' : 'none';
                if (valorEl) valorEl.textContent = Utils.formatCurrency(retiradaEntry > 0 ? retiradaEntry : remaining);
                if (infoEl)  infoEl.textContent = `Entrada: ${Utils.formatCurrency(entryValue)}${retiradaEntry > 0 ? ' | Retirada: ' + Utils.formatCurrency(retiradaEntry) : ''} | ${installments}x de ${Utils.formatCurrency(installmentValue)}`;

                
                let firstDate = document.getElementById('firstDueDate').value;
                const today = new Date();
                
                if (!firstDate) {
                    const firstDue = new Date(today);
                    firstDue.setDate(firstDue.getDate() + 30);
                    firstDate = firstDue.toISOString().slice(0, 10);
                    document.getElementById('firstDueDate').value = firstDate;
                }
                
                const parcels = [];
                let totalParcelas = 0;
                let totalMultaJuros = 0;
                
                for (let i = 1; i <= installments; i++) {
                    const dueDate = new Date(firstDate + 'T12:00:00');
                    dueDate.setMonth(dueDate.getMonth() + (i - 1));
                    
                    const fixedDay = document.getElementById('fixedDay').value;
                    if (fixedDay) {
                        dueDate.setDate(parseInt(fixedDay));
                    }
                    
                    const today = new Date();
                    const diffTime = today - dueDate;
                    const daysLate = diffTime > 0 ? Math.ceil(diffTime / (1000 * 60 * 60 * 24)) : 0;
                    
                    const lateFee = parseFloat(document.getElementById('lateFee').value) || 0;
                    const dailyInterest = parseFloat(document.getElementById('dailyInterest').value) || 0;
                    
                    let multaJuros = 0;
                    if (daysLate > 0) {
                        const multa = installmentValue * (lateFee / 100);
                        const juros = installmentValue * (dailyInterest / 100) * daysLate;
                        multaJuros = multa + juros;
                    }
                    
                    totalParcelas += installmentValue;
                    totalMultaJuros += multaJuros;
                    
                    parcels.push({
                        number: i,
                        dueDate: dueDate.toISOString().slice(0, 10),
                        value: installmentValue,
                        paidDate: null,
                        paidValue: null,
                        status: 'pending',
                        daysLate: daysLate,
                        lateFee: lateFee,
                        dailyInterest: dailyInterest,
                        multaJuros: multaJuros
                    });
                }
                
                state.currentSale.paymentDetails = {
                    entryPercent: entryPercent,
                    entryValue: entryValue,
                    retiradaEntry: retiradaEntry,
                    installments: installments,
                    installmentValue: installmentValue,
                    parcels: parcels,
                    totalParcelas: totalParcelas,
                    totalMultaJuros: totalMultaJuros
                };
                
                this.renderInstallmentsTable();
            },

            renderInstallmentsTable() {
                const details = state.currentSale.paymentDetails;
                if (!details) return;
                
                let html = '';
                let totalGeral = 0;
                let totalPago = 0;
                let totalMulta = 0;
                
                details.parcels.forEach(p => {
                    const today = new Date();
                    const dueDate = new Date(p.dueDate + 'T12:00:00');
                    const diffTime = today - dueDate;
                    const daysLate = diffTime > 0 ? Math.ceil(diffTime / (1000 * 60 * 60 * 24)) : 0;
                    // Status unificado: 'pago' | 'vencido' | 'aberto'
                    const isPago = p.status === 'pago' || p.status === 'paid';
                    const isLate = daysLate > 0 && !isPago;

                    let statusClass = 'status-pendente';
                    let statusText  = 'Aberto';
                    let statusIcon  = '⏳';

                    if (isPago) {
                        statusClass = 'status-pago';
                        statusText  = 'Pago';
                        statusIcon  = '✅';
                    } else if (isLate) {
                        statusClass = 'status-vencido';
                        statusText  = 'Vencido há ' + daysLate + ' dias';
                        statusIcon  = '⚠️';
                    }
                    
                    let multaJurosDisplay = 'R$ 0,00';
                    if (isLate) {
                        const multa = p.value * (p.lateFee / 100);
                        const juros = p.value * (p.dailyInterest / 100) * daysLate;
                        multaJurosDisplay = Utils.formatCurrency(multa + juros);
                        totalMulta += multa + juros;
                    }
                    
                    totalGeral += p.value;
                    if (p.paidValue) totalPago += p.paidValue;
                    
                    html += `
                        <tr style="${isLate ? 'background: rgba(220,53,69,0.05);' : ''}">
                            <td style="padding: 1rem; text-align: center; font-weight: bold;">${p.number}/${details.installments}</td>
                            <td style="padding: 1rem; text-align: center;">
                                <span style="display: flex; align-items: center; justify-content: center; gap: 0.25rem;">
                                    <i class="far fa-calendar-alt" style="color: ${isLate ? '#dc3545' : '#666'};"></i>
                                    ${Utils.formatDate(p.dueDate)}
                                    ${isLate ? `<span style="color: #dc3545; font-size: 0.7rem;">(${daysLate}d)</span>` : ''}
                                </span>
                            </td>
                            <td style="padding: 1rem; text-align: right; font-weight: bold;">${Utils.formatCurrency(p.value)}</td>
                            <td style="padding: 1rem; text-align: center;">
                                <span class="status-badge ${statusClass}">
                                    ${statusIcon} ${statusText}
                                </span>
                            </td>
                            <td style="padding: 1rem; text-align: center;">
                                <input type="date" id="paidDate_${p.number}" class="form-control" style="width: 140px; padding: 0.5rem; font-size: 0.8rem;" onchange="Sales.updatePaidDate(${p.number})" value="${p.paidDate || ''}">
                            </td>
                            <td style="padding: 1rem; text-align: right;">
                                <input type="text" id="paidValue_${p.number}" class="form-control" style="width: 120px; text-align: right; padding: 0.5rem; font-size: 0.8rem;" value="${p.paidValue ? p.paidValue.toFixed(2) : ''}" placeholder="0,00" onblur="Sales.updatePaidValue(${p.number})">
                            </td>
                            <td style="padding: 1rem; text-align: center; color: ${isLate ? '#dc3545' : '#28a745'};">
                                ${isLate ? daysLate : '0'}
                            </td>
                            <td style="padding: 1rem; text-align: right; color: #dc3545; font-weight: bold;">
                                ${multaJurosDisplay}
                            </td>
                            <td style="padding: 1rem; text-align: center;">
                                <div style="display: flex; gap: 0.25rem; justify-content: center;">
                                    <button class="btn-icon btn-edit" onclick="Sales.modifyDate(${p.number})" title="Modificar data">
                                        <i class="fas fa-calendar-alt"></i>
                                    </button>
                                    <button class="btn-icon btn-success" onclick="Sales.markAsPaid(${p.number})" title="Registrar pagamento">
                                        <i class="fas fa-money-bill"></i>
                                    </button>
                                    <button class="btn-icon btn-pdf-icon" onclick="Sales.gerarPDF_Comprovante(${p.number-1})" title="PDF Comprovante">
                                        <i class="fas fa-file-pdf"></i>
                                    </button>
                                    <button class="btn-icon" style="background:rgba(37,211,102,0.15);color:#25d366;" onclick="Sales.enviarComprovanteWhatsApp(${p.number-1})" title="Enviar comprovante por WhatsApp">
                                        <i class="fab fa-whatsapp"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                html += `
                    <tr style="background: var(--light); font-weight: bold; border-top: 2px solid var(--primary);">
                        <td colspan="2" style="padding: 1rem; text-align: right;">TOTAIS:</td>
                        <td style="padding: 1rem; text-align: right;">${Utils.formatCurrency(totalGeral)}</td>
                        <td></td>
                        <td></td>
                        <td style="padding: 1rem; text-align: right;">${Utils.formatCurrency(totalPago)}</td>
                        <td></td>
                        <td style="padding: 1rem; text-align: right; color: #dc3545;">${Utils.formatCurrency(totalMulta)}</td>
                        <td></td>
                    </tr>
                    <tr style="background: var(--light); font-weight: bold;">
                        <td colspan="8" style="padding: 1rem; text-align: right;">SALDO DEVEDOR:</td>
                        <td style="padding: 1rem; text-align: center; color: var(--primary); font-size: 1.1rem;">${Utils.formatCurrency(totalGeral - totalPago)}</td>
                    </tr>
                `;
                
                document.getElementById('installmentsTableBody').innerHTML = html;
            },

            setFixedDay() {
                const fixedDay = parseInt(document.getElementById('fixedDay').value);
                if (!fixedDay) { Toast.show('Selecione um dia fixo antes de aplicar', 'warning'); return; }

                const details = state.currentSale.paymentDetails;
                if (!details || !details.parcels?.length) {
                    Toast.show('Calcule as parcelas primeiro', 'warning');
                    return;
                }

                details.parcels.forEach(p => {
                    if (!p.dueDate) return;
                    const d = new Date(p.dueDate + 'T12:00:00');
                    // Ajusta para o dia fixo, não ultrapassando o último dia do mês
                    const maxDay = new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate();
                    d.setDate(Math.min(fixedDay, maxDay));
                    p.dueDate = d.toISOString().slice(0, 10);
                });

                state.currentSale.paymentDetails.parcels = details.parcels;
                this.renderInstallmentsTable();
                Toast.show('Dia fixo ' + fixedDay + ' aplicado em todas as parcelas!', 'success');
            },

            updatePaidDate(parcelNumber) {
                const paidDate = document.getElementById(`paidDate_${parcelNumber}`).value;
                const parcel = state.currentSale.paymentDetails.parcels.find(p => p.number === parcelNumber);
                if (parcel) {
                    parcel.paidDate = paidDate;
                    if (paidDate) {
                        parcel.status = 'pago';
                    }
                    this.renderInstallmentsTable();
                }
            },

            updatePaidValue(parcelNumber) {
                const paidValue = parseFloat(document.getElementById(`paidValue_${parcelNumber}`).value.replace(',', '.')) || 0;
                const parcel = state.currentSale.paymentDetails.parcels.find(p => p.number === parcelNumber);
                if (parcel) {
                    parcel.paidValue = paidValue;
                    this.renderInstallmentsTable();
                }
            },

            modifyDate(parcelNumber) {
                const newDate = prompt('Nova data de vencimento (AAAA-MM-DD):');
                if (newDate && newDate.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    const parcel = state.currentSale.paymentDetails?.parcels.find(p => p.number === parcelNumber);
                    if (parcel) {
                        parcel.dueDate = newDate;
                        this.renderInstallmentsTable();
                        Toast.show('Data atualizada com sucesso!');
                    }
                }
            },

            modifyAllDates() {
                const details = state.currentSale.paymentDetails;
                if (!details || !details.parcels?.length) {
                    Toast.show('Calcule as parcelas primeiro', 'warning');
                    return;
                }

                // Cria modal com input de calendário
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:99999;display:flex;align-items:center;justify-content:center;';

                const hoje = details.parcels[0]?.dueDate || new Date().toISOString().slice(0,10);
                overlay.innerHTML = `
                    <div style="background:#fff;border-radius:14px;padding:24px;width:320px;box-shadow:0 8px 32px rgba(0,0,0,0.25);font-family:inherit;">
                        <h3 style="margin:0 0 6px;font-size:1rem;color:#ff6b00;">📅 Modificar Todas as Datas</h3>
                        <p style="font-size:0.82rem;color:#666;margin:0 0 16px;">Selecione a data da <strong>1ª parcela</strong>. As demais serão ajustadas mensalmente.</p>
                        <input type="date" id="modAllDateInput" value="${hoje}"
                            style="width:100%;padding:10px;border:2px solid #ff6b00;border-radius:8px;font-size:1rem;outline:none;box-sizing:border-box;">
                        <div style="display:flex;gap:10px;margin-top:16px;">
                            <button id="modAllCancel" style="flex:1;padding:10px;border:2px solid #ccc;border-radius:8px;background:#fff;cursor:pointer;font-weight:700;font-size:0.88rem;">Cancelar</button>
                            <button id="modAllConfirm" style="flex:1;padding:10px;border:none;border-radius:8px;background:#ff6b00;color:#fff;cursor:pointer;font-weight:700;font-size:0.88rem;">✔ Aplicar</button>
                        </div>
                    </div>`;

                document.body.appendChild(overlay);

                overlay.querySelector('#modAllCancel').onclick = () => overlay.remove();
                overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
                overlay.querySelector('#modAllConfirm').onclick = () => {
                    const newDate = overlay.querySelector('#modAllDateInput').value;
                    if (!newDate) { Toast.show('Selecione uma data', 'warning'); return; }
                    const firstDate = new Date(newDate + 'T12:00:00');
                    details.parcels.forEach((p, i) => {
                        const d = new Date(firstDate);
                        d.setMonth(d.getMonth() + i);
                        p.dueDate = d.toISOString().slice(0, 10);
                    });
                    this.renderInstallmentsTable();
                    Toast.show('Todas as datas atualizadas!', 'success');
                    overlay.remove();
                };

                // Abre o calendário automaticamente
                setTimeout(() => {
                    const inp = overlay.querySelector('#modAllDateInput');
                    if (inp?.showPicker) inp.showPicker();
                }, 150);
            },

            markAsPaid(parcelNumber) {
                const value = prompt('Valor pago (R$):');
                if (value) {
                    const parcel = state.currentSale.paymentDetails?.parcels.find(p => p.number === parcelNumber);
                    if (parcel) {
                        parcel.paidDate = new Date().toISOString().slice(0, 10);
                        parcel.paidValue = parseFloat(value.replace(',', '.'));
                        parcel.status = 'pago';
                        this.renderInstallmentsTable();
                        Toast.show('Pagamento registrado com sucesso!');
                    }
                }
            },

            // Editar venda existente
            edit(id) {
                const sale = state.sales.find(s => s.id === id);
                if (!sale) return;

                state.editingSaleId = id;
                // Copiar dados para currentSale
                state.currentSale = {
                    number: sale.number,
                    date: sale.date,
                    unit: sale.unit,
                    seller: sale.seller,
                    deliveryForecast: sale.deliveryForecast,
                    clientId: sale.clientId,
                    items: sale.items.map(item => ({ ...item })), // cópia
                    subtotal: sale.subtotal,
                    discount: sale.discount,
                    addition: sale.addition,
                    total: sale.total,
                    _grossTotal: sale.grossTotal || sale.total, // restaura bruto para PIX/Dinheiro
                    methodDiscount: sale.methodDiscount || 0,
                    paymentMethod: sale.paymentMethod,
                    paymentDetails: sale.paymentDetails ? JSON.parse(JSON.stringify(sale.paymentDetails)) : null,
                    observations: sale.observations,
                    status: sale.status,
                    statusHistory: sale.statusHistory ? [...sale.statusHistory] : []
                };

                // Preencher campos do formulário
                document.getElementById('saleNumber').value = sale.number;
                document.getElementById('saleDate').value = sale.date;
                document.getElementById('saleUnit').value = sale.unit;
                document.getElementById('saleSeller').value = sale.seller || '';
                document.getElementById('deliveryForecast').value = sale.deliveryForecast || '';
                document.getElementById('saleStatus').value = sale.status;
                document.getElementById('discountValue').value = sale.discount;
                document.getElementById('additionValue').value = sale.addition;
                document.getElementById('saleObservations').value = sale.observations || '';

                // Carregar cliente
                if (sale.clientId) {
                    const client = state.clients.find(c => c.id === sale.clientId);
                    if (client) {
                        document.getElementById('clientNameDisplay').innerText = client.name || '';
                        document.getElementById('clientDocDisplay').innerText = `CPF: ${client.cpf || ''}`;
                        document.getElementById('clientContactDisplay').innerHTML = `📞 ${client.phone || ''} ${client.email ? '| 📧 ' + client.email : ''}`;
                        document.getElementById('clientAddressDisplay').innerHTML = `📍 ${client.address || ''} - ${client.neighborhood || ''} - ${client.city || ''}/${client.state || ''}`;
                        document.getElementById('selectedClientData').style.display = 'block';
                        // Carregar receita do cliente
                        this.loadClientPrescription(); // já usa state.currentSale.clientId
                    }
                }

                // Renderizar itens
                this.renderItems();

                // Calcular totais (subtotal já está em state.currentSale)
                document.getElementById('subtotalDisplay').innerText = Utils.formatCurrency(sale.subtotal);
                document.getElementById('totalDisplay').innerText = Utils.formatCurrency(sale.total);

                // Selecionar método de pagamento
                this.selectPayment(sale.paymentMethod);

                // Restaurar profissional
                if (profEl) profEl.value = sale.professional || '';

                // Se for crediário, restaurar campos de parcelas e recalcular
                if (sale.paymentMethod === 'installment' && sale.paymentDetails) {
                    const pDet = sale.paymentDetails;
                    const entryValEl = document.getElementById('entryValue');
                    if (entryValEl) {
                        const ev = (pDet.entryValue || 0).toFixed(2);
                        entryValEl.value = ev.replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                    }
                    const retEl = document.getElementById('retiradaEntry');
                    if (retEl) {
                        const rv = (pDet.retiradaEntry || 0).toFixed(2);
                        retEl.value = rv.replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                    }
                    document.getElementById('entryPercent').value = pDet.entryPercent || 0;
                    document.getElementById('installmentCount').value = pDet.installments;
                    // Recalcular parcelas (isso também vai gerar paymentDetails novamente, mas usaremos os dados salvos)
                    this.calculateInstallmentsFromValue(); // vai gerar novas parcelas, mas podemos substituir pelos dados salvos
                    // Substituir as parcelas geradas pelos dados salvos
                    if (sale.paymentDetails.parcels) {
                        state.currentSale.paymentDetails.parcels = sale.paymentDetails.parcels.map(p => ({ ...p }));
                        this.renderInstallmentsTable(); // re-render com os dados originais
                    }
                } else if (sale.paymentMethod === 'pix') {
                    this.calculatePixDiscount();
                } else if (sale.paymentMethod === 'cash') {
                    this.calculateCashDiscount();
                }
            },

            // ========== FUNÇÕES DE PDF - MODELOS EXATOS ==========

            // Permite gerar PDF de uma OS específica do histórico (sem editar)
            _setPdfTarget(saleId) {
                const sale = state.sales.find(s => s.id === saleId);
                if (sale) state.currentSale = JSON.parse(JSON.stringify(sale));
            },

            gerarPDF_OS(tipo) {
                const client  = state.clients.find(c => c.id === state.currentSale.clientId);
                const presc   = state.prescriptions.find(p => p.clientId === client?.id);
                const sale    = state.currentSale;
                const details = state.currentSale.paymentDetails;
                const company = state.company;
                const modelo  = state.osModelo || 'colorido';

                // Paletas por modelo
                let cor1, cor2, headerBg1, headerBg2, headerText, tableBg, borderColor, sectionBg, rodapeBg;
                if (modelo === 'semfundo') {
                    // Sem Fundo: sem qualquer cor — tudo preto/cinza/branco, sem faixas
                    cor1 = '#000'; cor2 = '#000';
                    headerBg1 = 'transparent'; headerBg2 = 'transparent'; headerText = '#000';
                    tableBg = '#fff'; borderColor = '#ccc'; sectionBg = 'transparent'; rodapeBg = 'transparent';
                } else {
                    // Colorido: usa as cores da empresa
                    cor1 = company.primaryColor || '#ff6b00'; cor2 = '#1a7a3e';
                    headerBg1 = cor1; headerBg2 = cor2; headerText = '#fff';
                    tableBg = '#fff3ee'; borderColor = '#e0e0e0'; sectionBg = '#f5f5f5'; rodapeBg = '#f0f0f0';
                }

                const fd = (d) => {
                    if (!d) return '—';
                    return new Date(d + 'T12:00:00').toLocaleDateString('pt-BR');
                };

                const logoHtml = company.logo
                    ? `<div class="os-logo-circulo" style="background-image:url('${company.logo}')"></div>`
                    : `<div class="os-logo-circulo"><span>👁️</span></div>`;

                const buildVia = (num, cor, titulo, showPrices) => {
                    const headerBg  = num === 1 ? headerBg1 : headerBg2;
                    // No semfundo: cabeçalho limpo com borda inferior simples, sem fundo
                    const hdrStyle  = modelo === 'semfundo'
                        ? `border:1px solid #ccc;border-radius:4px;`
                        : ``;
                    // Títulos de seção: colorido = faixa colorida; semfundo = só texto preto sem fundo
                    const secTitle  = (txt) => modelo === 'semfundo'
                        ? `<div class="os-section-title" style="background:transparent;color:#000;border-bottom:1.5px solid #ccc;font-weight:800;--cor:#000">${txt}</div>`
                        : `<div class="os-section-title" style="background:${cor};color:#fff;--cor:${cor}">${txt}</div>`;

                    const prescrHtml = presc ? `
                        <div class="os-receita-section">
                            ${secTitle('📋 Receituário Óptico')}
                            <table class="os-receita-table" style="--cor:${cor}">
                                <thead>
                                    <tr style="background:${modelo==='semfundo'?'#f5f5f5':cor+'20'}">
                                        <th>Olho</th><th>Tipo</th><th>ESF</th><th>CIL</th><th>EIXO</th><th>ADIÇÃO</th><th>DNP</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td class="os-olho-label" style="background:${modelo==='semfundo'?'#f0f0f0':'#000'};color:${modelo==='semfundo'?'#000':'#fff'}">OD</td><td>Longe</td>
                                        <td>${presc.od?.sph || '0.00'}</td><td>${presc.od?.cyl || '0.00'}</td>
                                        <td>${presc.od?.axis || '0°'}</td><td>${presc.od?.add || '0.00'}</td>
                                        <td>${presc.od?.dnp || '—'}</td>
                                    </tr>
                                    <tr>
                                        <td class="os-olho-label" style="background:${modelo==='semfundo'?'#f0f0f0':'#000'};color:${modelo==='semfundo'?'#000':'#fff'}">OE</td><td>Longe</td>
                                        <td>${presc.oe?.sph || '0.00'}</td><td>${presc.oe?.cyl || '0.00'}</td>
                                        <td>${presc.oe?.axis || '0°'}</td><td>${presc.oe?.add || '0.00'}</td>
                                        <td>${presc.oe?.dnp || '—'}</td>
                                    </tr>
                                    <tr>
                                        <td class="os-olho-label" style="background:${modelo==='semfundo'?'#f0f0f0':'#000'};color:${modelo==='semfundo'?'#000':'#fff'}">OD</td><td>Perto</td>
                                        <td>${presc.od?.sph && presc.od?.add ? (parseFloat(presc.od.sph)+parseFloat(presc.od.add)).toFixed(2) : '0.00'}</td>
                                        <td>${presc.od?.cyl || '0.00'}</td><td>${presc.od?.axis || '0°'}</td><td>—</td>
                                        <td>${presc.od?.dnp ? (parseFloat(presc.od.dnp)-2.5).toFixed(1) : '—'}</td>
                                    </tr>
                                    <tr>
                                        <td class="os-olho-label" style="background:${modelo==='semfundo'?'#f0f0f0':'#000'};color:${modelo==='semfundo'?'#000':'#fff'}">OE</td><td>Perto</td>
                                        <td>${presc.oe?.sph && presc.oe?.add ? (parseFloat(presc.oe.sph)+parseFloat(presc.oe.add)).toFixed(2) : '0.00'}</td>
                                        <td>${presc.oe?.cyl || '0.00'}</td><td>${presc.oe?.axis || '0°'}</td><td>—</td>
                                        <td>${presc.oe?.dnp ? (parseFloat(presc.oe.dnp)-2.5).toFixed(1) : '—'}</td>
                                    </tr>
                                </tbody>
                            </table>
                            <div class="os-receita-extra">
                                <div class="os-receita-extra-item">Optometrista: <strong>${presc.optometrist || '______'}</strong></div>
                                <div class="os-receita-extra-item">DP: <strong>${presc.dp || '—'} mm</strong></div>
                                <div class="os-receita-extra-item">Altura: <strong>${presc.height || '—'} mm</strong></div>
                                <div class="os-receita-extra-item">CRO: <strong>${presc.cro || '______'}</strong></div>
                            </div>
                        </div>` : '';

                    const itensRows = sale.items.map((item, i) => `
                        <tr>
                            <td>${String(i+1).padStart(2,'0')}</td>
                            <td>${item.name || ''}</td>
                            <td style="text-align:right">${item.qty || 1}</td>
                            ${showPrices ? `<td style="text-align:right">${Utils.formatCurrency(item.price)}</td><td style="text-align:right">${Utils.formatCurrency(item.subtotal)}</td>` : ''}
                        </tr>`).join('');

                    const pagMethodLabel = {'pix':'PIX','cash':'Dinheiro','debit':'Débito','credit':'Crédito','installment':'Crediário'}[sale.paymentMethod] || sale.paymentMethod || '—';
                    const isMixed = sale.paymentMode === 'mixed' && sale.mixedPayments?.length;

                    const pagHtml = details ? `
                        <div class="os-pagamento-grid">
                            <div class="os-pagamento-cell" style="border-color:${borderColor}">
                                <div class="os-pagamento-cell-label">Entrada (${details.entryPercent || 0}%)</div>
                                <div class="os-pagamento-cell-val" style="color:${cor}">${Utils.formatCurrency(details.entryValue || 0)}</div>
                            </div>
                            <div class="os-pagamento-cell" style="border-color:${borderColor}">
                                <div class="os-pagamento-cell-label">Parcelas</div>
                                <div class="os-pagamento-cell-val" style="color:${cor}">${details.installments}× ${Utils.formatCurrency(details.installmentValue)}</div>
                            </div>
                            <div class="os-pagamento-cell" style="border-color:${borderColor}">
                                <div class="os-pagamento-cell-label">1º Vencimento</div>
                                <div class="os-pagamento-cell-val" style="color:${cor}">${details.parcels?.[0] ? fd(details.parcels[0].dueDate) : '—'}</div>
                            </div>
                            <div class="os-pagamento-cell" style="border-color:${borderColor}">
                                <div class="os-pagamento-cell-label">Multa / Juros</div>
                                <div class="os-pagamento-cell-val">${company.lateFee}% + ${company.dailyInterest}%/dia</div>
                            </div>
                        </div>
                        <div class="os-pagamento-pix" style="background:${cor}15;border-left:3px solid ${cor}">
                            🔑 Pagamento via PIX — Chave CNPJ: <strong>${company.cnpj}</strong>
                        </div>
                    ` : isMixed ? `
                        <div class="os-pagamento-grid">
                            ${sale.mixedPayments.map(r => `
                            <div class="os-pagamento-cell" style="border-color:${borderColor}">
                                <div class="os-pagamento-cell-label">${{'pix':'PIX','cash':'Dinheiro','debit':'Débito','credit':'Crédito','installment':'Crediário'}[r.method]||r.method}</div>
                                <div class="os-pagamento-cell-val" style="color:${cor}">${Utils.formatCurrency(r.value)}</div>
                            </div>`).join('')}
                            <div class="os-pagamento-cell" style="border-color:${borderColor}">
                                <div class="os-pagamento-cell-label">Valor Total</div>
                                <div class="os-pagamento-cell-val" style="color:${cor}">${Utils.formatCurrency(sale.total)}</div>
                            </div>
                        </div>` : `
                        <div class="os-pagamento-grid">
                            <div class="os-pagamento-cell" style="border-color:${borderColor}">
                                <div class="os-pagamento-cell-label">Forma de Pagamento</div>
                                <div class="os-pagamento-cell-val" style="color:${cor}">${pagMethodLabel}</div>
                            </div>
                            <div class="os-pagamento-cell" style="border-color:${borderColor}">
                                <div class="os-pagamento-cell-label">Valor Total</div>
                                <div class="os-pagamento-cell-val" style="color:${cor}">${Utils.formatCurrency(sale.total)}</div>
                            </div>
                        </div>`;

                    const via = document.createElement('div');
                    via.className = 'os-via os-via-modelo-' + modelo;
                    via.innerHTML = `
                        <div class="os-via-header-bar" style="background:${headerBg};color:${headerText};${hdrStyle}border-radius:0">
                            <div class="os-logo-area" style="background:${modelo==='semfundo'?'transparent':'rgba(0,0,0,0.18)'}">
                                ${logoHtml}
                            </div>
                            <div class="os-empresa-area">
                                <div class="os-empresa-nome-wrap" style="border-bottom:1px solid ${modelo==='semfundo'?'#ccc':'rgba(255,255,255,0.25)'}">
                                    <div class="os-empresa-nome" style="color:${headerText}">${company.name}</div>
                                    <div class="os-empresa-badge" style="color:${modelo==='semfundo'?'#333':headerText};border-color:${modelo==='semfundo'?'#aaa':'rgba(255,255,255,0.4)'};background:${modelo==='semfundo'?'transparent':'rgba(255,255,255,0.15)'}">Ordem de Serviço</div>
                                </div>
                                <div class="os-empresa-sub" style="color:${modelo==='semfundo'?'#333':headerText+'dd'}">
                                    ${company.legalName ? company.legalName + ' &nbsp;|&nbsp; ' : ''}
                                    CNPJ: ${company.cnpj || '—'}<br>
                                    ${[company.address, company.number, company.neighborhood, company.city, company.state].filter(Boolean).join(', ')}<br>
                                    📞 ${company.phone || ''}  &nbsp; 📱 ${company.whatsapp || ''}  &nbsp; ✉️ ${company.email || ''}
                                </div>
                            </div>
                            <div class="os-numero-area" style="background:${modelo==='semfundo'?'transparent':'rgba(0,0,0,0.22)'};border-left:1px solid ${modelo==='semfundo'?'#ccc':'rgba(255,255,255,0.2)'}">
                                <div class="os-numero-label" style="color:${modelo==='semfundo'?'#555':headerText+'cc'}">Ordem de Serviço</div>
                                <div class="os-numero-valor" style="color:${headerText}">${sale.number}</div>
                                <div class="os-via-label" style="color:${modelo==='semfundo'?'#555':headerText+'cc'};background:${modelo==='semfundo'?'transparent':'rgba(255,255,255,0.15)'}">${titulo}</div>
                            </div>
                        </div>

                        <div class="os-info-bar" style="background:${sectionBg}">
                            <div class="os-info-cell"><span class="os-info-cell-label">Data de Abertura</span><span class="os-info-cell-val" style="color:${modelo==='semfundo'?'#000':cor}">${fd(sale.date)}</span></div>
                            <div class="os-info-cell"><span class="os-info-cell-label">Previsão de Entrega</span><span class="os-info-cell-val" style="color:${modelo==='semfundo'?'#000':cor}">${fd(sale.deliveryForecast)}</span></div>
                            <div class="os-info-cell"><span class="os-info-cell-label">Unidade</span><span class="os-info-cell-val">${sale.unit || '—'}</span></div>
                            <div class="os-info-cell"><span class="os-info-cell-label">Vendedor</span><span class="os-info-cell-val">${sale.seller || '—'}</span></div>
                            <div class="os-info-cell"><span class="os-info-cell-label">Status</span><span class="os-info-cell-val">${({'orcamento':'Orçamento','pendente':'Pendente','producao':'Em Produção','production':'Em Produção','laboratorio':'Laboratório','tratamento':'Tratamento','atrasado':'Atrasado','pronto':'Pronto p/ Retirada','ready':'Pronto','entregue':'Entregue','delivered':'Entregue','cancelado':'Cancelado'})[sale.status] || sale.status || '—'}</span></div>
                        </div>

                        <div class="os-cliente-section">
                            <div class="os-cliente-accent" style="background:${modelo==='semfundo'?'#ccc':cor}"></div>
                            <div class="os-cliente-body">
                                <div class="os-cliente-nome" style="color:${modelo==='semfundo'?'#000':cor}">${client?.name || 'Cliente não identificado'}</div>
                                <div class="os-cliente-nome-sep" style="border-color:${modelo==='semfundo'?'#ccc':cor+'40'}"></div>
                                <div class="os-cliente-grid">
                                    <div class="os-cliente-field">CPF / CNPJ<span>${client?.cpf || '—'}</span></div>
                                    <div class="os-cliente-field">Nascimento<span>${fd(client?.birthDate)}</span></div>
                                    <div class="os-cliente-field">Telefone<span>${client?.phone || '—'}</span></div>
                                    <div class="os-cliente-field">E-mail<span>${client?.email || '—'}</span></div>
                                    <div class="os-cliente-field">Endereço<span>${[client?.address, client?.number].filter(Boolean).join(', ') || '—'}</span></div>
                                    <div class="os-cliente-field">Bairro<span>${client?.neighborhood || '—'}</span></div>
                                    <div class="os-cliente-field">Cidade / UF<span>${[client?.city, client?.state].filter(Boolean).join(' / ') || '—'}</span></div>
                                    <div class="os-cliente-field">CEP<span>${client?.cep || '—'}</span></div>
                                </div>
                            </div>
                        </div>

                        ${prescrHtml}

                        <div class="os-itens-section">
                            ${secTitle('Itens da Ordem de Serviço')}
                            <table class="os-itens-table">
                                <thead>
                                    <tr style="background:${modelo==='semfundo'?'#f5f5f5':cor+'15'}">
                                        <th style="width:8mm">#</th>
                                        <th>Descrição do Produto / Serviço</th>
                                        <th style="width:12mm;text-align:center">Qtd</th>
                                        ${showPrices ? '<th style="width:22mm;text-align:right">Unitário</th><th style="width:24mm;text-align:right">Subtotal</th>' : ''}
                                    </tr>
                                </thead>
                                <tbody>${itensRows}</tbody>
                            </table>
                        </div>

                        ${showPrices ? `
                        <div class="os-totais-row" style="background:${sectionBg}">
                            <span class="os-totais-item">Subtotal: <strong>${Utils.formatCurrency(sale.subtotal)}</strong></span>
                            <span class="os-totais-item">Desconto: <strong style="color:#c0392b">− ${Utils.formatCurrency(sale.discount)}</strong></span>
                            ${sale.addition > 0 ? `<span class="os-totais-item">Acréscimo: <strong>+ ${Utils.formatCurrency(sale.addition)}</strong></span>` : ''}
                            <span class="os-total-final" style="color:${modelo==='semfundo'?'#000':cor}">TOTAL: ${Utils.formatCurrency(sale.total)}</span>
                        </div>` : ''}

                        <div class="os-pagamento-section">
                            ${secTitle('Condições de Pagamento')}
                            ${pagHtml}
                        </div>

                        <div class="os-obs-section">
                            <div class="os-obs-body">
                                <div class="os-obs-label">Observações</div>
                                ${sale.observations || '—'}
                            </div>
                        </div>

                        <div class="os-assinaturas">
                            <div class="os-assinatura-box">
                                <div class="os-assinatura-linha" style="border-color:${modelo==='semfundo'?'#aaa':cor}"></div>
                                <div class="os-assinatura-label">Assinatura do Cliente</div>
                            </div>
                            <div class="os-assinatura-box">
                                <div class="os-assinatura-linha" style="border-color:${modelo==='semfundo'?'#aaa':cor}"></div>
                                <div class="os-assinatura-label">Responsável / Vendedor</div>
                            </div>
                            <div class="os-assinatura-box">
                                <div class="os-assinatura-linha" style="border-color:${modelo==='semfundo'?'#aaa':cor}"></div>
                                <div class="os-assinatura-label">Data de Entrega</div>
                            </div>
                        </div>

                        <div class="os-rodape" style="background:${rodapeBg};border-top:${modelo==='semfundo'?'1px solid #ccc':'2px solid '+cor}">
                            <strong>${company.name || ''}</strong>${company.cnpj ? ' &nbsp;·&nbsp; CNPJ: ' + company.cnpj : ''} &nbsp;·&nbsp; ${[company.address, company.number, company.city, company.state].filter(Boolean).join(', ')}${company.cep ? ' — CEP: ' + company.cep : ''}<br>
                            ${company.phone ? '📞 ' + company.phone + ' &nbsp; ' : ''}${company.whatsapp ? '📱 ' + company.whatsapp + ' &nbsp; ' : ''}${company.email ? '✉️ ' + company.email : ''}<br>
                            Garantia: ${company.warrantyDays || 90} dias após entrega. Documento válido somente com assinatura e carimbo da empresa.
                        </div>
                    `;
                    return via;
                };

                const via1 = buildVia(1, cor1, '1ª VIA — ÓTICA',    true);
                const via2 = buildVia(2, cor2, '2ª VIA — CLIENTE',  false);

                if (tipo === 'via1') {
                    // Página única — via 1
                    const w1 = document.createElement('div');
                    w1.className = 'os-pdf-wrapper';
                    w1.appendChild(via1);
                    gerarPDF(w1, `OS_${sale.number}_via1`);
                } else if (tipo === 'via2') {
                    // Página única — via 2
                    const w2 = document.createElement('div');
                    w2.className = 'os-pdf-wrapper';
                    w2.appendChild(via2);
                    gerarPDF(w2, `OS_${sale.number}_via2`);
                } else {
                    // AMBAS: as duas vias na mesma folha A4
                    // Linha de corte entre as vias
                    const corte = document.createElement('div');
                    corte.className = 'os-corte';
                    corte.innerHTML = `
                        <div class="os-corte-linha"></div>
                        ✂️ &nbsp; RECORTE AQUI — 2ª VIA DO CLIENTE &nbsp; ✂️
                        <div class="os-corte-linha"></div>`;

                    const wrapper = document.createElement('div');
                    wrapper.className = 'os-pdf-wrapper uma-folha';
                    wrapper.appendChild(via1);
                    wrapper.appendChild(corte);
                    wrapper.appendChild(via2);
                    gerarPDF(wrapper, `OS_${sale.number}`, { pageHeight: 297 });
                }
            },
            gerarPDF_Promissoria() {
                const client = state.clients.find(c => c.id === state.currentSale.clientId);
                const sale = state.currentSale;
                const details = state.currentSale.paymentDetails;
                const company = state.company;

                if (!details) {
                    Toast.show('Calcule as parcelas primeiro', 'warning');
                    return;
                }

                const fmt = (dateStr) => {
                    if (!dateStr) return '___/___/______';
                    const d = new Date(dateStr + 'T12:00:00');
                    return d.toLocaleDateString('pt-BR');
                };

                const saldo = details.installmentValue * details.installments;

                // Tabela de parcelas
                let parcelasRows = '';
                details.parcels.forEach(p => {
                    parcelasRows += `<tr>
                        <td style="font-weight:700;">${p.number}/${details.installments}</td>
                        <td>${fmt(p.dueDate)}</td>
                        <td>${Utils.formatCurrency(p.value)}</td>
                        <td style="color:#888;">□ A vencer</td>
                    </tr>`;
                });

                const html = `
                    <div class="promissoria-pdf">
                      <div class="promissoria">
                        <div class="marca-dagua">NOTA PROMISSÓRIA</div>

                        <!-- Faixa topo laranja -->
                        <div class="prom-faixa-topo"></div>

                        <!-- Série / Série -->
                        <div class="prom-faixa-serie">
                            <span class="serie-left">DOCUMENTO COMERCIAL — USO INTERNO</span>
                            <strong>NP-${sale.number.replace('OS-','')} &nbsp;|&nbsp; OS: ${sale.number}</strong>
                        </div>

                        <!-- Cabeçalho empresa -->
                        <div class="header">
                            <div class="empresa-cabecalho">
                                ${company.logo
                                    ? `<div class="prom-logo-circulo" style="background-image:url('${company.logo}')"></div>`
                                    : `<div class="prom-logo-circulo"><span>👁️</span></div>`}
                                <div class="empresa-info">
                                    <div class="empresa-nome">${company.legalName || company.name}</div>
                                    <div class="empresa-subtitulo">ESTABELECIMENTO ÓPTICO</div>
                                    <div class="empresa-dados">CNPJ: ${company.cnpj} &nbsp;|&nbsp; IE: ${company.ie || '—'}</div>
                                    <div class="empresa-dados">${[company.address, company.number, company.neighborhood, company.city+'/'+company.state].filter(Boolean).join(', ')} — CEP: ${company.cep || ''}</div>
                                    <div class="empresa-dados">Tel: ${company.phone} &nbsp;|&nbsp; ${company.email}</div>
                                </div>
                            </div>
                            <div class="numero-promissoria">
                                <div class="numero-label">NOTA PROMISSÓRIA Nº</div>
                                <div class="numero-valor">NP-${sale.number.replace('OS-','')}</div>
                            </div>
                        </div>

                        <!-- Título central -->
                        <div class="titulo-block">
                            <div class="titulo">NOTA PROMISSÓRIA</div>
                            <div class="titulo-sub">TÍTULO EXECUTIVO EXTRAJUDICIAL — LEI Nº 10.406/2002</div>
                        </div>

                        <div class="corpo">

                            <!-- Valor em destaque -->
                            <div class="valor-box">
                                <div>
                                    <div class="valor-box-label">Valor Total da Promissória</div>
                                    <div class="valor-box-num">${Utils.formatCurrency(saldo)}</div>
                                    <div class="valor-box-extenso">${Utils.numeroPorExtenso(saldo)}</div>
                                </div>
                                <div style="text-align:right;font-size:8px;color:#888;line-height:1.7;">
                                    <div><strong>${details.installments}</strong> parcela(s)</div>
                                    <div>de <strong>${Utils.formatCurrency(details.installmentValue)}</strong> cada</div>
                                    ${details.entryValue ? `<div>Entrada: <strong>${Utils.formatCurrency(details.entryValue)}</strong></div>` : ''}
                                </div>
                            </div>

                            <!-- Texto jurídico -->
                            <div class="texto">
                                <p><span class="destaque">PELA PRESENTE NOTA PROMISSÓRIA</span>, eu, <span class="destaque">${client?.name || '___________________'}</span>,
                                portador(a) do CPF nº <span class="destaque">${client?.cpf || '___.___.___-__'}</span>,
                                residente e domiciliado(a) na <span class="destaque">${[client?.address, client?.number, client?.neighborhood, (client?.city||'')+'/'+(client?.state||'')].filter(Boolean).join(', ')}</span>,</p>

                                <p><span class="destaque">PROMETO PAGAR</span> à ordem de <span class="destaque">${company.name}</span>,
                                pessoa jurídica de direito privado, CNPJ nº <span class="destaque">${company.cnpj}</span>,
                                a importância de <span class="destaque">${Utils.formatCurrency(saldo)} (${Utils.numeroPorExtenso(saldo)})</span>,
                                referente ao saldo parcelado da compra realizada em <span class="destaque">${fmt(sale.date)}</span>,
                                conforme Ordem de Serviço nº <span class="destaque">${sale.number}</span>, nas condições abaixo:</p>
                            </div>

                            <!-- Tabela parcelas -->
                            <table class="tabela">
                                <thead>
                                    <tr>
                                        <th>Parcela</th>
                                        <th>Vencimento</th>
                                        <th>Valor (R$)</th>
                                        <th>Situação</th>
                                    </tr>
                                </thead>
                                <tbody>${parcelasRows}</tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="2" style="text-align:right;">TOTAL PARCELADO:</td>
                                        <td colspan="2">${Utils.formatCurrency(saldo)}</td>
                                    </tr>
                                </tfoot>
                            </table>

                            <!-- Grid info -->
                            <div class="info-grid">
                                <div class="info-box">
                                    <h4>📋 Dados da Compra</h4>
                                    <p><strong>OS Nº:</strong> ${sale.number}</p>
                                    <p><strong>Data:</strong> ${fmt(sale.date)}</p>
                                    <p><strong>Total da OS:</strong> ${Utils.formatCurrency(sale.total)}</p>
                                    <p><strong>Entrada paga:</strong> ${Utils.formatCurrency(details.entryValue||0)} (${details.entryPercent||0}%)</p>
                                    <p><strong>Saldo parcelado:</strong> ${Utils.formatCurrency(saldo)}</p>
                                </div>
                                <div class="info-box">
                                    <h4>🏢 Dados do Credor</h4>
                                    <p><strong>${company.name}</strong></p>
                                    <p><strong>CNPJ:</strong> ${company.cnpj}</p>
                                    <p><strong>Endereço:</strong> ${company.address||''}, ${company.number||''}</p>
                                    <p><strong>Cidade:</strong> ${company.city||''}/${company.state||''}</p>
                                    <p><strong>Contato:</strong> ${company.phone}</p>
                                </div>
                            </div>

                            <!-- PIX -->
                            <div class="pix-box">
                                🔑 <strong>PAGAMENTO VIA PIX:</strong> &nbsp; Chave CNPJ: <strong>${company.cnpj}</strong>
                                &nbsp;&nbsp;|&nbsp;&nbsp; ${company.phone ? '📱 WhatsApp: ' + (company.whatsapp||company.phone) : ''}
                            </div>

                            <!-- Juros -->
                            <div class="juros-box">
                                <strong>⚠️ CONDIÇÕES DE INADIMPLÊNCIA:</strong><br>
                                • Multa de <strong>${company.lateFee||2}%</strong> sobre o valor da parcela em atraso &nbsp;|&nbsp;
                                  Juros de <strong>${company.dailyInterest||0.033}% ao dia</strong> (${((company.dailyInterest||0.033)*30).toFixed(2)}% ao mês)<br>
                                • Correção monetária pelo IPCA/INPC a partir do vencimento
                            </div>

                            <!-- Cláusula -->
                            <div class="clausula">
                                <strong>📌 CLÁUSULA DE VENCIMENTO ANTECIPADO:</strong> O não pagamento de qualquer parcela nas datas
                                estipuladas implicará no vencimento antecipado de todas as demais, tornando exigível a totalidade
                                do saldo devedor, independentemente de aviso ou notificação, nos termos do art. 333 do Código Civil.
                            </div>

                            <hr class="separador">

                            <!-- Local e data -->
                            <div class="local-data">${company.city||'____________________'}, ${fmt(new Date().toISOString().slice(0,10))}.</div>

                            <!-- Assinaturas -->
                            <div class="assinaturas">
                                <div class="assinatura-box">
                                    <div class="linha-assinatura"></div>
                                    <div class="assinatura-nome">${client?.name||'___________________'}</div>
                                    <div class="assinatura-info">CPF: ${client?.cpf||'___.___.___-__'}</div>
                                    <div class="assinatura-role">(EMITENTE — DEVEDOR)</div>
                                </div>
                                <div class="assinatura-box">
                                    <div class="linha-assinatura"></div>
                                    <div class="assinatura-nome">${company.name}</div>
                                    <div class="assinatura-info">CNPJ: ${company.cnpj}</div>
                                    <div class="assinatura-role">(CREDOR)</div>
                                </div>
                            </div>

                            <!-- Testemunhas -->
                            <div class="testemunhas-block">
                                <div class="testemunhas-titulo">Testemunhas</div>
                                <div class="testemunhas">
                                    <div class="testemunha">
                                        <p><strong>Testemunha 1:</strong></p>
                                        <div class="linha-testemunha"></div>
                                        <p>Nome: ________________________________</p>
                                        <p>CPF: _________________________________</p>
                                    </div>
                                    <div class="testemunha">
                                        <p><strong>Testemunha 2:</strong></p>
                                        <div class="linha-testemunha"></div>
                                        <p>Nome: ________________________________</p>
                                        <p>CPF: _________________________________</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Rodapé -->
                        <div class="rodape">
                            ${company.name} &nbsp;|&nbsp; CNPJ: ${company.cnpj} &nbsp;|&nbsp;
                            ${company.address||''}, ${company.number||''} — ${company.city||''}/${company.state||''}<br>
                            Tel: ${company.phone} &nbsp;|&nbsp; WhatsApp: ${company.whatsapp||company.phone} &nbsp;|&nbsp; ${company.email}<br>
                            <em>Documento válido como título executivo extrajudicial conforme Lei nº 10.406/2002 (Código Civil Brasileiro)</em>
                        </div>

                        <div class="prom-faixa-base"></div>
                      </div>
                    </div>
                `;

                const elemento = document.createElement('div');
                elemento.innerHTML = html;
                elemento.className = 'promissoria-pdf';
                gerarPDF(elemento, `PROMISSORIA_${sale.number}`);
            },

            gerarPDF_Carne() {
                const client  = state.clients.find(c => c.id === state.currentSale.clientId);
                const sale    = state.currentSale;
                const details = state.currentSale.paymentDetails;
                const company = state.company;

                if (!details || !details.parcels || details.parcels.length === 0) {
                    Toast.show('Calcule as parcelas antes de gerar o carnê', 'warning');
                    return;
                }

                const fd = d => d ? new Date(d + 'T12:00:00').toLocaleDateString('pt-BR') : '—';
                const ext = v => (typeof Utils.numeroPorExtenso === 'function') ? Utils.numeroPorExtenso(v) : '';
                const nomeAbrev = (nome='') => nome.split(' ').slice(0,2).join(' ');
                const PARCELAS_POR_PAG = 5;

                // ── Cabeçalho de cada página (reutilizável) ──────────────────
                const logoHtml = company.logo
                    ? `<div class="carne-header-logo-circulo" style="background-image:url('${company.logo}')"></div>`
                    : `<div class="carne-header-logo-circulo"><span>👁️</span></div>`;

                const buildCabecalho = () => `
                    <div class="carne-faixa-topo"></div>
                    <div class="carne-header-geral">
                        <div class="carne-header-logo-wrap">
                            ${logoHtml}
                            <div>
                                <div class="carne-empresa-nome">${company.name}</div>
                                <div class="carne-empresa-info">
                                    CNPJ: ${company.cnpj || '—'} &nbsp;|&nbsp;
                                    ${[company.address, company.number, company.city, company.state].filter(Boolean).join(', ')}<br>
                                    ${company.phone ? '📞 ' + company.phone + ' &nbsp; ' : ''}${company.whatsapp ? '📱 ' + company.whatsapp + ' &nbsp; ' : ''}${company.email ? '✉️ ' + company.email : ''}
                                </div>
                            </div>
                        </div>
                        <div class="carne-header-os">
                            <div class="carne-header-os-label">Carnê de Pagamento</div>
                            <div class="carne-header-os-num">${sale.number}</div>
                        </div>
                    </div>
                    <div class="carne-cliente-bar">
                        <div class="carne-cliente-item">Cliente<strong>${client?.name || '—'}</strong></div>
                        <div class="carne-cliente-item">CPF<strong>${client?.cpf || '—'}</strong></div>
                        <div class="carne-cliente-item">Total OS<strong>${Utils.formatCurrency(sale.total)}</strong></div>
                        <div class="carne-cliente-item">Entrada<strong>${Utils.formatCurrency(details.entryValue || 0)}</strong></div>
                        <div class="carne-cliente-item">${details.installments}× de<strong>${Utils.formatCurrency(details.installmentValue)}</strong></div>
                    </div>`;

                // ── Uma parcela (linha do talão) ──────────────────────────────
                const carneLogoHtml = company.logo
                    ? `<div class="carne-logo-circulo" style="background-image:url('${company.logo}')"></div>`
                    : `<div class="carne-logo-circulo"><span>👁️</span></div>`;

                const buildParcela = (p, isLast) => `
                    <div class="carne-parcela">
                        <!-- Faixa lateral -->
                        <div class="carne-lateral">
                            <div class="carne-lateral-num">${p.number}</div>
                            <div class="carne-lateral-label">Parcela</div>
                        </div>

                        <!-- Canhoto da empresa -->
                        <div class="carne-canhoto">
                            <div class="carne-canhoto-title">✂ Recibo — ${nomeAbrev(company.name)}</div>
                            <div class="carne-canhoto-row"><span>OS nº</span><span>${sale.number}</span></div>
                            <div class="carne-canhoto-row"><span>Parcela</span><span>${p.number}/${details.installments}</span></div>
                            <div class="carne-canhoto-row"><span>Cliente</span><span>${nomeAbrev(client?.name)}</span></div>
                            <div class="carne-canhoto-row"><span>Valor</span><span>${Utils.formatCurrency(p.value)}</span></div>
                            <div class="carne-canhoto-row"><span>Vencimento</span><span>${fd(p.dueDate)}</span></div>
                            <div class="carne-canhoto-row"><span>Pago em</span><span>___/___/___</span></div>
                            <div class="carne-canhoto-assin">Assinatura / Carimbo</div>
                        </div>

                        <!-- Dados principais -->
                        <div class="carne-dados">
                            <div class="carne-dados-header">
                                <div style="display:flex;align-items:center;gap:2mm;">
                                    ${carneLogoHtml}
                                    <div>
                                        <div class="carne-dados-empresa">${company.name}</div>
                                        <div class="carne-dados-os">OS ${sale.number} &nbsp;·&nbsp; ${client?.name || '—'} &nbsp;·&nbsp; CPF: ${client?.cpf || '—'}</div>
                                    </div>
                                </div>
                                <div class="carne-dados-venc">
                                    <div class="carne-dados-venc-label">Vencimento</div>
                                    <div class="carne-dados-venc-date">${fd(p.dueDate)}</div>
                                </div>
                            </div>

                            <div class="carne-dados-meio">
                                <!-- Infos à esquerda -->
                                <div class="carne-dados-info">
                                    <div class="carne-dados-row"><span>Parcela</span><span>${p.number} de ${details.installments}</span></div>
                                    <div class="carne-dados-row"><span>Cliente</span><span>${client?.name || '—'}</span></div>
                                    <div class="carne-dados-row"><span>Telefone</span><span>${client?.phone || '—'}</span></div>
                                    <div class="carne-dados-row"><span>CNPJ Credor</span><span>${company.cnpj || '—'}</span></div>
                                </div>
                                <!-- Caixa de valor -->
                                <div class="carne-valor-box">
                                    <div class="carne-valor-label">Valor da Parcela</div>
                                    <div class="carne-valor-num">${Utils.formatCurrency(p.value)}</div>
                                    <div class="carne-valor-extenso">${ext(p.value)}</div>
                                    <div class="carne-valor-venc">Venc: ${fd(p.dueDate)}</div>
                                </div>
                            </div>

                            <div class="carne-dados-rodape">
                                <div class="carne-pix-inline">🔑 PIX CNPJ: <strong>${company.cnpj || '—'}</strong></div>
                                <div class="carne-multa-info">⚠️ Atraso: ${company.lateFee || 2}% + ${company.dailyInterest || 0.033}%/dia</div>
                            </div>
                            <div class="carne-contatos">
                                ${company.whatsapp || company.phone ? `<div class="carne-contatos-item">📱 <span>${company.whatsapp || company.phone}</span></div>` : ''}
                                ${company.website ? `<div class="carne-contatos-item">🌐 <span>${company.website}</span></div>` : ''}
                                ${company.email ? `<div class="carne-contatos-item">✉️ <span>${company.email}</span></div>` : ''}
                            </div>
                        </div>
                    </div>
                    ${!isLast ? '<div class="carne-parcela-sep"><div class="carne-parcela-sep-linha"></div><div class="carne-parcela-sep-txt">✂ recorte</div><div class="carne-parcela-sep-linha"></div></div>' : ''}
                `;

                // ── Totalizador (última linha de cada página ou final) ────────
                const buildTotalizador = () => `
                    <div class="carne-totalizador">
                        <div class="carne-totalizador-item">
                            <span class="carne-totalizador-label">Total de Parcelas</span>
                            <span class="carne-totalizador-val">${details.installments}</span>
                        </div>
                        <div class="carne-totalizador-item">
                            <span class="carne-totalizador-label">Valor Unitário</span>
                            <span class="carne-totalizador-val">${Utils.formatCurrency(details.installmentValue)}</span>
                        </div>
                        <div class="carne-totalizador-item">
                            <span class="carne-totalizador-label">Total Parcelado</span>
                            <span class="carne-totalizador-val">${Utils.formatCurrency(details.installmentValue * details.installments)}</span>
                        </div>
                        <div class="carne-totalizador-item">
                            <span class="carne-totalizador-label">Entrada</span>
                            <span class="carne-totalizador-val">${Utils.formatCurrency(details.entryValue || 0)}</span>
                        </div>
                        <div class="carne-totalizador-item">
                            <span class="carne-totalizador-label">Total Geral (OS)</span>
                            <span class="carne-totalizador-val">${Utils.formatCurrency(sale.total)}</span>
                        </div>
                    </div>`;

                // ── Montar páginas (5 parcelas cada) ─────────────────────────
                const parcelas = details.parcels;
                let paginasHtml = '';
                for (let i = 0; i < parcelas.length; i += PARCELAS_POR_PAG) {
                    const grupo = parcelas.slice(i, i + PARCELAS_POR_PAG);
                    const isUltimaPag = (i + PARCELAS_POR_PAG) >= parcelas.length;
                    const parcelasHtml = grupo.map((p, gi) => {
                        const isLastInGrupo = gi === grupo.length - 1;
                        return buildParcela(p, isLastInGrupo);
                    }).join('');

                    paginasHtml += `
                        <div class="carne-talao-page">
                            ${buildCabecalho()}
                            ${parcelasHtml}
                            ${isUltimaPag ? buildTotalizador() : ''}
                        </div>`;
                }

                const el = document.createElement('div');
                el.innerHTML = paginasHtml;

                // Injetar CSS do carnê no elemento para renderização correta
                const style = document.createElement('style');
                style.textContent = Array.from(document.styleSheets)
                    .flatMap(s => { try { return Array.from(s.cssRules).map(r => r.cssText); } catch(e){ return []; } })
                    .filter(r => r.includes('carne-') || r.includes('carne'))
                    .join('\n');
                el.prepend(style);

                gerarPDF(el, `CARNE_${sale.number}`);
            },
            gerarPDF_Comprovante(parcelaIndex) {
                const client  = state.clients.find(c => c.id === state.currentSale.clientId);
                const sale    = state.currentSale;
                const details = state.currentSale.paymentDetails;
                const company = state.company;

                if (!details) {
                    Toast.show('Calcule as parcelas primeiro', 'warning');
                    return;
                }

                const parcela = details.parcels[parcelaIndex];
                if (!parcela) return;

                const fd = d => d ? new Date(d + 'T12:00:00').toLocaleDateString('pt-BR') : '—';
                const isLate   = parcela.daysLate > 0;
                const multa    = isLate ? parcela.value * ((parcela.lateFee    || company.lateFee    || 2)    / 100) : 0;
                const juros    = isLate ? parcela.value * ((parcela.dailyInterest || company.dailyInterest || 0.033) / 100) * parcela.daysLate : 0;
                const totalPago = parcela.value + multa + juros;
                const valorExibido = parcela.paidValue || (isLate ? totalPago : parcela.value);

                const logoHtml = company.logo
                    ? `<div class="comp-logo-circulo" style="background-image:url('${company.logo}')"></div>`
                    : `<div class="comp-logo-circulo"><span>👁️</span></div>`;

                const html = `
                    <div class="comprovante-wrapper">

                        <!-- Topo laranja com logo e empresa -->
                        <div class="comp-topo">
                            ${logoHtml}
                            <div class="comp-empresa-nome">${company.name}</div>
                            <div class="comp-empresa-sub">
                                CNPJ: ${company.cnpj || '—'} &nbsp;|&nbsp;
                                ${[company.address, company.number, company.city, company.state].filter(Boolean).join(', ')}
                            </div>
                        </div>

                        <!-- Título -->
                        <div class="comp-titulo">✅ Comprovante de Pagamento</div>

                        <div class="comp-body">

                            <!-- Grid OS / Parcela / Datas -->
                            <div class="comp-grid">
                                <div class="comp-cell">
                                    <div class="comp-cell-label">OS Nº</div>
                                    <div class="comp-cell-val">${sale.number}</div>
                                </div>
                                <div class="comp-cell">
                                    <div class="comp-cell-label">Parcela</div>
                                    <div class="comp-cell-val">${parcela.number} / ${details.installments}</div>
                                </div>
                                <div class="comp-cell">
                                    <div class="comp-cell-label">Data do Pagamento</div>
                                    <div class="comp-cell-val">${parcela.paidDate ? fd(parcela.paidDate) : fd(new Date().toISOString().slice(0,10))}</div>
                                </div>
                                <div class="comp-cell">
                                    <div class="comp-cell-label">Vencimento</div>
                                    <div class="comp-cell-val" style="${isLate ? 'color:#c0392b' : ''}">${fd(parcela.dueDate)}</div>
                                </div>
                            </div>

                            <!-- Cliente -->
                            <div class="comp-cliente">
                                <div class="comp-cliente-label">Cliente</div>
                                <div class="comp-cliente-nome">${client?.name || '—'}</div>
                                <div class="comp-cliente-cpf">CPF: ${client?.cpf || '—'}</div>
                            </div>

                            <!-- Valor pago em destaque -->
                            <div class="comp-valor-box">
                                <div class="comp-valor-label">Valor Pago</div>
                                <div class="comp-valor-num">${Utils.formatCurrency(valorExibido)}</div>
                                <div class="comp-valor-extenso">${Utils.numeroPorExtenso ? Utils.numeroPorExtenso(valorExibido) : ''}</div>
                            </div>

                            <!-- Tabela de multa/juros (somente se atrasado) -->
                            ${isLate ? `
                            <table class="comp-multa">
                                <tr>
                                    <td>Valor original</td>
                                    <td>${Utils.formatCurrency(parcela.value)}</td>
                                </tr>
                                <tr>
                                    <td>Multa (${parcela.lateFee || company.lateFee || 2}%)</td>
                                    <td>${Utils.formatCurrency(multa)}</td>
                                </tr>
                                <tr>
                                    <td>Juros (${parcela.dailyInterest || company.dailyInterest || 0.033}%/dia × ${parcela.daysLate}d)</td>
                                    <td>${Utils.formatCurrency(juros)}</td>
                                </tr>
                                <tr>
                                    <td>Total com encargos</td>
                                    <td>${Utils.formatCurrency(totalPago)}</td>
                                </tr>
                            </table>` : ''}

                            <!-- Status confirmado -->
                            <div class="comp-status">✅ PAGAMENTO CONFIRMADO</div>

                            <!-- Info adicional -->
                            <div class="comp-info-pag">
                                <div><span>Forma de pagamento</span><span>${parcela.paymentMethod || 'Dinheiro'}</span></div>
                                <div><span>Recebido por</span><span>${sale.seller || '______'}</span></div>
                                ${company.whatsapp || company.phone
                                    ? `<div><span>WhatsApp</span><span>${company.whatsapp || company.phone}</span></div>` : ''}
                                ${company.website
                                    ? `<div><span>Site</span><span>${company.website}</span></div>` : ''}
                            </div>

                            <!-- Assinatura -->
                            <div class="comp-assinatura">
                                <br>
                                Assinatura do Cliente
                            </div>

                        </div>

                        <!-- Rodapé -->
                        <div class="comp-rodape">
                            <strong>${company.name}</strong><br>
                            ${company.address || ''}, ${company.number || ''} — ${company.city || ''}/${company.state || ''}<br>
                            📞 ${company.phone || ''} &nbsp; 📱 ${company.whatsapp || ''} &nbsp; ✉️ ${company.email || ''}<br>
                            ${company.website ? '🌐 ' + company.website + '<br>' : ''}
                            * Documento válido como comprovante de pagamento
                        </div>

                    </div>
                `;

                // Monta elemento com largura real de 80mm — PDF no tamanho exato do conteúdo
                const el = document.createElement('div');
                el.innerHTML = html;

                // Injetar CSS do comprovante
                const style = document.createElement('style');
                style.textContent = Array.from(document.styleSheets)
                    .flatMap(s => { try { return Array.from(s.cssRules).map(r => r.cssText); } catch(e){ return []; } })
                    .filter(r => r.includes('comp-') || r.includes('comprovante'))
                    .join('\n');
                el.prepend(style);

                // PDF no tamanho real: largura 80mm, altura = conteúdo real
                gerarPDFTamanhoReal(el, `COMPROVANTE_OS${sale.number}_P${parcela.number}`, 80);
            },

            // ── WhatsApp: enviar status do pedido para o cliente ──
            enviarStatusPedidoWhatsApp(saleId) {
                const sale    = state.sales.find(s => s.id === saleId);
                const client  = state.clients.find(c => c.id === sale?.clientId);
                const company = state.company;

                if (!sale)   { Toast.show('Venda não encontrada', 'error');   return; }
                if (!client) { Toast.show('Cliente não encontrado', 'error'); return; }

                const phone = (client.whatsapp || client.phone || '').replace(/\D/g, '');
                if (!phone) { Toast.show('Cliente não possui WhatsApp/telefone cadastrado', 'warning'); return; }

                const STATUS_LABEL = {
                    'orcamento':   '📋 Orçamento',
                    'pendente':    '⏳ Aguardando confirmação',
                    'producao':    '🔧 Em produção',
                    'laboratorio': '🔬 No laboratório',
                    'tratamento':  '🧪 Em tratamento',
                    'atrasado':    '⚠️ Com atraso — entraremos em contato',
                    'pronto':      '📦 PRONTO PARA RETIRADA!',
                    'entregue':    '✅ Entregue',
                    'cancelado':   '❌ Cancelado',
                };
                const STATUS_MSG = {
                    'pronto':      '🎉 Seu pedido está pronto! Compareça à nossa loja para retirar.',
                    'laboratorio': 'Estamos trabalhando no seu pedido com todo cuidado! 🔍',
                    'producao':    'Estamos trabalhando no seu pedido com todo cuidado! 🔍',
                    'tratamento':  'Estamos trabalhando no seu pedido com todo cuidado! 🔍',
                    'atrasado':    'Pedimos desculpas pelo atraso. Em breve entraremos em contato.',
                };

                const fd = d => d ? new Date(d + 'T12:00:00').toLocaleDateString('pt-BR') : '—';

                let msg = ConfigWpp.get('statusPedido')
                    .replace(/{{NOME}}/g,       client.name.split(' ')[0])
                    .replace(/{{EMPRESA}}/g,    company.name || '')
                    .replace(/{{OS}}/g,         sale.number || '')
                    .replace(/{{DATA_VENDA}}/g, fd(sale.date))
                    .replace(/{{PREVISAO}}/g,   sale.deliveryForecast ? fd(sale.deliveryForecast) : '—')
                    .replace(/{{STATUS}}/g,     STATUS_LABEL[sale.status] || sale.status || '—')
                    .replace(/{{MSG_STATUS}}/g, STATUS_MSG[sale.status]   || '')
                    .replace(/{{TELEFONE}}/g,   [company.phone, company.whatsapp].filter(Boolean).join(' | '));

                WppConfirm.show({
                    nome:     client.name,
                    phone:    phone,
                    subtitle: `Status da OS ${sale.number}`,
                    msg:      msg,
                    url:      `https://wa.me/55${phone}?text=${encodeURIComponent(msg)}`
                });
            },

            enviarStatusPedidoWhatsAppAtual() {
                const saleNumber = document.getElementById('saleNumber')?.value;
                const sale = state.sales.find(s => s.number === saleNumber) ||
                             (state.currentSale.clientId ? state.currentSale : null);
                if (!sale?.id) {
                    // Se for a OS atual (não salva ainda), usa clientId do currentSale
                    const client  = state.clients.find(c => c.id === state.currentSale.clientId);
                    const company = state.company;
                    if (!client) { Toast.show('Selecione um cliente primeiro', 'warning'); return; }
                    const phone = (client.whatsapp || client.phone || '').replace(/\D/g, '');
                    if (!phone) { Toast.show('Cliente sem WhatsApp/telefone', 'warning'); return; }
                    const status = document.getElementById('saleStatus')?.value || 'pendente';
                    // chama reutilizando a lógica com objeto temporário
                    const fakeSale = { ...state.currentSale, id: '__temp__', status };
                    state.sales.push(fakeSale);
                    this.enviarStatusPedidoWhatsApp('__temp__');
                    state.sales.pop();
                    return;
                }
                this.enviarStatusPedidoWhatsApp(sale.id);
            },

            sendWhatsApp() {
                const client = state.clients.find(c => c.id === state.currentSale.clientId);
                if (!client || !client.phone) {
                    Toast.show('Cliente não possui telefone cadastrado', 'warning');
                    return;
                }
                
                const phone = client.phone.replace(/\D/g, '');
                const details = state.currentSale.paymentDetails;
                
                let message = `Olá ${client.name.split(' ')[0]}! 👋\n\n`;
                message += `Segue o plano de pagamento da sua compra:\n`;
                message += `📍 OS: ${document.getElementById('saleNumber').value}\n`;
                message += `💰 Entrada: ${Utils.formatCurrency(details.entryValue)}\n`;
                message += `📆 ${details.installments}x de ${Utils.formatCurrency(details.installmentValue)}\n\n`;
                message += `📅 Datas de vencimento:\n`;
                
                details.parcels.forEach(p => {
                    message += `- Parcela ${p.number}: ${Utils.formatDate(p.dueDate)}\n`;
                });
                
                message += `\n🔄 Qualquer dúvida estamos à disposição!`;
                
                const encodedMessage = encodeURIComponent(message);
                const whatsappUrl = `https://wa.me/55${phone}?text=${encodedMessage}`;
                
                window.open(whatsappUrl, '_blank');
            },

            // ── WhatsApp: enviar receituário como texto formatado ──
            enviarReceituarioWhatsApp(clientId) {
                const clientTarget = clientId
                    ? state.clients.find(c => c.id === clientId)
                    : state.clients.find(c => c.id === state.currentSale.clientId);

                if (!clientTarget) { Toast.show('Selecione um cliente primeiro', 'warning'); return; }

                const phone = (clientTarget.whatsapp || clientTarget.phone || '').replace(/\D/g, '');
                if (!phone) { Toast.show('Cliente não possui WhatsApp/telefone cadastrado', 'warning'); return; }

                const presc   = state.prescriptions.find(p => p.clientId === clientTarget.id);
                const company = state.company;
                const fmt     = v => v || '—';
                const endereco = [company.address, company.number ? ', ' + company.number : '', company.city ? ' — ' + company.city : '', company.state ? '/' + company.state : ''].filter(Boolean).join('');

                let dadosOD = '', dadosOE = '', dadosExtra = '';
                if (presc) {
                    // Suporta tanto estrutura antiga (presc.odSph) quanto nova (presc.od.sph)
                    const odSph  = presc.od?.sph  || presc.odSph  || '—';
                    const odCyl  = presc.od?.cyl  || presc.odCyl  || '—';
                    const odAxis = presc.od?.axis || presc.odAxis || '—';
                    const odAdd  = presc.od?.add  || presc.odAdd  || '';
                    const odDnp  = presc.od?.dnp  || presc.odDnp  || '';
                    const oeSph  = presc.oe?.sph  || presc.oeSph  || '—';
                    const oeCyl  = presc.oe?.cyl  || presc.oeCyl  || '—';
                    const oeAxis = presc.oe?.axis || presc.oeAxis || '—';
                    const oeAdd  = presc.oe?.add  || presc.oeAdd  || '';
                    const oeDnp  = presc.oe?.dnp  || presc.oeDnp  || '';

                    dadosOD = `  ESF: ${fmt(odSph)} | CIL: ${fmt(odCyl)} | EIXO: ${fmt(odAxis)}°` +
                              (odAdd && odAdd !== '0.00' ? `\n  ADD: ${fmt(odAdd)}` : '') +
                              (odDnp ? ` | DNP: ${fmt(odDnp)} mm` : '');
                    dadosOE = `  ESF: ${fmt(oeSph)} | CIL: ${fmt(oeCyl)} | EIXO: ${fmt(oeAxis)}°` +
                              (oeAdd && oeAdd !== '0.00' ? `\n  ADD: ${fmt(oeAdd)}` : '') +
                              (oeDnp ? ` | DNP: ${fmt(oeDnp)} mm` : '');
                    dadosExtra = [
                        presc.dp          ? `📏 *DP Total:* ${presc.dp} mm`           : '',
                        presc.height      ? `📐 *Altura:* ${presc.height} mm`         : '',
                        presc.notes       ? `📝 *Obs:* ${presc.notes}`                : '',
                        presc.optometrist ? `🩺 *Profissional:* ${presc.optometrist}` : ''
                    ].filter(Boolean).join('\n');
                } else {
                    dadosOD = '_(não informado)_';
                    dadosOE = '_(não informado)_';
                }

                let msg = ConfigWpp.get('receituario')
                    .replace(/{{PACIENTE}}/g,    clientTarget.name)
                    .replace(/{{DATA}}/g,        presc?.date ? new Date(presc.date + 'T12:00:00').toLocaleDateString('pt-BR') : new Date().toLocaleDateString('pt-BR'))
                    .replace(/{{DADOS_OD}}/g,    dadosOD)
                    .replace(/{{DADOS_OE}}/g,    dadosOE)
                    .replace(/{{DADOS_EXTRA}}/g, dadosExtra)
                    .replace(/{{EMPRESA}}/g,     company.name || '')
                    .replace(/{{ENDERECO}}/g,    endereco)
                    .replace(/{{TELEFONE}}/g,    company.whatsapp || company.phone || '');

                WppConfirm.show({
                    nome:     clientTarget.name,
                    phone:    phone,
                    subtitle: 'Receituário Óptico',
                    msg:      msg,
                    url:      `https://wa.me/55${phone}?text=${encodeURIComponent(msg)}`
                });
            },

            // ── WhatsApp: enviar comprovante de pagamento como texto formatado ──
            enviarComprovanteWhatsApp(parcelaIndex) {
                const client  = state.clients.find(c => c.id === state.currentSale.clientId);
                const sale    = state.currentSale;
                const details = state.currentSale.paymentDetails;
                const company = state.company;

                if (!client) { Toast.show('Selecione um cliente primeiro', 'warning'); return; }
                if (!details) { Toast.show('Calcule as parcelas primeiro', 'warning'); return; }

                const phone = (client.whatsapp || client.phone || '').replace(/\D/g, '');
                if (!phone) { Toast.show('Cliente não possui WhatsApp/telefone cadastrado', 'warning'); return; }

                const parcela = details.parcels[parcelaIndex];
                if (!parcela) return;

                const fd = d => d ? new Date(d + 'T12:00:00').toLocaleDateString('pt-BR') : '—';
                const isLate = parcela.daysLate > 0;
                const multa  = isLate ? parcela.value * ((parcela.lateFee || company.lateFee || 2) / 100) : 0;
                const juros  = isLate ? parcela.value * ((parcela.dailyInterest || company.dailyInterest || 0.033) / 100) * parcela.daysLate : 0;
                const total  = parcela.paidValue || (isLate ? parcela.value + multa + juros : parcela.value);
                const endereco = [company.address, company.number ? ', ' + company.number : '', company.city ? ' — ' + company.city : '', company.state ? '/' + company.state : ''].filter(Boolean).join('');

                let msg = ConfigWpp.get('comprovante')
                    .replace(/{{NOME}}/g,            client.name)
                    .replace(/{{CPF}}/g,             client.cpf || '—')
                    .replace(/{{OS}}/g,              sale.number || '')
                    .replace(/{{PARCELA}}/g,         `${parcela.number} de ${details.installments}`)
                    .replace(/{{VENCIMENTO}}/g,      fd(parcela.dueDate))
                    .replace(/{{DATA_PAGAMENTO}}/g,  parcela.paidDate ? fd(parcela.paidDate) : fd(new Date().toISOString().slice(0,10)))
                    .replace(/{{VALOR}}/g,           Utils.formatCurrency(total))
                    .replace(/{{FORMA_PAGAMENTO}}/g, parcela.paymentMethod || 'Dinheiro')
                    .replace(/{{EMPRESA}}/g,         company.name || '')
                    .replace(/{{ENDERECO}}/g,        endereco)
                    .replace(/{{TELEFONE}}/g,        [company.phone, company.whatsapp].filter(Boolean).join(' | '));

                WppConfirm.show({
                    nome:     client.name,
                    phone:    phone,
                    subtitle: `Comprovante Parcela ${parcela.number}/${details.installments} — OS ${sale.number}`,
                    msg:      msg,
                    url:      `https://wa.me/55${phone}?text=${encodeURIComponent(msg)}`
                });
            },

            save() {
                if (!state.currentSale.clientId) {
                    Toast.show('Selecione um cliente', 'warning');
                    return;
                }
                
                if (state.currentSale.items.length === 0) {
                    Toast.show('Adicione pelo menos um item', 'warning');
                    return;
                }

                // Calcula desconto do método (PIX 5% opcional, Dinheiro 3% opcional)
                const method = state.currentSale.paymentMethod;
                const grossTotal = state.currentSale._grossTotal || state.currentSale.total || 0;
                let methodDiscount = 0;
                if (method === 'pix' && document.getElementById('pixDescontoAtivo')?.checked !== false)
                    methodDiscount = grossTotal * 0.05;
                if (method === 'cash' && document.getElementById('cashDescontoAtivo')?.checked !== false)
                    methodDiscount = grossTotal * 0.03;
                // Total final já foi aplicado pelo PAY object
                const finalTotal = state.currentSale.total;

                // ── MODO PAGAMENTO DUPLO ────────────────────────────────────
                const isDual = state.currentSale._dualMode && state.currentSale._dualPayments?.length === 2;
                let paymentDetailsToSave = null;
                let dualPaymentsToSave   = null;
                const metodosAVista = ['pix', 'cash', 'debit', 'credit'];

                if (isDual) {
                    // Valida que a soma bate com o total
                    const dp = state.currentSale._dualPayments;
                    const soma = (dp[0].value || 0) + (dp[1].value || 0);
                    const totalRef = state.currentSale._grossTotal || state.currentSale.total || 0;
                    if (Math.abs(soma - totalRef) > 0.05) {
                        Toast.show('A soma das 2 formas não corresponde ao total da OS', 'warning');
                        return;
                    }
                    // Gera parcelas para cada forma que for crediário
                    const firstDate = new Date();
                    firstDate.setDate(firstDate.getDate() + 30);
                    const firstDateStr = firstDate.toISOString().slice(0,10);
                    dualPaymentsToSave = dp.map(slot => ({
                        method:   slot.method,
                        value:    slot.value,
                        entry:    slot.entry    || 0,
                        retirada: slot.retirada || 0,
                        parcelas: slot.method === 'installment' ? this._gerarParcelasDual(slot, firstDateStr) : [],
                        nParcelas: slot.method === 'installment' ? (slot.parcelas || 2) : 0,
                        parcValue: slot.method === 'installment'
                            ? Math.max(0, slot.value - (slot.entry||0) - (slot.retirada||0)) / (slot.parcelas || 2) : 0
                    }));
                    paymentDetailsToSave = { dual: true, slots: dualPaymentsToSave };

                } else {
                    // ── MODO SIMPLES ─────────────────────────────────────────
                    // Captura retirada para métodos à vista com entrada parcial
                    paymentDetailsToSave = state.currentSale.paymentDetails
                        ? JSON.parse(JSON.stringify(state.currentSale.paymentDetails)) : null;
                    if (metodosAVista.includes(method)) {
                        const entradaIds = { pix:'pixEntrada', cash:'cashEntrada', debit:'debitEntrada', credit:'creditEntrada' };
                        const entradaEl  = document.getElementById(entradaIds[method]);
                        const entradaVal = entradaEl ? (parseFloat(entradaEl.value) || 0) : 0;
                        const totalFinal = state.currentSale.total || 0;
                        const retiradaVal = Math.max(0, totalFinal - entradaVal);
                        if (entradaVal > 0.01 && retiradaVal > 0.01) {
                            paymentDetailsToSave = paymentDetailsToSave || {};
                            paymentDetailsToSave.retiradaValue = retiradaVal;
                            paymentDetailsToSave.entradaValue  = entradaVal;
                        }
                    }
                }
                
                const sale = {
                    id: state.editingSaleId || Utils.generateId('SALE'),
                    updated_at: new Date().toISOString(),
                    number: document.getElementById('saleNumber').value,
                    date: document.getElementById('saleDate').value,
                    unit: document.getElementById('saleUnit').value,
                    seller: document.getElementById('saleSeller').value,
                    deliveryForecast: document.getElementById('deliveryForecast').value,
                    clientId: state.currentSale.clientId,
                    items: [...state.currentSale.items],
                    subtotal: state.currentSale.subtotal,
                    discount: state.currentSale.discount,
                    addition: state.currentSale.addition,
                    grossTotal,          // total bruto (sem desconto de método)
                    methodDiscount,      // desconto do método (PIX/Dinheiro)
                    total: finalTotal,   // total final (com desconto de método)
                    paymentMethod: method,
                    paymentMode: isDual ? 'dual' : (state.currentSale.paymentMode || 'single'),
                    mixedPayments: state.currentSale.mixedPayments ? [...state.currentSale.mixedPayments] : null,
                    paymentDetails: paymentDetailsToSave,
                    dualPayments: dualPaymentsToSave,
                    observations: document.getElementById('saleObservations').value,
                    status: document.getElementById('saleStatus').value,
                    statusHistory: [{ date: new Date().toISOString(), status: 'Criada' }]
                };
                
                if (state.editingSaleId) {
                    const index = state.sales.findIndex(s => s.id === state.editingSaleId);
                    if (index !== -1) {
                        state.sales[index] = sale;
                    }
                    state.editingSaleId = null;
                } else {
                    state.sales.push(sale);
                    const currentYear = new Date().getFullYear();
                    if (!state.lastOsCounter) state.lastOsCounter = {};
                    state.lastOsCounter[currentYear] = (state.lastOsCounter[currentYear] || 1) + 1;
                }
                
                // Salva localmente de forma assíncrona mas garante que state já está atualizado
                App.saveData(true); // silent=true evita toast duplicado
                SupaSync.inserirVenda(sale);
                this.clearForm();
                this.renderHistory();
                // Atualiza o dashboard imediatamente com os dados já em memória (state.sales)
                try { Dashboard.update(); } catch(e) {}
                Toast.show('Venda salva com sucesso! ✅', 'success');
                const osNumEl = document.getElementById('osGeradoNumero');
                if (osNumEl) osNumEl.textContent = 'OS: ' + sale.number;
                // Reset botões de situação
                Sales._osGeradoSaleId = sale.id;
                ['osGeradoBtnPago','osGeradoBtnPendente'].forEach(function(id){
                    var b=document.getElementById(id);
                    if(b){b.style.background='#fff';b.style.color='#555';b.style.borderColor='#ddd';}
                });
                var lbl=document.getElementById('osGeradoPagtoLabel');
                if(lbl) lbl.textContent='Selecione a situação — isso remove da lista de Contas a Receber';
                Modal.show('osGeradoModal');
            },

            clearForm() {
                state.currentSale = {
                    number: '',
                    date: new Date().toISOString().slice(0, 10),
                    unit: 'barueri',
                    seller: '',
                    deliveryForecast: '',
                    clientId: null,
                    items: [],
                    subtotal: 0,
                    discount: 0,
                    addition: 0,
                    total: 0,
                    paymentMethod: 'installment',
                    paymentMode: 'single',
                    mixedPayments: null,
                    paymentDetails: null,
                    observations: '',
                    status: 'orcamento',
                    statusHistory: []
                };
                
                const sellerEl = document.getElementById('saleSeller');
                const discountEl = document.getElementById('discountValue');
                const additionEl = document.getElementById('additionValue');
                const obsEl = document.getElementById('saleObservations');
                const selectedClientEl = document.getElementById('selectedClientData');
                const prescSectionEl = document.getElementById('prescSection');
                const clientSearchEl = document.getElementById('clientSearchResults');
                const statusEl = document.getElementById('saleStatus');
                
                if (sellerEl) sellerEl.value = '';
                if (discountEl) { discountEl.value = '0'; }
                if (additionEl) { additionEl.value = '0'; }
                if (obsEl) obsEl.value = '';
                if (typeof professionalEl !== 'undefined' && professionalEl) professionalEl.value = '';
                const clientSelectEl = document.getElementById('clientSelect');
                if (clientSelectEl) clientSelectEl.innerHTML = '<option value="">Selecione um cliente</option>';
                const entryValEl = document.getElementById('entryValue');
                if (entryValEl) entryValEl.value = '0';
                const retiradaEntryEl = document.getElementById('retiradaEntry');
                if (retiradaEntryEl) retiradaEntryEl.value = '0';
                const entryPctEl = document.getElementById('entryPercent');
                if (entryPctEl) entryPctEl.value = '0';
                if (selectedClientEl) selectedClientEl.style.display = 'none';
                if (prescSectionEl) prescSectionEl.style.display = 'none';
                if (clientSearchEl) clientSearchEl.style.display = 'none';
                const searchClientSaleEl = document.getElementById('searchClientSale');
                if (searchClientSaleEl) searchClientSaleEl.value = '';
                if (statusEl) statusEl.value = 'orcamento';
                // Oculta todos os painéis de pagamento
                ['pixDetails','cashDetails','debitDetails','creditDetails','installmentDetails'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) { el.classList.add('d-none'); el.style.display = ''; }
                });
                // Reseta checkboxes de desconto opcional
                const pixCb = document.getElementById('pixDescontoAtivo');
                if (pixCb) pixCb.checked = true;
                const cashCb = document.getElementById('cashDescontoAtivo');
                if (cashCb) cashCb.checked = true;
                // Oculta alertas de retirada/troco
                ['pixAlerta','cashAlerta','retiradaAlert'].forEach(id => {
                    const el = document.getElementById(id); if (el) el.style.display = 'none';
                });
                // Reseta TODOS os campos de cada método de pagamento (novos IDs)
                ['pixEntrada','cashEntrada','cashRecebido','creditEntrada','debitEntrada',
                 'installmentCount','lateFee','dailyInterest'].forEach(id => {
                    const el = document.getElementById(id);
                    if (!el) return;
                    if (id === 'installmentCount') el.value = '2';
                    else if (id === 'lateFee') el.value = '2';
                    else if (id === 'dailyInterest') el.value = '0.033';
                    else el.value = '0';
                });
                // Limpa tabela de parcelas
                const instBody = document.getElementById('installmentsTableBody');
                if (instBody) instBody.innerHTML = '';
                // Displays de retirada/troco/valores (novos IDs)
                ['pixRetirada','cashRetirada','cashTroco','creditRetirada','debitRetirada',
                 'pixBruto','pixDesconto','pixFinal',
                 'cashBruto','cashDesconto','cashFinal',
                 'debitTotal','creditTotal','creditParcelaVal',
                 'installmentValue','totalSaleValue','entrySummary','balanceSummary',
                 'pixAlertaVal','cashAlertaVal','retiradaValor',
                 // IDs antigos por compatibilidade legado
                 'pixRetiradaVal','cashRetiradaVal','cashChange','creditRetiradaVal','debitRetiradaVal',
                 'pixOriginalValue','pixDiscount','pixFinalValue',
                 'cashOriginalValue','cashDiscount','cashFinalValue'
                ].forEach(id => {
                    const el = document.getElementById(id); if (el) el.textContent = 'R$ 0,00';
                });
                // Reseta sumário de parcelas
                const totalParcelsSummary = document.getElementById('totalParcelsSummary');
                if (totalParcelsSummary) totalParcelsSummary.textContent = '0x';
                
                this.generateOsNumber();
                this.setDefaultDates();
                this.renderItems();
                this.calculateTotal();
                // Reset payment mode to single
                const radioSingle = document.querySelector('input[name="paymentMode"][value="single"]');
                if (radioSingle) { radioSingle.checked = true; this.setPaymentMode('single'); }
                else this.selectPayment('installment');
                // Limpa linhas do pagamento misto
                const mixedRows = document.getElementById('mixedPaymentRows');
                if (mixedRows) mixedRows.innerHTML = '';
                state.editingSaleId = null;
                // Reset modo duplo
                state.currentSale._dualMode = false;
                state.currentSale._dualPayments = null;
                this.setDualMode(false);
                // Limpa campos do painel duplo
                ['dual1Value','dual2Value','dual1Entry','dual1Retirada','dual2Entry','dual2Retirada'].forEach(id => {
                    const el = document.getElementById(id); if (el) el.value = '';
                });
                ['dual1Parcelas','dual2Parcelas'].forEach(id => {
                    const el = document.getElementById(id); if (el) el.value = '2';
                });
                ['dual1ParcelaInfo','dual2ParcelaInfo'].forEach(id => {
                    const el = document.getElementById(id); if (el) el.textContent = '—';
                });
            },

            finalize() {
                Modal.showConfirm('Finalizar venda?', () => {
                    this.save();
                });
            },

            _osGeradoSaleId: null,

            _setOsGeradoPagamento(situacao) {
                var saleId = Sales._osGeradoSaleId;
                if (!saleId) return;
                var sale = state.sales.find(function(s){ return s.id === saleId; });
                if (!sale) return;
                var btnP = document.getElementById('osGeradoBtnPago');
                var btnPend = document.getElementById('osGeradoBtnPendente');
                var lbl = document.getElementById('osGeradoPagtoLabel');
                if (situacao === 'pago') {
                    sale.paymentStatus = 'pago';
                    sale.paidAt = new Date().toISOString();
                    sale.updated_at = sale.paidAt;
                    if (sale.paymentDetails && sale.paymentDetails.parcels) {
                        sale.paymentDetails.parcels.forEach(function(p){
                            p.status='pago'; p.paid=true;
                            p.paidDate=sale.paidAt.slice(0,10);
                            p.paidValue=p.paidValue||p.value;
                        });
                    }
                    if(btnP){btnP.style.background='#28a745';btnP.style.color='white';btnP.style.borderColor='#28a745';}
                    if(btnPend){btnPend.style.background='#fff';btnPend.style.color='#555';btnPend.style.borderColor='#ddd';}
                    if(lbl) lbl.textContent='✅ Marcado como PAGO — não aparece em Contas a Receber';
                } else {
                    sale.paymentStatus = 'pendente';
                    sale.updated_at = new Date().toISOString();
                    delete sale.paidAt;
                    if (sale.paymentDetails && sale.paymentDetails.parcels) {
                        sale.paymentDetails.parcels.forEach(function(p){
                            p.status='aberto'; p.paid=false;
                            delete p.paidDate; delete p.paidValue;
                        });
                    }
                    if(btnP){btnP.style.background='#fff';btnP.style.color='#555';btnP.style.borderColor='#ddd';}
                    if(btnPend){btnPend.style.background='#ffc107';btnPend.style.color='#333';btnPend.style.borderColor='#ffc107';}
                    if(lbl) lbl.textContent='⏳ Marcado como PENDENTE — aparece em Contas a Receber';
                }
                var idx = state.sales.findIndex(function(s){ return s.id === saleId; });
                if (idx !== -1) state.sales[idx] = sale;
                App.saveData();
                SupaSync.inserirVenda(sale); // push atualização ao Supabase
                if (typeof ContasManager !== 'undefined') { try { ContasManager.renderAll?.(); } catch(e){} }
                try { Dashboard.update(); } catch(e) {}
                Toast.show(situacao==='pago' ? '✅ Venda marcada como PAGA!' : '⏳ Venda marcada como PENDENTE',
                           situacao==='pago' ? 'success' : 'warning');
            },

            view(id) {
                const sale   = state.sales.find(s => s.id === id);
                if (!sale) return;
                const client = state.clients.find(c => c.id === sale.clientId);
                const fd = d => d ? new Date(d+'T12:00:00').toLocaleDateString('pt-BR') : '—';

                // Tabela de status
                const ST = [
                    {v:'orcamento',   e:'📋', l:'Orçamento',         c:'#17a2b8'},
                    {v:'pendente',    e:'⏳', l:'Pendente',           c:'#e0a800'},
                    {v:'producao',    e:'🔧', l:'Em Produção',        c:'#6610f2'},
                    {v:'laboratorio', e:'🔬', l:'Laboratório',        c:'#0056b3'},
                    {v:'tratamento',  e:'🧪', l:'Tratamento',         c:'#6f42c1'},
                    {v:'atrasado',    e:'⚠️', l:'Atrasado',           c:'#c0392b'},
                    {v:'pronto',      e:'📦', l:'Pronto p/ Retirada', c:'#fd7e14'},
                    {v:'entregue',    e:'✅', l:'Entregue',           c:'#28a745'},
                    {v:'cancelado',   e:'❌', l:'Cancelado',          c:'#dc3545'},
                ];
                const cur = sale.status;
                const stAtual = ST.find(s => s.v===cur||(s.v==='producao'&&cur==='production')||(s.v==='pronto'&&cur==='ready')||(s.v==='entregue'&&cur==='delivered')) || {e:'❓',l:cur||'—',c:'#6c757d'};

                // Botões de status
                const botoesStatus = ST.map(s => {
                    const on = cur===s.v||(s.v==='producao'&&cur==='production')||(s.v==='pronto'&&cur==='ready')||(s.v==='entregue'&&cur==='delivered');
                    return `<button onclick="Sales._salvarStatusBtn('${sale.id}','${s.v}',this)"${on?' data-ativo="1"':''}
                        style="display:inline-flex;align-items:center;gap:4px;padding:5px 12px;border-radius:20px;
                        border:2px solid ${on?s.c:'#ddd'};background:${on?s.c:'#fff'};color:${on?'#fff':'#555'};
                        font-size:11px;font-weight:${on?'700':'500'};cursor:pointer;transition:all .15s;margin:0;
                        box-shadow:${on?'0 2px 8px '+s.c+'66':'none'};">
                        ${s.e} ${s.l}</button>`;
                }).join('');

                // Itens
                const itensRows = (sale.items||[]).map(item=>`
                    <tr style="border-bottom:1px solid #f0f0f0;">
                        <td style="padding:7px 10px;">${Utils.sanitizeHTML(item.name||'')}</td>
                        <td style="padding:7px 10px;text-align:center;">${item.qty||1}</td>
                        <td style="padding:7px 10px;text-align:right;color:#666;">${Utils.formatCurrency(item.price||0)}</td>
                        <td style="padding:7px 10px;text-align:right;font-weight:700;color:#ff6b00;">${Utils.formatCurrency(item.subtotal||0)}</td>
                    </tr>`).join('');

                // Parcelas
                const parcels = sale.paymentDetails?.parcels || [];
                const isPago = p => p.status === 'pago' || p.status === 'paid';
                const totalPago   = parcels.filter(isPago).reduce((a,p)=>a+(p.paidValue||p.value),0);
                const totalAberto = parcels.filter(p=>!isPago(p)).reduce((a,p)=>a+p.value,0);
                const parcelasRows = parcels.map(p => {
                    const pago = isPago(p);
                    const atrasado = !pago && p.dueDate && new Date(p.dueDate+'T12:00:00') < new Date();
                    const [bg,cor,label] = pago
                        ? ['#d4edda','#155724','✅ Pago']
                        : atrasado
                            ? ['#f8d7da','#721c24','🔴 Atrasado']
                            : ['#fff3cd','#856404','⏳ Aberto'];
                    return `<tr style="border-bottom:1px solid #f5f5f5;">
                        <td style="padding:6px 10px;font-weight:700;">${p.number}/${sale.paymentDetails.installments}</td>
                        <td style="padding:6px 10px;">${fd(p.dueDate)}</td>
                        <td style="padding:6px 10px;text-align:right;font-weight:700;">${Utils.formatCurrency(p.value)}</td>
                        <td style="padding:6px 10px;"><span style="background:${bg};color:${cor};padding:2px 9px;border-radius:12px;font-size:11px;font-weight:700;white-space:nowrap;">${label}</span></td>
                    </tr>`;
                }).join('');

                const html = `<div style="font-family:Arial,sans-serif;">

                    <!-- ── Cabeçalho ── -->
                    <div style="background:linear-gradient(135deg,#ff6b00,#d45000);color:white;padding:14px 18px;margin:-16px -16px 16px;border-radius:8px 8px 0 0;">
                        <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:10px;">
                            <div>
                                <div style="font-size:10px;opacity:.8;text-transform:uppercase;letter-spacing:1.5px;">Ordem de Serviço</div>
                                <div style="font-size:26px;font-weight:900;letter-spacing:1px;line-height:1.1;">${sale.number}</div>
                                <div style="font-size:11px;opacity:.85;margin-top:4px;">📅 Abertura: ${fd(sale.date)} &nbsp;|&nbsp; 🚚 Entrega: ${fd(sale.deliveryForecast)}</div>
                            </div>
                            <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px;">
                                <span style="background:${stAtual.c};padding:5px 14px;border-radius:20px;font-size:12px;font-weight:700;box-shadow:0 2px 8px rgba(0,0,0,.3);white-space:nowrap;">
                                    ${stAtual.e} ${stAtual.l}
                                </span>
                                <button onclick="Modal.close('viewModal');setTimeout(()=>Sales.edit('${sale.id}'),80);"
                                    style="background:rgba(255,255,255,.18);border:1.5px solid rgba(255,255,255,.7);color:white;padding:6px 14px;border-radius:20px;cursor:pointer;font-size:12px;font-weight:700;display:flex;align-items:center;gap:5px;backdrop-filter:blur(4px);">
                                    ✏️ Editar Venda
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- ── Status clicável ── -->
                    <div style="margin-bottom:14px;padding:12px 14px;background:#f8f9fa;border-radius:10px;border:1px solid #e8e8e8;">
                        <div style="font-size:10px;color:#999;text-transform:uppercase;letter-spacing:.8px;margin-bottom:9px;display:flex;align-items:center;gap:7px;">
                            🏷️ <span>Alterar Status</span>
                            <span style="background:#ff6b00;color:white;font-size:9px;padding:1px 7px;border-radius:8px;font-weight:700;text-transform:none;">toque para mudar</span>
                        </div>
                        <div style="display:flex;flex-wrap:wrap;gap:6px;">${botoesStatus}</div>
                    </div>

                    <!-- ── Info grid ── -->
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;">
                        <div style="background:#fff8f5;padding:11px 13px;border-radius:9px;border-left:4px solid #ff6b00;">
                            <div style="font-size:9px;color:#ff6b00;font-weight:700;text-transform:uppercase;letter-spacing:.6px;margin-bottom:5px;">👤 Cliente</div>
                            <div style="font-size:14px;font-weight:800;color:#1a1a1a;">${Utils.sanitizeHTML(client?.name||'—')}</div>
                            <div style="font-size:11px;color:#666;margin-top:3px;">📄 ${client?.cpf||'—'}</div>
                            <div style="font-size:11px;color:#666;">📞 ${client?.phone||'—'}</div>
                        </div>
                        <div style="background:#f0fdf4;padding:11px 13px;border-radius:9px;border-left:4px solid #28a745;">
                            <div style="font-size:9px;color:#28a745;font-weight:700;text-transform:uppercase;letter-spacing:.6px;margin-bottom:5px;">💰 Financeiro</div>
                            <div style="font-size:18px;font-weight:900;color:#1a1a1a;">${Utils.formatCurrency(sale.total)}</div>
                            ${sale.discount > 0 ? `<div style="font-size:11px;color:#666;margin-top:2px;">Desconto manual: <span style="color:#dc3545;font-weight:600;">- ${Utils.formatCurrency(sale.discount)}</span></div>` : ''}
                            ${sale.methodDiscount > 0 ? `<div style="font-size:11px;color:#2e7d32;margin-top:1px;">Desconto método: <span style="font-weight:700;">- ${Utils.formatCurrency(sale.methodDiscount)}</span></div>` : ''}
                            <div style="font-size:11px;color:#666;margin-top:2px;">Pagamento: <strong>${{'pix':'PIX','cash':'Dinheiro','debit':'Débito','credit':'Crédito','installment':'Crediário'}[sale.paymentMethod]||sale.paymentMethod||'—'}</strong></div>
                        </div>
                        <div style="background:#f8f9fa;padding:11px 13px;border-radius:9px;">
                            <div style="font-size:9px;color:#888;font-weight:700;text-transform:uppercase;letter-spacing:.6px;margin-bottom:4px;">🧑‍💼 Vendedor</div>
                            <div style="font-size:13px;font-weight:700;">${Utils.sanitizeHTML(sale.seller||'—')}</div>
                        </div>
                        <div style="background:#f8f9fa;padding:11px 13px;border-radius:9px;">
                            <div style="font-size:9px;color:#888;font-weight:700;text-transform:uppercase;letter-spacing:.6px;margin-bottom:4px;">📦 Previsão de Entrega</div>
                            <div style="font-size:13px;font-weight:700;">${fd(sale.deliveryForecast)}</div>
                        </div>
                    </div>

                    <!-- ── Itens ── -->
                    ${itensRows ? `<div style="margin-bottom:14px;">
                        <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:#ff6b00;margin-bottom:8px;">🛒 Itens da OS</div>
                        <div style="border-radius:9px;overflow:hidden;border:1px solid #ebebeb;">
                        <table style="width:100%;border-collapse:collapse;font-size:12px;">
                            <thead><tr style="background:linear-gradient(90deg,#ff6b00,#e05500);color:white;">
                                <th style="padding:8px 10px;text-align:left;font-weight:600;">Descrição</th>
                                <th style="padding:8px 10px;text-align:center;font-weight:600;">Qtd</th>
                                <th style="padding:8px 10px;text-align:right;font-weight:600;">Unitário</th>
                                <th style="padding:8px 10px;text-align:right;font-weight:600;">Total</th>
                            </tr></thead>
                            <tbody>${itensRows}</tbody>
                            <tfoot><tr style="background:#fff3e0;">
                                <td colspan="3" style="padding:8px 10px;text-align:right;font-weight:700;color:#555;">TOTAL</td>
                                <td style="padding:8px 10px;text-align:right;font-weight:900;color:#ff6b00;font-size:14px;">${Utils.formatCurrency(sale.total)}</td>
                            </tr></tfoot>
                        </table></div>
                    </div>` : ''}

                    <!-- ── Parcelas ── -->
                    ${(sale.paymentMethod === 'installment' && parcelasRows) ? `<div style="margin-bottom:14px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px;margin-bottom:8px;">
                            <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:#6610f2;">💳 Parcelas do Crediário</div>
                            <div style="display:flex;gap:6px;flex-wrap:wrap;">
                                <span style="background:#d4edda;color:#155724;font-size:11px;padding:2px 9px;border-radius:10px;font-weight:700;">✅ ${Utils.formatCurrency(totalPago)}</span>
                                <span style="background:#fff3cd;color:#856404;font-size:11px;padding:2px 9px;border-radius:10px;font-weight:700;">⏳ ${Utils.formatCurrency(totalAberto)}</span>
                            </div>
                        </div>
                        <div style="border-radius:9px;overflow:hidden;border:1px solid #ebebeb;">
                        <table style="width:100%;border-collapse:collapse;font-size:12px;">
                            <thead><tr style="background:#6610f2;color:white;">
                                <th style="padding:7px 10px;text-align:left;font-weight:600;">Parcela</th>
                                <th style="padding:7px 10px;font-weight:600;">Vencimento</th>
                                <th style="padding:7px 10px;text-align:right;font-weight:600;">Valor</th>
                                <th style="padding:7px 10px;font-weight:600;">Status</th>
                            </tr></thead>
                            <tbody>${parcelasRows}</tbody>
                        </table></div>
                    </div>` : ''}

                    ${sale.observations ? `
                    <div style="padding:10px 14px;background:#fffbf0;border-left:4px solid #ffc107;border-radius:0 8px 8px 0;font-size:12px;margin-bottom:14px;">
                        <div style="font-size:9px;color:#856404;font-weight:700;text-transform:uppercase;margin-bottom:4px;">📝 Observações</div>
                        ${Utils.sanitizeHTML(sale.observations)}
                    </div>` : ''}

                    <!-- ── Rodapé de ações ── -->
                    <div style="display:flex;gap:8px;padding-top:14px;border-top:1px solid #ebebeb;flex-wrap:wrap;">
                        <button onclick="Modal.close('viewModal');setTimeout(()=>Sales.edit('${sale.id}'),80);"
                            style="flex:1;min-width:130px;background:#ff6b00;color:white;border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:700;font-size:13px;display:flex;align-items:center;justify-content:center;gap:6px;">
                            ✏️ Editar Venda
                        </button>
                        <button onclick="if(confirm('Excluir esta OS?')){Modal.close(\\'viewModal\\');setTimeout(()=>Sales.delete(\\'${sale.id}\\'),80);}"
                            style="background:white;color:#dc3545;border:1.5px solid #dc3545;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:700;font-size:13px;display:flex;align-items:center;gap:5px;">
                            🗑️ Excluir
                        </button>
                        <button onclick="Modal.close('viewModal');"
                            style="background:#f0f0f0;color:#555;border:1px solid #ddd;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;">
                            ✖ Fechar
                        </button>
                    </div>
                    <!-- ── Gerar O.S. PDF ── -->
                    <div style="margin-top:12px;padding-top:12px;border-top:1px solid #ebebeb;">
                        <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:#dc3545;margin-bottom:8px;">🖨️ Gerar O.S. (PDF)</div>
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
                            <button onclick="Sales.gerarPDF_OS('via1')"
                                style="background:#ff6b00;color:white;border:none;padding:9px 12px;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;display:flex;align-items:center;justify-content:center;gap:5px;">
                                <i class="fas fa-file-pdf"></i> Via Ótica
                            </button>
                            <button onclick="Sales.gerarPDF_OS('via2')"
                                style="background:#28a745;color:white;border:none;padding:9px 12px;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;display:flex;align-items:center;justify-content:center;gap:5px;">
                                <i class="fas fa-file-pdf"></i> Via Cliente
                            </button>
                            <button onclick="Sales.gerarPDF_OS('ambas')"
                                style="background:#dc3545;color:white;border:none;padding:9px 12px;border-radius:8px;cursor:pointer;font-weight:700;font-size:12px;display:flex;align-items:center;justify-content:center;gap:5px;grid-column:1/-1;">
                                <i class="fas fa-file-pdf"></i> Ambas as Vias
                            </button>
                        </div>
                    </div>
                </div>`;

                Modal.show('viewModal', html);
                document.getElementById('viewTitle').innerText = `Detalhes — OS ${sale.number}`;
            },

            // Salva status clicando diretamente no botão
            _salvarStatusBtn(saleId, novoStatus, btnEl) {
                var sale = state.sales.find(function(s){ return s.id === saleId; });
                if (!sale) return;
                var COR = {
                    orcamento:'#17a2b8', pendente:'#e0a800', producao:'#6610f2',
                    laboratorio:'#0056b3', tratamento:'#6f42c1', atrasado:'#c0392b',
                    pronto:'#fd7e14', entregue:'#28a745', cancelado:'#dc3545'
                };
                var container = btnEl.closest('div[style*="flex-wrap"]');
                if (container) {
                    container.querySelectorAll('button').forEach(function(b){
                        b.style.background='#fff'; b.style.color='#555';
                        b.style.borderColor='#ddd'; b.style.fontWeight='500';
                        b.style.boxShadow='none'; delete b.dataset.ativo;
                    });
                }
                var c = COR[novoStatus] || '#6c757d';
                btnEl.style.background=c; btnEl.style.color='#fff';
                btnEl.style.borderColor=c; btnEl.style.fontWeight='700';
                btnEl.style.boxShadow='0 2px 8px '+c+'55';
                btnEl.dataset.ativo='1';
                sale.status = novoStatus;
                App.saveData();
                Sales.renderHistory();
                try { Dashboard.update(); } catch(e) {}
                Toast.show('Status: ' + btnEl.textContent.trim(), 'success');
            },

            // Mantidos por compatibilidade
            _previewStatus(val) {},
            _salvarStatus(saleId) {
                var sel = document.getElementById('modalStatusSelect');
                if (!sel) return;
                var sale = state.sales.find(function(s){ return s.id===saleId; });
                if (!sale) return;
                sale.status = sel.value;
                App.saveData(); Sales.renderHistory();
                try { Dashboard.update(); } catch(e) {}
                Toast.show('Status atualizado!', 'success');
                Modal.close('viewModal');
            },

            delete(id) {
                Modal.showConfirm('Excluir esta venda?', () => {
                    state.sales = state.sales.filter(s => s.id !== id);
                    App.saveData();
                    LocalFirst.deleteItem('sales', id);
                    this.renderHistory();
                    try { Dashboard.update(); } catch(e) {}
                    Toast.show('Venda excluída com sucesso!');
                });
            }
        };

        // ==================== INICIALIZAÇÃO ====================
        document.addEventListener('DOMContentLoaded', async () => {
            await App.init();
            Dashboard.update();
            Usuarios.renderTable();
            BackupManager.init();
            KeyboardShortcuts.init();
            LogSystem.log('info', 'Sistema Iniciado', 'ÓticaVision Pro v2.0');
            setTimeout(() => {
                adicionarTooltips();
                melhorarAcessibilidade();
            }, 500);
        });
    
        
        // ============================================
        // 🚀 MELHORIAS ADICIONADAS - VERSÃO 2.0
        // ============================================
        
        // 1. VALIDAÇÕES ROBUSTAS
        const Validadores = {
            // Validação de CPF com algoritmo oficial
            cpf: function(cpf) {
                cpf = cpf.replace(/[^\d]/g, '');
                if (cpf.length !== 11) return false;
                if (/^(\d)\1{10}$/.test(cpf)) return false;
                
                let soma = 0;
                let resto;
                
                for (let i = 1; i <= 9; i++) {
                    soma += parseInt(cpf.substring(i-1, i)) * (11 - i);
                }
                resto = (soma * 10) % 11;
                if (resto === 10 || resto === 11) resto = 0;
                if (resto !== parseInt(cpf.substring(9, 10))) return false;
                
                soma = 0;
                for (let i = 1; i <= 10; i++) {
                    soma += parseInt(cpf.substring(i-1, i)) * (12 - i);
                }
                resto = (soma * 10) % 11;
                if (resto === 10 || resto === 11) resto = 0;
                if (resto !== parseInt(cpf.substring(10, 11))) return false;
                
                return true;
            },
            
            // Validação de email robusta
            email: function(email) {
                const regex = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
                return regex.test(email);
            },
            
            // Validação de telefone
            telefone: function(tel) {
                const cleaned = tel.replace(/[^\d]/g, '');
                return cleaned.length === 10 || cleaned.length === 11;
            },
            
            // Sanitização contra XSS
            sanitize: function(str) {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            }
        };
        
        // 2. DEBOUNCE PARA PERFORMANCE
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // 3. LOADING STATE
        const LoadingManager = {
            show: function(message = 'Carregando...') {
                let loader = document.getElementById('global-loader');
                if (!loader) {
                    loader = document.createElement('div');
                    loader.id = 'global-loader';
                    loader.style.cssText = `
                        position: fixed;
                        top: 0; left: 0;
                        width: 100%; height: 100%;
                        background: rgba(0,0,0,0.7);
                        z-index: 99999;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-size: 1.2rem;
                    `;
                    loader.innerHTML = `
                        <div class="loading" style="width: 50px; height: 50px; border-width: 5px;"></div>
                        <div style="margin-top: 1rem;">${message}</div>
                    `;
                    document.body.appendChild(loader);
                }
                loader.style.display = 'flex';
            },
            
            hide: function() {
                const loader = document.getElementById('global-loader');
                if (loader) {
                    loader.style.display = 'none';
                }
            }
        };
        
        // 4. BACKUP AUTOMÁTICO
        const BackupManager = {

            _dailyTimer: null,

            init: function() {
                // ── Verifica/agenda backup diário ao iniciar ──
                this._agendarBackupDiario();

                // Verificação periódica a cada minuto (para não perder a janela)
                setInterval(() => this._verificarBackupDiario(), 60 * 1000);
            },

            // ── Agendamento diário ────────────────────────────────────────
            _agendarBackupDiario: function() {
                const cfg = state.backupConfig;
                if (!cfg.autoEnabled) return;

                const agora    = new Date();
                const alvo     = new Date(agora);
                alvo.setHours(cfg.hour, 0, 0, 0);
                if (alvo <= agora) alvo.setDate(alvo.getDate() + 1); // próximo dia se já passou

                const msAte = alvo.getTime() - agora.getTime();

                clearTimeout(this._dailyTimer);
                this._dailyTimer = setTimeout(async () => {
                    await this.autoBackup(true);
                    this._agendarBackupDiario(); // reagendar para amanhã
                }, msAte);

                // Atualiza próximo backup no estado
                state.backupConfig.nextAutoBackup = alvo.toISOString();
            },

            // Verificação por intervalo (garante que o sistema não "perdeu" o horário)
            _verificarBackupDiario: async function() {
                const cfg = state.backupConfig;
                if (!cfg.autoEnabled) return;

                const agora = new Date();
                const hoje  = agora.toLocaleDateString('pt-BR');
                const hora  = agora.getHours();

                // Se está na hora configurada e o último backup não foi hoje
                if (hora === cfg.hour) {
                    const ultimo = cfg.lastAutoBackup;
                    const dataUltimo = ultimo ? new Date(ultimo).toLocaleDateString('pt-BR') : null;
                    if (dataUltimo !== hoje) {
                        await this.autoBackup(true);
                    }
                }
            },

            // ── Executa backup automático ─────────────────────────────────
            autoBackup: async function(isDiario = false) {
                const timestamp = new Date().toISOString();
                let savedData = {};
                try { savedData = JSON.parse(await IDB.get(STORAGE_KEY) || '{}'); } catch(e) {}

                const backup = {
                    timestamp,
                    tipo: isDiario ? 'diario' : 'automatico',
                    versao: '2.0',
                    data: savedData
                };

                // Salva o backup mais recente
                try { await IDB.set('ultimo_backup', JSON.stringify(backup)); } catch(e) {}

                if (isDiario) {
                    // Atualiza timestamp no estado e persiste
                    state.backupConfig.lastAutoBackup = timestamp;
                    await App.saveData(true);

                    // Histórico: mantém os últimos N dias
                    await this._salvarNoHistorico(backup);

                    // Notifica usuário
                    Toast.show('✅ Backup diário realizado às ' + new Date(timestamp).toLocaleTimeString('pt-BR', {hour:'2-digit',minute:'2-digit'}), 'success', 4000);

                    // Atualiza painel se Configurações estiver aberta
                    if (document.getElementById('tabBackup')?.style.display !== 'none') {
                        Config.renderBackupStatus();
                    }
                } else {
                }
            },

            // ── Histórico de backups (últimos N dias no IDB) ──────────────
            _salvarNoHistorico: async function(backup) {
                const cfg = state.backupConfig;
                let historico = [];
                try { historico = JSON.parse(await IDB.get('backup_historico') || '[]'); } catch(e) {}

                historico.unshift({
                    timestamp: backup.timestamp,
                    tipo: backup.tipo,
                    tamanho: JSON.stringify(backup.data).length
                });

                // Mantém apenas os últimos keepDays registros
                const limite = cfg.keepDays || 7;
                historico = historico.slice(0, limite);

                try { await IDB.set('backup_historico', JSON.stringify(historico)); } catch(e) {}
            },

            // Retorna histórico de backups
            getHistorico: async function() {
                try { return JSON.parse(await IDB.get('backup_historico') || '[]'); } catch(e) { return []; }
            },
            
            exportar: async function() {
                LoadingManager.show('Exportando dados...');
                
                try {
                    let appData = {};
                    try { appData = JSON.parse(await IDB.get(STORAGE_KEY) || '{}'); } catch(e) {}
                    // Fallback: usa state diretamente se IDB não retornou nada
                    if (!appData || Object.keys(appData).length === 0) appData = state;
                    const dados = {
                        versao: '2.0',
                        data_exportacao: new Date().toISOString(),
                        ...appData
                    };
                    
                    const blob = new Blob([JSON.stringify(dados, null, 2)], {type: 'application/json'});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `oticavision_backup_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    
                    LoadingManager.hide();
                    Toast.show('Dados exportados com sucesso!', 'success');
                } catch (error) {
                    LoadingManager.hide();
                    Toast.show('Erro ao exportar dados: ' + error.message, 'error');
                }
            },
            
            importar: function(file) {
                LoadingManager.show('Importando dados...');
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const dados = JSON.parse(e.target.result);
                        
                        // Validação básica
                        if (!dados.versao || !dados.data_exportacao) {
                            throw new Error('Arquivo inválido');
                        }
                        
                        // Confirmar antes de sobrescrever
                        if (confirm('⚠️ ATENÇÃO: Isso irá sobrescrever todos os dados atuais. Deseja continuar?')) {
                            const { versao, data_exportacao, ...appData } = dados;
                            await IDB.set(STORAGE_KEY, JSON.stringify(appData));
                            
                            LoadingManager.hide();
                            Toast.show('Dados importados com sucesso!', 'success');
                            setTimeout(() => location.reload(), 1500);
                        } else {
                            LoadingManager.hide();
                        }
                    } catch (error) {
                        LoadingManager.hide();
                        Toast.show('Erro ao importar dados: ' + error.message, 'error');
                    }
                };
                reader.readAsText(file);
            }
        };
        
        // 5. ATALHOS DE TECLADO
        const KeyboardShortcuts = {
            init: function() {
                document.addEventListener('keydown', (e) => {
                    // Ctrl/Cmd + S = Salvar
                    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                        e.preventDefault();
                        const activeSection = document.querySelector('.section.active');
                        if (activeSection) {
                            const saveBtn = activeSection.querySelector('.btn-primary[onclick*="salvar"]');
                            if (saveBtn) saveBtn.click();
                        }
                    }
                    
                    // Ctrl/Cmd + B = Backup
                    if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
                        e.preventDefault();
                        BackupManager.exportar();
                    }
                    
                    // Ctrl/Cmd + F = Buscar
                    if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                        const activeSection = document.querySelector('.section.active');
                        if (activeSection) {
                            const searchInput = activeSection.querySelector('input[type="text"][placeholder*="Buscar"]');
                            if (searchInput) {
                                e.preventDefault();
                                searchInput.focus();
                            }
                        }
                    }
                    
                    // ESC = Fechar modal
                    if (e.key === 'Escape') {
                        const modalAtivo = document.querySelector('.modal.active');
                        if (modalAtivo) {
                            modalAtivo.classList.remove('active');
                        }
                    }
                });
            }
        };
        
        // 6. ESTATÍSTICAS AVANÇADAS — corrigido: campos alinhados com modelo de dados real
        const Analytics = {
            calcularTicketMedio: function() {
                const vendas = state.sales || [];
                if (vendas.length === 0) return 0;
                const total = vendas.reduce((sum, v) => sum + (v.total || 0), 0);
                return total / vendas.length;
            },
            
            produtoMaisVendido: function() {
                const vendas = state.sales || [];
                const contador = {};
                
                vendas.forEach(venda => {
                    // corrigido: items (não itens), name (não nome), qty (não quantidade)
                    if (venda.items) {
                        venda.items.forEach(item => {
                            const nome = item.name || item.nome || 'Desconhecido';
                            contador[nome] = (contador[nome] || 0) + (item.qty || item.quantidade || 1);
                        });
                    }
                });
                
                let maisVendido = null;
                let maxQtd = 0;
                
                for (let [produto, qtd] of Object.entries(contador)) {
                    if (qtd > maxQtd) {
                        maxQtd = qtd;
                        maisVendido = produto;
                    }
                }
                
                return { produto: maisVendido, quantidade: maxQtd };
            },
            
            taxaConversao: function() {
                const clientes = state.clients || [];
                const vendas   = state.sales   || [];
                
                if (clientes.length === 0) return 0;
                
                // corrigido: clientId (não clienteId)
                const clientesComCompra = new Set(vendas.map(v => v.clientId || v.clienteId).filter(Boolean));
                return (clientesComCompra.size / clientes.length) * 100;
            }
        };
        
        // 7. MELHORIAS NO SISTEMA DE VENDAS — corrigido: campo qty (não estoque)
        const VendasMelhoradas = {
            validarEstoque: function(produtoId, quantidade) {
                const produtos = state.products || [];
                const produto = produtos.find(p => p.id === produtoId);
                
                if (!produto) {
                    Toast.show('Produto não encontrado', 'error');
                    return false;
                }
                
                // corrigido: qty (não estoque)
                const estoque = produto.qty !== undefined ? produto.qty : (produto.estoque || 0);
                if (estoque < quantidade) {
                    Toast.show(`Estoque insuficiente! Disponível: ${estoque}`, 'warning');
                    return false;
                }
                
                return true;
            },
            
            calcularDesconto: function(subtotal, percentual) {
                if (percentual < 0 || percentual > 100) {
                    Toast.show('Percentual de desconto inválido', 'warning');
                    return 0;
                }
                return (subtotal * percentual) / 100;
            },
            
            validarPagamento: function(total, valorPago) {
                if (valorPago < total) {
                    Toast.show('Valor pago insuficiente', 'warning');
                    return false;
                }
                return true;
            }
        };
        
        // 8. SISTEMA DE LOGS
        const LogSystem = {
            log: async function(tipo, acao, detalhes) {
                let logs = [];
                try { logs = JSON.parse(await IDB.get('system_logs') || '[]'); } catch(e) {}
                const log = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    tipo: tipo,
                    acao: acao,
                    detalhes: detalhes,
                    usuario: 'Sistema'
                };
                logs.push(log);
                if (logs.length > 1000) logs.shift();
                IDB.set('system_logs', JSON.stringify(logs)).catch(() => {});
            },
            
            getLogs: async function(filtro = {}) {
                let logs = [];
                try { logs = JSON.parse(await IDB.get('system_logs') || '[]'); } catch(e) {}
                if (filtro.tipo) return logs.filter(log => log.tipo === filtro.tipo);
                return logs;
            }
        };
        
        // 9. MELHORIAS NA INTERFACE
        // Adicionar tooltips informativos
        function adicionarTooltips() {
            const elementos = document.querySelectorAll('[data-tooltip]');
            elementos.forEach(el => {
                el.setAttribute('title', el.getAttribute('data-tooltip'));
            });
        }
        
        // Melhorar acessibilidade
        function melhorarAcessibilidade() {
            // Adicionar ARIA labels
            document.querySelectorAll('input:not([aria-label])').forEach(input => {
                const label = input.closest('.form-group')?.querySelector('label');
                if (label) {
                    input.setAttribute('aria-label', label.textContent.trim());
                }
            });
            
            // Adicionar aria-readonly em campos somente leitura
            document.querySelectorAll('input[readonly]').forEach(input => {
                input.setAttribute('aria-readonly', 'true');
            });
            
            // Adicionar role em botões sem role explícito
            document.querySelectorAll('.btn').forEach(btn => {
                if (!btn.getAttribute('role')) {
                    btn.setAttribute('role', 'button');
                }
            });
        }
        
    
</script>

<!-- ===== PWA: Service Worker + Banner de Instalação ===== -->
<style>
  #pwa-install-banner {
    display:none; position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
    background:#ff6b00; color:white; padding:14px 20px; border-radius:12px;
    box-shadow:0 8px 24px rgba(0,0,0,0.25); z-index:99999;
    font-family:'Inter',-apple-system,sans-serif; align-items:center;
    gap:14px; max-width:94vw; width:420px;
  }
  #pwa-install-banner.visible { display:flex; }
  #pwa-install-banner .pi-text { flex:1; }
  #pwa-install-banner .pi-text strong { display:block; font-size:0.95rem; }
  #pwa-install-banner .pi-text small { font-size:0.78rem; opacity:0.9; }
  #pwa-install-banner .pi-btns { display:flex; gap:8px; flex-shrink:0; }
  .btn-pi-ok { background:white; color:#ff6b00; border:none; padding:8px 16px; border-radius:8px; font-weight:700; cursor:pointer; font-size:0.88rem; }
  .btn-pi-x  { background:rgba(255,255,255,0.2); color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
  #pwa-update-toast {
    display:none; position:fixed; top:20px; right:20px;
    background:#212529; color:white; padding:12px 18px; border-radius:10px;
    box-shadow:0 4px 16px rgba(0,0,0,0.3); z-index:99999;
    font-family:'Inter',-apple-system,sans-serif; font-size:0.88rem;
    gap:12px; align-items:center; max-width:320px;
  }
  #pwa-update-toast.visible { display:flex; }
  #pwa-update-toast button { background:#ff6b00; color:white; border:none; padding:6px 14px; border-radius:6px; cursor:pointer; font-weight:700; font-size:0.82rem; }
  #pwa-offline-bar {
    display:none; position:fixed; top:0; left:0; right:0;
    background:#dc3545; color:white; text-align:center;
    padding:8px; font-size:0.85rem; z-index:99999;
  }
  #pwa-offline-bar.visible { display:block; }
</style>

<div id="pwa-install-banner">
  <span style="font-size:28px;">&#128083;</span>
  <div class="pi-text">
    <strong>Instalar &#211;ticaVision Pro</strong>
    <small>Acesse r&#225;pido, funciona offline!</small>
  </div>
  <div class="pi-btns">
    <button class="btn-pi-ok" id="pwa-install-btn">Instalar</button>
    <button class="btn-pi-x"  id="pwa-dismiss-btn">&#x2715;</button>
  </div>
</div>

<div id="pwa-update-toast">
  <span>&#128260; Nova vers&#227;o dispon&#237;vel!</span>
  <button id="pwa-update-btn">Atualizar</button>
</div>

<div id="pwa-offline-bar">
  &#128225; Voc&#234; est&#225; <strong>offline</strong> &mdash; dados locais dispon&#237;veis normalmente
</div>

<script>
(function(){
  'use strict';
  var deferredPrompt = null;
  var swReg = null;

  if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
      navigator.serviceWorker.register('./sw.js', {scope:'./'}).then(function(reg) {
        swReg = reg;
        console.log('[PWA] SW registrado:', reg.scope);
        reg.addEventListener('updatefound', function() {
          var nw = reg.installing;
          nw.addEventListener('statechange', function() {
            if (nw.state === 'installed' && navigator.serviceWorker.controller) {
              document.getElementById('pwa-update-toast').classList.add('visible');
            }
          });
        });
        navigator.serviceWorker.addEventListener('controllerchange', function() { location.reload(); });

        // Recebe mensagem do SW para disparar sync em background
        navigator.serviceWorker.addEventListener('message', function(e) {
          if (e.data?.type === 'BACKGROUND_SYNC') {
            if (typeof LocalFirst !== 'undefined') {
              LocalFirst.sync(false).catch(() => {});
            }
          }
        });
      }).catch(function(e){ console.warn('[PWA] SW falhou:', e); });
    });
  }

  document.getElementById('pwa-update-btn').addEventListener('click', function() {
    if (swReg && swReg.waiting) swReg.waiting.postMessage({type:'SKIP_WAITING'});
    document.getElementById('pwa-update-toast').classList.remove('visible');
  });

  window.addEventListener('beforeinstallprompt', function(e) {
    e.preventDefault(); deferredPrompt = e;
    IDB.get('pwa-dismissed').then(function(v){
      if (!v) setTimeout(function(){ document.getElementById('pwa-install-banner').classList.add('visible'); }, 3000);
    }).catch(function(){ setTimeout(function(){ document.getElementById('pwa-install-banner').classList.add('visible'); }, 3000); });
  });

  document.getElementById('pwa-install-btn').addEventListener('click', function() {
    document.getElementById('pwa-install-banner').classList.remove('visible');
    if (deferredPrompt) { deferredPrompt.prompt(); deferredPrompt.userChoice.then(function(){ deferredPrompt = null; }); }
  });

  document.getElementById('pwa-dismiss-btn').addEventListener('click', function() {
    document.getElementById('pwa-install-banner').classList.remove('visible');
    IDB.set('pwa-dismissed','1').catch(function(){});
  });

  window.addEventListener('appinstalled', function() {
    document.getElementById('pwa-install-banner').classList.remove('visible');
    deferredPrompt = null;
  });

  function checkOnline() {
    var bar = document.getElementById('pwa-offline-bar');
    var dot = document.getElementById('syncBtnStatusDot');
    if (!navigator.onLine) {
      bar.classList.add('visible');
      if(dot) { dot.style.background='#f38ba8'; dot.style.boxShadow='0 0 6px #f38ba8'; }
    } else {
      bar.classList.remove('visible');
      if(dot) { dot.style.background='#a6e3a1'; dot.style.boxShadow='0 0 6px #a6e3a1'; }
      if (swReg && 'sync' in swReg) swReg.sync.register('sync-data').catch(function(){});
    }
  }
  window.addEventListener('online', checkOnline);
  window.addEventListener('offline', checkOnline);
  checkOnline();
  console.log('[PWA] Controller ativo &#10003;');
})();
</script>
<!-- ===== /PWA ===== -->

<!-- ═══════════════════════════════════════════════════
     ConfigFiscal MODULE — Configurações Fiscais + API CNPJ
═══════════════════════════════════════════════════ -->
<script>
(function(){
'use strict';

const ConfigFiscal = window.ConfigFiscal = {

    _cfg: {},

    // ── Carrega configs salvas ──
    init() {
        try { this._cfg = JSON.parse(localStorage.getItem('fiscal_config')||'{}'); } catch(e){}
        this._preencher();
    },

    _preencher() {
        const c = this._cfg;
        const set = (id,v) => { const el=document.getElementById(id); if(el&&v!==undefined) el.value=v; };
        set('cfgNfeAmbiente',  c.ambiente  || '2');
        set('cfgNfeUF',        c.uf        || 'SP');
        set('cfgNfeVersao',    c.versao    || '4.00');
        set('cfgNfeUrlSefaz',  c.urlSefaz  || '');
        set('cfgNfeToken',     c.token     || '');
        set('cfgNfeUrlProxy',  c.urlProxy  || '');
        set('cfgNfeSerie',     c.serie     || '001');
        set('cfgCertSenha',    c.certSenha || '');
        set('cfgCertValidade', c.certValidade || '');
        set('cfgCertTitular',  c.certTitular  || '');
        set('cfgRazaoSocial',  c.razaoSocial  || '');
        set('cfgCNPJ',         c.cnpj         || '');
        set('cfgIE',           c.ie           || '');
        set('cfgIM',           c.im           || '');
        set('cfgCNAE',         c.cnae         || '');
        set('cfgRegime',       c.regime       || '1');
        set('cfgICMSPadrao',   c.icmsPadrao   || '12');
        set('cfgCFOP',         c.cfop         || '5102');
        set('cfgEnderecoFiscal', c.endereco   || '');
        set('cfgCEP',          c.cep          || '');
        set('cfgMunicipio',    c.municipio    || '');
        set('cfgCodIBGE',      c.codIBGE      || '');
        set('cfgEstado',       c.estado       || 'SP');
        set('cfgTelFiscal',    c.telefone     || '');
        set('cfgCnpjProvider', c.cnpjProvider || 'brasilapi');
        set('cfgCnpjUrl',      c.cnpjUrl      || '');
        set('cfgCnpjToken',    c.cnpjToken    || '');
        set('cfgLogoPosicao',  c.logoPosicao  || 'esquerda');
        set('cfgLogoExibir',   c.logoExibir   || 'sim');

        // Restaurar logo NF-e salva
        if (c.logoNFeBase64) {
            const img = document.getElementById('cfgLogoNFeImg');
            const ph  = document.getElementById('cfgLogoNFePreviewPlaceholder');
            if (img) { img.src = c.logoNFeBase64; img.style.display = 'block'; }
            if (ph)  ph.style.display = 'none';
        }

        // Status certificado
        const statusEl = document.getElementById('cfgCertStatus');
        if (statusEl) {
            if (c.certTitular) {
                statusEl.innerHTML = `<span style="color:#28a745;font-weight:700;"><i class="fas fa-check-circle"></i> ${c.certTitular}</span>`;
            } else {
                statusEl.textContent = 'Nenhum certificado carregado';
            }
        }

        // Pré-preenche campos NF-e com dados da config
        if (c.razaoSocial) { const el=document.getElementById('nfeRazaoSocial'); if(el&&!el.value) el.value=c.razaoSocial; }
        if (c.cnpj)        { const el=document.getElementById('nfeCnpj');        if(el&&!el.value) el.value=c.cnpj; }
        if (c.ie)          { const el=document.getElementById('nfeIE');           if(el&&!el.value) el.value=c.ie; }
        if (c.regime)      { const el=document.getElementById('nfeRegime');       if(el&&!el.value) el.value=c.regime; }
        if (c.serie)       { const el=document.getElementById('nfeSerie');        if(el) el.value=c.serie; }
    },

    salvarConfig(feedback) {
        const get = id => document.getElementById(id)?.value||'';
        this._cfg = {
            ambiente:     get('cfgNfeAmbiente'),
            uf:           get('cfgNfeUF'),
            versao:       get('cfgNfeVersao'),
            urlSefaz:     get('cfgNfeUrlSefaz'),
            token:        get('cfgNfeToken'),
            urlProxy:     get('cfgNfeUrlProxy'),
            serie:        get('cfgNfeSerie'),
            certSenha:    get('cfgCertSenha'),
            certValidade: get('cfgCertValidade'),
            certTitular:  get('cfgCertTitular'),
            razaoSocial:  get('cfgRazaoSocial'),
            cnpj:         get('cfgCNPJ'),
            ie:           get('cfgIE'),
            im:           get('cfgIM'),
            cnae:         get('cfgCNAE'),
            regime:       get('cfgRegime'),
            icmsPadrao:   get('cfgICMSPadrao'),
            cfop:         get('cfgCFOP'),
            endereco:     get('cfgEnderecoFiscal'),
            cep:          get('cfgCEP'),
            municipio:    get('cfgMunicipio'),
            codIBGE:      get('cfgCodIBGE'),
            estado:       get('cfgEstado'),
            telefone:     get('cfgTelFiscal'),
            cnpjProvider: get('cfgCnpjProvider'),
            cnpjUrl:      get('cfgCnpjUrl'),
            cnpjToken:    get('cfgCnpjToken'),
            logoPosicao:  get('cfgLogoPosicao'),
            logoExibir:   get('cfgLogoExibir'),
            logoNFeBase64: this._cfg.logoNFeBase64 || '',
            certBase64:   this._cfg.certBase64 || '',
        };
        localStorage.setItem('fiscal_config', JSON.stringify(this._cfg));
        if (feedback) this._toast('✅ Configurações fiscais salvas!', 'success');
    },

    limpar() {
        if (!confirm('Limpar todas as configurações fiscais?')) return;
        localStorage.removeItem('fiscal_config');
        this._cfg = {};
        this._preencher();
    },

    // ── Logo NF-e ──
    carregarLogoNFe(input) {
        const file = input.files[0];
        if (!file) return;
        if (file.size > 2 * 1024 * 1024) {
            this._toast('⚠️ Arquivo muito grande. Máximo: 2 MB.', 'warning');
            input.value = '';
            return;
        }
        const reader = new FileReader();
        reader.onload = (e) => {
            const base64 = e.target.result;
            this._cfg.logoNFeBase64 = base64;
            localStorage.setItem('fiscal_config', JSON.stringify(this._cfg));
            const img = document.getElementById('cfgLogoNFeImg');
            const ph  = document.getElementById('cfgLogoNFePreviewPlaceholder');
            if (img) { img.src = base64; img.style.display = 'block'; }
            if (ph)  ph.style.display = 'none';
            this._toast('✅ Logo carregada com sucesso!', 'success');
        };
        reader.readAsDataURL(file);
    },

    removerLogoNFe() {
        if (!confirm('Remover a logo da NF-e?')) return;
        this._cfg.logoNFeBase64 = '';
        localStorage.setItem('fiscal_config', JSON.stringify(this._cfg));
        const img = document.getElementById('cfgLogoNFeImg');
        const ph  = document.getElementById('cfgLogoNFePreviewPlaceholder');
        const inp = document.getElementById('cfgLogoNFeInput');
        if (img) { img.src = ''; img.style.display = 'none'; }
        if (ph)  ph.style.display = '';
        if (inp) inp.value = '';
        this._toast('Logo removida.', 'info');
    },

    // ── API de Busca de CNPJ ──
    async buscarCNPJ(inputId, prefixo) {
        const inputEl = document.getElementById(inputId);
        if (!inputEl) return;
        const cnpjRaw = inputEl.value.replace(/\D/g,'');

        if (cnpjRaw.length !== 14) {
            this._toast('⚠️ Digite um CNPJ completo (14 dígitos).', 'warning');
            return;
        }

        const btn = inputEl.nextElementSibling;
        const originalHTML = btn?.innerHTML || '';
        if (btn) btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        try {
            const provider = this._cfg.cnpjProvider || 'brasilapi';
            let url = '';

            if (provider === 'brasilapi') {
                url = `https://brasilapi.com.br/api/cnpj/v1/${cnpjRaw}`;
            } else if (provider === 'receitaws') {
                url = `https://www.receitaws.com.br/v1/cnpj/${cnpjRaw}`;
            } else if (provider === 'cnpja') {
                url = `https://api.cnpja.com/office/${cnpjRaw}`;
            } else if (provider === 'custom' && this._cfg.cnpjUrl) {
                url = this._cfg.cnpjUrl.replace('{cnpj}', cnpjRaw);
            } else {
                url = `https://brasilapi.com.br/api/cnpj/v1/${cnpjRaw}`;
            }

            const headers = {};
            if (this._cfg.cnpjToken && provider !== 'brasilapi') {
                headers['Authorization'] = `Bearer ${this._cfg.cnpjToken}`;
            }

            const resp = await fetch(url, { headers });
            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            const data = await resp.json();

            this._preencherDadosCNPJ(data, prefixo, provider);
            this._toast('✅ CNPJ encontrado e dados preenchidos!', 'success');

        } catch(e) {
            this._toast('❌ CNPJ não encontrado ou API indisponível.', 'error');
            console.warn('[ConfigFiscal] Erro CNPJ:', e);
        } finally {
            if (btn) btn.innerHTML = originalHTML;
        }
    },

    _preencherDadosCNPJ(data, prefixo, provider) {
        // Normaliza campos das diferentes APIs
        let nome, fantasia, logradouro, numero, bairro, municipio, uf, cep, telefone, email, cnpjFormatado;

        if (provider === 'brasilapi' || !provider) {
            nome       = data.razao_social      || '';
            fantasia   = data.nome_fantasia      || '';
            logradouro = data.logradouro         || '';
            numero     = data.numero             || '';
            bairro     = data.bairro             || '';
            municipio  = data.municipio          || '';
            uf         = data.uf                 || '';
            cep        = data.cep                || '';
            telefone   = data.ddd_telefone_1     || '';
            email      = data.email              || '';
            cnpjFormatado = data.cnpj            || '';
        } else {
            // Fallback genérico
            nome       = data.razao_social || data.nome || data.company?.name || '';
            fantasia   = data.nome_fantasia || data.fantasia || '';
            logradouro = data.logradouro   || data.address?.street || '';
            numero     = data.numero       || data.address?.number || '';
            bairro     = data.bairro       || data.address?.district || '';
            municipio  = data.municipio    || data.address?.city || '';
            uf         = data.uf           || data.address?.state || '';
            cep        = data.cep          || data.address?.zip || '';
            telefone   = data.telefone     || '';
            email      = data.email        || '';
        }

        const set = (id,v) => { const el=document.getElementById(id); if(el&&v) el.value=v; };
        const end = [logradouro, numero, bairro].filter(Boolean).join(', ');

        if (prefixo === 'nfeEmit') {
            set('nfeRazaoSocial', nome);
            // UF para select
            const ufSel = document.getElementById('nfeUF');
            if (ufSel && uf) ufSel.value = uf;

        } else if (prefixo === 'nfeDest') {
            set('nfeDestNome', nome || fantasia);
            set('nfeDestEnd',  end);
            set('nfeDestMun',  municipio);
            set('nfeDestEmail', email);
            set('nfeDestTel',  telefone);
            const ufSel = document.getElementById('nfeDestUF');
            if (ufSel && uf) ufSel.value = uf;

        } else if (prefixo === 'cfg') {
            // Configurações fiscais
            set('cfgRazaoSocial',    nome);
            set('cfgEnderecoFiscal', end);
            set('cfgCEP',            cep.replace(/\D/g,'').replace(/(\d{5})(\d{3})/,'$1-$2'));
            set('cfgMunicipio',      municipio);
            set('cfgTelFiscal',      telefone);
            const ufSel = document.getElementById('cfgEstado');
            if (ufSel && uf) ufSel.value = uf;
            this.salvarConfig();
        }
    },

    async testarApiCnpj() {
        const cnpjEl = document.getElementById('cfgCNPJ');
        if (cnpjEl?.value?.replace(/\D/g,'').length === 14) {
            await this.buscarCNPJ('cfgCNPJ', 'cfg');
        } else {
            // Usa CNPJ público da Receita Federal para teste
            const tempEl = { value: '00.394.460/0001-41' };
            document.getElementById('cfgCNPJ').value = '00.394.460/0001-41';
            await this.buscarCNPJ('cfgCNPJ', 'cfg');
        }
    },

    // ── Certificado Digital ──
    carregarCertificado(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            this._cfg.certBase64 = e.target.result;
            this._cfg.certNome   = file.name;
            // Dados reais viriam da leitura do PFX — aqui simulamos
            this._cfg.certTitular  = file.name.replace(/\.(pfx|p12)$/i,'').toUpperCase();
            this._cfg.certValidade = 'Verificar com software de certificado';
            const statusEl = document.getElementById('cfgCertStatus');
            if (statusEl) statusEl.innerHTML = `<span style="color:#28a745;font-weight:700;"><i class="fas fa-check-circle"></i> ${file.name}</span>`;
            const v = document.getElementById('cfgCertValidade'); if(v) v.value = this._cfg.certValidade;
            const t = document.getElementById('cfgCertTitular');  if(t) t.value = this._cfg.certTitular;
            this.salvarConfig();
            this._toast('✅ Certificado carregado! Configure a senha e salve.', 'success');
        };
        reader.readAsDataURL(file);
    },

    removerCertificado() {
        if (!confirm('Remover o certificado digital?')) return;
        delete this._cfg.certBase64;
        delete this._cfg.certNome;
        delete this._cfg.certTitular;
        delete this._cfg.certValidade;
        const statusEl = document.getElementById('cfgCertStatus');
        if (statusEl) statusEl.textContent = 'Nenhum certificado carregado';
        ['cfgCertValidade','cfgCertTitular','cfgCertSenha'].forEach(id => { const el=document.getElementById(id); if(el) el.value=''; });
        this.salvarConfig();
        this._toast('Certificado removido.', 'warning');
    },

    testarCertificado() {
        if (!this._cfg.certBase64) {
            this._toast('⚠️ Nenhum certificado carregado.', 'warning');
            return;
        }
        if (!document.getElementById('cfgCertSenha')?.value) {
            this._toast('⚠️ Informe a senha do certificado.', 'warning');
            return;
        }
        // Simulação — integração real exigiria backend
        this._toast('⚠️ Teste real requer backend. Certificado está carregado na memória.', 'info');
    },

    toggleSenha() {
        const el   = document.getElementById('cfgCertSenha');
        const icon = document.getElementById('cfgCertSenhaIcon');
        if (!el) return;
        if (el.type === 'password') {
            el.type = 'text';
            if (icon) { icon.classList.remove('fa-eye'); icon.classList.add('fa-eye-slash'); }
        } else {
            el.type = 'password';
            if (icon) { icon.classList.remove('fa-eye-slash'); icon.classList.add('fa-eye'); }
        }
    },

    _toast(msg, tipo='info') {
        const colors = {success:'#28a745',error:'#dc3545',warning:'#ff6b00',info:'#17a2b8'};
        const icons  = {success:'fa-check-circle',error:'fa-times-circle',warning:'fa-exclamation-triangle',info:'fa-info-circle'};
        const t = document.createElement('div');
        t.style.cssText = `background:white;border-radius:10px;padding:0.9rem 1rem;box-shadow:0 5px 20px rgba(0,0,0,0.15);display:flex;align-items:center;gap:10px;border-left:4px solid ${colors[tipo]};min-width:250px;`;
        t.innerHTML = `<i class="fas ${icons[tipo]}" style="color:${colors[tipo]};font-size:1.1rem;flex-shrink:0;"></i><span style="font-size:0.84rem;font-weight:600;color:#333;">${msg}</span>`;
        const c = document.getElementById('toastContainer');
        if (c) { c.appendChild(t); setTimeout(()=>t.remove(), 4500); }
    }
};

// Inicializa ao abrir aba Fiscal nas Configurações
document.addEventListener('DOMContentLoaded', () => {
    const fiscalBtn = document.querySelector('[onclick*="fiscal"]');
    if (fiscalBtn) {
        const orig = fiscalBtn.getAttribute('onclick');
        fiscalBtn.setAttribute('onclick', orig + '; ConfigFiscal.init()');
    }
    // Também inicializa ao abrir NF-e (pré-preenche campos)
    const menuNFe = document.querySelector('.menu-item[data-section="nfe"]');
    if (menuNFe) {
        menuNFe.addEventListener('click', () => setTimeout(()=>ConfigFiscal.init(), 80));
    }
});

})();
</script>

</body>
</html>
<script>
(function() {
'use strict';

const NFeModule = window.NFeModule = {

    itens: [],
    historico: [],
    nfeCounter: 1,

    init() {
        this._loadStorage();
        this._preencherData();
        this._gerarNumero();
        this.renderItens();
        this.renderHistorico();
        this.atualizarCards();
    },

    _preencherData() {
        const el = document.getElementById('nfeDataEmissao');
        if (el) el.value = new Date().toISOString().slice(0,10);
    },

    _gerarNumero() {
        const el = document.getElementById('nfeNumero');
        if (el) el.value = 'NFe-' + String(this.nfeCounter).padStart(6,'0');
    },

    _loadStorage() {
        try {
            const h = localStorage.getItem('nfe_historico');
            if (h) this.historico = JSON.parse(h);
            const c = localStorage.getItem('nfe_counter');
            if (c) this.nfeCounter = parseInt(c) || 1;
        } catch(e) {}
    },

    _saveStorage() {
        try {
            localStorage.setItem('nfe_historico', JSON.stringify(this.historico));
            localStorage.setItem('nfe_counter', String(this.nfeCounter));
        } catch(e) {}
    },

    _fmt(v) {
        return 'R$ ' + Number(v||0).toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2});
    },

    addItem() {
        const desc  = document.getElementById('nfeItemDesc')?.value?.trim();
        const ncm   = document.getElementById('nfeItemNCM')?.value?.trim()  || '90041000';
        const cfop  = document.getElementById('nfeItemCFOP')?.value?.trim() || '5102';
        const qtd   = parseFloat(document.getElementById('nfeItemQtd')?.value)  || 1;
        const valor = parseFloat(document.getElementById('nfeItemValor')?.value) || 0;
        const icms  = parseFloat(document.getElementById('nfeItemICMS')?.value)  || 12;

        if (!desc) { alert('Informe a descrição do item.'); return; }
        if (valor <= 0) { alert('Informe o valor unitário.'); return; }

        this.itens.push({ desc, ncm, cfop, qtd, valor, icms, total: qtd * valor });
        this.renderItens();
        this.calcTotais();
        const el = document.getElementById('nfeItemDesc');
        if (el) { el.value = ''; el.focus(); }
        const vEl = document.getElementById('nfeItemValor');
        if (vEl) vEl.value = '';
    },

    removeItem(idx) {
        this.itens.splice(idx, 1);
        this.renderItens();
        this.calcTotais();
    },

    renderItens() {
        const cont = document.getElementById('nfeItens');
        if (!cont) return;
        if (!this.itens.length) { cont.innerHTML = ''; return; }

        cont.innerHTML = `<div style="overflow-x:auto;margin-bottom:0.75rem;">
        <table style="width:100%;border-collapse:separate;border-spacing:0;font-size:0.83rem;">
            <thead><tr>
                ${['#','Descrição','NCM','CFOP','Qtd','Vl. Unit.','ICMS%','Total',''].map(h =>
                    `<th style="background:linear-gradient(90deg,#ff6b00,#ffaa00);color:white;padding:0.65rem 0.8rem;text-align:left;font-size:0.7rem;letter-spacing:0.5px;text-transform:uppercase;">${h}</th>`
                ).join('')}
            </tr></thead>
            <tbody>
            ${this.itens.map((it,i) => `<tr>
                <td style="padding:0.6rem 0.8rem;border-bottom:1px solid rgba(255,107,0,0.08);color:#888;font-weight:600;">${i+1}</td>
                <td style="padding:0.6rem 0.8rem;border-bottom:1px solid rgba(255,107,0,0.08);font-weight:600;">${it.desc}</td>
                <td style="padding:0.6rem 0.8rem;border-bottom:1px solid rgba(255,107,0,0.08);text-align:center;font-family:monospace;font-size:0.78rem;">${it.ncm}</td>
                <td style="padding:0.6rem 0.8rem;border-bottom:1px solid rgba(255,107,0,0.08);text-align:center;font-family:monospace;font-size:0.78rem;">${it.cfop}</td>
                <td style="padding:0.6rem 0.8rem;border-bottom:1px solid rgba(255,107,0,0.08);text-align:center;">${it.qtd}</td>
                <td style="padding:0.6rem 0.8rem;border-bottom:1px solid rgba(255,107,0,0.08);text-align:right;">${this._fmt(it.valor)}</td>
                <td style="padding:0.6rem 0.8rem;border-bottom:1px solid rgba(255,107,0,0.08);text-align:center;">${it.icms}%</td>
                <td style="padding:0.6rem 0.8rem;border-bottom:1px solid rgba(255,107,0,0.08);text-align:right;font-weight:700;color:#ff6b00;">${this._fmt(it.total)}</td>
                <td style="padding:0.6rem 0.8rem;border-bottom:1px solid rgba(255,107,0,0.08);text-align:center;">
                    <button onclick="NFeModule.removeItem(${i})" style="background:rgba(220,53,69,0.1);color:#dc3545;border:none;border-radius:6px;width:28px;height:28px;cursor:pointer;" title="Remover">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </td>
            </tr>`).join('')}
            </tbody>
        </table></div>`;
    },

    calcTotais() {
        const sub  = this.itens.reduce((a,it) => a + it.total, 0);
        const icms = this.itens.reduce((a,it) => a + (it.total * it.icms / 100), 0);
        const desc = parseFloat(document.getElementById('nfeDesconto')?.value) || 0;
        const total = Math.max(0, sub - desc);
        const set = (id,v) => { const el = document.getElementById(id); if (el) el.innerHTML = v; };
        set('nfeSubtotal', this._fmt(sub));
        set('nfeTotalICMS', this._fmt(icms));
        set('nfeTotalGeral', this._fmt(total));
        const box = document.getElementById('nfeTotaisBox');
        if (box) box.style.display = this.itens.length ? 'block' : 'none';
    },

    limparForm() {
        if (!confirm('Limpar todos os dados do formulário?')) return;
        this.itens = [];
        this.renderItens();
        this.calcTotais();
        ['nfeRazaoSocial','nfeCnpj','nfeIE','nfeDestNome','nfeDestDoc',
         'nfeDestEnd','nfeDestMun','nfeDestEmail','nfeDestTel',
         'nfeSerie','nfeInfoCompl','nfeChave','nfeOSRef','nfeDesconto'
        ].forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
        const s = document.getElementById('nfeSerie'); if (s) s.value = '001';
        this._preencherData();
    },

    salvarRascunho() {
        const nfe = this._coletarDados('rascunho');
        if (!nfe) return;
        this.historico.unshift(nfe);
        this._saveStorage();
        this.renderHistorico();
        this.atualizarCards();
        this._toast('Rascunho salvo!', 'success');
    },

    gerarXML() {
        const nfe = this._coletarDados('pendente');
        if (!nfe) return;
        const blob = new Blob([this._buildXML(nfe)], {type:'application/xml'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `NFe_${nfe.numero}.xml`; a.click();
        URL.revokeObjectURL(url);
        this._toast('XML gerado e baixado!', 'info');
    },

    emitir() {
        const nfe = this._coletarDados('emitida');
        if (!nfe) return;
        nfe.chave = this._gerarChave();
        const el = document.getElementById('nfeChave');
        if (el) el.value = nfe.chave;
        this.historico.unshift(nfe);
        this.nfeCounter++;
        this._saveStorage();
        this.renderHistorico();
        this.atualizarCards();
        this._toast('✅ NF-e ' + nfe.numero + ' emitida!', 'success');
        this._gerarNumero();
    },

    _coletarDados(status) {
        const destNome = document.getElementById('nfeDestNome')?.value?.trim();
        if (!destNome) { alert('Informe o destinatário.'); return null; }
        if (!this.itens.length) { alert('Adicione pelo menos um item.'); return null; }
        const desc  = parseFloat(document.getElementById('nfeDesconto')?.value) || 0;
        const sub   = this.itens.reduce((a,it) => a + it.total, 0);
        return {
            id: Date.now(),
            numero: document.getElementById('nfeNumero')?.value || 'NFe-000001',
            serie:  document.getElementById('nfeSerie')?.value || '001',
            data:   document.getElementById('nfeDataEmissao')?.value || new Date().toISOString().slice(0,10),
            emitente:  document.getElementById('nfeRazaoSocial')?.value || '',
            cnpjEmit:  document.getElementById('nfeCnpj')?.value || '',
            destNome,
            destDoc:   document.getElementById('nfeDestDoc')?.value || '',
            destEmail: document.getElementById('nfeDestEmail')?.value || '',
            natureza:  document.getElementById('nfeNatureza')?.value || 'Venda de mercadoria',
            formaPag:  document.getElementById('nfeFormaPag')?.value || '01',
            osRef:     document.getElementById('nfeOSRef')?.value || '',
            infoCompl: document.getElementById('nfeInfoCompl')?.value || '',
            chave:     document.getElementById('nfeChave')?.value || '',
            itens: [...this.itens],
            subtotal: sub,
            desconto: desc,
            total: Math.max(0, sub - desc),
            status,
            criadoEm: new Date().toISOString(),
        };
    },

    _gerarChave() {
        let c = '';
        for (let i=0; i<44; i++) c += Math.floor(Math.random()*10);
        return c.replace(/(.{4})/g,'$1 ').trim();
    },

    _buildXML(nfe) {
        return `<?xml version="1.0" encoding="UTF-8"?>
<!-- NF-e gerada pelo ÓticaVision Pro — Demonstração -->
<nfeProc xmlns="http://www.portalfiscal.inf.br/nfe" versao="4.00">
  <NFe><infNFe versao="4.00">
    <ide><nNF>${nfe.numero}</nNF><serie>${nfe.serie}</serie><dhEmi>${nfe.data}</dhEmi><natOp>${nfe.natureza}</natOp></ide>
    <emit><xNome>${nfe.emitente}</xNome><CNPJ>${nfe.cnpjEmit.replace(/\D/g,'')}</CNPJ></emit>
    <dest><xNome>${nfe.destNome}</xNome><CPF>${nfe.destDoc.replace(/\D/g,'')}</CPF><email>${nfe.destEmail}</email></dest>
    ${nfe.itens.map((it,i)=>`<det nItem="${i+1}"><prod><xProd>${it.desc}</xProd><NCM>${it.ncm}</NCM><CFOP>${it.cfop}</CFOP><qCom>${it.qtd}</qCom><vUnCom>${it.valor.toFixed(2)}</vUnCom><vProd>${it.total.toFixed(2)}</vProd></prod><imposto><ICMS><pICMS>${it.icms}</pICMS></ICMS></imposto></det>`).join('\n    ')}
    <total><ICMSTot><vProd>${nfe.subtotal.toFixed(2)}</vProd><vDesc>${nfe.desconto.toFixed(2)}</vDesc><vNF>${nfe.total.toFixed(2)}</vNF></ICMSTot></total>
    <pag><detPag><tPag>${nfe.formaPag}</tPag><vPag>${nfe.total.toFixed(2)}</vPag></detPag></pag>
    <infAdic><infCpl>${nfe.infoCompl}</infCpl></infAdic>
  </infNFe></NFe>
</nfeProc>`;
    },

    renderHistorico(lista) {
        const tbody = document.getElementById('nfeHistoricoBody');
        if (!tbody) return;
        const dados = lista !== undefined ? lista : this.historico;
        if (!dados.length) {
            tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;padding:3rem 1rem;color:#aaa;">
                <i class="fas fa-file-invoice" style="font-size:2.5rem;display:block;margin-bottom:0.75rem;opacity:0.3;"></i>
                Nenhuma nota fiscal registrada ainda.</td></tr>`;
            return;
        }
        const sb = {
            emitida:  '<span style="background:rgba(40,167,69,0.12);color:#1a7a3a;padding:3px 10px;border-radius:99px;font-size:0.72rem;font-weight:700;">✅ Emitida</span>',
            pendente: '<span style="background:rgba(255,170,0,0.15);color:#8a5800;padding:3px 10px;border-radius:99px;font-size:0.72rem;font-weight:700;">⏳ Pendente</span>',
            cancelada:'<span style="background:rgba(220,53,69,0.12);color:#b02030;padding:3px 10px;border-radius:99px;font-size:0.72rem;font-weight:700;">❌ Cancelada</span>',
            rascunho: '<span style="background:rgba(108,117,125,0.12);color:#555;padding:3px 10px;border-radius:99px;font-size:0.72rem;font-weight:700;">📝 Rascunho</span>',
        };
        tbody.innerHTML = dados.map(nfe => `<tr>
            <td style="font-family:monospace;font-weight:700;color:#ff6b00;">${nfe.numero}</td>
            <td>${nfe.data ? new Date(nfe.data+'T12:00:00').toLocaleDateString('pt-BR') : '-'}</td>
            <td style="font-weight:600;">${nfe.destNome||'-'}</td>
            <td style="font-family:monospace;font-size:0.8rem;">${nfe.destDoc||'-'}</td>
            <td style="font-weight:700;color:#28a745;">${this._fmt(nfe.total)}</td>
            <td>${nfe.osRef||'-'}</td>
            <td>${sb[nfe.status]||nfe.status}</td>
            <td><div style="display:flex;gap:0.3rem;">
                <button onclick="NFeModule.verDetalhe(${nfe.id})" title="Ver" style="background:rgba(23,162,184,0.1);color:#17a2b8;border:none;border-radius:6px;width:30px;height:30px;cursor:pointer;"><i class="fas fa-eye"></i></button>
                <button onclick="NFeModule.baixarXML(${nfe.id})" title="XML" style="background:rgba(255,107,0,0.1);color:#ff6b00;border:none;border-radius:6px;width:30px;height:30px;cursor:pointer;"><i class="fas fa-download"></i></button>
                ${nfe.status==='emitida'?`<button onclick="NFeModule.cancelarNFe(${nfe.id})" title="Cancelar" style="background:rgba(220,53,69,0.1);color:#dc3545;border:none;border-radius:6px;width:30px;height:30px;cursor:pointer;"><i class="fas fa-ban"></i></button>`:''}
            </div></td>
        </tr>`).join('');
    },

    filtrarHistorico() {
        const busca  = (document.getElementById('nfeBusca')?.value||'').toLowerCase();
        const status = document.getElementById('nfeFiltroStatus')?.value||'';
        this.renderHistorico(this.historico.filter(n =>
            (!busca  || (n.numero+n.destNome+n.destDoc).toLowerCase().includes(busca)) &&
            (!status || n.status===status)
        ));
    },

    verDetalhe(id) {
        const n = this.historico.find(n=>n.id===id);
        if (!n) return;
        alert([`📄 NF-e: ${n.numero} | Série: ${n.serie}`,`📅 Data: ${n.data}`,
            `👤 Destinatário: ${n.destNome} (${n.destDoc})`,
            `📦 Itens: ${n.itens?.length||0}`,`💰 Total: ${this._fmt(n.total)}`,
            `🔑 Status: ${n.status}`, n.chave?`🗝️ Chave: ${n.chave}`:'',
            n.osRef?`🔗 OS: ${n.osRef}`:''].filter(Boolean).join('\n'));
    },

    baixarXML(id) {
        const nfe = this.historico.find(n=>n.id===id);
        if (!nfe) return;
        const blob = new Blob([this._buildXML(nfe)], {type:'application/xml'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href=url; a.download=`NFe_${nfe.numero}.xml`; a.click();
        URL.revokeObjectURL(url);
    },

    cancelarNFe(id) {
        if (!confirm('Cancelar esta NF-e?')) return;
        const nfe = this.historico.find(n=>n.id===id);
        if (nfe) { nfe.status='cancelada'; this._saveStorage(); this.renderHistorico(); this.atualizarCards(); }
        this._toast('NF-e cancelada.', 'warning');
    },

    exportarCSV() {
        if (!this.historico.length) { alert('Nenhuma nota para exportar.'); return; }
        const csv = ['Número,Data,Destinatário,CPF/CNPJ,Total,OS,Status',
            ...this.historico.map(n=>`${n.numero},${n.data},${n.destNome},${n.destDoc},${n.total.toFixed(2)},${n.osRef||''},${n.status}`)
        ].join('\n');
        const blob = new Blob([csv],{type:'text/csv'});
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');
        a.href=url; a.download='nfe_historico.csv'; a.click();
        URL.revokeObjectURL(url);
    },

    atualizarCards() {
        const mes=new Date().getMonth(), ano=new Date().getFullYear();
        const dm=this.historico.filter(n=>{const d=new Date(n.criadoEm);return d.getMonth()===mes&&d.getFullYear()===ano;});
        const set=(id,v)=>{const el=document.getElementById(id);if(el)el.textContent=v;};
        set('nfeCountEmitidas',  dm.filter(n=>n.status==='emitida').length);
        set('nfeCountPendentes', dm.filter(n=>n.status==='pendente'||n.status==='rascunho').length);
        set('nfeCountCanceladas',dm.filter(n=>n.status==='cancelada').length);
        set('nfeTotalEmitido', this._fmt(dm.filter(n=>n.status==='emitida').reduce((a,n)=>a+n.total,0)));
    },

    _toast(msg, tipo='info') {
        const colors={success:'#28a745',error:'#dc3545',warning:'#ff6b00',info:'#17a2b8'};
        const icons={success:'fa-check-circle',error:'fa-times-circle',warning:'fa-exclamation-triangle',info:'fa-info-circle'};
        const t=document.createElement('div');
        t.style.cssText=`background:white;border-radius:10px;padding:0.9rem 1rem;box-shadow:0 5px 20px rgba(0,0,0,0.15);display:flex;align-items:center;gap:10px;border-left:4px solid ${colors[tipo]};min-width:240px;`;
        t.innerHTML=`<i class="fas ${icons[tipo]}" style="color:${colors[tipo]};font-size:1.1rem;flex-shrink:0;"></i><span style="font-size:0.85rem;font-weight:600;color:#333;">${msg}</span>`;
        const c=document.getElementById('toastContainer');
        if(c){c.appendChild(t);setTimeout(()=>t.remove(),4000);}
    }
};

// Inicializa ao clicar no menu NF-e
document.addEventListener('DOMContentLoaded', () => {
    const m = document.querySelector('.menu-item[data-section="nfe"]');
    if (m) m.addEventListener('click', () => setTimeout(()=>NFeModule.init(), 60));
});

})();
</script>

</body>
</html>